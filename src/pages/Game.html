<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATALIAN ‚Äì QR Demo</title>
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
	:root{
	  /* merk & basis */
	  --bg:#f4f6fa;
	  --atalian-orange:#EE7E00;

	  /* bubbels */
	  --bubble-radius:16px;

	  /* BOT (links) ‚Äì leesbaar licht oranje */
	  --bubble-bot-bg:#FFF4E8;
	  --bubble-bot-border:#F6C791;
	  --bubble-bot-text:#1a202c;

	  /* GEBRUIKER (rechts) ‚Äì donker grijs */
	  --bubble-human-bg:#C85E00;
	  --bubble-human-border:#3b4450;
	  --bubble-human-text:#ffffff;

	  /* rechterzijde schaduw/gradient */
	  --right-shade-a: rgba(15,23,42,.38);
	  --right-shade-b: rgba(15,23,42,.26);
	  --right-shade-c: rgba(15,23,42,.12);
	}

	/* schoonmaak-kaart met regels per tijdsblok */
	.info-card{
	  background:#FFF7ED; border:1.5px solid #F6C791;
	  border-radius:14px; padding:10px 12px; box-shadow:0 1px 6px rgba(0,0,0,.06);
	}
	.info-title{ display:flex; align-items:center; gap:8px; font-weight:800; color:#1A202C; margin:0 0 6px 0; }
	.info-sub{ color:#475569; font-size:.92rem; margin-top:6px; }
	.badge-now{
	  margin-left:auto; font-size:.82rem; font-weight:700;
	  background:#22c55e1A; color:#166534; border:1px solid #22c55e55;
	  padding:2px 8px; border-radius:999px;
	}

	/* >>> per-regel lay-out + kalender-icoon */
	.info-list{ display:flex; flex-direction:column; gap:4px; margin:6px 0 0 0; }
	.info-row{ display:flex; align-items:baseline; gap:8px; }
	.info-row .ico{ font-size:1.05rem; line-height:1; }
	.info-row .txt{ font-weight:700; color:#1A202C; }

  html,body{
    height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
    font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background-color:var(--bg);overflow-y:auto;
  }

  /* Achtergrond via pseudo-laag + fel-pulse klasse */
  body{
    position: relative;
    background-color: var(--bg);
    overflow-y:auto;
  }
    body{background-image:url('/building-cleaning.png');background-size:cover;background-repeat:no-repeat;background-position:center}

  /* ‚á© Donkere overlay aan de rechterkant van de pagina */
  body::after{
    content:"";
    position: fixed;
    inset: 0;
    z-index: -1;              /* onder de UI */
    pointer-events: none;
    background: linear-gradient(
      to left,
      var(--right-shade-a) 0%,
      var(--right-shade-b) 22%,
      var(--right-shade-c) 44%,
      rgba(15,23,42,0) 64%
    );
    transition: opacity .6s ease;
    opacity: 1;
  }
  @media (max-width: 480px){
    body::after{ opacity:.85; }
  }

  /* wanneer demo klaar is ‚Üí kort feller */
  body.demo-bright::before{
    box-shadow: inset 0 0 0 9999px rgba(255,255,255,.10);
    filter:saturate(1.14) brightness(1.10);
  }

  *{box-sizing:border-box}
  header{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin:1rem 0;position:relative}
  img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);
    padding:.15rem .4rem;border-radius:12px}
  .subtitle{background:rgba(255,255,255,.95);padding:.35rem .8rem;border-radius:10px;border:2.5px solid var(--atalian-orange);
    color:#334155;font-size:.95rem;box-shadow:0 2px 8px rgba(238,126,0,.08)}
  .lang-toggle{margin-top:.5rem;display:flex;gap:8px;justify-content:center}
  .lang-btn{cursor:pointer;background:#fff;border:1.5px solid #e2e8f0;border-radius:999px;padding:.25rem .6rem;font-weight:600;font-size:.9rem}
  .wrap{max-width:640px;margin:0 auto;padding:0 1rem 2rem}

  .botui-container{
    max-width:640px;margin:0 auto;
    /* transparanter zodat achtergrond zichtbaar kan pulsen */
    background:linear-gradient(120deg, rgba(255,255,255,.92) 85%, rgba(244,246,250,.86) 100%);
    border:2px solid var(--atalian-orange);
    box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
    border-radius:12px;padding:1rem;opacity:0;animation:fadeIn .9s ease forwards;
    transition: background .5s ease, box-shadow .5s ease;
    backdrop-filter: blur(1px);
  }
  /* tijdens bright pulse nog iets transparanter */
  body.demo-bright .botui-container{
    background:linear-gradient(120deg, rgba(255,255,255,.84) 80%, rgba(244,246,250,.74) 100%);
    box-shadow:0 10px 38px rgba(0,0,0,.18),0 2px 10px rgba(238,126,0,.14);
  }
  .botui-container .botui-message{border-radius:10px}

  /* default (wordt overschreven door selectors hieronder) */
  .botui-message-content{
    background:#ffffff; color:#1f2937;
    border-radius:10px; border:1px solid #e5e7f0;
  }

  /* Highlight voor ‚ÄúKlaar met deze demo.‚Äù */
  .botui-message-content:has(.end-highlight){
    border:2px solid var(--atalian-orange);
    box-shadow:0 0 0 4px rgba(238,126,0,.12), 0 6px 24px rgba(238,126,0,.18);
  }
  .end-highlight{ display:inline-block; padding:2px 2px; }

  /* Donkere, rechthoekige actieknoppen (hoog contrast) */
/* Donkere knop met oranje rand ‚Äì goed contrast voor tekst + emoji */
.botui-actions-buttons-button{
  background:#4B5563;            /* zacht donkergrijs (slate-600) */
  color:#F1F5F9;                 /* heel licht grijs, geen fel wit */
  border:2px solid #EE7E00;      /* Atalian-oranje rand */
  border-radius:10px;
  padding:10px 14px;
  font-weight:700; letter-spacing:.1px;
  box-shadow:0 2px 10px rgba(0,0,0,.16);
  transition:filter .15s ease, transform .05s ease, box-shadow .15s ease;
}
.botui-actions-buttons-button:hover{
  filter:brightness(1.05);       /* subtiel, niet schreeuwerig */
  box-shadow:0 4px 14px rgba(0,0,0,.18);
}
.botui-actions-buttons-button:active{ transform:translateY(1px); }
.botui-actions-buttons-button:focus{ outline:2px solid #F59E0B; outline-offset:2px; }

.img-card{
  background:#fff; border:1.5px solid #F6C791; border-radius:12px;
  padding:6px; box-shadow:0 1px 6px rgba(0,0,0,.06);
}
.img-card img{ width:100%; height:auto; display:block; border-radius:8px; }
.img-caption{ font-size:.9rem; color:#475569; margin-top:6px; }



  /* Tekstveld duidelijk anders dan knoppen */
  .botui-actions-text-input{
    background:#ffffff; color:#0f172a;
    border:2px solid #cbd5e1; border-radius:4px;
  }
  .botui-actions-text-input:focus{
    border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.25);
  }
  /* breder invulveld */
	.botui-actions-text{ display:flex; }         /* laat het element de rij vullen */
	.botui-actions-text-input{
	  width:60% !important;                     /* volle breedte binnen de container */
	  max-width:60% !important;
	  box-sizing:border-box;                      /* borders meetellen in die 100% */
	}

  .botui-actions-buttons, .botui-actions-text{ margin-top:10px; }

  #confetti-canvas{position:fixed;inset:0;pointer-events:none}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

  /* =========================
     BUBBLES (definitieve overrides)
     ========================= */

  /* BOT (links) ‚Äì licht oranje
     Gebruik :not(.human) omdat BotUI de ‚Äòhuman‚Äô class op het content-element zet */
  .botui-message .botui-message-content:not(.human){
    background:
      linear-gradient(180deg, rgba(238,126,0,.06), rgba(238,126,0,.04)),
      var(--bubble-bot-bg) !important;
    color:var(--bubble-bot-text) !important;
    border:1px solid var(--bubble-bot-border) !important;
    border-radius:var(--bubble-radius) !important;
  }

  /* GEBRUIKER (rechts) ‚Äì donker
     Dek beide varianten af: .human op content √©n .botui-message-human op wrapper */
  .botui-message-content.human,
  .botui-message.botui-message-human .botui-message-content{
    background:var(--bubble-human-bg) !important;
    color:var(--bubble-human-text) !important;
    border:1px solid var(--bubble-human-border) !important;
    border-radius:var(--bubble-radius) !important;
  }

  /* Links in bubbels: goed leesbaar */
  .botui-message-content a{
    color:#0f172a;
    text-decoration: underline;
  }

  /* Reset-overlay (long-press) */
  #reset-overlay{position:fixed;inset:0;background:rgba(17,24,39,.75);display:flex;align-items:center;justify-content:center;z-index:9999}
  .reset-ripple{position:absolute;top:20px;left:calc(50% - 60px);width:120px;height:120px;border-radius:50%;
    background:radial-gradient(circle,rgba(255,255,255,.35),transparent 60%);animation:ripple .8s ease-out}
  @keyframes ripple{from{transform:scale(.7);opacity:.9}to{transform:scale(1.4);opacity:0}}
  .reset-emoji{position:absolute;top:-10px;font-size:28px;animation:drop 1.3s ease forwards}
  @keyframes drop{0%{opacity:0;transform:translateY(-40px)}30%{opacity:1}100%{transform:translateY(180px);opacity:0}}
  </style>
</head>
<body>
<header>
  <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" title="Lang drukken om demo te resetten" />
  <div class="lang-toggle">
    <button class="lang-btn" id="btn-nl" aria-label="Nederlands">NL</button>
    <button class="lang-btn" id="btn-fr" aria-label="Fran√ßais">FR</button>
  </div>
  <div class="subtitle" id="subtitle">Productdemo ‚Äì QR-codes in FM ¬∑ geen echte tickets</div>
</header>

<canvas id="confetti-canvas"></canvas>

<div class="wrap">
  <div id="botui-app"><bot-ui></bot-ui></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
<script>
  /* ===== helpers & storage ===== */
  const qs=new URLSearchParams(location.search);
  const LANG=(qs.get('lang')||localStorage.getItem('atalian_lang')||'nl').toLowerCase().startsWith('fr')?'fr':'nl';
  const KEY_NAME='atalian_name';
  const KEY_MAIL='atalian_email';
  const PROG_KEY='atalian_all_done';
  const CHECKED_KEY='atalian_checkedin';

  // In dev geen logging
  const LOG_URL = (location.hostname === '127.0.0.1' || location.hostname === 'localhost')
    ? '' : 'https://atalian-logs.atalianqr.workers.dev/api/log';

  /* ===== i18n ===== */
  const I18N = {
    nl: {
      subtitle: 'Interactieve Demo ‚Äì QR-codes voor Facility Management',
      hello_name: 'Hartelijk welkom bij de <b>ATALIAN QR-demo</b>! Hier ontdek je hoe eenvoudig Facility Management meldingen worden via QR-codes. Om te beginnen: hoe heet jij?',
      nice_to_meet: n => `Aangenaam, ${n}.`,
      intro_welcome: n => `Welkom, ${n}. Dit is een simulatie van onze QR-processen. In de demo-stappen zal je vier veelvoorkomende situaties doorlopen.`,
      intro_line1: 'Het doel: <b>snel, duidelijk en direct</b> melden wat er aan de hand is. Geen apps, geen telefoonnummers.',
      intro_list_title: 'Wat je in de demo kan verwachten:',
      intro_list_1: '‚Ä¢ **Registratie:** Direct een ticket aanmaken (technisch defect, schoonmaak, comfort).',
      intro_list_2: '‚Ä¢ **Informatie:** Onmiddellijk relevante info krijgen (schoonmaakprogramma, wifi-codes).',
      start_btn: 'Start de demo',
      ask_problem: 'Kan je in het kort zeggen wat je wilt melden?',
      ask_email: 'Wat is je e-mailadres?',
      invalid_email: 'Hm, dat lijkt geen geldig adres. Probeer nog eens',
      urgent_q: n => `${n}, is dit dringend of mag het op de to-do-lijst?`,
      urgent_yes: 'üî• Dringend!',
      urgent_no: '‚è±Ô∏è To-do mag',
confirm_urgent: n => `Ok√© ${n}, mag ik meteen een <b>dringende</b> oproep aanmaken?`,
fast_thanks: (ctx,id,n) => `Bedankt, ${n}. Je <b>${ctx}</b> is <b>dringend</b> verstuurd. <span class="hint">(Demo) ‚Ä¢ ref: ${id}</span>`,
fast_cancel: n => `Geen probleem, ${n}. We maken nu geen dringende oproep aan.`,
      servicedesk_note: 'Omdat dit ‚ÄúDringend‚Äù is: in productie bellen we meteen de servicedesk om prioriteit te geven. In deze demo tonen we enkel de flow.',
      photo_preview: 'Voorbeeld van je foto:',
      photo_take: 'üì∏ Foto nemen',
      photo_gallery: 'üñºÔ∏è Kies uit galerij',
      photo_skip: '‚ûñ Overslaan',
      photo_skip_msg: 'Ok√©, we gaan verder zonder foto',
      photo_none: 'Geen foto gekozen ‚Äî kies opnieuw of sla over.',
      thanks_sent: (ctx,id) => `Bedankt! Je <b>${ctx}</b> is verstuurd. <span class="hint">(Demo ‚Äì geen echte ticket) ‚Ä¢ ref: ${id}</span>`,
      summary_heading: 'Samenvatting:',
      summary_urgent: u => `‚Ä¢ Urgent: <b>${u==='ja'?'ja':'nee'}</b>`,
      summary_desc: d => `‚Ä¢ Beschrijving: <b>${d||'-'}</b>`,
      summary_email: e => `‚Ä¢ Contact: <b>${e}</b>`,
      summary_photo: '‚Ä¢ Foto: <i>bijgevoegd</i>',
      end_msg: 'Bedankt. Klaar met deze demo.',
      scen1_q: 'Wat wil je melden in dit lokaal?',
      scen1_opts: ['üõ†Ô∏è Technisch', 'üßπ Schoonmaak'],
      scen1_feedback: (n) => `Helder, ${n}. We maken een korte melding aan.`,
      // SCENARIO 2
      scen2_q: 'Wat is er aan de hand met de koffiemachine? ‚òïÔ∏è',
      scen2_opts: ['Koffiebonen zijn op', 'Melk/bekers zijn op', 'Toestel is defect'],
      scen2_feedback: (n, selection)=> `Prima, ${n}. Melding aangemaakt voor: ${selection}.`,
      scen2_context: 'Koffiemachine-ticket',
      // EINDE SCENARIO 2
		scen3_q: 'Wil je het schoonmaakprogramma voor deze zone zien?',
		scen3_btn: 'Toon programma',
		scen3_badge: '2√ó/week',
		scen3_info: 'Schoonmaak gebeurt <b>2√ó per week</b>: <b>di 08:00‚Äì12:00</b> en <b>do 13:00‚Äì17:00</b>.',
		scen3_next: (dStr)=> `Volgende poetsbeurt: <b>${dStr}</b>`,
		scen3_now: 'We zitten nu in het voorziene tijdsblok ‚Äî de poetsbeurt is voorzien. üßº',
		scen3_list_title: 'Komende 4 weken:',
		scen3_holiday: '(feestdag ‚Äì geen poetsbeurt)',
		scen3_done: 'Genoteerd. Programma getoond (demo).',
		scen4_q: 'We zitten in een vergaderruimte üñ•Ô∏èüë•üí¨. Wat wil je doen?',
		scen4_opts: ['Wifi-code', 'TV verbinden', 'Ander probleem'],
		wifi_hint: 'Zoek het netwerk <b>GUEST</b> en gebruik het wachtwoord <b>BeMyGuest</b>.',
		wifi_ok_q: 'Is het gelukt om te verbinden?',
		wifi_ok_yes: 'Ja, gelukt üëç',
		wifi_ok_no: 'Nee, nog steeds niet',
		wifi_done: 'Mooi zo! We gaan verder. ‚úÖ',
		wifi_escalate: n => `Ok√© ${n}, we maken een melding aan.`,
		tv_q_power: 'Staat de TV aan?',
		tv_fix_power: 'Zoek de afstandsbediening (onder de TV of op de tafel) en zet de TV aan.',
		tv_q_hdmi: 'Is de HDMI-kabel verbonden met je laptop?',
		tv_fix_hdmi: 'Verbind de HDMI-kabel met je laptop.',
		tv_q_source: 'Is de bron van de TV ingesteld op <b>HDMI1</b>?',
		tv_fix_source: 'Kies op de TV met Source/Input voor <b>HDMI1</b>.',
		tv_q_result: 'Zie je nu beeld op de TV?',
		tv_ok: 'Top, TV werkt. ‚úÖ',
		tv_escalate:  n => `Lukt het niet, ${n}? We maken een <b>dringende</b> melding aan.`,
		tv_step_power_hint: 'üîã Zet de TV aan met de afstandsbediening (onder de TV of op de tafel).',
		tv_step_hdmi_hint: 'üîå Verbind de HDMI-kabel met je laptop.',
		tv_step_source_hint: 'üîÄ Kies op de TV de bron <b>HDMI1</b> (knop Source/Input).',
		ok_now_q: 'Is het nu in orde?',
		other_context: 'ander probleem in vergaderruimte',
    },
    fr: {
      subtitle: 'D√©mo Interactive ‚Äì Codes QR pour le Facility Management',
      hello_name: 'Bienvenue √† la <b>d√©mo QR d‚ÄôATALIAN</b> ! D√©couvrez la simplicit√© des signalements en Facility Management via un simple code QR. Pour commencer : comment vous appelez-vous ?',
      nice_to_meet: n => `Enchant√©, ${n}.`,
      intro_welcome: n => `Bienvenue, ${n}. Ceci est une simulation de nos processus QR. Vous allez parcourir quatre sc√©narios fr√©quents.`,
      intro_line1: 'L‚Äôobjectif : <b>signaler le probl√®me rapidement, clairement et directement</b>. Pas d‚Äôapplication, pas d‚Äôappel t√©l√©phonique.',
      intro_list_title: 'Ce que vous allez exp√©rimenter dans cette d√©mo :',
      intro_list_1: '‚Ä¢ **Enregistrement :** Cr√©er imm√©diatement un ticket (technique, nettoyage, confort).',
      intro_list_2: '‚Ä¢ **Information :** Obtenir des informations pertinentes instantan√©ment (programme de nettoyage, codes Wi-Fi).',
      start_btn: 'D√©marrer la d√©mo',
      ask_problem: 'Que souhaitez-vous signaler en quelques mots ?',
      ask_email: 'Quelle est votre adresse e-mail ?',
      invalid_email: 'Adresse invalide. R√©essayez',
      urgent_q: n => `${n}, est-ce urgent ou peut-on planifier ?`,
      urgent_yes: 'üö® Urgent',
      urgent_no: '‚è≥ Pas urgent',
confirm_urgent: n => `D‚Äôaccord ${n}, puis-je cr√©er tout de suite un signalement <b>urgent</b> ?`,
fast_thanks: (ctx,id,n) => `Merci, ${n}. Votre <b>${ctx}</b> a √©t√© envoy√© en <b>urgent</b>. <span class="hint">(D√©mo) ‚Ä¢ r√©f : ${id}</span>`,
fast_cancel: n => `Pas de souci, ${n}. Pas de signalement urgent pour l‚Äôinstant.`,
      servicedesk_note: 'Puisque c‚Äôest ‚ÄúUrgent‚Äù : en production, nous appelons imm√©diatement le service desk pour prioriser. Ici, c‚Äôest une d√©mo.',
      photo_preview: 'Aper√ßu :',
      photo_take: 'üì∏ Prendre une photo',
      photo_gallery: 'üñºÔ∏è Choisir dans la galerie',
      photo_skip: '‚ûñ Passer',
      photo_skip_msg: 'Ok, on continue sans photo',
      photo_none: 'Aucune photo ‚Äî r√©essayez ou passez.',
      thanks_sent: (ctx,id) => `Merci ! Votre <b>${ctx}</b> a √©t√© envoy√©. <span class="hint">(D√©mo ‚Äì pas de vrai ticket) ‚Ä¢ r√©f: ${id}</span>`,
      summary_heading: 'R√©capitulatif :',
      summary_urgent: u => `‚Ä¢ Urgent : <b>${u==='ja'?'oui':'non'}</b>`,
      summary_desc: d => `‚Ä¢ Description : <b>${d||'-'}</b>`,
      summary_email: e => `‚Ä¢ Contact: <b>${e}</b>`,
      summary_photo: '‚Ä¢ Photo : <i>jointe</i>',
      end_msg: 'Merci. D√©mo termin√©e.',
      scen1_q: 'Que souhaitez-vous signaler pour ce local?',
      scen1_opts: ['Technique', 'Nettoyage', 'Rien ‚Äì info seulement'],
      scen1_feedback: (n) => `Parfait, ${n}. Nous cr√©ons un signalement (d√©mo).`,
      // SCENARIO 2
      scen2_q: 'Quel est le probl√®me avec la machine √† caf√© ? ‚òïÔ∏è',
      scen2_opts: ['Plus de grains de caf√©', 'Plus de lait/gobelets', 'Machine d√©fectueuse'],
      scen2_feedback: (n, selection)=> `Tr√®s bien, ${n}. Signalement cr√©√© pour : ${selection}.`,
      scen2_context: 'Ticket machine √† caf√©',
      // EINDE SCENARIO 2
		scen3_q: 'Voulez-vous voir le programme de nettoyage voor deze zone ?',
		scen3_btn: 'Afficher le programme',
		scen3_badge: '2√ó/semaine',
		scen3_info: 'Le nettoyage a lieu <b>2√ó par semaine</b> : <b>mar 08:00‚Äì12:00</b> et <b>jeu 13:00‚Äì17:00</b>.',
		scen3_next: (dStr)=> `Prochain passage : <b>${dStr}</b>`,
		scen3_now: 'Bonne nouvelle : nous sommes dans le cr√©neau pr√©vu ‚Äî le nettoyage est programm√©. üßº',
		scen3_list_title: 'Prochaines 4 semaines :',
		scen3_holiday: '(jour f√©ri√© ‚Äì pas de nettoyage)',
		scen3_done: 'C‚Äôest not√©. Programme affich√© (d√©mo).',
		scen4_q: 'Nous sommes dans une salle de r√©union üñ•Ô∏èüë•üí¨. Que souhaitez-vous faire ?',
		scen4_opts: ['Code Wi-Fi', 'Connecter la TV', 'Autre probl√®me'],
		wifi_hint: 'Cherchez le r√©seau <b>GUEST</b> et utilisez le mot de passe <b>BeMyGuest</b>.',
		wifi_ok_q: 'La connexion a-t-elle r√©ussi ?',
		wifi_ok_yes: 'Oui, c‚Äôest bon üëç',
		wifi_ok_no: 'Non, pas encore',
		wifi_done: 'Parfait ! On continue. ‚úÖ',
		wifi_escalate: n => `D‚Äôaccord ${n}, on cr√©e un signalement.`,
		tv_q_power: 'La TV est-elle allum√©e ?',
		tv_fix_power: 'Trouvez la t√©l√©commande (sous la TV ou sur la table) et allumez la TV.',
		tv_q_hdmi: 'Le c√¢ble HDMI est-il branch√© √† votre laptop ?',
		tv_fix_hdmi: 'Branchez le c√¢ble HDMI sur votre laptop.',
		tv_q_source: 'La source de la TV est-elle r√©gl√©e sur <b>HDMI1</b> ?',
		tv_fix_source: 'Choisissez <b>HDMI1</b> avec la touche Source/Input.',
		tv_q_result: 'Voyez-vous l‚Äôimage maintenant ?',
		tv_ok: 'Super, la TV fonctionne. ‚úÖ',
		tv_escalate:  n => `Sinon, ${n}, on cr√©e un signalement <b>urgent</b>.`,
		tv_step_power_hint: 'üîã Allumez la TV met de afstandsbediening (onder de TV of op de tafel).',
		tv_step_hdmi_hint: 'üîå Verbind de HDMI-kabel met je laptop.',
		tv_step_source_hint: 'üîÄ Kies op de TV de bron <b>HDMI1</b> (knop Source/Input).',
		ok_now_q: 'Is het nu in orde?',
		other_context: 'autre probl√®me en salle de r√©union'
    }
  };

  function t(key, ...args){
    const src = I18N[LANG] && I18N[LANG][key];
    if(!src) return '';
    if(typeof src === 'function') return src(...args);
    return src;
  }

  function setStored(key,value){ try{ localStorage.setItem(key, value);}catch(_){} }
  function getStored(key){
    try{ const v=localStorage.getItem(key); if (v) return v; }catch(_){}
    try{ const v2 = sessionStorage.getItem(key); if (v2) return v2; } catch(_) {}
    return '';
  }

  let botui=null, USERNAME=getStored(KEY_NAME)||'', EMAIL=getStored(KEY_MAIL)||'';

  /* logging */
  function logEvent(type, extra={}){
    try{
      if(!LOG_URL) return;
      const payload={ type, ts:Date.now(), lang:LANG, name_set: !!USERNAME, ...extra };
      if(navigator.sendBeacon){
        const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
        navigator.sendBeacon(LOG_URL, blob);
      }
    }catch(_){}
  }
  function logVisit(){ logEvent('visit'); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  /* confetti */
  const Confetti=function(){
    const canvas=document.getElementById('confetti-canvas');
    const ctx=canvas.getContext('2d');
    let W,H,parts=[],running=false;
    function resize(){ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; }
    function add(n){
      for(let i=0;i<n;i++){
        parts.push({x:Math.random()*W,y:-10,r:2+Math.random()*4,dx:-1+Math.random()*2,dy:2+Math.random()*2,ttl:220+Math.random()*120});
      }
    }
    function tick(){
      ctx.clearRect(0,0,W,H);
      parts.forEach(p=>{ p.x+=p.dx; p.y+=p.dy; p.ttl-=1; ctx.fillStyle='rgba(255,165,0,.85)'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();});
      parts=parts.filter(p=>p.ttl>0);
      if(running) requestAnimationFrame(tick);
    }
    return {
      start(){ running=true; resize(); add(140); tick(); window.addEventListener('resize',resize); },
      stop(){ running=false; window.removeEventListener('resize',resize); ctx.clearRect(0,0,W,H); }
    };
  }();

  /* background boost */
  function bgBoost(ms=2200){
    document.body.classList.add('demo-bright');
    setTimeout(()=>document.body.classList.remove('demo-bright'), ms);
  }
  
	async function askYesNo(questionHtml){
	  await botui.message.add({ type:'html', content: questionHtml });
	  const res = await botui.action.button({
		action: [{ text:'Ja', value:'yes' }, { text:'Nee', value:'no' }]
	  });
	  return res?.value === 'yes';
	}

// --- schedule helpers voor schoonmaak step=3 ---
// --- Config vaste vensters (di/do) ---
const CLEAN_WINDOWS = [
  { dow: 2, startH: 8,  endH: 12, labelNL: 'di 08:00‚Äì12:00', labelFR: 'mar 08:00‚Äì12:00' },
  { dow: 4, startH: 13, endH: 17, labelNL: 'do 13:00‚Äì17:00', labelFR: 'jeu 13:00‚Äì17:00' }
];

// --- Instelling: feestdagen overslaan ---
const SKIP_ON_HOLIDAYS = true;
// Voeg hier je feestdagen toe in ISO 'YYYY-MM-DD' (Belgische 2025 voorbeelden):
const HOLIDAYS = new Set([
  '2025-01-01','2025-04-21','2025-05-01','2025-05-29','2025-06-09',
  '2025-07-21','2025-08-15','2025-11-01','2025-11-11','2025-12-25'
]);

const DOW_NL = ['zo','ma','di','wo','do','vr','za'];
const DOW_FR = ['dim','lun','mar','mer','jeu','ven','sam'];

function pad2(n){ return n<10?('0'+n):(''+n); }

function fmtWindow(dt, win, lang){
  const dOw = lang==='fr' ? DOW_FR[ dt.getDay() ] : DOW_NL[ dt.getDay() ];
  const d   = `${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()}`;
  const range = `${pad2(win.startH)}:00‚Äì${pad2(win.endH)}:00`;
  return `${dOw} ${d}, ${range}`;
}

function isHoliday(date){
  const key = `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`;
  return HOLIDAYS.has(key);
}

function isWithinWindow(now, win){
  if (now.getDay() !== win.dow) return false;
  const h = now.getHours() + now.getMinutes()/60;
  return h >= win.startH && h < win.endH;
}

function nextStartFrom(now, win){
  // eerstvolgende start (vandaag of later), ex. di 08:00
  const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const delta = (win.dow - now.getDay() + 7) % 7;
  const t = new Date(base);
  t.setDate(base.getDate() + delta);
  t.setHours(win.startH,0,0,0);
  // als voorbij ‚Üí +7d
  if (t <= now) t.setDate(t.getDate() + 7);
  return t;
}

function getNextCleaning(now){
  // indien we NU in een venster zitten ‚Üí report 'inWindow'
  for (const w of CLEAN_WINDOWS){
    if (isWithinWindow(now, w) && (!SKIP_ON_HOLIDAYS || !isHoliday(now))) {
      const nextAfter = nextStartFrom(new Date(now.getTime()+1), w);
      return { inWindow:true, next: nextAfter, win: w };
    }
  }
  // anders: dichtste toekomstige venster, sla feestdag over
  let candidate = null, cwin = null;
  for (const w of CLEAN_WINDOWS){
    let t = nextStartFrom(now, w);
    // overslaan indien feestdag: schuif door telkens +7d
    if (SKIP_ON_HOLIDAYS){
      while (isHoliday(t)) t.setDate(t.getDate()+7);
    }
    if (!candidate || t < candidate){ candidate = t; cwin = w; }
  }
  return { inWindow:false, next: candidate, win: cwin };
}



  /* naam */
  async function askNameIfNeeded() {
    if (USERNAME) return;
    await botui.message.add({ type: 'html', content: t('hello_name') });
    const res = await botui.action.text({
      action: {
        placeholder: LANG === 'fr' ? 'Entrez votre nom‚Ä¶' : 'Typ je naam‚Ä¶',
        value: getStored(KEY_NAME) || ''
      }
    });
    USERNAME = (res && res.value ? String(res.value).trim() : '') || (LANG === 'fr' ? 'coll√®gue' : 'collega');
    setStored(KEY_NAME, USERNAME);
    await logEvent('name_set', { display_name: USERNAME });
    await botui.message.add({ content: t('nice_to_meet', USERNAME) });
    await sleep(60);
  }

  async function askProblem() {
    await botui.message.add({ content: t('ask_problem') });
    const { value } = await botui.action.text({
      action: { placeholder: LANG==='fr' ? 'D√©crivez bri√®vement‚Ä¶' : 'Omschrijf kort‚Ä¶' }
    });
    return (value||'').trim();
  }

  async function askEmail() {
    await botui.message.add({ content: t('ask_email') });
    let email='';
    while(true){
      const res = await botui.action.text({
        action: { type:'email', placeholder: 'naam@bedrijf.be', value: getStored(KEY_MAIL) || '' }
      });
      email = (res && res.value || '').trim();
      if(!email || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) break;
      await botui.message.add({ content: t('invalid_email') });
    }
    if(email){ EMAIL=email; setStored(KEY_MAIL,email); }
    return email;
  }

  /* ticket flow */
	async function ticketFlow(context, opts={}){
	  const forceUrgent = !!opts.forceUrgent;
	  const skipDetails = !!opts.skipDetails;
	  const presetDesc  = opts.presetDesc || '';

	  let urgent = 'nee';
	  if (forceUrgent) urgent = 'ja';
	  else {
		await botui.message.add({ content: t('urgent_q', USERNAME) });
		urgent = (await botui.action.button({
		  action: [{ text: t('urgent_yes'), value:'ja' }, { text: t('urgent_no'), value:'nee' }]
		}))?.value || 'nee';
	  }

	  let desc = '';
	  let photoChosen = false;
	  let email = '';

	  if (!skipDetails){
		// klassieke flow
		desc = await askProblem();

		const photoChoice = (await botui.action.button({
		  action: [
			{ text: t('photo_take'), value: 'take' },
			{ text: t('photo_gallery'), value: 'gallery' },
			{ text: t('photo_skip'), value: 'skip' }
		  ]
		}))?.value;

		if (photoChoice === 'take' || photoChoice === 'gallery') {
		  const pickPhoto = (capture=false) => new Promise(resolve => {
			const input = document.createElement('input');
			input.type = 'file'; input.accept = 'image/*';
			if (capture) input.setAttribute('capture', 'environment');
			input.onchange = () => {
			  const file = input.files && input.files[0]; if (!file) return resolve(null);
			  const reader = new FileReader();
			  reader.onload = () => resolve({ dataUrl: reader.result, file });
			  reader.onerror = () => resolve(null);
			  reader.readAsDataURL(file);
			};
			input.click();
		  });
		  const picked = await pickPhoto(photoChoice === 'take');
		  if (picked && picked.dataUrl) {
			photoChosen = true;
			await botui.message.add({ type:'html', content: t('photo_preview') });
			await botui.message.add({ type:'html',
			  content:`<div style="border:1px solid #e2e8f0;border-radius:8px;padding:6px;text-align:center;background:#fff">
				<img alt="preview" src="${picked.dataUrl}" style="max-width:100%;height:auto;border-radius:6px"/>
			  </div>`});
		  } else {
			await botui.message.add({ content: t('photo_none') });
		  }
		} else {
		  await botui.message.add({ content: t('photo_skip_msg') });
		}

		email = await askEmail();
	  } else {
		// snelle flow: geen vragen
		desc  = presetDesc || '(auto)';
		
		// Vraag om e-mail als deze nog niet bekend is (EMAIL is de globale variabele)
		if (!EMAIL) {
            email = await askEmail(); // askEmail() vult de globale EMAIL en return de waarde
        } else {
            email = EMAIL;
        }
	  }

	  const id = Math.random().toString(36).slice(2,8).toUpperCase();

	  // Bedank/overzicht
	  if (skipDetails && urgent==='ja' && I18N[LANG].fast_thanks){
		await botui.message.add({ type:'html', content: t('fast_thanks', context, id, USERNAME) });
	  } else {
		await botui.message.add({ type:'html', content: t('thanks_sent', context, id) });
	  }

	  await botui.message.add({
		type:'html',
		content:
		  `<div>${t('summary_heading')}</div>
		   <div>${t('summary_urgent', urgent)}</div>
		   <div>${t('summary_desc', desc)}</div>
		   <div>${t('summary_email', email || '-' )}</div>
		   <div>${photoChosen ? t('summary_photo') : ''}</div>`
	  });

	  if (urgent === 'ja') await botui.message.add({ content: t('servicedesk_note') });

	  await logEvent('ticket_submitted', { context, urgent, has_photo: photoChosen, skip_details: skipDetails });
	}



  /* scenario's */
  async function intro() {
    await askNameIfNeeded();
    const hi = t('intro_welcome', USERNAME);
    if (hi) await botui.message.add({ type:'html', content: hi });
    const line1 = t('intro_line1');
    if (line1) await botui.message.add({ type:'html', content: line1 });

    // Gebruik de nieuwe, opgesplitste i18n keys voor de bullet points
    await botui.message.add({ type:'html', content:
        `<b>${t('intro_list_title')}</b><br>` +
        t('intro_list_1') + `<br>` +
        t('intro_list_2')
    });

    const start = await botui.action.button({
      action: [{ text: t('start_btn'), value: 'start' }]
    });

    if (start && start.value === 'start') {
      localStorage.setItem('atalian_checkedin', 'yes');
      const lang = LANG || 'nl';
      window.location.href = `${window.location.pathname}?step=1&lang=${lang}`;
    }
  }

  async function scenario1(){
    await askNameIfNeeded();
    await botui.message.add({content:t('scen1_q')});
    await botui.action.button({action:[
      {text:I18N[LANG].scen1_opts[0],value:'tech'},
      {text:I18N[LANG].scen1_opts[1],value:'clean'}]});
    await botui.message.add({content:t('scen1_feedback',USERNAME)});
    await ticketFlow(LANG==='fr'?'signalement local/asset':'melding lokaal/asset');
    markScenarioDone(1);
    await endMessage(1);
  }

  // GEPASTE SCENARIO 2 FUNCTIE
  async function scenario2(){
    await askNameIfNeeded();
    await botui.message.add({content:t('scen2_q')});
    
    const options = I18N[LANG].scen2_opts;
    const choice = await botui.action.button({
      action:[
        {text: options[0], value:'bonen'},
        {text: options[1], value:'melk'},
        {text: options[2], value:'defect'}
      ]
    });

    const selectedText = choice ? choice.text : (LANG === 'fr' ? 'Annul√©' : 'Geannuleerd');
    await botui.message.add({content:t('scen2_feedback', USERNAME, selectedText)});
    
    // Bepaal de beschrijving en flow
    let description = selectedText;
    let isUrgent = false;
    let skipDetails = true; // Default: snelle flow (bonen, melk)

    if (choice.value === 'defect') {
        // Defect: is dringend en heeft een volledige beschrijving/foto nodig
        description = (LANG === 'fr' ? 'Machine √† caf√© enti√®rement en panne' : 'Koffiemachine volledig defect');
        isUrgent = true; 
        skipDetails = false; // <-- Forceert de volledige ticket flow
    } else if (choice.value === 'bonen') {
        description = (LANG === 'fr' ? 'Grains de caf√© √©puis√©s' : 'Koffiebonen zijn op');
    } else if (choice.value === 'melk') {
        description = (LANG === 'fr' ? 'Lait/gobelets √©puis√©s' : 'Melk/bekers zijn op');
    }

    // Roep de ticket flow aan, nu met dynamische skipDetails
    await ticketFlow(t('scen2_context'), {
      skipDetails: skipDetails,
      forceUrgent: isUrgent,
      presetDesc: description // Wordt alleen gebruikt als skipDetails: true
    });

    markScenarioDone(2);
    await endMessage(2);
  }
  // EINDE GEPASTE SCENARIO 2 FUNCTIE

	async function scenario3(){
	  await askNameIfNeeded();

	  await botui.message.add({ content: t('scen3_q') });
	  await botui.action.button({ action:[{ text:t('scen3_btn'), value:'show' }] });

	  // Kaartje met emoji + chips + "Nu bezig" badge
	const now = new Date();
	// haal alles op wat je later nodig hebt
	const { inWindow, next, win } = getNextCleaning(now);
	const nowBadge = inWindow ? `<span class="badge-now">${LANG==='fr'?'En cours':'Nu bezig'}</span>` : '';


	await botui.message.add({
	  type:'html',
	  content: `
		<div class="info-card">
		  <div class="info-title">üßπ <span>${LANG==='fr'?'Programme de nettoyage - 2√ó par semaine':'Schoonmaakprogramma - 2√ó per week'}</span>${nowBadge}</div>
		  <div class="info-sub"><span> <br></span>     </div>
		  <div class="info-list">
			<div class="info-row">
			  <span class="ico">üìÖ</span>
			  <span class="txt">${LANG==='fr'?'mar':'di'} 08:00‚Äì12:00</span>
			</div>
			<div class="info-row">
			  <span class="ico">üìÖ</span>
			  <span class="txt">${LANG==='fr'?'jeu':'do'} 13:00‚Äì17:00</span>
			</div>
		  </div>
		  
		</div>`
	});


	  // Volgende poetsbeurt (√©√©n regel)
	  const nextStr = fmtWindow(next, win, LANG);
	  await botui.message.add({ type:'html', content: t('scen3_next', nextStr) });

	  await botui.message.add({ content: t('scen3_done') });
	  markScenarioDone(3);
	  await endMessage(3);
	}




async function scenario4(){
  await askNameIfNeeded();

  await botui.message.add({ content: t('scen4_q') });

  const choice = await botui.action.button({
    action: [
      { text: I18N[LANG].scen4_opts[0], value:'wifi' },
      { text: I18N[LANG].scen4_opts[1], value:'tv'   },
      { text: I18N[LANG].scen4_opts[2], value:'other'}
    ]
  });

  if (!choice) { await endMessage(4); return; }

	// --- WIFI PAD ---
	if (choice.value === 'wifi'){
	  // Toon SSID + paswoord
	  await botui.message.add({ type:'html', content: t('wifi_hint') });

	  // Gelukt?
	  const ok = await botui.action.button({
		action: [
		  { text: t('wifi_ok_yes'), value:'yes' },
		  { text: t('wifi_ok_no'),  value:'no'  }
		]
	  });

	  if (ok?.value === 'yes'){
		await botui.message.add({ content: t('wifi_done') });
		markScenarioDone(4); await endMessage(4); return;
	  }

	  // Mislukt ‚Üí vraag of we meteen DRINGEND mogen aanmaken (zonder extra velden)
	  const goUrgent = await askYesNo( t('confirm_urgent', USERNAME) );
	  if (!goUrgent){
		await botui.message.add({ type:'html', content: t('fast_cancel', USERNAME) });
		markScenarioDone(4); await endMessage(4); return;
	  }

	  await ticketFlow(
		(LANG==='fr'
		  ? `Wi-Fi invit√© ‚Äì salle de r√©union ‚Äî ${USERNAME}`
		  : `Wifi-guest ‚Äì vergaderruimte ‚Äî ${USERNAME}`),
		{
		  forceUrgent: true,
		  skipDetails: true,
		  presetDesc: (LANG==='fr'
			? 'Connexion GUEST (BeMyGuest) √©chou√©e'
			: 'Verbinding GUEST (BeMyGuest) mislukt')
		}
	  );

	  markScenarioDone(4); await endMessage(4); return;
	}


// --- TV PAD ---
if (choice.value === 'tv'){
  // 1) Staat de TV aan?
  const isOn = await askYesNo( t('tv_q_power') );
  if (!isOn){
    await botui.message.add({ type:'html', content: t('tv_step_power_hint') });

    // Foto: afstandsbediening
    await botui.message.add({
      type:'html',
      content: `
        <div class="img-card">
          <img src="/TV_RC.png"
               alt="${LANG==='fr'?'T√©l√©commande sur la table':'Afstandsbediening op de tafel'}"
               loading="lazy" />
          <div class="img-caption">
            ${LANG==='fr'
              ? 'Astuce : la t√©l√©commande se trouve souvent au centre de la table.'
              : 'Tip: de afstandsbediening ligt vaak in het midden van de tafel.'}
          </div>
        </div>`
    });

    const okAfterPower = await askYesNo( t('ok_now_q') );
    if (okAfterPower){
      await botui.message.add({ content: t('tv_ok') });
      markScenarioDone(4); await endMessage(4); return;
    }
  }

  // 2) Is de HDMI-kabel verbonden met je laptop?
  const hdmiOk = await askYesNo( t('tv_q_hdmi') );
  if (!hdmiOk){
    await botui.message.add({ type:'html', content: t('tv_step_hdmi_hint') });

    // Foto: HDMI-verbinding
    await botui.message.add({
      type:'html',
      content: `
        <div class="img-card">
          <img src="/TV_HDMI.png"
               alt="${LANG==='fr'
                  ? 'Branchez le c√¢ble HDMI entre le laptop et la TV'
                  : 'Verbind de HDMI-kabel tussen laptop en TV'}"
               loading="lazy" />
          <div class="img-caption">
            ${LANG==='fr'
              ? 'Astuce : poussez bien le connecteur jusqu‚Äôau ‚Äúclic‚Äù.'
              : 'Tip: duw de stekker goed door tot je een ‚Äúklik‚Äù voelt.'}
          </div>
        </div>`
    });

    const okAfterHdmi = await askYesNo( t('ok_now_q') );
    if (okAfterHdmi){
      await botui.message.add({ content: t('tv_ok') });
      markScenarioDone(4); await endMessage(4); return;
    }
  }

  // 3) Is de bron van de TV ingesteld op HDMI1?
  const srcOk = await askYesNo( t('tv_q_source') );
  if (!srcOk){
    await botui.message.add({ type:'html', content: t('tv_step_source_hint') });
    const okAfterSrc = await askYesNo( t('ok_now_q') );
    if (okAfterSrc){
      await botui.message.add({ content: t('tv_ok') });
      markScenarioDone(4); await endMessage(4); return;
    }
  }

  // 4) Eindcheck: zie je nu beeld?
  const finalOk = await askYesNo( t('tv_q_result') );
  if (finalOk){
    await botui.message.add({ content: t('tv_ok') });
    markScenarioDone(4); await endMessage(4); return;
  }

  // 5) Escalatie ‚Üí eerst toestemming; bij JA: direct DRINGEND (zonder extra velden)
  const goUrgentTV = await askYesNo( t('confirm_urgent', USERNAME) );
  if (!goUrgentTV){
    await botui.message.add({ type:'html', content: t('fast_cancel', USERNAME) });
    markScenarioDone(4); await endMessage(4); return;
  }

  await ticketFlow(
    (LANG==='fr'
      ? `TV ‚Äì connexion laptop (salle de r√©union) ‚Äî ${USERNAME}`
      : `TV ‚Äì laptop verbinden (vergaderruimte) ‚Äî ${USERNAME}`),
    {
      forceUrgent: true,
      skipDetails: true,
      presetDesc: (LANG==='fr'
        ? 'TV sans image apr√®s essais (alimentation/HDMI/source)'
        : 'TV geen beeld na checks (aan/HDMI/bron)')
    }
  );

  markScenarioDone(4); await endMessage(4); return;
}






  // --- ANDER PROBLEEM ---
  await ticketFlow(t('other_context'));
  markScenarioDone(4);
  await endMessage(4);
}


  function countCompleted(){
    let n=0; for(let i=1;i<=4;i++){ if(localStorage.getItem('atalian_scenario_'+i)==='yes') n++; } return n;
  }
  function markScenarioDone(i){
    localStorage.setItem('atalian_scenario_'+i,'yes');
    if(countCompleted()>=4 && localStorage.getItem(PROG_KEY)!=='yes'){
      localStorage.setItem(PROG_KEY,'yes');
      bgBoost(2600);
      Confetti.start();
      setTimeout(()=>Confetti.stop(),2200);
    }
  }

	async function endMessage(currStep){
	  bgBoost();
	  await botui.message.add({ type:'html', content: `<span class="end-highlight">${t('end_msg')}</span>` });

	  const res = await botui.action.button({
		action: [
		  { text: (LANG==='fr' ? 'Voir une autre d√©mo' : 'Nog een demo zien?'), value: 'next' },
		  { text: (LANG==='fr' ? 'Recharger l‚Äô√©cran' : 'Herbeginnen'),        value: 'reload' },
		  { text: (LANG==='fr' ? 'Aller sur atalian.be' : 'Ga naar atalian.be'), value: 'site' }
		]
	  });
	  if (!res) return;

	  if (res.value === 'next') {
		const next = (currStep >= 4) ? 1 : (currStep + 1);
		const lang = LANG || 'nl';
		window.location.href = `${window.location.pathname}?step=${next}&lang=${lang}`;
		return;
	  }

	  if (res.value === 'reload') {
		const lang = localStorage.getItem('atalian_lang') || LANG || 'nl';
		const step = isNaN(currStep) ? 0 : currStep;     // wil je altijd vanaf start? zet hier 0.
		// enkel herladen, niks wissen:
		window.location.href = `${window.location.pathname}?step=${step}&lang=${lang}&_=${Date.now()}`;
		// of: window.location.reload();  // simpele reload zonder query-aanpassing
		return;
	  }

	  window.location.href = 'https://www.atalian.be';
	}



  if(qs.get('reset')==='1'){
    const lang=(localStorage.getItem('atalian_lang')||'nl');
    localStorage.clear();
    localStorage.setItem('atalian_lang',lang);
    window.location.href = window.location.pathname + `?step=0&lang=${lang}`;
  }

  const STEP_PARAM=parseInt(qs.get('step')||'0',10);
  const SCENARIOS=[intro,scenario1,scenario2,scenario3,scenario4];

  async function start(){
    document.getElementById('subtitle').textContent = I18N[LANG].subtitle || '';
    const step = isNaN(STEP_PARAM) ? 0 : Math.max(0, Math.min(4, STEP_PARAM));
    botui = new BotUI('botui-app');
    await SCENARIOS[step]();
  }

  window.addEventListener('load', ()=>{ logVisit(); start(); });

  document.getElementById('btn-nl').addEventListener('click', ()=>{ localStorage.setItem('atalian_lang','nl'); location.href=`${location.pathname}?lang=nl&step=${isNaN(STEP_PARAM)?0:STEP_PARAM}`;});
  document.getElementById('btn-fr').addEventListener('click', ()=>{ localStorage.setItem('atalian_lang','fr'); location.href=`${location.pathname}?lang=fr&step=${isNaN(STEP_PARAM)?0:STEP_PARAM}`;});

  document.addEventListener('DOMContentLoaded', ()=>{
    const logo=document.querySelector('img.logo');
    if(!logo) return;
    let pressTimer=null;

    function launchResetEffect(){
      const ov=document.createElement('div'); ov.id='reset-overlay'; document.body.appendChild(ov);
      const ripple=document.createElement('div'); ripple.className='reset-ripple'; ov.appendChild(ripple);
      const EMO=['üßπ','‚òï','üí°','üîß','üõéÔ∏è'];
      for(let i=0;i<12;i++){
        const span=document.createElement('div'); span.className='reset-emoji'; span.textContent=EMO[i%EMO.length];
        span.style.left=(20+Math.random()*60)+'vw'; span.style.animationDelay=(Math.random()*0.6)+'s';
        ov.appendChild(span);
      }
      setTimeout(()=>{ try{ document.body.removeChild(ov);}catch(_){ } },1200);
    }

    function startP(){
      if(pressTimer) return;
      pressTimer=setTimeout(()=>{
        launchResetEffect();
        try{
          const lang=(localStorage.getItem('atalian_lang')||'nl');
          Object.keys(localStorage).forEach(k=>{
            if(k.startsWith('atalian_') && k!=='atalian_lang') localStorage.removeItem(k);
          });
          sessionStorage.clear();
          const base=window.location.pathname;
          window.location.replace(`${base}?step=0&lang=${lang}&_=${Date.now()}`);
        }catch(_){}
      },900);
    }
    function cancelP(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }

    logo.addEventListener('touchstart',startP,{passive:true});
    logo.addEventListener('mousedown',startP);
    logo.addEventListener('touchend',cancelP,{passive:true});
    logo.addEventListener('mouseup',cancelP);
    logo.addEventListener('mouseleave',cancelP);
  });
</script>
</body>
</html>
