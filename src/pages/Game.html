<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATALIAN â€“ De Missie van de Assistent (Demo)</title>
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    :root{
      --atalian-orange:#EE7E00;
      --bg:#f4f6fa;
      --text:#1a202c;
    }
    html,body{height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background-color:var(--bg);overflow-y:auto}
    body{background-image:url('/building-cleaning.png');background-size:cover;background-repeat:no-repeat;background-position:center}
    *{box-sizing:border-box}
    header{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin:1rem 0}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);
      padding:.15rem .4rem;border-radius:12px}
    .subtitle{background:rgba(255,255,255,.95);padding:.35rem .8rem;border-radius:10px;border:2.5px solid var(--atalian-orange);
      color:#334155;font-size:.95rem;box-shadow:0 2px 8px rgba(238,126,0,.08)}
    .wrap{max-width:640px;margin:0 auto;padding:0 1rem 2rem}
    .botui-container{max-width:640px;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border:2px solid var(--atalian-orange);box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      border-radius:12px;padding:1rem;opacity:0;animation:fadeIn .9s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    .botui-actions-buttons-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.07);transition:transform .06s ease}
    .botui-actions-buttons-button:active{transform:scale(.98)}
    .hint{font-size:.9rem;color:#475569}
    @keyframes fadeIn{to{opacity:1}}
    .credit{margin-top:.75rem;text-align:center;color:#475569;font-size:.85rem}
    #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999}
  </style>
</head>
<body>
  <header>
    <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
    <div class="subtitle">ğŸ‰ Personeelsevent â€“ demo met AI-assistent Â· geen echte tickets</div>
  </header>

  <canvas id="confetti-canvas"></canvas>

  <div class="wrap">
    <div id="botui-app"><bot-ui></bot-ui></div>
    <div class="credit">Vragen of ideeÃ«n? Spreek ons FM-team aan ğŸ’¬</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    const botui = new BotUI('botui-app');
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    let USERNAME = localStorage.getItem('atalian_name') || '';

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function launchConfetti(){
      const end = Date.now() + 800;
      (function frame(){
        confetti({ particleCount: 80, spread: 70, origin: { y: 0.2 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    // ---------- Progress tracking (localStorage) ----------
    const PROG_KEY = 'atalian_all_done';
    function markScenarioDone(step){
      try {
        localStorage.setItem('atalian_scenario_'+step, 'done');
        checkAllScenarios();
      } catch(e) { /* ignore */ }
    }
    function countCompleted(){
      let n=0; for(let i=1;i<=4;i++){ if(localStorage.getItem('atalian_scenario_'+i)==='done') n++; }
      return n;
    }
    function checkAllScenarios(){
      try{
        const all = [1,2,3,4].every(i => localStorage.getItem('atalian_scenario_'+i)==='done');
        const fired = localStorage.getItem(PROG_KEY)==='yes';
        if(all && !fired){
          localStorage.setItem(PROG_KEY,'yes');
          launchConfetti();
          botui.message.add({ type:'html', content:'ğŸŠ <b>Fantastisch!</b> Je hebt alle 4 scenarioâ€™s ontdekt.<br>Bedankt om de volledige AIâ€‘Ultimo missie mee te doen ğŸ™' });
        }
      }catch(e){/* ignore */}
    }

    async function askNameIfNeeded(){
      if (USERNAME) return;
      await botui.message.add({ type:'html', content: 'Hallo! Ik ben je <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span>-assistent ğŸ¤–. Hoe heet jij?' });
      const name = await botui.action.text({ action:{ placeholder:'Typ je naamâ€¦' } });
      USERNAME = (name.value||'collega').trim();
      localStorage.setItem('atalian_name', USERNAME);
      await botui.message.add({ content: `Aangenaam, ${USERNAME}!` });
    }

    async function askProblem(){
      await botui.message.add({ content: 'Kun je kort beschrijven wat er aan de hand is?' });
      const { value } = await botui.action.text({ action:{ placeholder:'Schrijf hier je meldingâ€¦' } });
      return (value||'').trim();
    }

    async function askEmail(){
      await botui.message.add({ content: 'Wat is je e-mailadres? (mag ook nep zijn ğŸ˜‰)' });
      const { value } = await botui.action.text({ action: { placeholder: 'jij@voorbeeld.be' } });
      if (!emailRegex.test(value)) {
        await botui.message.add({ content: 'Hm, dat lijkt geen geldig adres. Probeer nog eens ğŸ™ˆ' });
        return askEmail();
      }
      return value;
    }

    async function ticketFlow(contextLabel){
      await botui.message.add({ content: `Is dit dringend, ${USERNAME}?` });
      const urgent = await botui.action.button({
        action: [
          { text: 'ğŸš¨ Ja, dringend', value: 'ja' },
          { text: 'â±ï¸ Nee, kan wachten', value: 'nee' },
        ]
      });
      // Eerst melding + e-mail verzamelen
      const desc = await askProblem();
      const email = await askEmail();
      // Pas daarna het "bellen"-gedrag tonen bij dringend
      if(urgent.value==='ja'){
        await botui.message.add({ type:'html', content: 'Normaal zou je nu het telefoonnummer van de servicedesk krijgen â˜ï¸.<br><b>Maar omdat ze zelf deelnemen aan dit event, laten we ze vandaag met rust ğŸ˜‡.</b>' });
      }
      const fakeId = 'TCK-' + Math.random().toString(36).slice(2, 6).toUpperCase();
      await botui.message.add({ type:'html', content: `Bedankt! Je <b>${contextLabel}</b> is verzonden naar Ultimo âœ…<br><span class="hint">(Demo, geen echte ticket) â€“ ref: ${fakeId}</span>` });
      await sleep(300);
      await botui.message.add({ type:'html', content: `<span class="hint">Samenvatting:</span><br>â€¢ Urgent: <b>${urgent.value==='ja'?'ja':'nee'}</b><br>â€¢ Beschrijving: <b>${desc||'-'}</b><br>â€¢ Contact: <b>${email}</b>` });
    }
      const fakeId = 'TCK-' + Math.random().toString(36).slice(2, 6).toUpperCase();
      await botui.message.add({ type:'html', content: `Bedankt! Je <b>${contextLabel}</b> is verzonden naar Ultimo âœ…<br><span class="hint">(Demo, geen echte ticket) â€“ ref: ${fakeId}</span>` });
      await sleep(300);
      await botui.message.add({ type:'html', content: `<span class="hint">Samenvatting:</span><br>â€¢ Urgent: <b>${urgent.value==='ja'?'ja':'nee'}</b><br>â€¢ Beschrijving: <b>${desc||'-'}</b><br>â€¢ Contact: <b>${email}</b>` });
    }

    async function intro(){
      await askNameIfNeeded();
      await botui.message.add({ type:'html', content: `Welkom, ${USERNAME}! ğŸ‰` });
      await botui.message.add({ type:'html', content: 'Dit is onze speurtocht met AI + <b>Ultimo</b> (FMIS). Scan de verschillende QR-codes in het gebouw en ontdek per scenario hoe melden werkt: schoonmaak, techniek en comfort.' });
      await botui.message.add({ content: 'Tip: elke QR werkt apart. Er worden geen echte tickets aangemaakt â€“ dit is een demo.' });
      await botui.message.add({ content: 'Veel plezier! ğŸ¤ Scan nu de volgende QR voor een scenario.' });
      const done = countCompleted();
      if(done>0) await botui.message.add({ content:`Je hebt al ${done}/4 scenarioâ€™s ontdekt.` });
    }

    async function scenarioCleaning(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Stel je vindt een ruimte die niet netjes is. Wat zou jij doen?' });
      await botui.action.button({ action:[
        { text: 'Direct melden via Ultimo ğŸ“²', value: 'ultimo' },
        { text: 'Zelf de mop pakken ğŸª£', value: 'mop' },
        { text: 'Niks doen en hopen dat het verdwijnt ğŸ™ˆ', value: 'niks' },
      ] });
      await botui.message.add({ content: `Juist! In Ultimo registreer je het meteen, zodat cleaning het kan oppakken. Geen zorgen ${USERNAME}, ik verklik niemand ğŸ˜….` });
      await ticketFlow('schoonmaak-melding');
      await endMessage();
      markScenarioDone(1);
    }

    async function scenarioCoffee(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Je komt in de refter en de koffiemachine is kapot. Wat nu?' });
      await botui.action.button({ action:[
        { text: 'Een technieker bellen ğŸ“', value: 'bel' },
        { text: 'Een ticket in Ultimo maken ğŸ› ï¸', value: 'ultimo' },
        { text: 'Gewoon thee drinken ğŸµ', value: 'thee' },
      ] });
      await botui.message.add({ content: `Precies ${USERNAME}! Via Ultimo komt dit meteen bij techniek terecht.` });
      await ticketFlow('koffiemachine-melding');
      await endMessage();
      markScenarioDone(2);
    }

    async function scenarioProgram(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Benieuwd wanneer de volgende poetsbeurt is in jouw gebouw?' });
      await botui.action.button({ action:[ { text: 'Toon poetsprogramma ğŸ§¹', value: 'toon' } ] });
      await botui.message.add({ type:'html', content: 'ğŸŒ <b>Dagelijks</b> op elke werkdag.<br>ğŸ§¹ Volgende beurt: ğŸ“… <b>ma 09-09-2025</b>.<br><span class="hint">(Voorbeeld â€“ demo)</span>' });
      const wilMelding = await botui.action.button({ action:[
        { text: 'ğŸ“© Maak hier een melding van', value: 'ja' },
        { text: 'Nee hoor, is duidelijk ğŸ‘', value: 'nee' },
      ]});
      if (wilMelding.value === 'ja') await ticketFlow('poetsprogramma-melding');
      else await botui.message.add({ content:'OkÃ©, ik onthoud het wel voor je ğŸ˜.' });
      await endMessage();
      markScenarioDone(3);
    }

    async function scenarioLamp(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Je ziet dat een lamp stuk is in de vergaderzaal. Hoe los je dit op?' });
      await botui.action.button({ action:[
        { text: 'Ultimo inschakelen ğŸ–¥ï¸', value: 'ultimo' },
        { text: 'Zelf vervangen met ladder en risico ğŸ¤•', value: 'zelf' },
        { text: 'Vergaderen in het donker ğŸ˜', value: 'donker' },
      ] });
      await botui.message.add({ content: 'Ha, vergaderen in het donker klinkt spannend, maar Ultimo is slimmer ğŸ¤“.' });
      await ticketFlow('lamp-melding');
      await endMessage();
      markScenarioDone(4);
    }

    async function endMessage(){
      await botui.message.add({ content: 'Bedankt! Dit scenario is afgerond âœ…. Scan gerust een andere QR om nog een scenario te ontdekken.' });
    }

    // --- URL opties (single run per step) ---
    const qs = new URLSearchParams(window.location.search);
    const STEP_PARAM = parseInt(qs.get('step') || '0', 10);

    const SCENARIOS = [
      intro,            // 0 = intro
      scenarioCleaning, // 1
      scenarioCoffee,   // 2
      scenarioProgram,  // 3
      scenarioLamp      // 4
    ];

    async function start(){
      const step = isNaN(STEP_PARAM) ? 0 : Math.max(0, Math.min(4, STEP_PARAM));
      await SCENARIOS[step]();
    }

    start();
  </script>
</body>
</html>
