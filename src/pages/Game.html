<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATALIAN ‚Äì De Missie van de Assistent (Demo)</title>
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    :root{
      --atalian-orange:#EE7E00;
      --bg:#f4f6fa;
      --text:#1a202c;
    }
    html,body{height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background-color:var(--bg);overflow-y:auto}
    body{background-image:url('/building-cleaning.png');background-size:cover;background-repeat:no-repeat;background-position:center}
    *{box-sizing:border-box}
    header{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin:1rem 0;position:relative}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);
      padding:.15rem .4rem;border-radius:12px}
    .subtitle{background:rgba(255,255,255,.95);padding:.35rem .8rem;border-radius:10px;border:2.5px solid var(--atalian-orange);
      color:#334155;font-size:.95rem;box-shadow:0 2px 8px rgba(238,126,0,.08)}
    .lang-toggle{position:absolute;right:12px;top:6px;display:flex;gap:6px;align-items:center}
    .lang-btn{cursor:pointer;background:#fff;border:1.5px solid var(--atalian-orange);border-radius:999px;padding:.2rem .5rem;font-weight:600}
    .wrap{max-width:640px;margin:0 auto;padding:0 1rem 2rem}
    .botui-container{max-width:640px;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border:2px solid var(--atalian-orange);box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      border-radius:12px;padding:1rem;opacity:0;animation:fadeIn .9s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    .botui-actions-buttons-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.07);transition:transform .06s ease}
    .botui-actions-buttons-button:active{transform:scale(.98)}
    .hint{font-size:.9rem;color:#475569}
    @keyframes fadeIn{to{opacity:1}}
    .credit{margin-top:.75rem;text-align:center;font-size:.85rem;
      background:rgba(255,255,255,0.92);padding:.4rem .8rem;border-radius:8px;
      border:1.5px solid var(--atalian-orange);color:#1a202c;
      display:inline-block}
    #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999}
  </style>
</head>
<body>
  <header>
    <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
    <div class="subtitle" id="subtitle">üéâ Personeelsevent ‚Äì demo met AI-assistent ¬∑ geen echte tickets</div>
    <div class="lang-toggle">
      <button class="lang-btn" id="btn-nl">NL</button>
      <button class="lang-btn" id="btn-fr">FR</button>
    </div>
  </header>

  <canvas id="confetti-canvas"></canvas>

  <div class="wrap">
    <div id="botui-app"><bot-ui></bot-ui></div>
    <div class="credit" id="foot-credit">Vragen of idee√´n? Spreek ons FM-team aan üí¨</div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    // ===== i18n teksten =====
    const I18N = {
      nl: {
        subtitle: 'üéâ Personeelsevent ‚Äì demo met AI-assistent ¬∑ geen echte tickets',
        credit: 'Vragen of idee√´n? Spreek ons FM-team aan üí¨',
        hello_name: 'Hallo! Ik ben je <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span>-assistent ü§ñ. Hoe heet jij?',
        nice_to_meet: name => `Aangenaam, ${name}!`,
        intro_welcome: name => `Welkom, ${name}! üéâ`,
        intro_line1: 'Dit is onze speurtocht met AI + <b>Ultimo</b> (FMIS). Scan de verschillende QR-codes in het gebouw en ontdek per scenario hoe melden werkt: schoonmaak, techniek en comfort.',
        intro_tip: 'Tip: elke QR werkt apart. Er worden geen echte tickets aangemaakt ‚Äì dit is een demo.',
        intro_progress: done => `Je voortgang: ${done}/4 scenario‚Äôs afgerond.`,
        intro_go: 'Veel plezier! ü§ù Scan nu de volgende QR voor een scenario.',
        ask_problem: 'Kun je kort beschrijven wat er aan de hand is?',
        ask_email: 'Wat is je e-mailadres? (mag ook nep zijn üòâ)',
        invalid_email: 'Hm, dat lijkt geen geldig adres. Probeer nog eens üôà',
        urgent_q: name => `Is dit dringend, ${name}?`,
        urgent_yes: 'üö® Ja, dringend',
        urgent_no: '‚è±Ô∏è Nee, kan wachten',
        servicedesk_note: 'Normaal zou je nu het telefoonnummer van de servicedesk krijgen ‚òéÔ∏è.<br><b>Maar omdat ze zelf deelnemen aan dit event, laten we ze vandaag met rust üòá.</b>',
        photo_label: 'Wil je een foto toevoegen van het probleem? üì∑',
        photo_btn: 'üì∑ Foto nemen / kiezen',
        photo_skip: '‚è≠Ô∏è Overslaan',
        photo_skip_msg: 'Ok√©, we gaan verder zonder foto üëç',
        photo_preview: 'Voorbeeld van je foto:',
        thanks_sent: (ctx,id) => `Bedankt! Je <b>${ctx}</b> is verzonden naar Ultimo ‚úÖ<br><span class="hint">(Demo, geen echte ticket) ‚Äì ref: ${id}</span>`,
        summary_heading: 'Samenvatting:',
        summary_urgent: u => `‚Ä¢ Urgent: <b>${u==='ja'?'ja':'nee'}</b>`,
        summary_desc: d => `‚Ä¢ Beschrijving: <b>${d||'-'}</b>`,
        summary_email: e => `‚Ä¢ Contact: <b>${e}</b>`,
        summary_photo: '‚Ä¢ Foto: <i>bijgevoegd</i>',
        end_msg: 'Bedankt! Dit scenario is afgerond ‚úÖ. Scan gerust een andere QR om nog een scenario te ontdekken.',
        confetti_msg: 'üéä <b>Fantastisch!</b> Je hebt alle 4 scenario‚Äôs ontdekt.<br>Bedankt om de volledige AI‚ÄëUltimo missie mee te doen üôè',
        scen1_q: 'Stel je vindt een ruimte die niet netjes is. Wat zou jij doen?',
        scen1_opts: ['Direct melden via Ultimo üì≤','Zelf de mop pakken ü™£','Niks doen en hopen dat het verdwijnt üôà'],
        scen1_feedback: name => `Juist! In Ultimo registreer je het meteen, zodat cleaning het kan oppakken. Geen zorgen ${name}, ik verklik niemand üòÖ.`,
        scen2_q: 'Je komt in de refter en de koffiemachine is kapot. Wat nu?',
        scen2_opts: ['Een technieker bellen üìû','Een ticket in Ultimo maken üõ†Ô∏è','Gewoon thee drinken üçµ'],
        scen2_feedback: name => `Precies ${name}! Via Ultimo komt dit meteen bij techniek terecht.`,
        scen3_q: 'Benieuwd wanneer de volgende poetsbeurt is in jouw gebouw?',
        scen3_btn: 'Toon poetsprogramma üßπ',
        scen3_info: 'üåû <b>Dagelijks</b> op elke werkdag.<br>üßπ Volgende beurt: üìÖ <b>ma 09-09-2025</b>.<br><span class="hint">(Voorbeeld ‚Äì demo)</span>',
        scen3_mk: 'üì© Maak hier een melding van',
        scen3_ok: 'Nee hoor, is duidelijk üëç',
        scen3_okreply: 'Ok√©, ik onthoud het wel voor je üòé.',
        scen4_q: 'Je ziet dat een lamp stuk is in de vergaderzaal. Hoe los je dit op?',
        scen4_opts: ['Ultimo inschakelen üñ•Ô∏è','Zelf vervangen met ladder en risico ü§ï','Vergaderen in het donker üòé'],
        scen4_feedback: 'Ha, vergaderen in het donker klinkt spannend, maar Ultimo is slimmer ü§ì.'
      },
      fr: {
        subtitle: 'üéâ √âv√©nement du personnel ‚Äì d√©mo avec assistant IA ¬∑ pas de vrais tickets',
        credit: 'Des questions ou des id√©es ? Parlez √† notre √©quipe FM üí¨',
        hello_name: 'Bonjour ! Je suis votre coll√®gue <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span> ü§ñ. Comment vous appelez‚Äëvous ?',
        nice_to_meet: name => `Ravi de vous rencontrer, ${name} !`,
        intro_welcome: name => `Bienvenue, ${name} ! üéâ`,
        intro_line1: 'Voici notre chasse aux QR avec l‚ÄôIA + <b>Ultimo</b> (FMIS). Scannez les QR-codes dans le b√¢timent et d√©couvrez, par sc√©nario, comment signaler nettoyage, technique et confort.',
        intro_tip: 'Astuce : chaque QR fonctionne s√©par√©ment. Aucun ticket r√©el n‚Äôest cr√©√© ‚Äì c‚Äôest une d√©mo.',
        intro_progress: done => `Votre progression : ${done}/4 sc√©narios termin√©s.`,
        intro_go: 'Amusez‚Äëvous ! ü§ù Scannez maintenant un autre QR pour un sc√©nario.',
        ask_problem: 'Pouvez‚Äëvous d√©crire bri√®vement le probl√®me ?',
        ask_email: 'Quelle est votre adresse e‚Äëmail ? (une fausse est ok üòâ)',
        invalid_email: 'Hmm, cela ne ressemble pas √† une adresse valide. R√©essayez üôà',
        urgent_q: name => `Est‚Äëce urgent, ${name} ?`,
        urgent_yes: 'üö® Oui, urgent',
        urgent_no: '‚è±Ô∏è Non, √ßa peut attendre',
        servicedesk_note: 'Normalement, vous verriez maintenant le num√©ro de la helpdesk ‚òéÔ∏è.<br><b>Mais comme ils participent eux‚Äëm√™mes √† l‚Äô√©v√©nement, on les laisse tranquilles aujourd‚Äôhui üòá.</b>',
        photo_label: 'Voulez‚Äëvous ajouter une photo du probl√®me ? üì∑',
        photo_btn: 'üì∑ Prendre/choisir une photo',
        photo_skip: '‚è≠Ô∏è Passer',
        photo_skip_msg: 'D‚Äôaccord, continuons sans photo üëç',
        photo_preview: 'Aper√ßu de votre photo :',
        thanks_sent: (ctx,id) => `Merci ! Votre <b>${ctx}</b> a √©t√© envoy√© √† Ultimo ‚úÖ<br><span class="hint">(D√©mo, pas de vrai ticket) ‚Äì r√©f. ${id}</span>`,
        summary_heading: 'R√©capitulatif :',
        summary_urgent: u => `‚Ä¢ Urgent : <b>${u==='ja'?'oui':'non'}</b>`,
        summary_desc: d => `‚Ä¢ Description : <b>${d||'-'}</b>`,
        summary_email: e => `‚Ä¢ Contact : <b>${e}</b>`,
        summary_photo: '‚Ä¢ Photo : <i>jointe</i>',
        end_msg: 'Merci ! Ce sc√©nario est termin√© ‚úÖ. Scannez un autre QR pour en d√©couvrir un autre.',
        confetti_msg: 'üéä <b>G√©nial !</b> Vous avez termin√© les 4 sc√©narios.<br>Merci d‚Äôavoir particip√© √† la mission IA‚ÄëUltimo üôè',
        scen1_q: 'Vous trouvez un local qui n‚Äôest pas propre. Que faites‚Äëvous ?',
        scen1_opts: ['Signaler via Ultimo üì≤','Prendre la serpilli√®re ü™£','Ne rien faire et esp√©rer que √ßa disparaisse üôà'],
        scen1_feedback: name => `Exact ! Dans Ultimo, on enregistre directement pour que le cleaning s‚Äôen occupe. Pas d‚Äôinqui√©tude ${name}, personne ne vous d√©noncera üòÖ.`,
        scen2_q: 'Vous arrivez au r√©fectoire et la machine √† caf√© est en panne. Et maintenant ?',
        scen2_opts: ['Appeler un technicien üìû','Cr√©er un ticket dans Ultimo üõ†Ô∏è','Boire du th√© üçµ'],
        scen2_feedback: name => `Parfait ${name} ! Via Ultimo, cela va directement √† la technique.`,
        scen3_q: 'Curieux de conna√Ætre le prochain programme de nettoyage dans votre b√¢timent ?',
        scen3_btn: 'Afficher le programme üßπ',
        scen3_info: 'üåû <b>Quotidien</b> les jours ouvrables.<br>üßπ Prochain passage : üìÖ <b>lun 09‚Äë09‚Äë2025</b>.<br><span class="hint">(Exemple ‚Äì d√©mo)</span>',
        scen3_mk: 'üì© Cr√©er un signalement',
        scen3_ok: 'Non merci, c‚Äôest clair üëç',
        scen3_okreply: 'Ok, je le note pour vous üòé.',
        scen4_q: 'Vous voyez une lampe cass√©e dans la salle de r√©union. Que faites‚Äëvous ?',
        scen4_opts: ['Activer Ultimo üñ•Ô∏è','Remplacer vous‚Äëm√™me avec une √©chelle ü§ï','R√©union dans le noir üòé'],
        scen4_feedback: 'R√©unir dans le noir, c‚Äôest audacieux, mais Ultimo est plus malin ü§ì.'
      }
    };

    // taalkeuze
    const qs = new URLSearchParams(window.location.search);
    let LANG = (qs.get('lang') || localStorage.getItem('atalian_lang') || 'nl').toLowerCase();
    if (!['nl','fr'].includes(LANG)) LANG='nl';
    localStorage.setItem('atalian_lang', LANG);

    function t(key, ...args){
      const txt = I18N[LANG][key];
      return typeof txt === 'function' ? txt(...args) : txt;
    }

    // Header-teksten initialiseren op basis van taal
    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('subtitle').innerHTML = t('subtitle');
      document.getElementById('foot-credit').textContent = t('credit');
      document.getElementById('btn-nl').onclick = ()=> switchLang('nl');
      document.getElementById('btn-fr').onclick = ()=> switchLang('fr');
    });

    function switchLang(lang){
      localStorage.setItem('atalian_lang', lang);
      const step = qs.get('step') || '0';
      const base = window.location.pathname;
      window.location.href = `${base}?step=${step}&lang=${lang}`;
    }
  </script>

  <script>
    // ===== Foto helpers =====
    function createHiddenFileInput(){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      input.style.display = 'none';
      document.body.appendChild(input);
      return input;
    }
    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=reject;
        fr.readAsDataURL(file);
      });
    }
    function compressDataUrl(dataUrl,maxW=1200,quality=0.8){
      return new Promise(res=>{
        const img=new Image();
        img.onload=function(){
          const scale=Math.min(1,maxW/img.width);
          const w=Math.round(img.width*scale),h=Math.round(img.height*scale);
          const canvas=document.createElement('canvas');
          canvas.width=w; canvas.height=h;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,w,h);
          res(canvas.toDataURL('image/jpeg',quality));
        };
        img.src=dataUrl;
      });
    }
    async function askPhoto(botui,label=t('photo_label'),compress=true){
      await botui.message.add({ content: label });
      const choice = await botui.action.button({ action:[
        { text: t('photo_btn'), value:'snap' },
        { text: t('photo_skip'), value:'skip' }
      ]});
      if(choice.value==='skip'){
        await botui.message.add({ content: t('photo_skip_msg') });
        return null;
      }
      const input=createHiddenFileInput();
      const p=new Promise(resolve=>{
        input.onchange=async()=>{
          const file=input.files && input.files[0];
          input.remove();
          if(!file){ resolve(null); return; }
          try{
            let dataUrl=await fileToDataUrl(file);
            if(compress) dataUrl=await compressDataUrl(dataUrl,1200,0.8);
            await botui.message.add({ type:'html', content:`<div class='hint'>${t('photo_preview')}</div><img src='${dataUrl}' alt='photo' style='max-width:100%;border-radius:10px;border:1px solid #ddd' />` });
            resolve(dataUrl);
          }catch(e){ console.error(e); resolve(null); }
        };
      });
      input.click();
      return p;
    }
  </script>

  <script>
    // ===== Kern-logica =====
    let botui; // wordt gezet in bootstrap()
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    let USERNAME = localStorage.getItem('atalian_name') || '';

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function launchConfetti(){
      const end = Date.now() + 800;
      (function frame(){
        confetti({ particleCount: 80, spread: 70, origin: { y: 0.2 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    // ---------- Progress tracking (localStorage) ----------
    const PROG_KEY = 'atalian_all_done';
    function markScenarioDone(step){
      try { localStorage.setItem('atalian_scenario_'+step, 'done'); checkAllScenarios(); } catch(e){}
    }
    function countCompleted(){ let n=0; for(let i=1;i<=4;i++){ if(localStorage.getItem('atalian_scenario_'+i)==='done') n++; } return n; }
    function checkAllScenarios(){
      try{
        const all=[1,2,3,4].every(i=>localStorage.getItem('atalian_scenario_'+i)==='done');
        const fired=localStorage.getItem(PROG_KEY)==='yes';
        if(all && !fired){
          localStorage.setItem(PROG_KEY,'yes');
          launchConfetti();
          botui && botui.message.add({ type:'html', content:t('confetti_msg') });
        }
      }catch(e){}
    }

    // ---------- UI helpers ----------
    async function askNameIfNeeded(){
      if (USERNAME) return;
      await botui.message.add({ type:'html', content: t('hello_name') });
      const name = await botui.action.text({ action:{ placeholder:'Typ je naam‚Ä¶ / Entrez votre nom‚Ä¶' } });
      USERNAME = (name.value|| (LANG==='fr'?'coll√®gue':'collega')).trim();
      localStorage.setItem('atalian_name', USERNAME);
      await botui.message.add({ content: t('nice_to_meet', USERNAME) });
    }
    async function askProblem(){
      await botui.message.add({ content: t('ask_problem') });
      const { value } = await botui.action.text({ action:{ placeholder: LANG==='fr'?'D√©crivez bri√®vement‚Ä¶':'Schrijf kort je melding‚Ä¶' } });
      return (value||'').trim();
    }
    async function askEmail(){
      await botui.message.add({ content: t('ask_email') });
      const { value } = await botui.action.text({ action: { placeholder: LANG==='fr'?'vous@exemple.be':'jij@voorbeeld.be' } });
      if (!emailRegex.test(value)) { await botui.message.add({ content: t('invalid_email') }); return askEmail(); }
      return value;
    }

    // ---------- Ticket-flow ----------
    async function ticketFlow(contextLabel){
      // 1) Dringend of niet
      await botui.message.add({ content: t('urgent_q', USERNAME) });
      const urgent = await botui.action.button({ action:[
        { text: t('urgent_yes'), value: 'ja' },
        { text: t('urgent_no'), value: 'nee' },
      ]});
      // 2) Beschrijving
      const desc = await askProblem();
      // 3) Optionele foto
      const photoDataUrl = await askPhoto(botui);
      // 4) E-mail
      const email = await askEmail();
      // 5) Dringend boodschap i.p.v. nummer
      if(urgent.value==='ja'){
        await botui.message.add({ type:'html', content: t('servicedesk_note') });
      }
      // 6) Fake submit + samenvatting
      const fakeId = 'TCK-' + Math.random().toString(36).slice(2, 6).toUpperCase();
      try{
        const key='atalian_demo_tickets';
        const arr=JSON.parse(localStorage.getItem(key)||'[]');
        arr.push({ contextLabel, urgent:urgent.value, desc, email, photo: !!photoDataUrl, ts:Date.now(), lang:LANG });
        localStorage.setItem(key, JSON.stringify(arr));
      }catch(e){}
      await botui.message.add({ type:'html', content: t('thanks_sent', contextLabel, fakeId) });
      await botui.message.add({ type:'html', content: `<span class="hint">${t('summary_heading')}</span><br>${t('summary_urgent', urgent.value)}<br>${t('summary_desc', desc)}<br>${t('summary_email', email)}${photoDataUrl?'\n<br>'+t('summary_photo'):''}` });
    }

    // ---------- Content ----------
    async function intro(){
      await askNameIfNeeded();
      await botui.message.add({ type:'html', content: t('intro_welcome', USERNAME) });
      await botui.message.add({ type:'html', content: t('intro_line1') });
      await botui.message.add({ content: t('intro_tip') });
      const done = countCompleted();
      await botui.message.add({ content: t('intro_progress', done) });
      await botui.message.add({ content: t('intro_go') });
    }

    async function scenarioCleaning(){
      await askNameIfNeeded();
      await botui.message.add({ content: t('scen1_q') });
      await botui.action.button({ action:[
        { text: I18N[LANG].scen1_opts[0], value: 'ultimo' },
        { text: I18N[LANG].scen1_opts[1], value: 'mop' },
        { text: I18N[LANG].scen1_opts[2], value: 'niks' },
      ] });
      await botui.message.add({ content: t('scen1_feedback', USERNAME) });
      await ticketFlow(LANG==='fr'?'signalement nettoyage':'schoonmaak-melding');
      await endMessage();
      markScenarioDone(1);
    }

    async function scenarioCoffee(){
      await askNameIfNeeded();
      await botui.message.add({ content: t('scen2_q') });
      await botui.action.button({ action:[
        { text: I18N[LANG].scen2_opts[0], value: 'bel' },
        { text: I18N[LANG].scen2_opts[1], value: 'ultimo' },
        { text: I18N[LANG].scen2_opts[2], value: 'thee' },
      ] });
      await botui.message.add({ content: t('scen2_feedback', USERNAME) });
      await ticketFlow(LANG==='fr'?'machine √† caf√© en panne':'koffiemachine-melding');
      await endMessage();
      markScenarioDone(2);
    }

    async function scenarioProgram(){
      await askNameIfNeeded();
      await botui.message.add({ content: t('scen3_q') });
      await botui.action.button({ action:[ { text: t('scen3_btn'), value: 'toon' } ] });
      await botui.message.add({ type:'html', content: t('scen3_info') });
      const wilMelding = await botui.action.button({ action:[
        { text: t('scen3_mk'), value: 'ja' },
        { text: t('scen3_ok'), value: 'nee' },
      ]});
      if (wilMelding.value === 'ja') await ticketFlow(LANG==='fr'?'programme de nettoyage':'poetsprogramma-melding');
      else await botui.message.add({ content: t('scen3_okreply') });
      await endMessage();
      markScenarioDone(3);
    }

    async function scenarioLamp(){
      await askNameIfNeeded();
      await botui.message.add({ content: t('scen4_q') });
      await botui.action.button({ action:[
        { text: I18N[LANG].scen4_opts[0], value: 'ultimo' },
        { text: I18N[LANG].scen4_opts[1], value: 'zelf' },
        { text: I18N[LANG].scen4_opts[2], value: 'donker' },
      ] });
      await botui.message.add({ content: t('scen4_feedback') });
      await ticketFlow(LANG==='fr'?'lampe cass√©e':'lamp-melding');
      await endMessage();
      markScenarioDone(4);
    }

    async function endMessage(){
      await botui.message.add({ content: t('end_msg') });
    }

    // --- URL opties (single run per step) + reset ---
    // Reset via URL (bv. game.html?reset=1)
    if (qs.get('reset') === '1') {
      localStorage.clear();
      // behoud taal bij reset
      localStorage.setItem('atalian_lang', LANG);
      // Terug naar start met huidige taal
      window.location.href = window.location.pathname + `?step=0&lang=${LANG}`;
    }

    const STEP_PARAM = parseInt(qs.get('step') || '0', 10);
    const SCENARIOS = [ intro, scenarioCleaning, scenarioCoffee, scenarioProgram, scenarioLamp ];

    async function start(){
      const step = isNaN(STEP_PARAM) ? 0 : Math.max(0, Math.min(4, STEP_PARAM));
      await SCENARIOS[step]();
    }

    async function bootstrap(){
      try{
        botui = new BotUI('botui-app');
        await start();
      }catch(err){
        console.error('Init error', err);
        const c = document.getElementById('botui-app');
        if(c){ c.innerHTML = '<div style="background:#fff;border:2px solid #EE7E00;border-radius:12px;padding:12px">Er ging iets mis bij het laden van de chat. Vernieuw de pagina of probeer een andere QR. üôè</div>'; }
      }
    }

    window.addEventListener('load', bootstrap);
  </script>
</body>
</html>
