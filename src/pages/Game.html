<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATALIAN ‚Äì De Missie van de Assistent (Demo)</title>
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    :root{ --atalian-orange:#EE7E00; --bg:#f4f6fa; --text:#1a202c; }
    html,body{
      height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background-color:var(--bg);overflow-y:auto}
    body{background-image:url('/building-cleaning.png');background-size:cover;background-repeat:no-repeat;background-position:center}
    *{box-sizing:border-box}
    header{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin:1rem 0;position:relative}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);
      padding:.15rem .4rem;border-radius:12px}
    .subtitle{background:rgba(255,255,255,.95);padding:.35rem .8rem;border-radius:10px;border:2.5px solid var(--atalian-orange);
      color:#334155;font-size:.95rem;box-shadow:0 2px 8px rgba(238,126,0,.08)}
    .lang-toggle{margin-top:.5rem;display:flex;gap:8px;justify-content:center}
    .lang-btn{cursor:pointer;background:#fff;border:1.5px solid var(--atalian-orange);border-radius:999px;padding:.25rem .6rem;font-weight:600;font-size:.9rem}
    .wrap{max-width:640px;margin:0 auto;padding:0 1rem 2rem}
    .botui-container{max-width:640px;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border:2px solid var(--atalian-orange);box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      border-radius:12px;padding:1rem;opacity:0;animation:fadeIn .9s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    .botui-actions-buttons-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.07);transition:transform .06s ease}
    .botui-actions-buttons-button:active{transform:scale(.98)}
    .hint{font-size:.9rem;color:#475569}
    @keyframes fadeIn{to{opacity:1}}
    .credit{margin-top:.75rem;text-align:center;font-size:.85rem;background:rgba(255,255,255,.92);
      padding:.4rem .8rem;border-radius:8px;border:1.5px solid var(--atalian-orange);color:#1a202c;display:inline-block}
    #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999}
	/* Maak de BotUI invoervelden wat breder */
	.botui-actions-text-input {
	  width: 90% !important;   /* standaard is ~60% */
	  max-width: 500px;        /* optioneel: zet een max */
	  font-size: 1rem;         /* iets leesbaarder */
	  padding: 6px 10px;       /* meer lucht */
	}
	.botui-message-content {
	  white-space: normal !important;    /* laat regels afbreken */
	  word-wrap: break-word;             /* breek lange woorden (oude syntax) */
	  overflow-wrap: anywhere;           /* moderne fallback */
	}
	/* Zorg dat alle BotUI-knoppen hun tekst links uitlijnen */
	.botui-actions-buttons button {
	  text-align: left !important;
	  justify-content: flex-start;  /* icoontjes ook netjes mee naar links */
	}
	
  </style>
</head>
<body>
<header>
  <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
  <div class="lang-toggle">
    <button class="lang-btn" id="btn-nl">üá≥üá± NL</button>
    <button class="lang-btn" id="btn-fr">üá´üá∑ FR</button>
  </div>
  <div class="subtitle" id="subtitle">üéâ Personeelsevent ‚Äì demo met AI-assistent ¬∑ geen echte tickets</div>
</header>

<canvas id="confetti-canvas"></canvas>

<div class="wrap">
  <div id="botui-app"><bot-ui></bot-ui></div>
  <div class="credit" id="foot-credit">Vragen of idee√´n? Spreek ons FM-team aan üí¨</div>
</div>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>

  /* ===== i18n ===== */
  const I18N = {
    nl: {
      subtitle: 'üéâ Employees Day ‚Äì Discover, Play & AI',
      credit: 'Vragen of idee√´n? Spreek ons FM-team aan üí¨',
      hello_name: 'Welkom op deze event üëã. Ik ben je <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span>-assistent ü§ñ. Hoe heet jij?',
      nice_to_meet: n => `Hey ${n}!`,
      intro_welcome: n => `Leuk dat je meedoet, ${n}!`,
      intro_line1: 'Dit is onze speurtocht met AI + <b>Ultimo</b> üïµÔ∏è‚Äç‚ôÄÔ∏è. <br> Scan de 4 QR-codes in de zaal.  Bij elke scan speel je klant en meld je een probleem via een ticket. üëâ Je missie is geslaagd zodra alle 4 meldingen gedaan zijn. ',
      intro_tip: '',
      intro_progress: d => `Jouw voortgang: ${d}/4 scenario‚Äôs.`,
      intro_go: 'Zoek de 4 QR‚Äôs en meld het probleem. Vandaag is het spel üéÆ, maar normaal lossen we het zo op. Veel succes en plezier! üöÄ',
      start_btn: '‚úÖ Start het spel',
      need_checkin: 'Wil je deelnemen? Scan dan de oranje QR-code üëç.',
      ask_problem: 'Kan je in het kort zeggen wat je wilt melden?',
      ask_email: 'Wat is je e-mailadres?',
      invalid_email: 'Hm, dat lijkt geen geldig adres. Probeer nog eens üò•',
      urgent_q: n => `${n}, is dit dringend of mag het op de to-do-lijst?`,
      urgent_yes: 'üö® Dringend!',
      urgent_no: '‚è±Ô∏è To-do mag',
      servicedesk_note: 'Normaal zou je nu het nummer van de servicedesk krijgen ‚òéÔ∏è, maar omdat zij meedoen aan het event laten we ze vandaag met rust üòá.',
      photo_label: 'Wil je een foto toevoegen van het probleem? üì∑',
      photo_btn: 'üì∑ Foto nemen/kiezen',
      photo_skip: '‚è≠Ô∏è Overslaan',
      photo_skip_msg: 'Ok√©, we gaan verder zonder foto üëç',
      photo_preview: 'Voorbeeld van je foto:',
	  photo_take: 'üì∑ Foto nemen',
      photo_gallery: 'üñºÔ∏è Kies uit galerij',
	  photo_none: 'Geen foto gekozen ‚Äî kies opnieuw of sla over.',
      thanks_sent: (ctx,id) => `Bedankt! Je <b>${ctx}</b> is verzonden naar Ultimo ‚úÖ<br><span class="hint">(Demo ‚Äì geen echte ticket) ‚Ä¢ ref: ${id}</span>`,
      summary_heading: 'Samenvatting:',
      summary_urgent: u => `‚Ä¢ Urgent: <b>${u==='ja'?'ja':'nee'}</b>`,
      summary_desc: d => `‚Ä¢ Beschrijving: <b>${d||'-'}</b>`,
      summary_email: e => `‚Ä¢ Contact: <b>${e}</b>`,
      summary_photo: '‚Ä¢ Foto: <i>bijgevoegd</i>',
      end_msg: 'Bedankt! Scan een andere QR en vervolg je missie.üïµÔ∏è‚Äç‚ôÇÔ∏è',
      confetti_msg: 'üèÜ Topprestatie! Je ontdekte alle 4 QR‚Äôs en maakte meldingen. Zo simpel werkt het ook in het echt! üí°',
      scen1_q: 'Stel: je vindt een ruimte die niet netjes is üò±. Wat doe je?',
      scen1_opts: ['Direct melden via Ultimo üñ•Ô∏è','Een emmer water halen ü™£','Je hebt het niet gezien üôà'],
      scen1_feedback: n => `Met de QR pakt ons schoonmaakteam het direct op. Geen stress, ${n} üòÖ, we maken samen een melding.`,
      scen2_q: 'In de refter is de koffiemachine defect üö´‚òï. Wat nu?',
      scen2_opts: ['De technieker bellen? üìû','Ik maak een QR-ticket naar Ultimo? üõ†Ô∏è','Ik neem een theetje? üçµ'],
      scen2_feedback: n => `${n}, als je voor Ultimo kiest, komt dit bij onze technische dienst terecht üß∞. Dit is wellicht de beste optie.`,
      scen3_q: 'Benieuwd naar het poetsprogramma van deze ruimte? üìÖ Dat tonen we via deze QR.',
      scen3_btn: 'Toon poetsprogramma üßπ',
      scen3_info: 'üåû <b>Dagelijks</b>. Volgende beurt: <b>za 20-09-2025</b> (demo). <br> Wil je een melding maken rond het poetsprogramma of is het duidelijk?',
      scen3_mk: 'üì© Maak melding',
      scen3_ok: 'Het is duidelijk üëç',
      scen3_okreply: 'Top, onthouden üòé.',
      scen4_q: 'Een lamp is stuk in de vergaderzaal. Wat doe je?',
      scen4_opts: ['Ultimo inschakelen üñ•Ô∏è','Zelf vervangen ü§ï','Vergaderen in het donker üòé'],
      scen4_feedback: 'Ultimo is slimmer ü§ì. Geen kopzorgen, laten we gewoon samen een melding maken.'
	  
    },
	  fr: {
	  subtitle: 'üéâ Employees Day ‚Äì Discover, Play & AI',
	  credit: 'Des questions ou des id√©es ? Parles-en √† notre √©quipe FM üí¨',
	  hello_name: 'Bienvenue √† cet √©v√©nement üëã. Je suis ton ton assistant <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span> ü§ñ. Comment tu t‚Äôappelles ?',
	  nice_to_meet: n => `Ravi de te rencontrer, ${n} !`,
	  intro_welcome: n => `Heureux que tu sois parmi nous, ${n} !`,
	  intro_line1: `Voici notre chasse aux QR avec l‚ÄôIA + <b>Ultimo</b> üïµÔ∏è‚Äç‚ôÇÔ∏è.<br> Scanne les 4 QR-codes dans la salle. √Ä chaque scan, tu joues le client et tu cr√©es un ticket pour signaler un probl√®me. üëâ Ta mission est r√©ussie quand les 4 signalements sont compl√©t√©s.`,
	  intro_tip: '',
	  intro_progress: d => `Ta progression : ${d}/4 sc√©narios.`,
	  intro_go: 'Rep√®re les 4 QR et signale le probl√®me. Aujourd‚Äôhui c‚Äôest un jeu üéÆ, mais normalement c‚Äôest comme √ßa qu‚Äôon les r√©sout. Bonne chance et amuse-toi ! üöÄ',
	  start_btn: '‚úÖ D√©marrez le jeu',
	  need_checkin: 'Pour participer, commence par scanner le code QR orange. üëç',
	  ask_problem: 'Peux-tu d√©crire bri√®vement ce que tu veux signaler ?',
	  ask_email: 'Quelle est ton adresse e-mail ?',
	  invalid_email: 'Hmm, √ßa ne ressemble pas √† une adresse valide üò•',
	  urgent_q: n => `Dis ${n}, c‚Äôest pour tout de suite ou √ßa peut attendre ?`,
	  urgent_yes: 'üö® Tout de suite !',
	  urgent_no: '‚è±Ô∏è Ca peut attendre',
	  servicedesk_note: 'Normalement tu verrais le num√©ro de la helpdesk ‚òéÔ∏è, mais aujourd‚Äôhui on les laisse tranquilles üòá.',
	  photo_label: 'Tu veux ajouter une photo du probl√®me ? üì∑',
	  photo_btn: 'üì∑ Prendre/choisir une photo',
	  photo_skip: '‚è≠Ô∏è Passer',
	  photo_skip_msg: 'D‚Äôaccord, on continue sans photo üëç',
	  photo_preview: 'Aper√ßu :',
	  photo_take: 'üì∑ Prendre une photo',
      photo_gallery: 'üñºÔ∏è Choisir dans la galerie',
	  photo_none: 'Aucune photo choisie ‚Äî r√©essaie ou passe.',
	  thanks_sent: (ctx,id) => `Merci ! Ton <b>${ctx}</b> a √©t√© envoy√© √† Ultimo ‚úÖ<br><span class="hint">(D√©mo ‚Äì ticket fictif) ‚Ä¢ r√©f: ${id}</span>`,
	  summary_heading: 'R√©capitulatif :',
	  summary_urgent: u => `‚Ä¢ Urgent : <b>${u==='ja'?'oui':'non'}</b>`,
	  summary_desc: d => `‚Ä¢ Description : <b>${d||'-'}</b>`,
	  summary_email: e => `‚Ä¢ Contact : <b>${e}</b>`,
	  summary_photo: '‚Ä¢ Photo : <i>jointe</i>',
	  end_msg: 'Merci ! Trouve un autre QR et poursuis ta mission.üïµÔ∏è‚Äç‚ôÇÔ∏è',
	  confetti_msg: 'üèÜ Mission r√©ussie ! Les 4 QR sont scann√©s, les signalements faits. En vrai, c‚Äôest si simple que √ßa! üí°',
	  scen1_q: 'Tu trouves un local pas propre üò±. Que fais-tu ?',
	  scen1_opts: ['Tu les signales vers Ultimo üñ•Ô∏è',"Tu attrapes un seau d‚Äôeau ü™£","T'as rien vu... üôà"],
	  scen1_feedback: n => `Gr√¢ce au QR, notre √©quipe de nettoyage agit direct. Pas de stress, ${n} üòÖ, on cr√©e le signalement.`,
	  scen2_q: 'La machine √† caf√© est en panne üö´‚òï. Et maintenant, que faire?',
	  scen2_opts: ['Appeler un technicien üìû','Remplir ce QR vers Ultimo üõ†Ô∏è',"Boire du th√© √† l'aise üçµ"],
	  scen2_feedback: n => `Parfait, ${n} ! Dans Ultimo, √ßa arrive directement chez notre service technique üß∞. Faisons tout de suite un signalement pour √ßa.`,
	  scen3_q: 'Curieux du programme de nettoyage de cet espace? üìÖ On te le montre via ce QR.',
	  scen3_btn: 'Afficher le programme üßπ',
	  scen3_info: 'üåû <b>Quotidien</b>. Prochain passage : <b>sam 20-09-2025</b> (d√©mo).<br> Veux-tu cr√©er un signalement concernant le programme de nettoyage ou est-ce clair ?',
	  scen3_mk: 'üì© Cr√©er un signalement',
	  scen3_ok: "C‚Äôest clair üëç",
	  scen3_okreply: 'Ok, je le note üòé.',
	  scen4_q: 'Une lampe est cass√©e en salle de r√©union. Que fais-tu ?',
	  scen4_opts: ['Activer Ultimo üñ•Ô∏è','Remplacer toi-m√™me ü§ï','R√©union dans le noir üòé'],
	  scen4_feedback: 'Ultimo est plus malin ü§ì. Ne te casse pas la t√™te, faisons un signalement ensemble.'
	}

  };

  const qs = new URLSearchParams(window.location.search);
  let LANG = (qs.get('lang') || localStorage.getItem('atalian_lang') || 'nl').toLowerCase();
  if (!['nl','fr'].includes(LANG)) LANG='nl';
  localStorage.setItem('atalian_lang', LANG);
  window.LANG = LANG;

  function t(key, ...args){ const txt = I18N[LANG][key]; return typeof txt==='function' ? txt(...args) : txt; }

  window.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('subtitle').innerHTML = t('subtitle');
    document.getElementById('foot-credit').textContent = t('credit');
    document.getElementById('btn-nl').onclick = ()=> switchLang('nl');
    document.getElementById('btn-fr').onclick = ()=> switchLang('fr');
  });

  function switchLang(lang){
    localStorage.setItem('atalian_lang', lang);
    const step = qs.get('step') || '0';
    const base = window.location.pathname;
    try{
      const payload = { event:'lang_change', visitor_id: VISITOR_ID, session_id: SESSION_ID, lang, ts: Date.now() };
      const blob = new Blob([JSON.stringify(payload)], { type:'application/json' });
      navigator.sendBeacon && navigator.sendBeacon('/api/log', blob);
    }catch(e){}
    window.location.href = `${base}?step=${step}&lang=${lang}`;
  }
</script>

<script>
  /* ===== Foto helpers ===== */
  function createHiddenFileInput(mode='any'){
	  const i = document.createElement('input');
	  i.type = 'file';
	  i.accept = 'image/*';          // laat alle fototypes toe
	  if (mode === 'camera') {       // enkel forceren als de user camera kiest
		i.setAttribute('capture', 'environment');
	  }
	  i.style.display = 'none';
	  document.body.appendChild(i);
	  return i;
}

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file); });
  }
  function compressDataUrl(dataUrl,maxW=1200,quality=0.8){
    return new Promise(res=>{ const img=new Image(); img.onload=function(){ const s=Math.min(1,maxW/img.width); const w=Math.round(img.width*s),h=Math.round(img.height*s);
      const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg',quality)); }; img.src=dataUrl; });
  }
</script>

<script>
// === Identifiers & sessions ===
function uuidv4(){
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
}
const VISITOR_KEY='atalian_visitor_id'; let VISITOR_ID=localStorage.getItem(VISITOR_KEY); if(!VISITOR_ID){ VISITOR_ID=uuidv4(); localStorage.setItem(VISITOR_KEY,VISITOR_ID); }
const SESSION_KEY='atalian_session_id'; let SESSION_ID=localStorage.getItem(SESSION_KEY);
if(!SESSION_ID){ SESSION_ID=uuidv4(); localStorage.setItem(SESSION_KEY,SESSION_ID);
  try{ const payload={event:'session_start',visitor_id:VISITOR_ID,session_id:SESSION_ID,lang:(window.LANG||'nl'),ts:Date.now()};
    const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); navigator.sendBeacon && navigator.sendBeacon('/api/log',blob);}catch(_){}
}
const CHECKED_KEY='atalian_checkedin';

async function hashEmailToUserId(email){
  const data=new TextEncoder().encode((email||'').trim().toLowerCase()); const buf=await crypto.subtle.digest('SHA-256',data);
  const b=Array.from(new Uint8Array(buf)).map(x=>String.fromCharCode(x)).join(''); return btoa(b).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

// === Centrale logger + queue ===
async function postCentral(url,data,timeoutMs=4000){
  const controller=new AbortController(); const t=setTimeout(()=>controller.abort(),timeoutMs);
  const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data),signal:controller.signal});
  clearTimeout(t); if(!res.ok) throw new Error('HTTP '+res.status); return res.json().catch(()=>({ok:true}));
}
function queuePending(item){ try{ const k='atalian_pending'; const q=JSON.parse(localStorage.getItem(k)||'[]'); q.push(item); localStorage.setItem(k,JSON.stringify(q)); }catch(e){} }
async function flushPending(){ try{ const k='atalian_pending'; const q=JSON.parse(localStorage.getItem(k)||'[]'); if(!q.length) return; const rest=[]; for(const it of q){ try{ await postCentral('/api/log',it,4000);}catch(e){rest.push(it);} } localStorage.setItem(k,JSON.stringify(rest)); }catch(e){} }
async function logEvent(eventName,payload={}){ const base={event:eventName,visitor_id:VISITOR_ID,session_id:SESSION_ID,lang:(window.LANG||'nl'),ts:Date.now(),...payload}; try{ await postCentral('/api/log',base,3500);}catch(e){ queuePending(base);} }
function logScenarioDone(step){ return logEvent('scenario_done',{step}); }
function logVisit(){ return logEvent('visit',{path:location.pathname+location.search}); }
</script>

<script>
  /* ===== Kern-logica + gate ===== */
  let botui;
  const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  let USERNAME=localStorage.getItem('atalian_name')||'';

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function launchConfetti(){ const end=Date.now()+800; (function frame(){ confetti({particleCount:80,spread:70,origin:{y:0.2}}); if(Date.now()<end) requestAnimationFrame(frame); })(); }

  // voortgang
  const PROG_KEY='atalian_all_done';
  function markScenarioDone(step){ try{ localStorage.setItem('atalian_scenario_'+step,'done'); logScenarioDone(step); checkAllScenarios(); }catch(e){} }
  function countCompleted(){ let n=0; for(let i=1;i<=4;i++){ if(localStorage.getItem('atalian_scenario_'+i)==='done') n++; } return n; }
  function checkAllScenarios(){ try{ const all=[1,2,3,4].every(i=>localStorage.getItem('atalian_scenario_'+i)==='done'); const fired=localStorage.getItem(PROG_KEY)==='yes';
    if(all && !fired){ localStorage.setItem(PROG_KEY,'yes'); launchConfetti(); botui && botui.message.add({type:'html',content:t('confetti_msg')}); } }catch(e){} }

  // gate helpers
  function isCheckedIn(){ return localStorage.getItem(CHECKED_KEY)==='yes'; }
  function enforceGateOrRedirect(step){
    if(step>0 && !isCheckedIn()){
      logEvent('blocked_without_checkin',{attempt_step:step});
      const base=window.location.pathname;
      window.location.replace(`${base}?step=0&lang=${LANG}&need_checkin=1`);
      return false;
    }
    return true;
  }
  function startNewSession(lang){
    const sid=uuidv4(); localStorage.setItem(SESSION_KEY,sid); SESSION_ID=sid;
    try{ const payload={event:'session_start',visitor_id:VISITOR_ID,session_id:sid,lang,ts:Date.now()};
      const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); navigator.sendBeacon && navigator.sendBeacon('/api/log',blob);}catch(_){}
  }

  // UI
	// kleine helpers
	const KEY_NAME  = 'atalian_name';
	const KEY_EMAIL = 'atalian_email';

	function setStored(key, value) {
	  try { localStorage.setItem(key, value); } catch(_) {}
	  try { sessionStorage.setItem(key, value); } catch(_) {}
	  document.cookie = `${key}=${encodeURIComponent(value)}; max-age=31536000; path=/; samesite=lax`;
	}

	function getStored(key) {
	  try { const v = localStorage.getItem(key); if (v) return v; } catch(_) {}
	  const m = document.cookie.split('; ').find(r => r.startsWith(key + '='));
	  if (m) return decodeURIComponent(m.split('=')[1]);
	  try { const v2 = sessionStorage.getItem(key); if (v2) return v2; } catch(_) {}
	  return '';
	}

	async function askNameIfNeeded() {
	  if (USERNAME) return;

	  // eventueel vooraf opgeslagen naam tonen
	  const pre = getStored(KEY_NAME);

	  await botui.message.add({ type: 'html', content: t('hello_name') });

	  const res = await botui.action.text({
		action: {
		  placeholder: LANG === 'fr' ? 'Entrez votre nom‚Ä¶' : 'Typ je naam‚Ä¶',
		  value: pre || ''
		}
	  });

	  USERNAME = (res && res.value ? String(res.value).trim() : '') || (LANG === 'fr' ? 'coll√®gue' : 'collega');
	  setStored(KEY_NAME, USERNAME);

	  await logEvent('name_set', { display_name: USERNAME });
	  await botui.message.add({ content: t('nice_to_meet', USERNAME) });
	  await sleep(60);
	}

	async function askProblem() {
	  await botui.message.add({ content: t('ask_problem') });

	  const { value } = await botui.action.text({
		action: { placeholder: LANG === 'fr' ? 'D√©crivez bri√®vement‚Ä¶' : 'Schrijf kort je melding‚Ä¶' }
	  });

	  await sleep(40);
	  return (value || '').trim();
	}

	async function askEmail() {
	  const pre = getStored(KEY_EMAIL);

	  await botui.message.add({ content: t('ask_email') });

	  let { value } = await botui.action.text({
		action: { placeholder: LANG === 'fr' ? 'vous@exemple.be' : 'jij@voorbeeld.be', value: pre || '' }
	  });

	  // <<< hier injecteren we de attributen >>>
	  setTimeout(() => {
		const inputs = document.querySelectorAll('.botui-actions-text-input');
		const inp = inputs[inputs.length - 1]; // pak het laatste inputveld
		if (inp) {
		  inp.setAttribute('type', 'email');
		  inp.setAttribute('autocomplete', 'email');
		  inp.setAttribute('inputmode', 'email');
		  inp.setAttribute('autocapitalize', 'off');
		  inp.setAttribute('spellcheck', 'false');
		}
	  }, 0);
	  // <<< einde injectie >>>

	  let email = (value || '').trim();

	  while (!emailRegex.test(email)) {
		await botui.message.add({ content: t('invalid_email') });
		const ans = await botui.action.text({
		  action: { placeholder: LANG === 'fr' ? 'vous@exemple.be' : 'jij@voorbeeld.be', value: email }
		});

		// ook hier opnieuw attributen zetten (voor het nieuwe veld)
		setTimeout(() => {
		  const inputs = document.querySelectorAll('.botui-actions-text-input');
		  const inp = inputs[inputs.length - 1];
		  if (inp) {
			inp.setAttribute('type', 'email');
			inp.setAttribute('autocomplete', 'email');
			inp.setAttribute('inputmode', 'email');
			inp.setAttribute('autocapitalize', 'off');
			inp.setAttribute('spellcheck', 'false');
		  }
		}, 0);

		email = (ans && ans.value ? String(ans.value).trim() : '');
	  }

	  setStored(KEY_EMAIL, email);
	  await sleep(60);
	  return email;
	}


  
async function askPhoto(botuiInstance, label = t('photo_label'), compress = true){
  while (true) {
    // Vraag + knoppen (i18n)
    await botuiInstance.message.add({ content: label });
    const choice = await botuiInstance.action.button({
      action: [
        { text: t('photo_take'), value: 'camera' },
        { text: t('photo_gallery'), value: 'gallery' },
        { text: t('photo_skip'), value: 'skip' }
      ]
    });

    if (!choice || choice.value === 'skip') {
      await botuiInstance.message.add({ content: t('photo_skip_msg') });
      await sleep(80);
      return null;
    }

    const input = createHiddenFileInput(choice.value === 'camera' ? 'camera' : 'any');

    const result = await new Promise((resolve) => {
      let resolved = false;

      const cleanup = () => {
        window.removeEventListener('focus', onFocus, true);
        document.removeEventListener('visibilitychange', onVis, true);
        if (input && input.parentNode) input.parentNode.removeChild(input);
        clearTimeout(timer);
      };
      const safeResolve = (val) => { if (!resolved) { resolved = true; cleanup(); resolve(val); } };

      // Normale pad: bestand gekozen
      input.onchange = async () => {
        const file = input.files && input.files[0];
        if (!file) { safeResolve(null); return; }
        try {
          let dataUrl = await fileToDataUrl(file);
          try { if (compress) dataUrl = await compressDataUrl(dataUrl, 1200, 0.8); } catch (_) {}
          await botuiInstance.message.add({
            type: 'html',
            content: `<div class='hint'>${t('photo_preview')}</div>
                      <img src='${dataUrl}' alt='photo'
                           style='max-width:100%;border-radius:10px;border:1px solid #ddd'/>`
          });
          safeResolve(dataUrl);
        } catch (e) {
          console.error(e); safeResolve(null);
        }
      };

      // Annuleren/terugkeren ‚Üí resolve(null) zodat lus herstart
      const onFocus = () => {
        setTimeout(() => {
          if (resolved) return;
          const hasFile = input.files && input.files.length > 0;
          if (!hasFile) safeResolve(null);
        }, 300);
      };
      const onVis = () => { if (document.visibilityState === 'visible') onFocus(); };

      window.addEventListener('focus', onFocus, true);
      document.addEventListener('visibilitychange', onVis, true);

      // Safety net
      const timer = setTimeout(() => { safeResolve(null); }, 120000);

      // start native picker
      input.click();
    });

    await sleep(80);

    if (result) return result; // foto gekozen ‚Üí klaar

    // geen foto gekozen ‚Üí opnieuw opties tonen
    await botuiInstance.message.add({ content: t('photo_none') });
  }
}





  // Ticket-flow
  async function ticketFlow(contextLabel){
    try{
      await botui.message.add({content:t('urgent_q',USERNAME)});
      const urgentChoice=await botui.action.button({action:[{text:t('urgent_yes'),value:'ja'},{text:t('urgent_no'),value:'nee'}]});
      const urgentVal=(urgentChoice && urgentChoice.value) ? urgentChoice.value : 'nee'; await sleep(60);

      const desc=await askProblem();
      const photoDataUrl=await askPhoto(botui);
      const email=await askEmail();

      if(urgentVal==='ja'){ await botui.message.add({type:'html',content:t('servicedesk_note')}); await sleep(40); }

      const fakeId='TCK-'+Math.random().toString(36).slice(2,6).toUpperCase();
      try{ const key='atalian_demo_tickets'; const arr=JSON.parse(localStorage.getItem(key)||'[]');
        arr.push({contextLabel,urgent:urgentVal,desc,email,photo:!!photoDataUrl,lang:LANG,ts:Date.now()});
        localStorage.setItem(key,JSON.stringify(arr)); }catch(_){}
      const user_id=email ? await hashEmailToUserId(email) : null;

      await logEvent('ticket_submitted',{contextLabel,urgent:urgentVal,photo:!!photoDataUrl,desc_len:(desc||'').length,email_present:!!email,user_id});

      await botui.message.add({type:'html',content:t('thanks_sent',contextLabel,fakeId)});
      await botui.message.add({type:'html',content:`<span class="hint">${t('summary_heading')}</span><br>${t('summary_urgent',urgentVal)}<br>${t('summary_desc',desc)}<br>${t('summary_email',email)}${photoDataUrl?'<br>'+t('summary_photo'):''}`});
      await sleep(50);
    }catch(err){
      console.error('ticketFlow error',err);
      await botui.message.add({type:'html',content: LANG==='fr' ? "Oups, une erreur s‚Äôest produite. R√©essayez ou faites un reset (appui long sur le logo). üôè" : "Oei, er ging iets mis. Probeer nog eens, of reset (lang drukken op het logo). üôè"});
      throw err;
    }
  }
  



  // Scenario‚Äôs
	async function intro() {
	  // melding als iemand via QR hierheen werd teruggestuurd
	  const need = t('need_checkin');
	  if (qs.get('need_checkin') === '1' && need && need.trim()) {
		await botui.message.add({ type: 'html', content: need });
	  }

	  await askNameIfNeeded();

	  const welcome = t('intro_welcome', USERNAME);
	  if (welcome && welcome.trim()) {
		await botui.message.add({ type: 'html', content: welcome });
	  }

	  const line1 = t('intro_line1');
	  if (line1 && line1.trim()) {
		await botui.message.add({ type: 'html', content: line1 });
	  }

	  const tip = t('intro_tip');
	  if (tip && tip.trim()) {
		await botui.message.add({ type: 'html', content: tip });
	  }

	  // Incheck-knop (zet gate open)
	  const start = await botui.action.button({
		action: [{ text: t('start_btn'), value: 'start' }]
	  });

	  if (start && start.value === 'start') {
		localStorage.setItem(CHECKED_KEY, 'yes');
		await logEvent('checkin', { display_name: USERNAME });

		const go = t('intro_go');
		if (go && go.trim()) {
		  await botui.message.add({ type: 'html', content: go });
		}

		// ga automatisch naar eerder geprobeerde step (optioneel, maar handig)
		const next = localStorage.getItem('atalian_attempt_step');
		if (next) {
		  window.location.replace(`${window.location.pathname}?step=${encodeURIComponent(next)}&lang=${LANG}`);
		  return;
		}
	  }
	}


	async function showCheckinGate(step){
	  // log: iemand probeerde scenario zonder incheck
	  try { await logEvent('blocked_without_checkin', { attempt_step: step }); } catch(_) {}

	  // Alleen tonen, niet navigeren
	  await botui.message.add({
		type: 'html',
		content: t('need_checkin') + ''
	  });
	  // Niets returnen, geen redirect. We blijven op de huidige pagina.
	}


  async function scenarioCleaning(){ await askNameIfNeeded(); await botui.message.add({content:t('scen1_q')});
    await botui.action.button({action:[{text:I18N[LANG].scen1_opts[0],value:'ultimo'},{text:I18N[LANG].scen1_opts[1],value:'mop'},{text:I18N[LANG].scen1_opts[2],value:'niks'}]});
    await botui.message.add({content:t('scen1_feedback',USERNAME)});
    try{ await ticketFlow(LANG==='fr'?'signalement nettoyage':'schoonmaak-melding'); markScenarioDone(1); await endMessage(); }catch(_){}
  }
  async function scenarioCoffee(){ await askNameIfNeeded(); await botui.message.add({content:t('scen2_q')});
    await botui.action.button({action:[{text:I18N[LANG].scen2_opts[0],value:'bel'},{text:I18N[LANG].scen2_opts[1],value:'ultimo'},{text:I18N[LANG].scen2_opts[2],value:'thee'}]});
    await botui.message.add({content:t('scen2_feedback',USERNAME)});
    try{ await ticketFlow(LANG==='fr'?'machine √† caf√© en panne':'koffiemachine-melding'); markScenarioDone(2); await endMessage();}catch(_){}
  }
  async function scenarioProgram(){ await askNameIfNeeded(); await botui.message.add({content:t('scen3_q')});
    await botui.action.button({action:[{text:t('scen3_btn'),value:'toon'}]});
    await botui.message.add({type:'html',content:t('scen3_info')});
    const wil=await botui.action.button({action:[{text:t('scen3_mk'),value:'ja'},{text:t('scen3_ok'),value:'nee'}]});
    if(wil && wil.value==='ja'){ try{ await ticketFlow(LANG==='fr'?'programme de nettoyage':'poetsprogramma-melding'); markScenarioDone(3); await endMessage(); }catch(_){}} else { await botui.message.add({content:t('scen3_okreply')}); await endMessage(); markScenarioDone(3); }
  }
  async function scenarioLamp(){ await askNameIfNeeded(); await botui.message.add({content:t('scen4_q')});
    await botui.action.button({action:[{text:I18N[LANG].scen4_opts[0],value:'ultimo'},{text:I18N[LANG].scen4_opts[1],value:'zelf'},{text:I18N[LANG].scen4_opts[2],value:'donker'}]});
    await botui.message.add({content:t('scen4_feedback')});
    try{ await ticketFlow(LANG==='fr'?'lampe cass√©e':'lamp-melding'); markScenarioDone(4); await endMessage(); }catch(_){}
  }
	async function endMessage(){
	  // Toon geen eindboodschap als alle scenario‚Äôs reeds afgerond zijn
	  if (localStorage.getItem(PROG_KEY) === 'yes') return;
	  await botui.message.add({ content: t('end_msg') });
	}


  // URL reset (bv. ?reset=1)
  if(qs.get('reset')==='1'){
    const lang=(localStorage.getItem('atalian_lang')||'nl');
    localStorage.clear();
    localStorage.setItem('atalian_lang',lang);
    startNewSession(lang);
    window.location.href = window.location.pathname + `?step=0&lang=${lang}`;
  }

  const STEP_PARAM=parseInt(qs.get('step')||'0',10);
  const SCENARIOS=[intro,scenarioCleaning,scenarioCoffee,scenarioProgram,scenarioLamp];

	async function start(){
	  const step = isNaN(STEP_PARAM) ? 0 : Math.max(0, Math.min(4, STEP_PARAM));

	  // Gate: als nog niet ingecheckt en men landt op step>0 ‚Üí enkel melding tonen
	  if (step > 0 && localStorage.getItem('atalian_checkedin') !== 'yes') {
		await showCheckinGate(step);
		return; // Stop: niet verder naar het scenario
	  }

	  // Normale flow
	  await SCENARIOS[step]();
	}



  window.addEventListener('online',flushPending);
  window.addEventListener('load', ()=>{ logVisit(); flushPending(); (botui=new BotUI('botui-app')) && start(); });

  // Long-press reset op logo
  window.addEventListener('DOMContentLoaded', ()=>{
    const logo=document.querySelector('img.logo'); if(!logo) return;
    let pressTimer=null;
    function startP(){ cancelP(); pressTimer=setTimeout(()=>{ const lang=(localStorage.getItem('atalian_lang')||'nl');
      ['atalian_scenario_1','atalian_scenario_2','atalian_scenario_3','atalian_scenario_4','atalian_all_done','atalian_name','atalian_demo_tickets',CHECKED_KEY].forEach(k=>localStorage.removeItem(k));
      localStorage.setItem('atalian_lang',lang); startNewSession(lang);
      const base=window.location.pathname; window.location.replace(`${base}?step=0&lang=${lang}&_=${Date.now()}`); },900); }
    function cancelP(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }
    logo.addEventListener('touchstart',startP,{passive:true}); logo.addEventListener('mousedown',startP);
    logo.addEventListener('touchend',cancelP,{passive:true}); logo.addEventListener('mouseup',cancelP); logo.addEventListener('mouseleave',cancelP);
  });
</script>
</body>
</html>
