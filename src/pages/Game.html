<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATALIAN â€“ De Missie van de Assistent (Demo)</title>
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    :root{ --atalian-orange:#EE7E00; --bg:#f4f6fa; --text:#1a202c; }
    html,body{
      height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background-color:var(--bg);overflow-y:auto}
    body{background-image:url('/building-cleaning.png');background-size:cover;background-repeat:no-repeat;background-position:center}
    *{box-sizing:border-box}
    header{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin:1rem 0;position:relative}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);
      padding:.15rem .4rem;border-radius:12px}
    .subtitle{background:rgba(255,255,255,.95);padding:.35rem .8rem;border-radius:10px;border:2.5px solid var(--atalian-orange);
      color:#334155;font-size:.95rem;box-shadow:0 2px 8px rgba(238,126,0,.08)}
    .lang-toggle{margin-top:.5rem;display:flex;gap:8px;justify-content:center}
    .lang-btn{cursor:pointer;background:#fff;border:1.5px solid var(--atalian-orange);border-radius:999px;padding:.25rem .6rem;font-weight:600;font-size:.9rem}
    .wrap{max-width:640px;margin:0 auto;padding:0 1rem 2rem}
    .botui-container{max-width:640px;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border:2px solid var(--atalian-orange);box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      border-radius:12px;padding:1rem;opacity:0;animation:fadeIn .9s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    .botui-actions-buttons-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.07);transition:transform .06s ease}
    .botui-actions-buttons-button:active{transform:scale(.98)}
    .hint{font-size:.9rem;color:#475569}
    @keyframes fadeIn{to{opacity:1}}
    .credit{margin-top:.75rem;text-align:center;font-size:.85rem;background:rgba(255,255,255,.92);
      padding:.4rem .8rem;border-radius:8px;border:1.5px solid var(--atalian-orange);color:#1a202c;display:inline-block}
    #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999}
  </style>
</head>
<body>
<header>
  <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
  <div class="lang-toggle">
    <button class="lang-btn" id="btn-nl">ğŸ‡³ğŸ‡± NL</button>
    <button class="lang-btn" id="btn-fr">ğŸ‡«ğŸ‡· FR</button>
  </div>
  <div class="subtitle" id="subtitle">ğŸ‰ Personeelsevent â€“ demo met AI-assistent Â· geen echte tickets</div>
</header>

<canvas id="confetti-canvas"></canvas>

<div class="wrap">
  <div id="botui-app"><bot-ui></bot-ui></div>
  <div class="credit" id="foot-credit">Vragen of ideeÃ«n? Spreek ons FM-team aan ğŸ’¬</div>
</div>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
  /* ===== i18n ===== */
  const I18N = {
    nl: {
      subtitle: 'ğŸ‰ Personeelsevent â€“ demo met AI-assistent Â· geen echte tickets',
      credit: 'Vragen of ideeÃ«n? Spreek ons FM-team aan ğŸ’¬',
      hello_name: 'Welkom bij het onthaalloket ğŸ‘‹. Ik ben je <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span>-assistent ğŸ¤–. Hoe heet jij?',
      nice_to_meet: n => `Aangenaam, ${n}!`,
      intro_welcome: n => `Leuk dat je meedoet, ${n}!`,
      intro_line1: 'Dit is onze speurtocht met AI + <b>Ultimo</b> ğŸ•µï¸â€â™€ï¸. <br> Scan de 4 QR-codes in de zaal (schoonmaak, techniek, comfort).  Bij elke scan speel je klant en meld je een probleem via een ticket. ğŸ‘‰ Je missie is geslaagd zodra alle 4 meldingen gedaan zijn. ',
      intro_tip: 'âš ï¸ Eerst inchecken hier bij het onthaal. Daarna pas werkt elke andere QR.',
      intro_progress: d => `Jouw voortgang: ${d}/4 scenarioâ€™s.`,
      intro_go: 'Zoek de 4 QRâ€™s en meld een probleem. Vandaag is het spel, maar normaal lossen we het zo op. Veel succes en plezier! ğŸš€',
      start_btn: 'âœ… Inchecken + Start spel',
      need_checkin: 'Ga eerst naar het onthaal om deel te nemen ğŸ™',
      ask_problem: 'Kun je kort beschrijven wat er aan de hand is?',
      ask_email: 'Wat is je e-mailadres? (mag ook nep zijn ğŸ˜‰)',
      invalid_email: 'Hm, dat lijkt geen geldig adres. Probeer nog eens ğŸ™ˆ',
      urgent_q: n => `Is dit dringend, ${n}?`,
      urgent_yes: 'ğŸš¨ Ja, dringend',
      urgent_no: 'â±ï¸ Nee, kan wachten',
      servicedesk_note: 'Normaal zou je nu het nummer van de servicedesk krijgen â˜ï¸, maar omdat zij meedoen aan het event laten we ze vandaag met rust ğŸ˜‡.',
      photo_label: 'Wil je een foto toevoegen van het probleem? ğŸ“·',
      photo_btn: 'ğŸ“· Foto nemen/kiezen',
      photo_skip: 'â­ï¸ Overslaan',
      photo_skip_msg: 'OkÃ©, we gaan verder zonder foto ğŸ‘',
      photo_preview: 'Voorbeeld van je foto:',
      thanks_sent: (ctx,id) => `Bedankt! Je <b>${ctx}</b> is verzonden naar Ultimo âœ…<br><span class="hint">(Demo â€“ geen echte ticket) â€¢ ref: ${id}</span>`,
      summary_heading: 'Samenvatting:',
      summary_urgent: u => `â€¢ Urgent: <b>${u==='ja'?'ja':'nee'}</b>`,
      summary_desc: d => `â€¢ Beschrijving: <b>${d||'-'}</b>`,
      summary_email: e => `â€¢ Contact: <b>${e}</b>`,
      summary_photo: 'â€¢ Foto: <i>bijgevoegd</i>',
      end_msg: 'Bedankt! Dit scenario is afgerond âœ…. Scan nu een andere QR om verder te spelen.',
      confetti_msg: 'ğŸŠ <b>Fantastisch!</b> Je hebt alle 4 scenarioâ€™s gedaan. Merci om mee te spelen ğŸ™',
      scen1_q: 'Stel: je vindt een ruimte die niet netjes is. Wat doe je?',
      scen1_opts: ['Direct melden via Ultimo ğŸ“²','Zelf de mop pakken ğŸª£','Niks doen ğŸ™ˆ'],
      scen1_feedback: n => `Juist! Via Ultimo kan cleaning het meteen oppakken. Geen stress, ${n} ğŸ˜….`,
      scen2_q: 'In de refter is de koffiemachine stuk. Wat nu?',
      scen2_opts: ['Technieker bellen ğŸ“','Ticket in Ultimo ğŸ› ï¸','Dan maar thee ğŸµ'],
      scen2_feedback: n => `Exact, ${n}! In Ultimo komt dit bij techniek terecht.`,
      scen3_q: 'Benieuwd naar het poetsprogramma?',
      scen3_btn: 'Toon poetsprogramma ğŸ§¹',
      scen3_info: 'ğŸŒ <b>Dagelijks</b> op werkdagen. Volgende beurt: <b>ma 09-09-2025</b> (demo).',
      scen3_mk: 'ğŸ“© Maak melding',
      scen3_ok: 'Nee, is duidelijk ğŸ‘',
      scen3_okreply: 'Top, onthouden ğŸ˜.',
      scen4_q: 'Een lamp is stuk in de vergaderzaal. Wat doe je?',
      scen4_opts: ['Ultimo inschakelen ğŸ–¥ï¸','Zelf vervangen (risico) ğŸ¤•','Vergaderen in het donker ğŸ˜'],
      scen4_feedback: 'Ultimo is slimmer dan in het donker vergaderen ğŸ¤“.'
    },
    fr: {
      subtitle: 'ğŸ‰ Ã‰vÃ©nement du personnel â€“ dÃ©mo avec assistant IA Â· pas de vrais tickets',
      credit: 'Des questions ou des idÃ©es ? Parlez Ã  notre Ã©quipe FM ğŸ’¬',
      hello_name: 'Bienvenue au point dâ€™accueil ğŸ‘‹. Je suis votre collÃ¨gue <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span> ğŸ¤–. Comment vous appelez-vous ?',
      nice_to_meet: n => `Ravi de vous rencontrer, ${n} !`,
      intro_welcome: n => `Heureux de vous compter parmi nous, ${n} !`,
      intro_line1: `Voici notre chasse aux QR avec lâ€™IA + <b>Ultimo</b> ğŸ•µï¸â€â™‚ï¸. <br> Scannez les 4 QR-codes dans la salle (nettoyage, technique, confort). Ã€ chaque scan, vous jouez le client et crÃ©ez un ticket pour signaler un problÃ¨me. ğŸ‘‰ Votre mission est rÃ©ussie lorsque les 4 signalements sont complÃ©tÃ©s. `,
      intro_tip: 'âš ï¸ Enregistrez-vous dâ€™abord ici Ã  lâ€™accueil. Ensuite seulement les autres QR fonctionnent.',
      intro_progress: d => `Votre progression : ${d}/4 scÃ©narios.`,
      intro_go: 'RepÃ©rez les 4 QR et signalez un problÃ¨me. Aujourdâ€™hui câ€™est un jeu, mais normalement on le rÃ©sout comme Ã§a. Bonne chance et amusez-vous ! ğŸš€',
      start_btn: 'âœ… Sâ€™enregistrer + DÃ©marrer',
      need_checkin: 'Veuillez dâ€™abord vous rendre Ã  lâ€™accueil pour participer ğŸ™',
      ask_problem: 'Pouvez-vous dÃ©crire briÃ¨vement le problÃ¨me ?',
      ask_email: 'Quelle est votre adresse e-mail ? (factice ok ğŸ˜‰)',
      invalid_email: 'Hmm, cela ne ressemble pas Ã  un e-mail valide ğŸ™ˆ',
      urgent_q: n => `Est-ce urgent, ${n} ?`,
      urgent_yes: 'ğŸš¨ Oui, urgent',
      urgent_no: 'â±ï¸ Non',
      servicedesk_note: 'Normalement vous verriez le numÃ©ro de la helpdesk â˜ï¸, mais aujourdâ€™hui on les laisse tranquilles ğŸ˜‡.',
      photo_label: 'Ajouter une photo du problÃ¨me ? ğŸ“·',
      photo_btn: 'ğŸ“· Prendre/choisir une photo',
      photo_skip: 'â­ï¸ Passer',
      photo_skip_msg: 'Dâ€™accord, continuons sans photo ğŸ‘',
      photo_preview: 'AperÃ§u :',
      thanks_sent: (ctx,id) => `Merci ! Votre <b>${ctx}</b> a Ã©tÃ© envoyÃ© Ã  Ultimo âœ…<br><span class="hint">(DÃ©mo â€“ pas de vrai ticket) â€¢ rÃ©f: ${id}</span>`,
      summary_heading: 'RÃ©capitulatif :',
      summary_urgent: u => `â€¢ Urgent : <b>${u==='ja'?'oui':'non'}</b>`,
      summary_desc: d => `â€¢ Description : <b>${d||'-'}</b>`,
      summary_email: e => `â€¢ Contact : <b>${e}</b>`,
      summary_photo: 'â€¢ Photo : <i>jointe</i>',
      end_msg: 'Merci ! Scannez un autre QR pour continuer.',
      confetti_msg: 'ğŸŠ <b>GÃ©nial !</b> Vous avez fini les 4 scÃ©narios. Merci ğŸ™',
      scen1_q: 'Vous trouvez un local pas propre. Que faites-vous ?',
      scen1_opts: ['Signaler via Ultimo ğŸ“²','Prendre la serpilliÃ¨re ğŸª£','Rien faire ğŸ™ˆ'],
      scen1_feedback: n => `Exact ! Via Ultimo, le cleaning peut sâ€™en occuper, ${n} ğŸ˜….`,
      scen2_q: 'La machine Ã  cafÃ© est en panne. Et maintenant ?',
      scen2_opts: ['Appeler un technicien ğŸ“','Ticket dans Ultimo ğŸ› ï¸','Boire du thÃ© ğŸµ'],
      scen2_feedback: n => `Parfait, ${n} !`,
      scen3_q: 'Curieux du programme de nettoyage ?',
      scen3_btn: 'Afficher le programme ğŸ§¹',
      scen3_info: 'ğŸŒ <b>Quotidien</b> les jours ouvrables. Prochain passage : <b>lun 09-09-2025</b> (dÃ©mo).',
      scen3_mk: 'ğŸ“© CrÃ©er un signalement',
      scen3_ok: 'Non merci ğŸ‘',
      scen3_okreply: 'Ok, je le note ğŸ˜.',
      scen4_q: 'Une lampe est cassÃ©e en salle de rÃ©union. Que faire ?',
      scen4_opts: ['Activer Ultimo ğŸ–¥ï¸','Remplacer soi-mÃªme ğŸ¤•','RÃ©union dans le noir ğŸ˜'],
      scen4_feedback: 'Ultimo est plus malin ğŸ¤“.'
    }
  };

  const qs = new URLSearchParams(window.location.search);
  let LANG = (qs.get('lang') || localStorage.getItem('atalian_lang') || 'nl').toLowerCase();
  if (!['nl','fr'].includes(LANG)) LANG='nl';
  localStorage.setItem('atalian_lang', LANG);
  window.LANG = LANG;

  function t(key, ...args){ const txt = I18N[LANG][key]; return typeof txt==='function' ? txt(...args) : txt; }

  window.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('subtitle').innerHTML = t('subtitle');
    document.getElementById('foot-credit').textContent = t('credit');
    document.getElementById('btn-nl').onclick = ()=> switchLang('nl');
    document.getElementById('btn-fr').onclick = ()=> switchLang('fr');
  });

  function switchLang(lang){
    localStorage.setItem('atalian_lang', lang);
    const step = qs.get('step') || '0';
    const base = window.location.pathname;
    try{
      const payload = { event:'lang_change', visitor_id: VISITOR_ID, session_id: SESSION_ID, lang, ts: Date.now() };
      const blob = new Blob([JSON.stringify(payload)], { type:'application/json' });
      navigator.sendBeacon && navigator.sendBeacon('/api/log', blob);
    }catch(e){}
    window.location.href = `${base}?step=${step}&lang=${lang}`;
  }
</script>

<script>
  /* ===== Foto helpers ===== */
  function createHiddenFileInput(mode='any'){
	  const i = document.createElement('input');
	  i.type = 'file';
	  i.accept = 'image/*';          // laat alle fototypes toe
	  if (mode === 'camera') {       // enkel forceren als de user camera kiest
		i.setAttribute('capture', 'environment');
	  }
	  i.style.display = 'none';
	  document.body.appendChild(i);
	  return i;
}

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file); });
  }
  function compressDataUrl(dataUrl,maxW=1200,quality=0.8){
    return new Promise(res=>{ const img=new Image(); img.onload=function(){ const s=Math.min(1,maxW/img.width); const w=Math.round(img.width*s),h=Math.round(img.height*s);
      const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg',quality)); }; img.src=dataUrl; });
  }
</script>

<script>
// === Identifiers & sessions ===
function uuidv4(){
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
}
const VISITOR_KEY='atalian_visitor_id'; let VISITOR_ID=localStorage.getItem(VISITOR_KEY); if(!VISITOR_ID){ VISITOR_ID=uuidv4(); localStorage.setItem(VISITOR_KEY,VISITOR_ID); }
const SESSION_KEY='atalian_session_id'; let SESSION_ID=localStorage.getItem(SESSION_KEY);
if(!SESSION_ID){ SESSION_ID=uuidv4(); localStorage.setItem(SESSION_KEY,SESSION_ID);
  try{ const payload={event:'session_start',visitor_id:VISITOR_ID,session_id:SESSION_ID,lang:(window.LANG||'nl'),ts:Date.now()};
    const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); navigator.sendBeacon && navigator.sendBeacon('/api/log',blob);}catch(_){}
}
const CHECKED_KEY='atalian_checkedin';

async function hashEmailToUserId(email){
  const data=new TextEncoder().encode((email||'').trim().toLowerCase()); const buf=await crypto.subtle.digest('SHA-256',data);
  const b=Array.from(new Uint8Array(buf)).map(x=>String.fromCharCode(x)).join(''); return btoa(b).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

// === Centrale logger + queue ===
async function postCentral(url,data,timeoutMs=4000){
  const controller=new AbortController(); const t=setTimeout(()=>controller.abort(),timeoutMs);
  const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data),signal:controller.signal});
  clearTimeout(t); if(!res.ok) throw new Error('HTTP '+res.status); return res.json().catch(()=>({ok:true}));
}
function queuePending(item){ try{ const k='atalian_pending'; const q=JSON.parse(localStorage.getItem(k)||'[]'); q.push(item); localStorage.setItem(k,JSON.stringify(q)); }catch(e){} }
async function flushPending(){ try{ const k='atalian_pending'; const q=JSON.parse(localStorage.getItem(k)||'[]'); if(!q.length) return; const rest=[]; for(const it of q){ try{ await postCentral('/api/log',it,4000);}catch(e){rest.push(it);} } localStorage.setItem(k,JSON.stringify(rest)); }catch(e){} }
async function logEvent(eventName,payload={}){ const base={event:eventName,visitor_id:VISITOR_ID,session_id:SESSION_ID,lang:(window.LANG||'nl'),ts:Date.now(),...payload}; try{ await postCentral('/api/log',base,3500);}catch(e){ queuePending(base);} }
function logScenarioDone(step){ return logEvent('scenario_done',{step}); }
function logVisit(){ return logEvent('visit',{path:location.pathname+location.search}); }
</script>

<script>
  /* ===== Kern-logica + gate ===== */
  let botui;
  const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  let USERNAME=localStorage.getItem('atalian_name')||'';

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function launchConfetti(){ const end=Date.now()+800; (function frame(){ confetti({particleCount:80,spread:70,origin:{y:0.2}}); if(Date.now()<end) requestAnimationFrame(frame); })(); }

  // voortgang
  const PROG_KEY='atalian_all_done';
  function markScenarioDone(step){ try{ localStorage.setItem('atalian_scenario_'+step,'done'); logScenarioDone(step); checkAllScenarios(); }catch(e){} }
  function countCompleted(){ let n=0; for(let i=1;i<=4;i++){ if(localStorage.getItem('atalian_scenario_'+i)==='done') n++; } return n; }
  function checkAllScenarios(){ try{ const all=[1,2,3,4].every(i=>localStorage.getItem('atalian_scenario_'+i)==='done'); const fired=localStorage.getItem(PROG_KEY)==='yes';
    if(all && !fired){ localStorage.setItem(PROG_KEY,'yes'); launchConfetti(); botui && botui.message.add({type:'html',content:t('confetti_msg')}); } }catch(e){} }

  // gate helpers
  function isCheckedIn(){ return localStorage.getItem(CHECKED_KEY)==='yes'; }
  function enforceGateOrRedirect(step){
    if(step>0 && !isCheckedIn()){
      logEvent('blocked_without_checkin',{attempt_step:step});
      const base=window.location.pathname;
      window.location.replace(`${base}?step=0&lang=${LANG}&need_checkin=1`);
      return false;
    }
    return true;
  }
  function startNewSession(lang){
    const sid=uuidv4(); localStorage.setItem(SESSION_KEY,sid); SESSION_ID=sid;
    try{ const payload={event:'session_start',visitor_id:VISITOR_ID,session_id:sid,lang,ts:Date.now()};
      const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); navigator.sendBeacon && navigator.sendBeacon('/api/log',blob);}catch(_){}
  }

  // UI
  async function askNameIfNeeded(){
    if (USERNAME) return;
    await botui.message.add({type:'html',content:t('hello_name')});
    const res = await botui.action.text({action:{placeholder: LANG==='fr'?'Entrez votre nomâ€¦':'Typ je naamâ€¦'}});
    USERNAME = (res && res.value ? String(res.value).trim() : '') || (LANG==='fr'?'collÃ¨gue':'collega');
    localStorage.setItem('atalian_name',USERNAME);
    await logEvent('name_set',{display_name:USERNAME});
    await botui.message.add({content:t('nice_to_meet',USERNAME)});
    await sleep(60);
  }
  async function askProblem(){ await botui.message.add({content:t('ask_problem')});
    const {value}=await botui.action.text({action:{placeholder:LANG==='fr'?'DÃ©crivez briÃ¨vementâ€¦':'Schrijf kort je meldingâ€¦'}}); await sleep(40); return (value||'').trim(); }
  async function askEmail(){
    await botui.message.add({content:t('ask_email')});
    let {value}=await botui.action.text({action:{placeholder:LANG==='fr'?'vous@exemple.be':'jij@voorbeeld.be'}}); let email=(value||'').trim();
    while(!emailRegex.test(email)){ await botui.message.add({content:t('invalid_email')}); const ans=await botui.action.text({action:{placeholder:LANG==='fr'?'vous@exemple.be':'jij@voorbeeld.be'}}); email=(ans && ans.value? String(ans.value).trim() : ''); }
    await sleep(60); return email;
  }
async function askPhoto(botuiInstance, label = t('photo_label'), compress = true){
  await botuiInstance.message.add({ content: label });
  const choice = await botuiInstance.action.button({
    action: [
      { text: 'ğŸ“· Foto nemen', value: 'camera' },
      { text: 'ğŸ–¼ï¸ Kies uit galerij', value: 'gallery' },
      { text: t('photo_skip'), value: 'skip' }
    ]
  });

  if (!choice || choice.value === 'skip') {
    await botuiInstance.message.add({ content: t('photo_skip_msg') });
    await sleep(80);
    return null;
  }

  // â¬‡ï¸ camera = forceren, gallery = vrije keuze (toont ook bestanden/fotobibliotheek)
  const input = createHiddenFileInput(choice.value === 'camera' ? 'camera' : 'any');

  const p = new Promise(resolve => {
    input.onchange = async () => {
      const file = input.files && input.files[0];
      input.remove();
      if (!file) { resolve(null); return; }
      try {
        let dataUrl = await fileToDataUrl(file);
        try {
          if (compress) dataUrl = await compressDataUrl(dataUrl, 1200, 0.8);
        } catch (_) {
          // fallback: sommige HEIC/codec combinaties kunnen niet naar canvas â€” neem dan de originele
        }
        await botuiInstance.message.add({
          type: 'html',
          content: `<div class='hint'>${t('photo_preview')}</div>
                    <img src='${dataUrl}' alt='photo' style='max-width:100%;border-radius:10px;border:1px solid #ddd' />`
        });
        resolve(dataUrl);
      } catch (e) {
        console.error(e);
        resolve(null);
      }
    };
  });

  input.click();
  await sleep(80);
  return p;
}


  // Ticket-flow
  async function ticketFlow(contextLabel){
    try{
      await botui.message.add({content:t('urgent_q',USERNAME)});
      const urgentChoice=await botui.action.button({action:[{text:t('urgent_yes'),value:'ja'},{text:t('urgent_no'),value:'nee'}]});
      const urgentVal=(urgentChoice && urgentChoice.value) ? urgentChoice.value : 'nee'; await sleep(60);

      const desc=await askProblem();
      const photoDataUrl=await askPhoto(botui);
      const email=await askEmail();

      if(urgentVal==='ja'){ await botui.message.add({type:'html',content:t('servicedesk_note')}); await sleep(40); }

      const fakeId='TCK-'+Math.random().toString(36).slice(2,6).toUpperCase();
      try{ const key='atalian_demo_tickets'; const arr=JSON.parse(localStorage.getItem(key)||'[]');
        arr.push({contextLabel,urgent:urgentVal,desc,email,photo:!!photoDataUrl,lang:LANG,ts:Date.now()});
        localStorage.setItem(key,JSON.stringify(arr)); }catch(_){}
      const user_id=email ? await hashEmailToUserId(email) : null;

      await logEvent('ticket_submitted',{contextLabel,urgent:urgentVal,photo:!!photoDataUrl,desc_len:(desc||'').length,email_present:!!email,user_id});

      await botui.message.add({type:'html',content:t('thanks_sent',contextLabel,fakeId)});
      await botui.message.add({type:'html',content:`<span class="hint">${t('summary_heading')}</span><br>${t('summary_urgent',urgentVal)}<br>${t('summary_desc',desc)}<br>${t('summary_email',email)}${photoDataUrl?'<br>'+t('summary_photo'):''}`});
      await sleep(50);
    }catch(err){
      console.error('ticketFlow error',err);
      await botui.message.add({type:'html',content: LANG==='fr' ? "Oups, une erreur sâ€™est produite. RÃ©essayez ou faites un reset (appui long sur le logo). ğŸ™" : "Oei, er ging iets mis. Probeer nog eens, of reset (lang drukken op het logo). ğŸ™"});
      throw err;
    }
  }
  

  

  // Scenarioâ€™s
  async function intro(){
    // melding als iemand via QR hierheen werd teruggestuurd
    if(qs.get('need_checkin')==='1'){ await botui.message.add({type:'html',content:t('need_checkin')}); }
    await askNameIfNeeded();
    await botui.message.add({type:'html',content:t('intro_welcome',USERNAME)});
    await botui.message.add({type:'html',content:t('intro_line1')});
    await botui.message.add({content:t('intro_tip')});

    const done=countCompleted();
    await botui.message.add({content:t('intro_progress',done)});

    // Incheck-knop (zet gate open)
    const start = await botui.action.button({action:[{text:t('start_btn'),value:'start'}]});
    if(start && start.value==='start'){
      localStorage.setItem(CHECKED_KEY,'yes');
      await logEvent('checkin',{display_name:USERNAME});
      await botui.message.add({content:t('intro_go')});
    }
  }

	async function showCheckinGate(step){
	  // log: iemand probeerde scenario zonder incheck
	  try { await logEvent('blocked_without_checkin', { attempt_step: step }); } catch(_) {}

	  // Alleen tonen, niet navigeren
	  await botui.message.add({
		type: 'html',
		content: t('need_checkin') + ''
	  });
	  // Niets returnen, geen redirect. We blijven op de huidige pagina.
	}


  async function scenarioCleaning(){ await askNameIfNeeded(); await botui.message.add({content:t('scen1_q')});
    await botui.action.button({action:[{text:I18N[LANG].scen1_opts[0],value:'ultimo'},{text:I18N[LANG].scen1_opts[1],value:'mop'},{text:I18N[LANG].scen1_opts[2],value:'niks'}]});
    await botui.message.add({content:t('scen1_feedback',USERNAME)});
    try{ await ticketFlow(LANG==='fr'?'signalement nettoyage':'schoonmaak-melding'); await endMessage(); markScenarioDone(1);}catch(_){}
  }
  async function scenarioCoffee(){ await askNameIfNeeded(); await botui.message.add({content:t('scen2_q')});
    await botui.action.button({action:[{text:I18N[LANG].scen2_opts[0],value:'bel'},{text:I18N[LANG].scen2_opts[1],value:'ultimo'},{text:I18N[LANG].scen2_opts[2],value:'thee'}]});
    await botui.message.add({content:t('scen2_feedback',USERNAME)});
    try{ await ticketFlow(LANG==='fr'?'machine Ã  cafÃ© en panne':'koffiemachine-melding'); await endMessage(); markScenarioDone(2);}catch(_){}
  }
  async function scenarioProgram(){ await askNameIfNeeded(); await botui.message.add({content:t('scen3_q')});
    await botui.action.button({action:[{text:t('scen3_btn'),value:'toon'}]});
    await botui.message.add({type:'html',content:t('scen3_info')});
    const wil=await botui.action.button({action:[{text:t('scen3_mk'),value:'ja'},{text:t('scen3_ok'),value:'nee'}]});
    if(wil && wil.value==='ja'){ try{ await ticketFlow(LANG==='fr'?'programme de nettoyage':'poetsprogramma-melding'); await endMessage(); markScenarioDone(3);}catch(_){}} else { await botui.message.add({content:t('scen3_okreply')}); await endMessage(); markScenarioDone(3); }
  }
  async function scenarioLamp(){ await askNameIfNeeded(); await botui.message.add({content:t('scen4_q')});
    await botui.action.button({action:[{text:I18N[LANG].scen4_opts[0],value:'ultimo'},{text:I18N[LANG].scen4_opts[1],value:'zelf'},{text:I18N[LANG].scen4_opts[2],value:'donker'}]});
    await botui.message.add({content:t('scen4_feedback')});
    try{ await ticketFlow(LANG==='fr'?'lampe cassÃ©e':'lamp-melding'); await endMessage(); markScenarioDone(4);}catch(_){}
  }
  async function endMessage(){ await botui.message.add({content:t('end_msg')}); }

  // URL reset (bv. ?reset=1)
  if(qs.get('reset')==='1'){
    const lang=(localStorage.getItem('atalian_lang')||'nl');
    localStorage.clear();
    localStorage.setItem('atalian_lang',lang);
    startNewSession(lang);
    window.location.href = window.location.pathname + `?step=0&lang=${lang}`;
  }

  const STEP_PARAM=parseInt(qs.get('step')||'0',10);
  const SCENARIOS=[intro,scenarioCleaning,scenarioCoffee,scenarioProgram,scenarioLamp];

	async function start(){
	  const step = isNaN(STEP_PARAM) ? 0 : Math.max(0, Math.min(4, STEP_PARAM));

	  // Gate: als nog niet ingecheckt en men landt op step>0 â†’ enkel melding tonen
	  if (step > 0 && localStorage.getItem('atalian_checkedin') !== 'yes') {
		await showCheckinGate(step);
		return; // Stop: niet verder naar het scenario
	  }

	  // Normale flow
	  await SCENARIOS[step]();
	}



  window.addEventListener('online',flushPending);
  window.addEventListener('load', ()=>{ logVisit(); flushPending(); (botui=new BotUI('botui-app')) && start(); });

  // Long-press reset op logo
  window.addEventListener('DOMContentLoaded', ()=>{
    const logo=document.querySelector('img.logo'); if(!logo) return;
    let pressTimer=null;
    function startP(){ cancelP(); pressTimer=setTimeout(()=>{ const lang=(localStorage.getItem('atalian_lang')||'nl');
      ['atalian_scenario_1','atalian_scenario_2','atalian_scenario_3','atalian_scenario_4','atalian_all_done','atalian_name','atalian_demo_tickets',CHECKED_KEY].forEach(k=>localStorage.removeItem(k));
      localStorage.setItem('atalian_lang',lang); startNewSession(lang);
      const base=window.location.pathname; window.location.replace(`${base}?step=0&lang=${lang}&_=${Date.now()}`); },900); }
    function cancelP(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }
    logo.addEventListener('touchstart',startP,{passive:true}); logo.addEventListener('mousedown',startP);
    logo.addEventListener('touchend',cancelP,{passive:true}); logo.addEventListener('mouseup',cancelP); logo.addEventListener('mouseleave',cancelP);
  });
</script>
</body>
</html>
