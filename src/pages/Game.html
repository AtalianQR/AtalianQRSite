<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATALIAN ‚Äì De Missie van de Assistent (Demo)</title>
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    :root{
      --atalian-orange:#EE7E00;
      --bg:#f4f6fa;
      --text:#1a202c;
    }
    html,body{height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background-color:var(--bg);overflow-y:auto}
    body{background-image:url('/building-cleaning.png');background-size:cover;background-repeat:no-repeat;background-position:center}
    *{box-sizing:border-box}
    header{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin:1rem 0}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);
      padding:.15rem .4rem;border-radius:12px}
    .subtitle{background:rgba(255,255,255,.95);padding:.35rem .8rem;border-radius:10px;border:2.5px solid var(--atalian-orange);
      color:#334155;font-size:.95rem;box-shadow:0 2px 8px rgba(238,126,0,.08)}
    .wrap{max-width:640px;margin:0 auto;padding:0 1rem 2rem}
    .botui-container{max-width:640px;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border:2px solid var(--atalian-orange);box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      border-radius:12px;padding:1rem;opacity:0;animation:fadeIn .9s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    .botui-actions-buttons-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.07);transition:transform .06s ease}
    .botui-actions-buttons-button:active{transform:scale(.98)}
    .hint{font-size:.9rem;color:#475569}
    @keyframes fadeIn{to{opacity:1}}
    .credit{
	  margin-top:.75rem;
	  text-align:center;
	  font-size:.85rem;
	  background:rgba(255,255,255,0.92);   /* witte achtergrond */
	  padding:.4rem .8rem;
	  border-radius:8px;
	  border:1.5px solid var(--atalian-orange);
	  color:#1a202c;                       /* donkere tekst */
	  display:inline-block;
	}
    #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999}
  </style>
</head>
<body>
  <header>
    <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
    <div class="subtitle">üéâ Personeelsevent ‚Äì demo met AI-assistent ¬∑ geen echte tickets</div>
  </header>

  <canvas id="confetti-canvas"></canvas>

  <div class="wrap">
    <div id="botui-app"><bot-ui></bot-ui></div>
    <div class="credit">Vragen of idee√´n? Spreek ons FM-team aan üí¨</div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    // ===== Foto helpers (inline i.p.v. extern bestand) =====
    function createHiddenFileInput(){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      input.style.display = 'none';
      document.body.appendChild(input);
      return input;
    }
    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=reject;
        fr.readAsDataURL(file);
      });
    }
    function compressDataUrl(dataUrl,maxW=1200,quality=0.8){
      return new Promise(res=>{
        const img=new Image();
        img.onload=function(){
          const scale=Math.min(1,maxW/img.width);
          const w=Math.round(img.width*scale),h=Math.round(img.height*scale);
          const canvas=document.createElement('canvas');
          canvas.width=w; canvas.height=h;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,w,h);
          res(canvas.toDataURL('image/jpeg',quality));
        };
        img.src=dataUrl;
      });
    }
    async function askPhoto(botui,label='Wil je een foto toevoegen van het probleem? üì∑',compress=true){
      await botui.message.add({ content: label });
      const choice = await botui.action.button({ action:[
        { text:'üì∑ Foto nemen / kiezen', value:'snap' },
        { text:'‚è≠Ô∏è Overslaan', value:'skip' }
      ]});
      if(choice.value==='skip'){
        await botui.message.add({ content:'Ok√©, we gaan verder zonder foto üëç' });
        return null;
      }
      const input=createHiddenFileInput();
      const p=new Promise(resolve=>{
        input.onchange=async()=>{
          const file=input.files && input.files[0];
          input.remove();
          if(!file){ resolve(null); return; }
          try{
            let dataUrl=await fileToDataUrl(file);
            if(compress) dataUrl=await compressDataUrl(dataUrl,1200,0.8);
            await botui.message.add({ type:'html', content:`<div class='hint'>Voorbeeld van je foto:</div><img src='${dataUrl}' alt='foto' style='max-width:100%;border-radius:10px;border:1px solid #ddd' />` });
            resolve(dataUrl);
          }catch(e){ console.error(e); resolve(null); }
        };
      });
      input.click();
      return p;
    }
  </script>

  <script>
    // ===== Kern-logica =====
    let botui; // wordt gezet in bootstrap()
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    let USERNAME = localStorage.getItem('atalian_name') || '';

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function launchConfetti(){
      const end = Date.now() + 800;
      (function frame(){
        confetti({ particleCount: 80, spread: 70, origin: { y: 0.2 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    // ---------- Progress tracking (localStorage) ----------
    const PROG_KEY = 'atalian_all_done';
    function markScenarioDone(step){
      try { localStorage.setItem('atalian_scenario_'+step, 'done'); checkAllScenarios(); } catch(e){}
    }
    function countCompleted(){ let n=0; for(let i=1;i<=4;i++){ if(localStorage.getItem('atalian_scenario_'+i)==='done') n++; } return n; }
    function checkAllScenarios(){
      try{
        const all=[1,2,3,4].every(i=>localStorage.getItem('atalian_scenario_'+i)==='done');
        const fired=localStorage.getItem(PROG_KEY)==='yes';
        if(all && !fired){
          localStorage.setItem(PROG_KEY,'yes');
          launchConfetti();
          botui && botui.message.add({ type:'html', content:'üéä <b>Fantastisch!</b> Je hebt alle 4 scenario‚Äôs ontdekt.<br>Bedankt om de volledige AI‚ÄëUltimo missie mee te doen üôè' });
        }
      }catch(e){}
    }

    // ---------- UI helpers ----------
    async function askNameIfNeeded(){
      if (USERNAME) return;
      await botui.message.add({ type:'html', content: 'Hallo! Ik ben je <span style="color:var(--atalian-orange);font-weight:700">ATALIAN</span>-assistent ü§ñ. Hoe heet jij?' });
      const name = await botui.action.text({ action:{ placeholder:'Typ je naam‚Ä¶' } });
      USERNAME = (name.value||'collega').trim();
      localStorage.setItem('atalian_name', USERNAME);
      await botui.message.add({ content: `Aangenaam, ${USERNAME}!` });
    }
    async function askProblem(){
      await botui.message.add({ content: 'Kun je kort beschrijven wat er aan de hand is?' });
      const { value } = await botui.action.text({ action:{ placeholder:'Schrijf hier je melding‚Ä¶' } });
      return (value||'').trim();
    }
    async function askEmail(){
      await botui.message.add({ content: 'Wat is je e-mailadres? (mag ook nep zijn üòâ)' });
      const { value } = await botui.action.text({ action: { placeholder: 'jij@voorbeeld.be' } });
      if (!emailRegex.test(value)) { await botui.message.add({ content: 'Hm, dat lijkt geen geldig adres. Probeer nog eens üôà' }); return askEmail(); }
      return value;
    }

    // ---------- Ticket-flow ----------
    async function ticketFlow(contextLabel){
      // 1) Dringend of niet
      await botui.message.add({ content: `Is dit dringend, ${USERNAME}?` });
      const urgent = await botui.action.button({ action:[
        { text: 'üö® Ja, dringend', value: 'ja' },
        { text: '‚è±Ô∏è Nee, kan wachten', value: 'nee' },
      ]});
      // 2) Beschrijving
      const desc = await askProblem();
      // 3) Optionele foto
      const photoDataUrl = await askPhoto(botui);
      // 4) E-mail
      const email = await askEmail();
      // 5) Dringend boodschap i.p.v. nummer
      if(urgent.value==='ja'){
        await botui.message.add({ type:'html', content: 'Normaal zou je nu het telefoonnummer van de servicedesk krijgen ‚òéÔ∏è.<br><b>Maar omdat ze zelf deelnemen aan dit event, laten we ze vandaag met rust üòá.</b>' });
      }
      // 6) Fake submit + samenvatting
      const fakeId = 'TCK-' + Math.random().toString(36).slice(2, 6).toUpperCase();
      try{
        const key='atalian_demo_tickets';
        const arr=JSON.parse(localStorage.getItem(key)||'[]');
        arr.push({ contextLabel, urgent:urgent.value, desc, email, photo: !!photoDataUrl, ts:Date.now() });
        localStorage.setItem(key, JSON.stringify(arr));
      }catch(e){}
      await botui.message.add({ type:'html', content: `Bedankt! Je <b>${contextLabel}</b> is verzonden naar Ultimo ‚úÖ<br><span class="hint">(Demo, geen echte ticket) ‚Äì ref: ${fakeId}</span>` });
      await botui.message.add({ type:'html', content: `<span class="hint">Samenvatting:</span><br>‚Ä¢ Urgent: <b>${urgent.value==='ja'?'ja':'nee'}</b><br>‚Ä¢ Beschrijving: <b>${desc||'-'}</b><br>‚Ä¢ Contact: <b>${email}</b>${photoDataUrl?'\n<br>‚Ä¢ Foto: <i>bijgevoegd</i>':''}` });
    }

    // ---------- Content ----------
    async function intro(){
      await askNameIfNeeded();
      await botui.message.add({ type:'html', content: `Welkom, ${USERNAME}! üéâ` });
      await botui.message.add({ type:'html', content: 'Dit is onze speurtocht met AI + <b>Ultimo</b> (FMIS). Scan de verschillende QR-codes in het gebouw en ontdek per scenario hoe melden werkt: schoonmaak, techniek en comfort.' });
      await botui.message.add({ content: 'Tip: elke QR werkt apart. Er worden geen echte tickets aangemaakt ‚Äì dit is een demo.' });
      const done = countCompleted();
      await botui.message.add({ content: `Je voortgang: ${done}/4 scenario‚Äôs afgerond.` });
      await botui.message.add({ content: 'Veel plezier! ü§ù Scan nu de volgende QR voor een scenario.' });
    }

    async function scenarioCleaning(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Stel je vindt een ruimte die niet netjes is. Wat zou jij doen?' });
      await botui.action.button({ action:[
        { text: 'Direct melden via Ultimo üì≤', value: 'ultimo' },
        { text: 'Zelf de mop pakken ü™£', value: 'mop' },
        { text: 'Niks doen en hopen dat het verdwijnt üôà', value: 'niks' },
      ] });
      await botui.message.add({ content: `Juist! In Ultimo registreer je het meteen, zodat cleaning het kan oppakken. Geen zorgen ${USERNAME}, ik verklik niemand üòÖ.` });
      await ticketFlow('schoonmaak-melding');
      await endMessage();
      markScenarioDone(1);
    }

    async function scenarioCoffee(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Je komt in de refter en de koffiemachine is kapot. Wat nu?' });
      await botui.action.button({ action:[
        { text: 'Een technieker bellen üìû', value: 'bel' },
        { text: 'Een ticket in Ultimo maken üõ†Ô∏è', value: 'ultimo' },
        { text: 'Gewoon thee drinken üçµ', value: 'thee' },
      ] });
      await botui.message.add({ content: `Precies ${USERNAME}! Via Ultimo komt dit meteen bij techniek terecht.` });
      await ticketFlow('koffiemachine-melding');
      await endMessage();
      markScenarioDone(2);
    }

    async function scenarioProgram(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Benieuwd wanneer de volgende poetsbeurt is in jouw gebouw?' });
      await botui.action.button({ action:[ { text: 'Toon poetsprogramma üßπ', value: 'toon' } ] });
      await botui.message.add({ type:'html', content: 'üåû <b>Dagelijks</b> op elke werkdag.<br>üßπ Volgende beurt: üìÖ <b>ma 09-09-2025</b>.<br><span class="hint">(Voorbeeld ‚Äì demo)</span>' });
      const wilMelding = await botui.action.button({ action:[
        { text: 'üì© Maak hier een melding van', value: 'ja' },
        { text: 'Nee hoor, is duidelijk üëç', value: 'nee' },
      ]});
      if (wilMelding.value === 'ja') await ticketFlow('poetsprogramma-melding');
      else await botui.message.add({ content:'Ok√©, ik onthoud het wel voor je üòé.' });
      await endMessage();
      markScenarioDone(3);
    }

    async function scenarioLamp(){
      await askNameIfNeeded();
      await botui.message.add({ content: 'Je ziet dat een lamp stuk is in de vergaderzaal. Hoe los je dit op?' });
      await botui.action.button({ action:[
        { text: 'Ultimo inschakelen üñ•Ô∏è', value: 'ultimo' },
        { text: 'Zelf vervangen met ladder en risico ü§ï', value: 'zelf' },
        { text: 'Vergaderen in het donker üòé', value: 'donker' },
      ] });
      await botui.message.add({ content: 'Ha, vergaderen in het donker klinkt spannend, maar Ultimo is slimmer ü§ì.' });
      await ticketFlow('lamp-melding');
      await endMessage();
      markScenarioDone(4);
    }

    async function endMessage(){
      await botui.message.add({ content: 'Bedankt! Dit scenario is afgerond ‚úÖ. Scan gerust een andere QR om nog een scenario te ontdekken.' });
    }

    // --- URL opties (single run per step) ---
    const qs = new URLSearchParams(window.location.search);
    const STEP_PARAM = parseInt(qs.get('step') || '0', 10);

    const SCENARIOS = [
      intro,            // 0 = intro
      scenarioCleaning, // 1
      scenarioCoffee,   // 2
      scenarioProgram,  // 3
      scenarioLamp      // 4
    ];

    async function start(){
      const step = isNaN(STEP_PARAM) ? 0 : Math.max(0, Math.min(4, STEP_PARAM));
      await SCENARIOS[step]();
    }

    async function bootstrap(){
      try{
        botui = new BotUI('botui-app');
        await start();
      }catch(err){
        console.error('Init error', err);
        const c = document.getElementById('botui-app');
        if(c){ c.innerHTML = '<div style="background:#fff;border:2px solid #EE7E00;border-radius:12px;padding:12px">Er ging iets mis bij het laden van de chat. Vernieuw de pagina of probeer een andere QR. üôè</div>'; }
      }
    }

    window.addEventListener('load', bootstrap);
  </script>
</body>
</html>