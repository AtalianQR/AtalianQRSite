<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wat wil je melden?</title>

  <!-- favicon & externe styles -->
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    html, body{
      height:auto;
      min-height:100vh;
      width:100%;
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:'Segoe UI',sans-serif;
      background-color:#f4f6fa;
      overflow-y:auto
    }
    body{
      background-image:url('/building-cleaning.png');
      background-size:cover;
      background-repeat:no-repeat;
      background-position:center
    }
    *{box-sizing:border-box}

    /* NIEUWE STIJLEN VOOR TEST-INDICATOR */
    .test-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #28a745; /* Groene kleur */
      color: white;
      text-align: center;
      padding: 5px 0;
      font-weight: bold;
      z-index: 1000;
      font-size: 14px;
      text-transform: uppercase;
      opacity: 0.9;
    }
    /* Verschuif de content een beetje naar beneden als de banner actief is */
    body.is-test {
      padding-top: 30px; /* Moet hoger zijn dan de bannerhoogte */
    }

    .botui-actions-text-input{
      width: 100% !important;
      max-width: 80% !important;
      flex-grow: 1 !important;
    }
    /* op small screens gewoon full width */
    @media (max-width: 768px){
      .botui-actions-text-input{ max-width: 100% !important; }
    }
    /* EINDE NIEUWE STIJLEN */

    .header-flex{
      display:flex;
      flex-direction:column;
      align-items:center;
      max-width:600px;
      width:100%;
      margin:0 auto;
      padding:.5rem 0;
      gap:.5rem
    }
    img.logo{
      max-height:60px;
      height:auto;
      width:auto;
      display:block;
      margin:0 auto;
      background:rgba(255,255,255,.85);
      padding:.1rem;
      border-radius:12px
    }
    .header-flex .ruimte-label{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:rgba(255,255,255,.95);
      color:#1a202c;
      padding:.5rem 1rem;
      border-radius:12px;
      font-size:1rem;
      font-weight:500;
      white-space:normal;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
      border:2.5px solid #EE7E00;
      box-shadow:0 2px 8px rgba(238,126,0,.06);
      width:100%;
      max-width:600px;
      margin:0 auto;
      border-bottom-width:4px
    }
    .ruimte-label .type{
      font-size:.85rem;
      font-weight:normal;
      margin-top:.25rem;
      color:#666
    }
    .lang-switch{
      text-align:right;
      padding-right:1rem;
      margin-top:1rem
    }
    .lang-switch a{
      margin:0 .5rem;
      text-decoration:none;
      font-size:1.2rem
    }
    #botui-app{
      width:100%;
      max-width:600px;
      margin:1rem auto 0 auto;
      padding:.5rem 1rem 1rem
    }
    .botui-container{
      max-width:600px;
      width:100%;
      margin:0 auto;
      background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border:2px solid #EE7E00;
      box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      border-radius:12px;
      padding:1rem;
      box-sizing:border-box;
      opacity:0;
      animation:fadeIn 3s ease forwards
    }
    .botui-container,.botui-message-content{
      font-family:'Segoe UI',sans-serif
    }
    .botui-button{
      font-weight:600;
      border:none;
      box-shadow:0 2px 6px rgba(238,126,0,.04);
      transition:background .12s
    }
    .botui-button:active{background:#d86e00}
    .meldingen-lijst{
      background:#f5f8fc;
      border-radius:10px;
      padding:.7em 1em;
      margin:.7em 0;
      border-left:4px solid #EE7E00
    }
    @keyframes fadeIn{to{opacity:1}}
    @media(max-width:480px){
      .header-flex{flex-wrap:wrap;justify-content:center}
      .header-flex .ruimte-label,img.logo{
        flex:0 0 90%;
        max-width:90%;
        text-align:center
      }
      .header-flex .ruimte-label{
        font-size:.95rem;
        padding:.5rem
      }
      .botui-container{
        padding:.75rem;
        max-width:95%
      }
    }
  </style>
</head>
<body>
  <div id="test-indicator" style="display: none;" class="test-banner">
    ‚ö†Ô∏è TEST OMGEVING ACTIEF
  </div>

  <header>
    <div class="lang-switch">
      <a href="#" id="switch-nl">üá≥üá± NL</a> |
      <a href="#" id="switch-fr">üá´üá∑ FR</a>
    </div>
    <div class="header-flex">
      <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
      <div id="ruimte-info" class="ruimte-label" style="display:none"></div>
    </div>
  </header>
  <div id="botui-app"><bot-ui></bot-ui></div>

  <!-- Vue & BotUI -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>

  <script type="module">
  /* ======================================================================
     IMPORTS
  ====================================================================== */
  import { parseUltimoQR } from '/js/CodeUrl.js';

  /* ======================================================================
     GLOBALE STATE
  ====================================================================== */
  let cachedJobs = [];
  let cachedSvcWO = [];
  let cachedQRCommando = "";
  let contextFetched = false;
  let botui; // globaal beschikbaar
  let selectedServiceWOId = null;      // Gekozen ServiceWO bij schoonmaak
  let selectedOtherServiceWO = null;   // Gekozen ServiceWO bij "Andere problemen"

  // FOTO-state (ENKEL deze gebruiken)
  let pickedFiles = []; // [{file, kind:'image'|'pdf'|'other', name, previewUrl, remark}]

  /* ======================================================================
     HULPFUNCTIES (algemeen)
  ====================================================================== */
  function formatDateTimeLocal(d = new Date()){
	  // bv: 2025-12-21 14:08
	  const pad = (n)=> String(n).padStart(2,'0');
	  const yyyy = d.getFullYear();
	  const mm   = pad(d.getMonth()+1);
	  const dd   = pad(d.getDate());
	  const hh   = pad(d.getHours());
	  const mi   = pad(d.getMinutes());
	  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
	}
	
function buildPortalLogLine({ channel = 'PortalSelf', email = '', geo = null } = {}) {
	  const parts = [`Kanaal: ${channel}`];

	  if (email && email.trim()) {
		parts.push(`Email: ${email.trim()}`);
	  }

	  if (geo?.ok) {
		parts.push(`GPS: lat=${geo.lat}; lon=${geo.lon}; acc=${Math.round(geo.acc)}m`);
	  } else {
		parts.push(`GPS: unavailable`);
	  }

	  return parts.join(' | ');
	}
	
	
  async function getGeoFix({ timeoutMs = 8000, enableHighAccuracy = true } = {}) {
	  if (!('geolocation' in navigator)) {
		return { ok:false, reason:'geolocation_not_supported' };
	  }

	  return await new Promise((resolve) => {
		const opts = {
		  enableHighAccuracy,
		  timeout: timeoutMs,
		  maximumAge: 0
		};

		navigator.geolocation.getCurrentPosition(
		  (pos) => {
			const c = pos.coords || {};
			resolve({
			  ok: true,
			  lat: c.latitude,
			  lon: c.longitude,
			  acc: c.accuracy,
			  ts: pos.timestamp || Date.now()
			});
		  },
		  (err) => {
			resolve({
			  ok: false,
			  reason: err?.code ? `geo_error_${err.code}` : 'geo_error',
			  message: err?.message || ''
			});
		  },
		  opts
		);
	  });
	}
	

  function toInt(v){
    const n = parseInt((v ?? '').toString(), 10);
    return Number.isFinite(n) ? n : null;
  }
  function isTicketTrue(v){
    if (v === true || v === 1) return true;
    if (typeof v === 'string') return /^(true|1)$/i.test(v.trim());
    return false;
  }
  function hasCleaningActivities(svcList){
    return (svcList || []).some(x => {
      const act = toInt(x?.Activiteit ?? x?._Activiteit);
      return act !== null && act >= 10 && act <= 40 && isTicketTrue(x?.Ticket);
    });
  }
  function getRelevantCleaningServiceWOs(svcList) {
    return (svcList || []).filter(x => {
      const act = toInt(x?.Activiteit ?? x?._Activiteit);
      return act !== null && act >= 10 && act <= 40 && isTicketTrue(x?.Ticket);
    });
  }
  function hasOtherActivities(svcList){
    return (svcList || []).some(x => {
      const act = toInt(x?.Activiteit ?? x?._Activiteit);
      return act !== null && act > 40 && isTicketTrue(x?.Ticket);
    });
  }
  function getRelevantOtherServiceWOs(svcList){
    return (svcList || []).filter(x => {
      const act = toInt(x?.Activiteit ?? x?._Activiteit);
      return act !== null && act > 40 && isTicketTrue(x?.Ticket);
    });
  }

  function hasText(s){ return !!String(s ?? '').trim(); }
  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );
  }
  function isValidEmail(e){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
  }

  /* ======================================================================
     URL NORMALISATIE (pipes/tilde)
  ====================================================================== */
  (function () {
    const raw = window.location.search || '';
    if (!raw) return;
    let dec = decodeURIComponent(raw);
    if (dec.includes('|')) {
      const fixed = dec.replace(/\|/g, '&');
      window.location.replace(window.location.origin + window.location.pathname + fixed + window.location.hash);
      return;
    }
    if (dec.includes('~code=')) {
      const fixed = dec.replace(/([?&]lang=[^&~=]+)~code=/i, '$1&code=');
      window.location.replace(window.location.origin + window.location.pathname + fixed + window.location.hash);
      return;
    }
  })();

  /* ======================================================================
     PARAMS + OMGEVING
  ====================================================================== */
  const qs   = new URLSearchParams(window.location.search);
  const code = qs.get('code') ?? '';
  let   lang = qs.get('lang') ?? '';
  if (!lang) {
    const b = navigator.language || '';
    lang = b.startsWith('fr') ? 'fr' : 'nl';
  }
  const isFr = lang === 'fr';
  const host = location.host || '';

  const isTestEnv =
    qs.has('test') ||              // ?test=1 of ?test=...
    qs.get('env') === 'test' ||    // ?env=test
    /test|staging/i.test(host);    // test/staging in host

  const prefix = isTestEnv ? 'test' : 'prod';

  // üü¢ Grote banner bovenaan de pagina tonen
  if (isTestEnv) {
    document.getElementById('test-indicator').style.display = 'block';
    document.body.classList.add('is-test');
  }

  const parsedQR = parseUltimoQR(code);
  let isEquipment = false, typeStr = '', id = '', indicator = '';
  if (parsedQR) {
    isEquipment = parsedQR.isEquipment;
    typeStr     = parsedQR.typeStr;
    id          = parsedQR.id;
    indicator   = parsedQR.indicator;
  }

  const endpointLoc = isEquipment
    ? '/.netlify/functions/equipment'
    : '/.netlify/functions/space';
	
	const srcRaw = qs.get('src') ?? '';

	function safeSameOriginUrl(raw) {
	  if (!raw) return '';
	  try {
		const u = new URL(raw, window.location.origin);
		return (u.origin === window.location.origin) ? u.toString() : '';
	  } catch {
		return '';
	  }
	}

const sourceUrl = safeSameOriginUrl(srcRaw);
	

 /* ======================================================================
   CONTEXT LOADERS (jobs + serviceWO + locatie)
====================================================================== */
	async function preloadContextAndShow() {
	  try {
		const url = `/.netlify/functions/jobs?code=${encodeURIComponent(code)}&env=${prefix}`;
		const res = await fetch(url);
		let txt = await res.text();

		if (txt.includes('&quot;')) txt = txt.replace(/&quot;/g, '"');

		let data;
		try {
		  data = JSON.parse(txt);
		  if (data && typeof data.object === 'string') {
			const inner = data.object.includes('&quot;')
			  ? data.object.replace(/&quot;/g, '"')
			  : data.object;
			data = JSON.parse(inner);
		  }
		} catch (e) {
		  throw new Error(`Bad JSON from /jobs: ${e.message}\n---\n${txt.slice(0, 800)}`);
		}

		if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);

		cachedJobs       = Array.isArray(data.Jobs) ? data.Jobs : [];
		cachedSvcWO      = Array.isArray(data.ComplexServiceWO) ? data.ComplexServiceWO : [];
		cachedQRCommando = data.QRCommando || "";
		contextFetched   = true;

		const goToVendor = (jobId) => {
		  const v = new URL('/vendor.html', window.location.origin);
		  v.searchParams.set('jobId', String(jobId));
		  v.searchParams.set('lang', lang);
		  if (isTestEnv) v.searchParams.set('test', '1');
		  v.searchParams.set('src', window.location.pathname + window.location.search);
		  window.location.href = v.toString();
		};

		// ‚úÖ Resume: zet job naar 1008 ZONDER werklog, en ga dan naar vendor
		const resumeJobAndGo = async (jobId) => {
		  await botui.message.add({ content: isFr ? 'Votre adresse e-mail ?' : 'Wat is je e-mailadres?' });
		  const resMail = await botui.action.text({ action: { placeholder: 'jouw@email.com' } });

		  const email = (resMail?.value || '').trim();
		  if (!isValidEmail(email)) {
			await botui.message.add({ content: isFr ? 'Adresse e-mail invalide.' : 'Ongeldig e-mailadres.' });
			Telemetry.send('email_invalid_resume');
			return await resumeJobAndGo(jobId);
		  }

		  // Email bewaren voor vendor.html
		  try {
			sessionStorage.setItem('vendor_session_email', email.toLowerCase());
			sessionStorage.setItem('vendor_session_ts', String(Date.now()));
		  } catch {}

		  // ‚úÖ 1) status naar 1008 zetten (zonder "uitgevoerde werkzaamheden")
		  try {
			const endpoint = '/.netlify/functions/jobsvendor' + (isTestEnv ? '?test=1' : '');
			const payload = {
			  action: 'ACTIVATE_VENDORJOB',
			  jobId: String(jobId),
			  email: email
			  // geen text nodig
			};


			Telemetry.send('set_status_1008_attempt', { jobId: String(jobId) });

			const r = await fetch(endpoint, {
			  method: 'POST',
			  headers: { 'Content-Type': 'application/json' },
			  body: JSON.stringify(payload)
			});
			
			const resJson = await r.json().catch(() => null);
			Telemetry.send('activate_vendorjob_response', { ok: r.ok, resJson });


			if (!r.ok) {
			  const errTxt = await r.text().catch(() => `HTTP ${r.status}`);
			  Telemetry.send('set_status_1008_error', { jobId: String(jobId), errTxt });
			  // Ik laat je toch doorgaan naar vendor, maar je status gaat mogelijks niet 1008 zijn
			} else {
			  Telemetry.send('set_status_1008_success', { jobId: String(jobId) });
			}
		  } catch (e) {
			Telemetry.send('set_status_1008_exception', { jobId: String(jobId), message: String(e?.message || e) });
		  }

		  // ‚úÖ 2) pas daarna naar vendor
		  Telemetry.send('resume_go_vendor', { jobId: String(jobId) });
		  goToVendor(jobId);
		};


		// ============================================================
		// ‚úÖ Actieve job (Status=1008) = ENKEL verderzetten
		// ============================================================
		const active = (cachedJobs || [])
		  .filter(j => Number(j?.Status) === 1008)
		  .sort((a, b) => String(b?.Date || '').localeCompare(String(a?.Date || '')))[0] || null;

		if (active?.Id) {
		  await botui.message.add({
			type: 'html',
			content:
			  `üü¢ <b>Je hebt al een actieve job</b> in deze ruimte.<br>` +
			  `${esc(active.Description || '')}<br><br>` +
			  `Je kan nu enkel deze job verderzetten.`
		  });

		  const act = await botui.action.button({
			action: [{ text: '‚ñ∂Ô∏è Verdergaan', value: 'go' }]
		  });

		  if (act.value === 'go') {
			Telemetry.send('resume_active_job', { jobId: active.Id });
			goToVendor(active.Id);
			return;
		  }
		}

		// ============================================================
		// ‚úÖ Geen actieve job ‚Üí toon OPEN jobs (Status=1012)
		// ============================================================
		const open1012 = (cachedJobs || [])
		  .filter(j => Number(j?.Status) === 1012)
		  .sort((a, b) => String(b?.Date || '').localeCompare(String(a?.Date || '')));

		if (open1012.length) {
		  await botui.message.add({
			type: 'html',
			content:
			  `üìù <b>Je hebt nog openstaande meldingen</b> in deze ruimte.<br>` +
			  `Welke wil je verderzetten?`
		  });

		  const actions = open1012.slice(0, 10).map(j => ({
			text: `üìù ${esc(j.Description || ('Job ' + j.Id))}`,
			value: String(j.Id)
		  }));

		  const pick = await botui.action.button({ action: actions });

		  Telemetry.send('resume_open_job_1012', { jobId: pick.value });
		  await resumeJobAndGo(pick.value);
		  return;
		}

	  } catch (e) {
		console.error('preload error', e);
		await botui.message.add({
		  type: 'html',
		  content:
			'‚ùå Fout bij laden van context (jobs/ServiceWO‚Äôs).'
			+ `<br><small>${esc(String(e.message)).slice(0, 400)}</small>`
		});
	  }
}



  let cleaningProgramText = ""; // wordt gevuld door showLocation()

  async function showLocation(){
    const r = await fetch(
      `${endpointLoc}?id=${encodeURIComponent(id)}&lang=${lang}&env=${prefix}`
    );
    const d = await r.json();
    if(!d.description) return;
    const el = document.getElementById('ruimte-info');

    el.innerHTML = `
      <div style="font-size:.8rem;margin-bottom:.25rem;color:${isTestEnv ? '#b45309' : '#374151'}">
        ${isTestEnv ? 'üß™ TEST-omgeving' : ''}
      </div>
      ${d.description}
      <div class="type">
        ${
          isEquipment
            ? (isFr ? 'üîß Installation' : 'üîß Installatie')
            : (isFr ? 'üè¢ Espace'       : 'üè¢ Ruimte')
        }
      </div>
    `;
    el.style.display='flex';
    cleaningProgramText = d.cleaningProgramFormatted || "";
  }

  /* ======================================================================
     FOTO-HELPERS
  ====================================================================== */
  async function compressImageIfNeeded(file, { maxW=1600, maxH=1600, quality=0.8 } = {}) {
    if (!/^image\//.test(file.type)) return file; // alleen images
    const img = new Image();
    const url = URL.createObjectURL(file);
    await new Promise((res, rej) => {
      img.onload  = res;
      img.onerror = rej;
      img.src     = url;
    });
    let { width:w, height:h } = img;
    const scale = Math.min(1, maxW / w, maxH / h);
    URL.revokeObjectURL(url);
    if (scale >= 1) return file; // al klein genoeg

    const canvas = document.createElement('canvas');
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    const ctx = canvas.getContext('2d', { alpha: true });
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const blob = await new Promise(res =>
      canvas.toBlob(
        res,
        file.type === 'image/png' ? 'image/png' : 'image/jpeg',
        quality
      )
    );
    return new File(
      [blob],
      file.name.replace(/\.(jpe?g|png)$/i, (file.type==='image/png' ? '.png' : '.jpg')),
      { type: blob.type }
    );
  }

  function sanitizeName(name){
    return String(name||'').replace(/[^\w.\-()+ ]+/g,'_').trim() || 'upload.bin';
  }
  function guessMimeByName(name){
    const n = (name||'').toLowerCase();
    if(n.endsWith('.jpg')||n.endsWith('.jpeg')) return 'image/jpeg';
    if(n.endsWith('.png'))  return 'image/png';
    if(n.endsWith('.pdf'))  return 'application/pdf';
    return 'application/octet-stream';
  }
  function fileToBase64(file){
    return new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>{
        const s=String(r.result||'');
        const i=s.indexOf('base64,');
        res(i>0 ? s.substring(i+7) : s);
      };
      r.onerror=()=>rej(r.error||new Error('Kon bestand niet lezen'));
      r.readAsDataURL(file);
    });
  }

  async function pickOnePhotoWithConfirm() {
    const $file = document.getElementById('portal-photo');
    if (!$file) {
      await botui.message.add({
        content: isFr ? '‚ùå Entr√©e fichier manquante.' : '‚ùå Bestand-input ontbreekt.'
      });
      return { status: 'cancel' };
    }

    // dialoog openen + wachten op selectie
    $file.value = '';
    $file.click();
    const f = await new Promise(res => {
      const h = () => {
        $file.removeEventListener('change', h);
        res($file.files && $file.files[0]);
      };
      $file.addEventListener('change', h, { once: true });
    });
    if (!f) return { status: 'cancel' };

    const name = f.name;
    const mime = f.type || guessMimeByName(name);
    const kind = mime.startsWith('image/')
      ? 'image'
      : (mime === 'application/pdf' ? 'pdf' : 'other');

    // Korte preview
    let previewUrl = '';
    if (kind === 'image') {
      previewUrl = URL.createObjectURL(f);
      await botui.message.add({
        type: 'html',
        content: `<figure style="margin:0">
          <img src="${previewUrl}" alt="${esc(name)}"
               style="max-width:100%;height:auto;border:1px solid #ddd;border-radius:6px"/>
          <figcaption style="font-size:.85rem;color:#6b7280;margin-top:.25rem">
            ${esc(name)}
          </figcaption>
        </figure>`
      });
    } else {
      await botui.message.add({
        content: (isFr ? 'Fichier s√©lectionn√©: ' : 'Bestand geselecteerd: ') + esc(name)
      });
    }

    return { status: 'ok', file: f, kind, name, previewUrl };
  }

  async function askPhotosLoop() {
    while (true) {
      const add = await botui.action.button({
        action: [
          { text: isFr ? 'üìé Ajouter une photo ou document'
                       : 'üìé Foto of document toevoegen', value: 'add' },
          { text: isFr ? '‚û°Ô∏è Continuer' : '‚û°Ô∏è Doorgaan', value: 'next' }
        ]
      });
      if (add.value === 'next') break;

      const result = await pickOnePhotoWithConfirm();
      if (result?.status !== 'ok') continue;

      const { file: f, kind, name, previewUrl } = result;

      const remarkPrompt = isFr
        ? (kind === 'image'
            ? 'Votre remarque pour cette photo (max 200):'
            : 'Votre remarque pour ce document (max 200):')
        : (kind === 'image'
            ? 'Jouw opmerking bij deze foto (max 200):'
            : 'Jouw opmerking bij dit document (max 200):');

      const t = await botui.action.text({
        addMessage: { content: remarkPrompt },
        action: {
          placeholder: isFr
            ? 'D√©crivez la photo/le document‚Ä¶'
            : 'Beschrijf de foto/het document‚Ä¶',
          maxLength: 200
        }
      });

      const remark = (t?.value || '').trim().slice(0, 200);

      pickedFiles.push({
        file: f,
        kind,
        name,
        previewUrl: previewUrl || '',
        remark
      });
    }
  }

  async function uploadCustomerDoc({ jobId, email, file, description }) {
    const endpoint = '/.netlify/functions/jobdocupload' + (isTestEnv ? '?test=1' : '');

    const safeFile  = await compressImageIfNeeded(file);
    const fileName  = sanitizeName(safeFile.name);
    const mimeType  = safeFile.type || guessMimeByName(fileName);
    const base64    = await fileToBase64(safeFile);

    if (base64.length > 6_000_000) {
      throw new Error(
        (isFr ? 'Fichier trop volumineux' : 'Bestand te groot') + ' (~>4.5MB).'
      );
    }

    const payload = {
      action: 'ADD_JOB_DOC',
      jobId: String(jobId),
      fileName,
      description: (description || fileName).substring(0, 200),
      base64
    };

    if (email && email.trim().length > 0) {
      payload.email = email.trim();
    }

    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => `HTTP ${resp.status}`);
      throw new Error(`Upload mislukt: ${txt}`);
    }
    return resp.json();
  }

  /* ======================================================================
     TELEMETRIE
  ====================================================================== */
  const Telemetry = (()=> {
    const base = {
      code: String(code ?? ''),
      path: location.pathname,
      lang,
      id: (typeof id !== 'undefined' && id) ? String(id) : String(code),
      isEquipment,
      env: prefix
    };
    async function send(type, extra = {}) {
      const payload = { type, ts: Date.now(), href: location.href, ...base, ...extra };
      const json = JSON.stringify(payload);
      try {
        if (navigator.sendBeacon) {
          const ok = navigator.sendBeacon(
            '/.netlify/functions/formlog',
            new Blob([json], { type: 'application/json' })
          );
          if (ok) return;
        }
        await fetch('/.netlify/functions/formlog', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: json,
          keepalive: true,
          credentials: 'omit',
          cache: 'no-store'
        }).catch(()=>{});
      } catch(_) {}
    }
    return { send };
  })();
  Telemetry.send('url_load');
  addEventListener('pagehide', () => Telemetry.send('pagehide'), { capture: true });

  /* ======================================================================
     UI INIT
  ====================================================================== */
  const btnNl = document.getElementById('switch-nl');
  const btnFr = document.getElementById('switch-fr');
  btnNl.onclick = () => {
    Telemetry.send('language_switch', {to:'nl'});
    const u = new URL(window.location.href);
    u.searchParams.set('lang','nl');
    window.location.href = u;
  };
  btnFr.onclick = () => {
    Telemetry.send('language_switch', {to:'fr'});
    const u = new URL(window.location.href);
    u.searchParams.set('lang','fr');
    window.location.href = u;
  };

  const phoneLink = '<a href="tel:+3278152300">üìû +32 78 152 300</a>';
  let   omschrijving = '';


  /* ======================================================================
     CHATFLOW ‚Äì INIT
  ====================================================================== */
  async function init() {
    // Altijd eerst BotUI initialiseren
    botui = new BotUI('botui-app');

    if (!code) {
      await botui.message.add({
        type:'html',
        content: isFr ? '‚ùå Code QR manquante.' : '‚ùå QR-code ontbreekt.'
      });
      Telemetry.send('missing_code');
      return;
    }
    await startChat();
  }

  /* ======================================================================
     CHATFLOW ‚Äì START
  ====================================================================== */
  async function startChat(){
	  Telemetry.send('step', { step:'start', stepIndex:0 });

	  // Locatiekaart bovenaan vullen
	  showLocation();

	  await botui.message.add({
		type:'html',
		content: isFr
		  ? 'Bonjour, je suis votre assistant <span style="color:#EE7E00;font-weight:bold;">ATALIAN</span>.<br>Je charge les signalements en cours‚Ä¶'
		  : 'Hallo, ik ben je <span style="color:#EE7E00;font-weight:bold;">ATALIAN</span>-assistent.<br>Ik haal even de openstaande meldingen op‚Ä¶'
	  });

	  await preloadContextAndShow();

	  // üëâ Nieuw: meteen ServiceWO knoppen tonen
	  const ticketSvcWOs = (cachedSvcWO || []).filter(x => isTicketTrue(x?.Ticket));

	  if (!ticketSvcWOs.length) {
		await botui.message.add({
		  content: isFr
			? '‚ùå Aucun service (ticket) n‚Äôest disponible pour cet endroit.'
			: '‚ùå Er is geen service (ticket) beschikbaar voor deze locatie.'
		});
		Telemetry.send('no_servicewo_available');
		return;
	  }

	  await botui.message.add({
		content: isFr
		  ? 'Que voulez-vous faire ? Choisissez un service :'
		  : 'Wat wil je doen? Kies een service:'
	  });

	  const actions = ticketSvcWOs.map(x => ({
		text: `üìç ${esc(x.Description)}`,
		value: x.Id
	  }));

	  const res = await botui.action.button({ action: actions });
	  const chosenId = res.value;

	  const chosen = ticketSvcWOs.find(x => x.Id === chosenId) || null;
	  const act = toInt(chosen?.Activiteit ?? chosen?._Activiteit);

	  // Reset vorige keuzes
	  selectedServiceWOId = null;
	  selectedOtherServiceWO = null;

	  // Cleaning = activiteit 10..40
	  const isCleaning = (act !== null && act >= 10 && act <= 40);

	  if (isCleaning) {
		selectedServiceWOId = chosenId;
	  } else {
		selectedOtherServiceWO = chosen;
	  }

	  Telemetry.send('servicewo_selected', { id: chosenId, activiteit: act, isCleaning });

	  return await submitAutoJobFromServiceWO(chosen, isCleaning);

	}

	async function submitAutoJobFromServiceWO(chosenSvcWO, isCleaning){
	  Telemetry.send('step', { step:'auto_submit_start', isCleaning });

	  // =====================================================================
	  // ‚ö†Ô∏è DEV-ONLY: LOCALHOST GPS BYPASS
	  // Verwijder dit blok zodra je op staging/prod test met echte smartphones.
	  // =====================================================================
	  const __DEV_LOCALHOST_GPS_BYPASS__ =
		location.hostname === 'localhost' || location.hostname === '127.0.0.1';
	  // =====================================================================

	  // 1) Vraag email (voor wie is de uitvoerder / audit trail)
	  await botui.message.add({
		content: isFr ? 'Votre adresse e-mail ?' : 'Wat is je e-mailadres?'
	  });

	  const resMail = await botui.action.text({
		action: { placeholder: 'jouw@email.com' }
	  });

	  const email = (resMail?.value || '').trim();
	  if (!isValidEmail(email)) {
		await botui.message.add({
		  content: isFr ? 'Adresse e-mail invalide.' : 'Ongeldig e-mailadres.'
		});
		Telemetry.send('email_invalid');
		return await submitAutoJobFromServiceWO(chosenSvcWO, isCleaning);
	  }

		// ‚úÖ Email bewaren voor vendor.html
		try {
		  sessionStorage.setItem('vendor_session_email', email.toLowerCase());
		  sessionStorage.setItem('vendor_session_ts', String(Date.now()));
		} catch {}
	  

	  // 2) Geolocatie ophalen (VERPLICHT, behalve localhost dev)
	  await botui.message.add({
		content: isFr ? 'üìç Localisation‚Ä¶' : 'üìç Locatie ophalen‚Ä¶'
	  });

	  const geo = await getGeoFix({ timeoutMs: 8000, enableHighAccuracy: true });

	  // üîí GPS is verplicht: geen fix = STOP + uitleg + retry
	  // üß™ DEV uitzondering: localhost/127.0.0.1 mag door (FAKE geoLine)
	  if (!geo.ok && !__DEV_LOCALHOST_GPS_BYPASS__) {
		Telemetry.send('gps_required_block', {
		  reason: geo.reason,
		  message: geo.message || ''
		});

		await botui.message.add({
		  type: 'html',
		  content: isFr
			? `‚ùå <b>Localisation GPS requise</b>.<br>
			   Activez la localisation (GPS) et autorisez ce site.<br>
			   Ensuite, r√©essayez.`
			: `‚ùå <b>GPS is verplicht</b>.<br>
			   Zet je locatie (GPS) aan en geef toestemming voor deze site.<br>
			   Probeer daarna opnieuw.`
		});

		const choice = await botui.action.button({
		  action: [
			{ text: isFr ? 'üîÑ R√©essayer' : 'üîÑ Opnieuw proberen', value: 'retry' },
			{ text: isFr ? '‚ÑπÔ∏è Aide' : '‚ÑπÔ∏è Hulp', value: 'help' }
		  ]
		});

		if (choice.value === 'help') {
		  await botui.message.add({
			type: 'html',
			content: isFr
			  ? `üëâ iPhone : R√©glages ‚Üí Confidentialit√© et s√©curit√© ‚Üí Services de localisation.<br>
				 üëâ Android : Param√®tres ‚Üí Localisation.<br>
				 üëâ Navigateur : autorisez ‚ÄúLocalisation‚Äù pour ce site.`
			  : `üëâ iPhone: Instellingen ‚Üí Privacy en beveiliging ‚Üí Locatievoorzieningen.<br>
				 üëâ Android: Instellingen ‚Üí Locatie.<br>
				 üëâ Browser: geef ‚ÄúLocatie‚Äù toestemming voor deze site.`
		  });
		}

		return await submitAutoJobFromServiceWO(chosenSvcWO, isCleaning);
	  }

	  // 3) Titel bouwen (knopnaam + datum/uur)
	  const nowStr = formatDateTimeLocal(new Date());
	  const knopNaam = String(chosenSvcWO?.Description || 'Service').trim();
	  const title = `${knopNaam} ‚Äî ${nowStr}`;

	  // 4) ReportText bouwen (geo + tijd + basiscontext)
	  // üß™ DEV-ONLY: als geo faalt op localhost, log duidelijk dat het een bypass is
	  const reportBody = buildPortalLogLine({ channel: 'PortalSelf', email, geo });

	  // 5) ServiceWOId bepalen
	  const serviceWorkOrderId = chosenSvcWO?.Id || null;

	  // 6) Payload
	  const payload = {
		id,
		type: typeStr,
		JobDescr: title,
		ReportText: reportBody,
		Email: email,
		lang,
		env: prefix,
		Activity: toInt(chosenSvcWO?.Activiteit ?? chosenSvcWO?._Activiteit),
		ServiceWOId: serviceWorkOrderId
	  };

	  try {
		Telemetry.send('submit_attempt', {
		  isCleaning,
		  serviceWorkOrderId,
		  geoOk: geo.ok,
		  localhostBypass: (!geo.ok && __DEV_LOCALHOST_GPS_BYPASS__)
		});

		const endpointMelding =
		  '/.netlify/functions/melding' + (isTestEnv ? '?test=1' : '');

		const r = await fetch(endpointMelding, {
		  method: 'POST',
		  headers: { 'Content-Type': 'application/json' },
		  body: JSON.stringify(payload)
		});

		let raw = await r.text();
		if (raw.includes('&quot;')) raw = raw.replace(/&quot;/g, '"');

		let resp;
		try {
		  resp = JSON.parse(raw);
		  if (resp && typeof resp.object === 'string') {
			const inner = resp.object.includes('&quot;')
			  ? resp.object.replace(/&quot;/g, '"')
			  : resp.object;
			resp = JSON.parse(inner);
		  }
		} catch {
		  resp = { _raw: raw };
		}

		if (!r.ok) throw new Error(resp?.error || `HTTP ${r.status}`);

		const jobId =
		  resp?.JobId || resp?.jobId ||
		  resp?.Job?.Id || resp?.job?.Id ||
		  resp?.Id || resp?.id || null;

		await botui.message.add({
		  content: isFr
			? '‚úÖ D√©marr√©. Vous allez √™tre redirig√©‚Ä¶'
			: '‚úÖ Gestart. Je wordt doorgestuurd‚Ä¶'
		});

		Telemetry.send('submit_success', {
		  jobId,
		  geoOk: geo.ok,
		  localhostBypass: (!geo.ok && __DEV_LOCALHOST_GPS_BYPASS__)
		});

		// üëâ Meteen naar vendor.html om af te werken
		if (jobId) {
		  const v = new URL('/vendor.html', window.location.origin);
		  v.searchParams.set('jobId', String(jobId));
		  v.searchParams.set('lang', lang);
		  if (isTestEnv) v.searchParams.set('test', '1');
		  v.searchParams.set('src', window.location.pathname + window.location.search);
		  window.location.href = v.toString();
		  return;
		}

		window.location.reload();

	  } catch (e) {
		console.error(e);
		await botui.message.add({
		  content: isFr ? '‚ùå Erreur lors de l‚Äôenvoi.' : '‚ùå Fout bij verzenden.'
		});
		Telemetry.send('submit_error', { message: String(e?.message || e) });
	  }
	}



  async function showCleaningProgramAndContinue() {
    Telemetry.send('poets_info_viewed');
    await botui.message.add({
      type: 'html',
      content: isFr
        ? `<b>Programme de nettoyage :</b><br>${cleaningProgramText}`
        : `<b>Poetsprogramma:</b><br>${cleaningProgramText}`
    });

    const vervolg = await botui.action.button({
      action: [
        {
          text: isFr ? 'üßπ Nouveau signalement Nettoyage'
                     : 'üßπ Schoonmaak Melding maken',
          value: "cleaning_ticket"
        },
        {
          text: isFr ? 'üí° Autre Probl√®me' : 'üí° Ander Probleem',
          value: "other_problem"
        },
        {
          text: isFr ? "‚ÑπÔ∏è Plus d'info" : "‚ÑπÔ∏è Meer info",
          value: "info"
        }
      ]
    });

    if (vervolg.value === "cleaning_ticket") return await startCleaningFlow();
    if (vervolg.value === "other_problem")    return await startGenericFlow();

    await botui.message.add({
      type: 'html',
      content: isFr
        ? 'Vous allez √™tre redirig√© vers notre site web externe.'
        : 'Je wordt nu doorverwezen naar onze externe website.'
    });
    setTimeout(() => {
      window.location.href = isFr
        ? 'https://www.atalian.be/?lang=fr'
        : 'https://www.atalian.be/?lang=nl';
    }, 2000);
  }

  async function startGenericFlow() {
    return await startProbleemFlow(false);
  }
  async function startCleaningFlow() {
    return await startProbleemFlow(true);
  }

  async function startProbleemFlow(isCleaning) {
    Telemetry.send('step', { step:'flow_start', stepIndex:1, isCleaning });
    if (!parsedQR) {
      await botui.message.add({
        type: 'html',
        content: '<span style="color:red;font-weight:bold">Geen geldige QR-code. Je kunt geen melding doen zonder geldige code.</span>'
      });
      Telemetry.send('invalid_qr');
      return;
    }
    await askUrgency(isCleaning);
  }

  function askUrgency(isCleaning){
    Telemetry.send('step', { step:'ask_urgent', stepIndex:2, isCleaning });
    return botui.message.add({
      content: isFr ? 'Le probl√®me est urgent ?' : 'Is het dringend?'
    }).then(() =>
      botui.action.button({
        action:[
          {text:isFr?'üö® Oui':'üö® Ja', value:'ja'},
          {text:isFr?'‚è± Non':'‚è± Nee', value:'nee'}
        ]
      })
    ).then(res => {
      Telemetry.send('urgent_answer', {
        urgent: res.value==='ja',
        isCleaning
      });

      const isUrgent = res.value === 'ja';

      if (isCleaning) {
        return askCleaningServiceWO(isUrgent);
      }
      if (hasOtherActivities(cachedSvcWO)) {
        return askOtherServiceWO(isUrgent);
      }
      return askDescription(isUrgent, false);
    });
  }

  async function askCleaningServiceWO(isUrgent) {
    Telemetry.send('step', {
      step: 'ask_service_wo',
      stepIndex: 3,
      isUrgent
    });
    const relevantSvcWOs = getRelevantCleaningServiceWOs(cachedSvcWO);

    if (relevantSvcWOs.length === 0) {
      await botui.message.add({
        content: isFr
          ? 'Aucun programme de nettoyage actif n‚Äôa pu √™tre trouv√© pour cette zone.'
          : 'Er kon geen actief schoonmaakprogramma voor deze zone gevonden worden.'
      });
      return await askDescription(isUrgent, true);
    }

    await botui.message.add({
      content: isFr
        ? 'Pour quel service de nettoyage signalez-vous un probl√®me ?'
        : 'Voor welke schoonmaakservice wil je een melding maken?'
    });

    const actions = relevantSvcWOs.map(x => ({
      text: `üìç ${esc(x.Description)}`,
      value: x.Id
    }));

    const res = await botui.action.button({ action: actions });
    selectedServiceWOId = res.value;
    Telemetry.send('service_wo_selected', { id: selectedServiceWOId });
    return await askDescription(isUrgent, true);
  }

  async function askOtherServiceWO(isUrgent) {
    Telemetry.send('step', {
      step: 'ask_other_service_wo',
      stepIndex: 3,
      isCleaning: false
    });

    const relevantSvcWOs = getRelevantOtherServiceWOs(cachedSvcWO);

    if (relevantSvcWOs.length === 0) {
      return await askDescription(isUrgent, false);
    }

    await botui.message.add({
      content: isFr
        ? 'Pour quel service signalez-vous un autre probl√®me ?'
        : 'Voor welke dienst wil je een ander probleem melden?'
    });

    const actions = relevantSvcWOs.map(x => ({
      text: `üìç ${esc(x.Description)}`,
      value: x.Id
    }));

    actions.push({
      text: isFr ? '‚ûï Autre' : '‚ûï Andere',
      value: 'OTHER_GENERIC'
    });

    const res = await botui.action.button({ action: actions });

    if (res.value === 'OTHER_GENERIC') {
      selectedOtherServiceWO = null;
      return await askDescription(isUrgent, false);
    }

    selectedOtherServiceWO =
      relevantSvcWOs.find(x => x.Id === res.value) || null;

    return await askDescription(isUrgent, false);
  }

  async function askDescription(isUrgent, isCleaning) {
    await botui.message.add({
      content: isFr
        ? 'Quel est le probl√®me exactement ?'
        : 'Wat is het probleem precies?'
    });
    let res = await botui.action.text({
      action: { placeholder: isFr ? 'D√©crivez‚Ä¶' : 'Beschrijf‚Ä¶' }
    });
    omschrijving = (res?.value || '').trim();
    if (!omschrijving) {
      await botui.message.add({
        content: isFr
          ? 'üìù Une petite description aide l‚Äô√©quipe.'
          : 'üìù Een korte beschrijving helpt het team.'
      });
      res = await botui.action.text({
        action: {
          placeholder: isFr
            ? 'Ex.: fuite au lavabo du 2e'
            : 'Bv.: lekkende kraan in lokaal 2.12'
        }
      });
      omschrijving = (res?.value || '').trim();
    }

    await botui.message.add({
      content: isFr
        ? 'Souhaitez-vous ajouter des photos ?'
        : 'Wil je foto‚Äôs toevoegen?'
    });
    await askPhotosLoop();

    Telemetry.send('desc_entered', {
      length: omschrijving.length,
      withPhotos: Array.isArray(pickedFiles) && pickedFiles.length > 0,
      isUrgent,
      isCleaning
    });

    return askEmail(isUrgent, isCleaning);
  }

  async function askEmail(isUrgent, isCleaning){
    const stepIndex = isCleaning ? 5 : 4;
    Telemetry.send('step', { step:'ask_email', stepIndex, isCleaning });

    await botui.message.add({
      content: isFr
        ? 'Quelle est votre adresse e-mail ?'
        : 'Wat is je e-mailadres?'
    });
    const res = await botui.action.text({
      action: { placeholder: 'jouw@email.com' }
    });
    const email = (res.value || '').trim();
    if (!isValidEmail(email)) {
      await botui.message.add({
        content: isFr
          ? 'Adresse e-mail invalide.'
          : 'Ongeldig e-mailadres.'
      });
      Telemetry.send('email_invalid');
      return askEmail(isUrgent, isCleaning);
    }
	
	// ‚úÖ Email bewaren voor vendor.html (ook handig als user later naar vendor gaat)
	try {
	  sessionStorage.setItem('vendor_session_email', email.toLowerCase());
	  sessionStorage.setItem('vendor_session_ts', String(Date.now()));
	} catch {}
	
    Telemetry.send('email_entered');

    const meldingTekst = omschrijving;

    let activityCode = null;
    let serviceWorkOrderId = null;

    if (isCleaning) {
      activityCode       = 20;
      serviceWorkOrderId = selectedServiceWOId;
    } else if (selectedOtherServiceWO) {
      activityCode = toInt(
        selectedOtherServiceWO.Activiteit
        ?? selectedOtherServiceWO._Activiteit
      );
      serviceWorkOrderId = selectedOtherServiceWO.Id;
    }

    await botui.message.add({ content: isFr ? 'üìç Localisation‚Ä¶' : 'üìç Locatie ophalen‚Ä¶' });
	const geo = await getGeoFix({ timeoutMs: 8000, enableHighAccuracy: true });

	const reportBody = buildPortalLogLine({ channel: 'PortalSelf', email, geo });


    const payload = {
      id,
      type: typeStr,
      JobDescr: meldingTekst,
      ReportText: reportBody,
      Email: email,
      lang,
      env: prefix,
      Activity: activityCode,
      ServiceWOId: serviceWorkOrderId
    };

    let jobId = null;

    try {
      Telemetry.send('submit_attempt', {
        urgent: isUrgent,
        withPhotos: Array.isArray(pickedFiles) && pickedFiles.length > 0,
        isCleaning,
        serviceWorkOrderId
      });

      const endpointMelding =
        '/.netlify/functions/melding' + (isTestEnv ? '?test=1' : '');

      const r = await fetch(endpointMelding, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      let raw = await r.text();
      let resp;
      try {
        if (raw.includes('&quot;')) raw = raw.replace(/&quot;/g, '"');
        resp = JSON.parse(raw);
        if (resp && typeof resp.object === 'string') {
          const inner = resp.object.includes('&quot;')
            ? resp.object.replace(/&quot;/g, '"')
            : resp.object;
          resp = JSON.parse(inner);
        }
      } catch (parseErr) {
        console.warn('melding JSON parse error:', parseErr, raw);
        resp = { _raw: raw };
      }

      if (!r.ok) throw new Error(resp?.error || `HTTP ${r.status}`);

      jobId =
        resp?.JobId || resp?.jobId ||
        resp?.Job?.Id || resp?.job?.Id ||
        resp?.Id     || resp?.id     || null;

      if (!jobId && typeof raw === 'string') {
        const m = raw.match(/"Id"\s*:\s*"?(\d{5,})"?/);
        if (m) jobId = m[1];
      }

      if (!jobId) {
        try {
          const jres = await fetch(
            `/.netlify/functions/jobs?code=${encodeURIComponent(code)}&env=${prefix}`
          );
          let jtxt = await jres.text();
          if (jtxt.includes('&quot;')) jtxt = jtxt.replace(/&quot;/g, '"');
          let jdata = JSON.parse(jtxt);
          if (jdata && typeof jdata.object === 'string') {
            jdata = JSON.parse(jdata.object.replace(/&quot;/g, '"'));
          }
          const jobs = Array.isArray(jdata?.Jobs) ? jdata.Jobs : [];
          const normalizedDesc = String(meldingTekst || '').trim();

          const cand = jobs
            .filter(j =>
              String(j.Description || '').trim() === normalizedDesc ||
              String(j.Report || '').includes(email)
            )
            .sort((a, b) => (b.Date || '').localeCompare(a.Date || ''));

          if (cand.length) jobId = cand[0].Id;
        } catch (e) {
          console.warn('fallback jobs fetch error', e);
        }
      }

      if (!jobId) {
        await botui.message.add({
          content: isFr
            ? '‚ùå Er is een probleem opgetreden. Je melding is mogelijk niet succesvol ingediend. Probeer het later opnieuw.'
            : '‚ùå Un probl√®me est survenu. Votre signalement n\'a peut-√™tre pas √©t√© soumis avec succ√®s. Veuillez r√©essayer plus tard.'
        });
        Telemetry.send('jobid_missing_fallback_fail');
        return;
      }

      await botui.message.add({
        content: isFr
          ? 'Merci ! Votre signalement a √©t√© envoy√©.'
          : 'Bedankt! Jouw melding is verzonden.'
      });
      Telemetry.send('submit_success', { jobId });

      if (Array.isArray(pickedFiles) && pickedFiles.length) {
        await botui.message.add({
          content: isFr
            ? 'T√©l√©versement des pi√®ces‚Ä¶'
            : 'Bestanden uploaden‚Ä¶'
        });

        for (const it of pickedFiles) {
          try {
            const baseRemark = (it.remark || '').trim();
            const fallback   = (omschrijving || it.name || '').trim();
            const docDescr   = (baseRemark ? baseRemark : fallback).slice(0, 200);

            await uploadCustomerDoc({
              jobId,
              email,
              file: it.file,
              description: docDescr
            });

            await botui.message.add({
              content: '‚úÖ ' + (isFr ? 'Ajout√©: ' : 'Toegevoegd: ') + it.name
            });
          } catch (e) {
            await botui.message.add({
              content: '‚ùå ' + (isFr ? '√âchec: ' : 'Mislukt: ')
                     + it.name + ' ‚Äî ' + (e.message || e)
            });
          }
        }

        Telemetry.send('doc_upload_batch_done', {
          count: pickedFiles.length
        });
		pickedFiles = [];
      }

      if (isUrgent) {
        await botui.message.add({
          type: 'html',
          content: isFr
            ? `‚ö†Ô∏è <b>Probl√®me urgent :</b> Appelez ${phoneLink}`
            : `‚ö†Ô∏è <b>Dringend probleem:</b> Bel onmiddellijk ${phoneLink}`
        });
        return;
      }

	await botui.message.add({
	  content: isFr ? 'Que voulez-vous faire maintenant?' : 'Wat wil je nu doen?'
	});

	const actions = [
	  { text: isFr ? 'üîÑ Nouveau signalement' : 'üîÑ Nieuwe melding', value: 'restart' }
	];

	if (sourceUrl) {
	  actions.push({
		text: isFr ? 'üè¢ Revenir √† l‚Äô√©cran de choix' : 'üè¢ Naar keuzescherm gaan',
		value: 'back'
	  });
	}

	actions.push({
	  text: isFr ? "‚ÑπÔ∏è Plus d'info" : '‚ÑπÔ∏è Meer info',
	  value: 'info'
	});

	const k = await botui.action.button({ action: actions });

	if (k.value === 'back' && sourceUrl) {
	  Telemetry.send('back_to_source', { sourceUrl });
	  window.location.href = sourceUrl;
	} else if (k.value === 'restart') {
	  Telemetry.send('restart');
	  window.location.reload();
	} else {
	  Telemetry.send('external_info');
	  window.location.href = isFr
		? 'https://www.atalian.be/?lang=fr'
		: 'https://www.atalian.be/?lang=nl';
	}



    } catch (e) {
      console.error(e);
      await botui.message.add({
        content: isFr
          ? 'Erreur lors de l‚Äôenvoi.'
          : 'Fout bij verzenden.'
      });
      Telemetry.send('submit_error', {
        message: String((e && e.message) || e)
      });
    }
  }

  /* ======================================================================
     IDLE DETECTIE + SCROLL
  ====================================================================== */
  let lastActivity = Date.now();
  ['click','keydown','touchstart'].forEach(ev =>
    document.addEventListener(ev, () => { lastActivity = Date.now(); }, {passive:true})
  );
  const IDLE_MS = 45000;
  setInterval(() => {
    const inactive = Date.now()-lastActivity;
    if (inactive > IDLE_MS){
      Telemetry.send('idle', { inactiveMs: inactive });
      lastActivity = Date.now();
    }
  }, 5000);

  window.addEventListener('load', () => {
    const it = setInterval(() => {
      const b = document.querySelector('#botui-app');
      if (b && b.offsetTop > 0){
        window.scrollTo({
          top: Math.max(b.offsetTop-100,0),
          behavior:'smooth'
        });
        clearInterval(it);
      }
    }, 300);
  });

  /* ======================================================================
     START
  ====================================================================== */
  init();
  /* ======================================================================
     EIND MODULE
  ====================================================================== */
  </script>

  <!-- Verborgen file input voor foto‚Äôs/doc‚Äôs (0..n) -->
  <input id="portal-photo" type="file"
         accept="image/*,application/pdf"
         capture="environment"
         style="display:none" />

</body>
</html>
