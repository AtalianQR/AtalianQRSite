<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wat wil je melden? / Que voulez-vous signaler ?</title>

  <!-- Favicon & externe styles -->
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />

  <style>
    :root{ --atalian:#ee7e00; --bg:#f7fafc; --card:#fff; --text:#0f172a; --muted:#475569 }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background-image:
        linear-gradient(rgba(255,255,255,.82), rgba(255,255,255,.82)),
        url('/building-cleaning.png');
      background-size:cover; background-position:center; background-attachment:fixed
    }
    .wrap{ max-width:880px; margin:0 auto; padding:16px }
    header{ display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap }
    header img{ height:42px; background:rgba(255,255,255,.92); padding:4px; border-radius:10px }
    .title{ font-weight:800 }
    .sub{ color:var(--muted); font-size:13px; display:flex; align-items:center; gap:6px }
    .lang{ margin-left:auto; display:flex; gap:10px; align-items:center }
    .lang a{ text-decoration:none; padding:6px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.1); background:#fff; color:#0f172a }
    .card{ background:var(--card); border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.08) }
    #bot-card{ border:2px solid var(--atalian) }
    .badge{ color:var(--muted); font-size:12px }
    .ruimte-label{ display:none; flex-direction:column; gap:2px; align-items:flex-start; margin-top:6px }
    .ruimte-label .type{ font-size:12px; color:#64748b }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/AtalianLogo.png" alt="Atalian" />
      <div>
        <div class="title" id="hdr-title">Wat wil je melden?</div>
        <div class="sub"><span id="hdr-type">‚Äî</span><span class="badge" id="hdr-id"></span></div>
        <div id="ruimte-info" class="ruimte-label">
          <span id="ruimte-name"></span>
          <span class="type" id="ruimte-type"></span>
        </div>
      </div>
      <nav class="lang">
        <a id="btn-lang-nl" href="#">üá≥üá± NL</a>
        <a id="btn-lang-fr" href="#">üá´üá∑ FR</a>
      </nav>
    </header>

    <div id="bot-card" class="card">
      <div id="botui-app" class="botui"></div>
    </div>

    <div class="badge" id="foot-msg"></div>
  </div>

  <!-- Vue & BotUI -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>

  <!-- Portal logica (NL/FR) -->
  <script type="module">
  (async () => {
    // ===== Pipe (|) in query naar & omzetten (sommige scanners) =====
    (function fixPipes(){
      const raw = location.search;
      if (raw.includes('|')) {
        location.replace(location.origin + location.pathname + raw.replace(/\|/g, '&') + location.hash);
      }
    })();

    // ===== Taal =====
    const qs   = new URLSearchParams(location.search);
    const langQ = (qs.get('lang')||'').toLowerCase();
    let LANG = (langQ==='fr'||langQ==='nl') ? langQ : ((navigator.language||'').startsWith('fr') ? 'fr' : 'nl');

    const STR = {
      nl: {
        title: 'Wat wil je melden?',
        hello: 'Hallo, ik ben je <b>ATALIAN</b>-assistent.',
        fetching: 'Ik haal even de <b>openstaande meldingen</b> voor je op‚Ä¶',
        noOpen: '‚ÑπÔ∏è Er zijn momenteel <b>geen openstaande meldingen</b>.',
        openCount: (n)=>`üìã <b>${n}</b> openstaand(e):`,
        urgentQ: 'Is het dringend?',
        yes: 'Ja', no:'Nee',
        askDesc: 'Wat is het probleem precies?',
        descPh: 'Beschrijf het probleem‚Ä¶',
        askEmail: 'Wat is je e-mailadres?',
        emailPh: 'jouw@email.com',
        emailInvalid: '‚ùó Dat lijkt geen geldig e-mailadres. Probeer opnieuw.',
        creating: 'Ik maak je melding aan‚Ä¶',
        success: (id)=>`‚úÖ Je melding is geregistreerd${id?` onder nr <b>${id}</b>`:''}.`,
        fail: '‚ö†Ô∏è Registreren lukte niet. We sturen je melding alsnog door naar het team.',
        footer: 'Bedankt! Je kan dit venster sluiten of een nieuwe QR scannen.',
        entityRoom: 'Ruimte', entityEquip: 'Installatie',
        urgentPhone: (tel)=>`‚ö†Ô∏è <b>Dringend probleem:</b> Bel onmiddellijk <a href="tel:${tel}">üìû ${tel}</a>`
      },
      fr: {
        title: 'Que voulez-vous signaler ?',
        hello: 'Bonjour, je suis votre assistant <b>ATALIAN</b>.',
        fetching: 'Je r√©cup√®re les <b>tickets ouverts</b>‚Ä¶',
        noOpen: '‚ÑπÔ∏è Il n‚Äôy a actuellement <b>aucun ticket ouvert</b>.',
        openCount: (n)=>`üìã <b>${n}</b> ticket(s) ouvert(s) :`,
        urgentQ: 'Est-ce urgent ?',
        yes: 'Oui', no:'Non',
        askDesc: 'Quel est exactement le probl√®me ?',
        descPh: 'D√©crivez le probl√®me‚Ä¶',
        askEmail: 'Quelle est votre adresse e-mail ?',
        emailPh: 'votre@email.com',
        emailInvalid: '‚ùó Cette adresse e-mail ne semble pas valide. R√©essayez.',
        creating: 'Je cr√©e votre ticket‚Ä¶',
        success: (id)=>`‚úÖ Votre ticket a √©t√© enregistr√©${id?` sous le n¬∞ <b>${id}</b>`:''}.`,
        fail: '‚ö†Ô∏è Impossible d‚Äôenregistrer maintenant. Nous transmettons quand m√™me votre demande √† l‚Äô√©quipe.',
        footer: 'Merci ! Vous pouvez fermer cette fen√™tre ou scanner un autre QR.',
        entityRoom: 'Local', entityEquip: '√âquipement',
        urgentPhone: (tel)=>`‚ö†Ô∏è <b>Probl√®me urgent :</b> Appelez <a href="tel:${tel}">üìû ${tel}</a>`
      }
    };

    function applyLang(){
      document.getElementById('hdr-title').textContent = STR[LANG].title;
    }
    document.getElementById('btn-lang-nl').addEventListener('click', (e)=>{ e.preventDefault(); setLang('nl'); });
    document.getElementById('btn-lang-fr').addEventListener('click', (e)=>{ e.preventDefault(); setLang('fr'); });
    function setLang(l){
      LANG = l; applyLang();
      const url = new URL(location.href); url.searchParams.set('lang', l); history.replaceState({}, '', url);
    }
    applyLang();

    // ===== QR-parser met fallback =====
    let parseUltimoQR;
    try { ({ parseUltimoQR } = await import('./CodeUrl.js')); }
    catch(e){
      console.warn('CodeUrl.js niet gevonden, fallback parser actief', e);
      parseUltimoQR = (code) => {
        const m = String(code||'').match(/^(eq|sp):([A-Za-z0-9_-]+)/i);
        if (!m) return null;
        const isEquipment = m[1].toLowerCase()==='eq';
        return { isEquipment, typeStr: isEquipment?STR[LANG].entityEquip:STR[LANG].entityRoom, id: m[2], indicator:m[1] };
      };
    }

    const code = qs.get('code') || '';
    const ctx  = parseUltimoQR(code);

    // ===== Header invullen =====
    const hdrType  = document.getElementById('hdr-type');
    const hdrId    = document.getElementById('hdr-id');
    const rName    = document.getElementById('ruimte-name');
    const rType    = document.getElementById('ruimte-type');
    const rWrap    = document.getElementById('ruimte-info');
    const footMsg  = document.getElementById('foot-msg');

    if (ctx) {
      hdrType.textContent = ctx.typeStr;
      hdrId.textContent   = `#${ctx.id}`;
      rType.textContent   = ctx.typeStr;
      rWrap.style.display = 'flex';
      // optioneel display-naam ophalen
      try{
        const r = await fetch(`/.netlify/functions/prod_entity?code=${encodeURIComponent(code)}`);
        if (r.ok) {
          const j = await r.json();
          if (j && j.name) rName.textContent = j.name;
        }
      }catch(_){}
    }

    // ===== BotUI init =====
    const botui = new BotUI('botui-app');
    const say   = (html, opts={}) => botui.message.add(Object.assign({human:false, content:html}, opts));
    const TEL   = '+32 78 152 300'; // pas aan indien nodig

    await say(STR[LANG].hello);
    await say(STR[LANG].fetching);

    // Openstaande tickets (best effort)
    let openJobs = [];
    try {
      const r = await fetch(`/.netlify/functions/prod_jobs?code=${encodeURIComponent(code)}`);
      if (r.ok) {
        const j = await r.json();
        openJobs = Array.isArray(j.Jobs) ? j.Jobs : [];
      }
    } catch(_) {}

    if (!openJobs.length) {
      await say(STR[LANG].noOpen);
    } else {
      await say(STR[LANG].openCount(openJobs.length));
      for (const it of openJobs.slice(0,5)) {
        await say(`‚Ä¢ <b>${it.JobId||'-'}</b> ‚Äî ${it.Description||it.JobDescr||'-'}`);
      }
    }

    // Urgent?
    await say(STR[LANG].urgentQ);
    const urgent = await botui.action.button({
      action: [ { text:STR[LANG].yes, value:true }, { text:STR[LANG].no, value:false } ]
    }).then(res => res.value);

    // Probleem
    await say(STR[LANG].askDesc);
    const desc = await botui.action.text({
      action: { placeholder:STR[LANG].descPh, value:'' }
    }).then(r => (r.value||'').trim());

    // E-mail
    await say(STR[LANG].askEmail);
    const email = await botui.action.text({
      action: { placeholder:STR[LANG].emailPh, value:'' }
    }).then(r => (r.value||'').trim());

    // Validatie e-mail
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!re.test(email)) {
      await say(STR[LANG].emailInvalid);
      footMsg.textContent = STR[LANG].footer;
      return;
    }

    // Melding aanmaken
    await say(STR[LANG].creating);
    let ok=false, ticketId=null;
    try {
      const r = await fetch('/.netlify/functions/prod_melding', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, urgent, description: desc, email, lang: LANG })
      });
      if (r.ok) {
        const j = await r.json(); ok = !!j; ticketId = j.Id || j.JobId || null;
      }
    } catch(_) {}

    if (ok) {
      await say(STR[LANG].success(ticketId));
      if (urgent) { await say(STR[LANG].urgentPhone(TEL)); }
    } else {
      await say(STR[LANG].fail);
    }
    footMsg.textContent = STR[LANG].footer;
  })();
  </script>

  <!-- Telemetrie: progress/idle/pagehide/submit (zonder <form>) -->
  <script>
  (() => {
    function onReady(fn){
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true });
      else fn();
    }

    onReady(() => {
      const qs   = new URLSearchParams(location.search);
      const code = qs.get('code') || 'unknown';

      const root = document.getElementById('botui-app');
      if (!root) return; // geen BotUI container aanwezig

      // simpele UUIDv4
      function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
      }); }
      const sid = uuid();

      const now  = () => Date.now();
      const send = (type, extra={}) => {
        try {
          const blob = new Blob([JSON.stringify({
            type, code, sid, path: location.pathname, ts: now(), ...extra
          })], { type:'application/json' });
          navigator.sendBeacon('/.netlify/functions/prod_formlog', blob);
        } catch {}
      };

      // Stappen: 0=dringend?, 1=probleem, 2=email
      const TOTAL = 3;
      let last = -1, submitted = false, lastActivity = now();

      function bump(step, reason){
        if (step > last) {
          last = step;
          const filled = last + 1;
          const pct = Math.round((filled / TOTAL) * 100);
          send('progress', { reason, filled, total: TOTAL, pct, lastIndex: last });
        }
        lastActivity = now();
      }

      // 0) klik op knoppen (urgent ja/nee)
      root.addEventListener('click', (e) => {
        if (e.target.closest('.botui-actions-buttons-button')) bump(0, 'urgent_click');
      }, true);

      // 1/2) inputvelden (probleem vs e-mail via placeholder detectie, incl. FR)
      root.addEventListener('input', (e) => {
        const el = e.target;
        if (!root.contains(el)) return;
        const ph = (el.getAttribute('placeholder') || '').toLowerCase();
        if (/@|e-mail|email|courriel/.test(ph)) bump(2, 'email_input');
        else bump(1, 'desc_input');
      }, true);

      // idle + verlaten pagina ‚Üí abandon
      setInterval(() => {
        if (submitted) return;
        const idle = now() - lastActivity;
        if (idle > 45000) { // 45 s
          const filled = last + 1, pct = Math.round((filled / TOTAL) * 100);
          send('idle_abandon', { filled, total: TOTAL, pct, lastIndex: last, inactiveMs: idle });
          lastActivity = now();
        }
      }, 5000);

      window.addEventListener('pagehide', () => {
        if (submitted) return;
        const filled = last + 1, pct = Math.round((filled / TOTAL) * 100);
        send('pagehide_abandon', { filled, total: TOTAL, pct, lastIndex: last });
      });

      // submit hook: registreer zodra naar prod_melding (of alternatieve create) gepost wordt
      (function patchFetch(){
        const _fetch = window.fetch;
        window.fetch = function(){
          try {
            const url = arguments[0];
            if (typeof url === 'string' && (
                url.includes('/.netlify/functions/prod_melding') ||
                url.includes('/.netlify/functions/prod_create_ticket')
            )) {
              submitted = true;
              send('submit', { filled: TOTAL, total: TOTAL, pct: 100, lastIndex: 2 });
            }
          } catch {}
          return _fetch.apply(this, arguments);
        };
      })();

      // eerste snapshot
      send('progress', {
        reason: 'load',
        filled: (last + 1),
        total: TOTAL,
        pct: Math.max(0, Math.round(((last + 1)/TOTAL) * 100)),
        lastIndex: last
      });
    });
  })();
  </script>
</body>
</html>
