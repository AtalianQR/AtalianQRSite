<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wat wil je melden?</title>

  <!-- favicon & externe styles -->
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    html, body{height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',sans-serif;background-color:#f4f6fa;overflow-y:auto}
    body{background-image:url('/building-cleaning.png');background-size:cover;background-repeat:no-repeat;
      background-position:center}
    *{box-sizing:border-box}
    .header-flex{display:flex;flex-direction:column;align-items:center;max-width:600px;width:100%;
      margin:0 auto;padding:.5rem 0;gap:.5rem}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;
      background:rgba(255,255,255,.85);padding:.1rem;border-radius:12px}
    .header-flex .ruimte-label{display:flex;flex-direction:column;align-items:center;justify-content:center;
      text-align:center;background:rgba(255,255,255,.95);color:#1a202c;padding:.5rem 1rem;border-radius:12px;
      font-size:1rem;font-weight:500;white-space:normal;box-shadow:0 2px 6px rgba(0,0,0,.05);
      border:2.5px solid #EE7E00;box-shadow:0 2px 8px rgba(238,126,0,.06);width:100%;max-width:600px;margin:0 auto;
      border-bottom-width:4px}
    .ruimte-label .type{font-size:.85rem;font-weight:normal;margin-top:.25rem;color:#666}
    .lang-switch{text-align:right;padding-right:1rem;margin-top:1rem}
    .lang-switch a{margin:0 .5rem;text-decoration:none;font-size:1.2rem}
    #botui-app{width:100%;max-width:600px;margin:1rem auto 0 auto;padding:.5rem 1rem 1rem}
    .botui-container{max-width:600px;width:100%;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border:2px solid #EE7E00;box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      border-radius:12px;padding:1rem;box-sizing:border-box;opacity:0;animation:fadeIn 3s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',sans-serif}
    .botui-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.04);transition:background .12s}
    .botui-button:active{background:#d86e00}
    .meldingen-lijst{background:#f5f8fc;border-radius:10px;padding:.7em 1em;margin:.7em 0;border-left:4px solid #EE7E00}
    @keyframes fadeIn{to{opacity:1}}
    @media(max-width:480px){
      .header-flex{flex-wrap:wrap;justify-content:center}
      .header-flex .ruimte-label,img.logo{flex:0 0 90%;max-width:90%;text-align:center}
      .header-flex .ruimte-label{font-size:.95rem;padding:.5rem}
      .botui-container{padding:.75rem;max-width:95%}
    }
  </style>
</head>
<body>
<header>
  <div class="lang-switch">
    <a href="#" id="switch-nl">üá≥üá± NL</a> |
    <a href="#" id="switch-fr">üá´üá∑ FR</a>
  </div>
  <div class="header-flex">
    <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
    <div id="ruimte-info" class="ruimte-label" style="display:none"></div>
  </div>
</header>
<div id="botui-app"><bot-ui></bot-ui></div>

<!-- Vue & BotUI -->
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>

<script type="module">
import { parseUltimoQR } from '/js/CodeUrl.js';

/* ‚ñ∏ 0. Normaliseer afwijkende scheidingstekens in de query ‚óÇ */
(function () {
  // Ruwe en gedecodeerde zoekstring
  const raw = window.location.search || '';
  if (!raw) return;

  // Normaliseer percent-encodes naar zichtbare tekens, puur voor detectie
  let dec = decodeURIComponent(raw);

  // 0a) Pipe ‚Üí ampersand (backwards compatibility)
  if (dec.includes('|')) {
    const fixed = dec.replace(/\|/g, '&');
    window.location.replace(window.location.origin + window.location.pathname + fixed + window.location.hash);
    return;
  }

  // 0b) Tilde-vorm "lang=nl~code=...." ‚Üí "lang=nl&code=...."
  //   - werkt ook als de tilde in procentcode zat (%7E), door de decode hierboven
  //   - pakt zowel "?lang=xx~code=yy" als "&lang=xx~code=yy"
  if (dec.includes('~code=')) {
    const fixed = dec.replace(/([?&]lang=[^&~=]+)~code=/i, '$1&code=');
    window.location.replace(window.location.origin + window.location.pathname + fixed + window.location.hash);
    return;
  }
})();

/* ‚ñ∏ 1. Parameters verwerken ‚óÇ */
const qs   = new URLSearchParams(window.location.search);
const code = qs.get('code') ?? '';
let   lang = qs.get('lang') ?? '';
if (!lang) { const b = navigator.language||''; lang = b.startsWith('fr') ? 'fr' : 'nl'; }
const isFr = lang === 'fr';

// NIEUWE LOGICA: Bepaal de prefix op basis van de 'test' parameter
const isTestEnv = qs.get('test') !== null; // Controleert op aanwezigheid van '?test'
const prefix = isTestEnv ? 'test' : 'prod';
const telemetryPrefix = 'Ultimo' + prefix;
// ...
// <<-- CRUCIAAL: Voeg de omgevingstag toe aan de payload
  const base = {
    // ...
    env: prefix // <<-- CRUCIAAL: Voeg de omgevingstag toe aan de payload
  };


// Alleen parsen, NIET direct valideren!
const parsedQR = parseUltimoQR(code);
let isEquipment = false, typeStr = '', id = '', indicator = '';
if (parsedQR) { isEquipment = parsedQR.isEquipment; typeStr = parsedQR.typeStr; id = parsedQR.id; indicator = parsedQR.indicator; }

const endpointLoc = isEquipment
  ? `/.netlify/functions/equipment` // Gebruik de dynamische prefix
  : `/.netlify/functions/space`;    // Gebruik de dynamische prefix

/* ‚ñ∏ 2. Telemetrie helper (sendBeacon, zelfde endpoint als statsportal) ‚óÇ */
const Telemetry = (()=>{
  const base = {
    code: String(code ?? ''),                     // ‚Üê forceer string
    path: location.pathname,
    lang,
    id: (typeof id !== 'undefined' && id) ? String(id) : String(code), // ‚Üê fallback als string
    isEquipment,
    env: prefix // <<-- CRUCIAAL: Voeg de omgevingstag toe aan de payload
  };
  async function send(type, extra = {}) {
    const payload = { type, ts: Date.now(), href: location.href, ...base, ...extra };
    const json = JSON.stringify(payload);
    try {
      if (navigator.sendBeacon) {
        // VASTE URL: GEEN VARIABELE MEER NODIG
        const ok = navigator.sendBeacon(`/.netlify/functions/formlog`, new Blob([json], { type: 'application/json' }));
        if (ok) return;
      }
      // VASTE URL: GEEN VARIABELE MEER NODIG
      await fetch(`/.netlify/functions/formlog`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: json,
        keepalive: true,
        credentials: 'omit',
        cache: 'no-store'
      }).catch(()=>{});
    } catch(_) {}
  }
  return { send };
})();
Telemetry.send('url_load');


// (optioneel) ook bij tab sluiten/weg navigeren
addEventListener('pagehide', () => Telemetry.send('pagehide'), { capture: true });


/* ‚ñ∏ 3. taal-knopjes ‚óÇ */
const btnNl = document.getElementById('switch-nl');
const btnFr = document.getElementById('switch-fr');
btnNl.onclick = () => { Telemetry.send('language_switch', {to:'nl'}); const u = new URL(window.location.href); u.searchParams.set('lang','nl'); window.location.href = u; };
btnFr.onclick = () => { Telemetry.send('language_switch', {to:'fr'}); const u = new URL(window.location.href); u.searchParams.set('lang','fr'); window.location.href = u; };

/* ‚ñ∏ 4. hulpfuncties ‚óÇ */
const botui     = new BotUI('botui-app');
const phoneLink = '<a href="tel:+3278152300">üìû +32 78 152 300</a>';
let   omschrijving = '';
function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }

let cleaningProgramText = ""; // Globaal beschikbaar

async function showLocation(){
  const r = await fetch(`${endpointLoc}?id=${encodeURIComponent(id)}&lang=${lang}`);
  const d = await r.json();
  if(!d.description) return;
  const el=document.getElementById('ruimte-info');
  el.innerHTML = `${d.description}<div class="type">${
    isEquipment ? (isFr?'üîß Installation':'üîß Installatie')
                : (isFr?'üè¢ Espace'      :'üè¢ Ruimte')
  }</div>`;
  el.style.display='flex';
  cleaningProgramText = d.cleaningProgramFormatted || "";
}

async function fetchOpenJobs(){
  try{
    const res = await fetch(`/.netlify/functions/jobs?code=${code}`);
    if(!res.ok) throw new Error(res.status);
    return await res.json();
  }catch(e){ console.error('Jobs error',e); return null; }
}

/* ‚ñ∏ 5. BotUI-chatflow (concept ongewijzigd, enkel onzichtbare telemetrie-calls) ‚óÇ */
async function startChat(){
  Telemetry.send('step', { step:'start', stepIndex:0 });
  await showLocation();

  await botui.message.add({
    type:'html',
    content:isFr
      ? 'Bonjour, je suis votre assistant <span style="color:#EE7E00;font-weight:bold;">ATALIAN</span>.<br>Je recherche pour vous les <b>signalements en cours</b>‚Ä¶'
      : 'Hallo, ik ben je <span style="color:#EE7E00;font-weight:bold;">ATALIAN</span>-assistent.<br>Ik haal even de <b>openstaande meldingen</b> voor je op‚Ä¶'
  });

  // Eerst: alleen bij ruimte, √©n als cleaningProgram NIET leeg is, extra keuze!
  if (!isEquipment && cleaningProgramText && cleaningProgramText.trim() !== "") {
    const ans = await botui.action.button({
      action: [
        { text: isFr ? 'üßπ Infos sur le programme de nettoyage' : 'üßπ Info over poetsprogramma', value: 'poets' },
        { text: isFr ? '‚ùóÔ∏è Je veux signaler un probl√®me' : '‚ùóÔ∏è Ik wil een probleem melden', value: 'probleem' }
      ]
    });

    if (ans.value === 'poets') {
      Telemetry.send('poets_info_viewed');
      await botui.message.add({
        type: 'html',
        content: isFr
          ? `<b>Programme de nettoyage :</b><br>${cleaningProgramText}`
          : `<b>Poetsprogramma:</b><br>${cleaningProgramText}`
      });

      // Daarna: wil je toch een probleem melden?
      const vervolg = await botui.action.button({
        action: [
          { text: isFr ? 'üîÑ Nouveau signalement' : 'üîÑ Nieuwe melding', value: "doorgaan" },
          { text: isFr ? "‚ÑπÔ∏è Plus d'info" : "‚ÑπÔ∏è Meer info", value: "info" }
        ]
      });
      if (vervolg.value === "doorgaan") {
        return await startProbleemFlow();
      } else if (vervolg.value === "info") {
        await botui.message.add({
          type: 'html',
          content: isFr
            ? 'Vous allez √™tre redirig√© vers notre site web externe.'
            : 'Je wordt nu doorverwezen naar onze externe website.'
        });
        setTimeout(() => {
          window.location.href = isFr
            ? "https://www.atalian.be/?lang=fr"
            : "https://www.atalian.be/?lang=nl";
        }, 2000);
        return;
      }
    }
    // Bij 'probleem' direct de flow starten:
    return await startProbleemFlow();
  }

  // Anders (installatie of poetsprogramma niet ingevuld): standaardflow
  return await startProbleemFlow();
}

async function startProbleemFlow() {
  Telemetry.send('step', { step:'flow_start', stepIndex:1 });
  // QR-validatie ENKEL op dit punt!
  if (!parsedQR) {
    await botui.message.add({
      type: 'html',
      content: '<span style="color:red;font-weight:bold">Geen geldige QR-code. Je kunt geen melding doen zonder geldige code.</span>'
    });
    Telemetry.send('invalid_qr');
    return;
  }

  const result = await fetchOpenJobs();
  if (result===null){
    await botui.message.add({content:isFr?'‚ùå Erreur lors du chargement des signalements.':'‚ùå Fout bij het ophalen van de meldingen.'});
    Telemetry.send('open_jobs_error');
    return;
  }

  const jobs = result.Jobs || [];
  Telemetry.send('open_jobs_shown', { count: jobs.length });
  if (jobs.length){
    await botui.message.add({type:'html',content:isFr?'‚ö†Ô∏èÔ∏è Quelques signalements sont d√©j√† en cours :':'‚ö†Ô∏è  Er zijn al enkele openstaande meldingen gevonden:'});
    await botui.message.add({type:'html',content:'<div class="meldingen-lijst">'+jobs.map(j=>`‚úÖ ${j.Description}`).join('<br>')+'</div>'});
    await botui.message.add({content:isFr?'Votre probl√®me est-il d√©j√† list√© ?':'Staat jouw probleem hierbij?'});
    const ans = await botui.action.button({action:[
      {text:isFr?'‚úÖ Oui':'‚úÖ Ja',value:'ja'},
      {text:isFr?'‚ùå Non':'‚ùå Nee',value:'nee'}
    ]});
    Telemetry.send('existing_list_confirm', { match: ans.value==='ja' });
    if (ans.value==='ja'){
      await botui.message.add({content:isFr?'Merci ! Aucun nouveau signalement n‚Äôest n√©cessaire.':'Bedankt! Je hoeft geen nieuwe melding te maken.'});
      Telemetry.send('no_new_needed');
      return;
    }
  }else{
    await botui.message.add({content:isFr?'‚ÑπÔ∏è Aucun signalement est en cours.':'‚ÑπÔ∏è Er zijn momenteel geen openstaande meldingen.'});
  }
  await askUrgency('');
}

function askUrgency(){
  Telemetry.send('step', { step:'ask_urgent', stepIndex:2 });
  return botui.message.add({content:isFr?'Le probl√®me est urgent ?':'Is het dringend?'})
    .then(()=>botui.action.button({action:[
      {text:isFr?'üö® Oui':'üö® Ja',value:'ja'},
      {text:isFr?'‚è± Non':'‚è± Nee',value:'nee'}
    ]})).then(res=>{Telemetry.send('urgent_answer', { urgent: res.value==='ja' }); return askDescription(res.value==='ja');});
}
function askDescription(isUrgent){
  Telemetry.send('step', { step:'ask_description', stepIndex:3 });
  return botui.message.add({content:isFr?'Quel est le probl√®me exactement ?':'Wat is het probleem precies?'})
    .then(()=>botui.action.text({action:{placeholder:isFr?'D√©crivez‚Ä¶':'Beschrijf‚Ä¶'}}))
    .then(async res=>{
      omschrijving=res.value||'';
      Telemetry.send('desc_entered', { length: omschrijving.length }); // ‚òÖ Melding ingegeven
      return askEmail(isUrgent);
    });
}
function askEmail(isUrgent){
  Telemetry.send('step', { step:'ask_email', stepIndex:4 });
  return botui.message.add({content:isFr?'Quelle est votre adresse e-mail ?':'Wat is je e-mailadres?'})
    .then(()=>botui.action.text({action:{placeholder:'jouw@email.com'}}))
    .then(async res=>{
      const email=res.value||'';
      if(!isValidEmail(email)){
        await botui.message.add({content:isFr?'Adresse e-mail invalide.':'Ongeldig e-mailadres.'});
        Telemetry.send('email_invalid');
        return askEmail(isUrgent);
      }
      Telemetry.send('email_entered');
      const payload = { id, type: typeStr, JobDescr: omschrijving, ReportText: email, lang };
      try{
        Telemetry.send('submit_attempt', { urgent: isUrgent });
        const r=await fetch(`/.netlify/functions/melding`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error(await r.text());
        await botui.message.add({content:isFr?'Merci ! Votre signalement a √©t√© envoy√©.':'Bedankt! Jouw melding is verzonden.'});
        Telemetry.send('submit_success'); // ‚òÖ Melding doorgegeven
        if(isUrgent){
          await botui.message.add({type:'html',content:isFr?`‚ö†Ô∏è <b>Probl√®me urgent :</b> Appelez ${phoneLink}`:`‚ö†Ô∏è <b>Dringend probleem:</b> Bel onmiddellijk ${phoneLink}`});
          return;
        }
        await botui.message.add({content:isFr?'Que voulez-vous faire maintenant?':'Wat wil je nu doen?'});
        const k=await botui.action.button({action:[
          {text:isFr?'üîÑ Nouveau signalement':'üîÑ Nieuwe melding',value:'restart'},
          {text:isFr?'‚ÑπÔ∏è Plus d\'info':'‚ÑπÔ∏è Meer info',value:'info'}
        ]});
        if(k.value==='restart') { Telemetry.send('restart'); window.location.reload(); }
        else { Telemetry.send('external_info'); window.location.href=isFr?'https://www.atalian.be/?lang=fr':'https://www.atalian.be/?lang=nl'; }
      }catch(e){
        console.error(e);
        await botui.message.add({content:isFr?'Erreur lors de l‚Äôenvoi.':'Fout bij verzenden.'});
        Telemetry.send('submit_error', { message: String(e&&e.message||e) });
      }
    });
}

/* ‚ñ∏ 6. Idle / page-leave detectie (lichtgewicht, zonder form) ‚óÇ */
let lastActivity = Date.now();
['click','keydown','touchstart'].forEach(ev=>document.addEventListener(ev,()=>{lastActivity=Date.now();},{passive:true}));
const IDLE_MS = 45000; // 45 s
setInterval(()=>{
  const inactive = Date.now()-lastActivity;
  if (inactive>IDLE_MS){ Telemetry.send('idle', { inactiveMs: inactive }); lastActivity = Date.now(); }
}, 5000);
window.addEventListener('pagehide', ()=>{ Telemetry.send('pagehide'); });

/* ‚ñ∏ 7. Automatisch naar BotUI-container scrollen (ongewijzigd) ‚óÇ */
window.addEventListener('load',()=>{
  const it=setInterval(()=>{
    const b=document.querySelector('#botui-app');
    if(b&&b.offsetTop>0){
      window.scrollTo({top:Math.max(b.offsetTop-100,0),behavior:'smooth'});
      clearInterval(it);
    }
  },300);
});

/* start chat */
startChat();
</script>

</body>
</html>