<!DOCTYPE html>
<script>
(() => {
const qs = new URLSearchParams(location.search);
const code = qs.get('code') || 'unknown';


const root = document.getElementById('botui-app');
if (!root) return; // geen BotUI, niets te tracken


// simpele UUIDv4
function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
}); }
const sid = uuid();


const now = () => Date.now();
const send = (type, extra={}) => {
try {
const blob = new Blob([JSON.stringify({ type, code, sid, path: location.pathname, ts: now(), ...extra })], {type:'application/json'});
navigator.sendBeacon('/.netlify/functions/prod_formlog', blob);
} catch {}
};


// Model: 0=dringend?, 1=probleem, 2=email
const TOTAL = 3;
let last = -1, submitted = false, lastActivity = now();


function bump(step, reason){
if (step > last) {
last = step;
const filled = last + 1;
const pct = Math.round((filled / TOTAL) * 100);
send('progress', { reason, filled, total: TOTAL, pct, lastIndex: last });
}
lastActivity = now();
}


// 0) knop ja/nee
root.addEventListener('click', (e) => {
if (e.target.closest('.botui-actions-buttons-button')) bump(0, 'urgent_click');
}, true);


// 1/2) tekst inputs (placeholder check)
root.addEventListener('input', (e) => {
const el = e.target; if (!root.contains(el)) return;
const ph = (el.getAttribute('placeholder') || '').toLowerCase();
if (/@|e-mail|email/.test(ph)) bump(2, 'email_input'); else bump(1, 'desc_input');
}, true);


// idle + verlaten pagina â†’ abandon
setInterval(() => {
if (submitted) return;
const idle = now() - lastActivity;
if (idle > 45000) { // 45 s
const filled = last + 1, pct = Math.round((filled / TOTAL) * 100);
send('idle_abandon', { filled, total: TOTAL, pct, lastIndex: last, inactiveMs: idle });
lastActivity = now();
}
}, 5000);


window.addEventListener('pagehide', () => {
if (submitted) return;
const filled = last + 1, pct = Math.round((filled / TOTAL) * 100);
send('pagehide_abandon', { filled, total: TOTAL, pct, lastIndex: last });
});


// submit hook (luister naar call naar prod_create_ticket via fetch-monkeypatch)
(function patchFetch(){
const _fetch = window.fetch;
window.fetch = function(){
try {
const url = arguments[0];
if (typeof url === 'string' && url.includes('/.netlify/functions/prod_create_ticket')) {
submitted = true;
const filled = TOTAL, pct = 100;
send('submit', { filled, total: TOTAL, pct, lastIndex: 2 });
}
} catch {}
return _fetch.apply(this, arguments);
};
})();


// Eerste momentopname (bestaande defaultwaarden?)
send('progress', { reason:'load', filled: (last+1), total: TOTAL, pct: Math.max(0, Math.round(((last+1)/TOTAL)*100)), lastIndex: last });
})();
</script>
</body>
</html>