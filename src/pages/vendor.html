<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Opvolging ‚Äî met Documentenpaneel</title>

  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    /* ====== Basis layout (zoals origineel) ====== */
    html, body{height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',sans-serif;background-color:#f4f6fa;overflow-y:auto}
    body{background-image:url('/afmeldentaak.png');background-size:cover;background-repeat:no-repeat;background-position:center}
    *{box-sizing:border-box}

    .header-flex{display:flex;flex-direction:column;align-items:center;max-width:600px;width:100%;margin:0 auto;padding:.5rem 0;gap:.5rem}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);padding:.1rem;border-radius:12px}
    .header-flex .ruimte-label{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;background:rgba(255,255,255,.95);color:#1a202c;padding:.5rem 1rem;border-radius:12px;font-size:1rem;font-weight:500;white-space:normal;box-shadow:0 2px 6px rgba(0,0,0,.05);border:2px solid #EE7E00;box-shadow:0 2px 8px rgba(238,126,0,.06);width:100%;max-width:600px;margin:0 auto;border-bottom-width:4px}
    .lang-switch{text-align:right;padding-right:1rem;margin-top:1rem}
    .lang-switch a{margin:0 .5rem;text-decoration:none;font-size:1.2rem}
    #botui-app{width:100%;max-width:600px;margin:1rem auto 0 auto;padding:.5rem 1rem 1rem}
    .botui-container{max-width:600px;width:100%;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);border:2px solid #EE7E00;box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);border-radius:12px;padding:1rem;box-sizing:border-box;opacity:0;animation:fadeIn 3s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',sans-serif}
    .botui-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.04);transition:background .12s}
    .botui-button:active{background:#d86e00}

    .meldingen-lijst{background:#f5f8fc;border-radius:10px;padding:.7em 1em;margin:.7em 0;border-left:4px solid #EE7E00}
    .job-description-box{background:#e0f2fe;border-radius:10px;padding:.7em 1em;margin:.7em 0;border-left:4px solid #3b82f6}

    @keyframes fadeIn{to{opacity:1}}

    .ruimte-label .jobid{font-size:.8rem;color:#6b7280;margin-bottom:.25rem}
    .ruimte-label .desc{font-size:1.05rem;font-weight:600;color:#1f2937;line-height:1.4}

    .botui-actions-text-input {width:100% !important; max-width:50% !important; flex-grow:1 !important}

    .view-doc-btn{background:none;border:1px solid #EE7E00;color:#EE7E00;padding:4px 8px;cursor:pointer;font-size:.8rem;border-radius:4px;transition:background-color .1s}
    .view-doc-btn:hover{background-color:#EE7E00;color:#fff}

    @media(max-width:768px){
      .header-flex{flex-wrap:wrap;justify-content:center}
      .header-flex .ruimte-label,img.logo{flex:0 0 90%;max-width:90%;text-align:center}
      .header-flex .ruimte-label{font-size:.95rem;padding:.5rem}
      .botui-container{padding:.75rem;max-width:95%}
      .botui-actions-text-input{max-width:100% !important}
    }

    /* ====== Documentenpaneel (nieuw) ====== */
    .doc-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:saturate(140%) blur(1px);z-index:990;opacity:0;transition:opacity .18s ease}
    .doc-backdrop[hidden]{display:none}

    .doc-panel{position:fixed;top:0;right:0;height:100vh;width:min(560px,96vw);background:#ffffff;box-shadow:-2px 0 18px rgba(0,0,0,.18);border-left:3px solid #EE7E00;z-index:999;transform:translateX(100%);transition:transform .22s ease}
    .doc-panel.open{transform:translateX(0)}

    .doc-panel-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid #eee}
    .doc-panel-header #doc-panel-title{font-weight:700}
    .doc-close-btn{background:none;border:0;font-size:1.2rem;cursor:pointer;color:#1f2937}

    .doc-panel-body{display:grid;grid-template-columns:1fr;grid-template-rows:auto 1fr;gap:.75rem;height:calc(100vh - 56px);padding:0 .75rem .75rem}

    .doc-preview{border:1px solid #e5e7eb;border-radius:8px;padding:.5rem;overflow:auto;min-height:160px;background:#fafafa}
    .doc-preview .pdf-tip{font-size:.85rem;color:#6b7280}

    .doc-list{border:1px solid #e5e7eb;border-radius:8px;overflow:auto}
    .doc-table{width:100%;border-collapse:collapse;font-size:.92rem}
    .doc-table th,.doc-table td{padding:.4rem .5rem;border-bottom:1px solid #f0f0f0}
    .doc-table th{text-align:left;background:#fafafa;position:sticky;top:0;z-index:1}

    /* Drijvende actieknop */
    .doc-fab{position:fixed;right:16px;bottom:16px;height:48px;min-width:48px;border-radius:24px;border:2px solid #EE7E00;background:#fff;color:#EE7E00;padding:0 14px;display:flex;align-items:center;gap:.5rem;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,.16);z-index:980;font-weight:700}
    .doc-fab:hover{background:#FFF8F1}

    @media (max-width:640px){
      .doc-panel{width:100vw;border-left-width:0;border-top:3px solid #EE7E00}
      .doc-panel-body{grid-template-rows:1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="lang-switch">
      <a href="#" id="switch-nl">üá≥üá± NL</a> |
      <a href="#" id="switch-fr">üá´üá∑ FR</a>
    </div>
    <div class="header-flex">
      <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
      <div id="job-info" class="ruimte-label" style="display:none"></div>
    </div>
  </header>

  <div id="botui-app"><bot-ui></bot-ui></div>

  <!-- Backdrop + Zijpaneel + FAB -->
  <div id="doc-backdrop" class="doc-backdrop" hidden></div>
  <aside id="doc-panel" class="doc-panel" aria-hidden="true">
    <div class="doc-panel-header">
      <div id="doc-panel-title">üìé Documenten</div>
      <button id="doc-panel-close" class="doc-close-btn" aria-label="Sluiten">‚úï</button>
    </div>
    <div class="doc-panel-body">
      <div id="doc-preview" class="doc-preview">
        <div class="pdf-tip">Selecteer een document uit de lijst om de preview te zien. PDF's openen in een nieuw tabblad of via downloadlink.</div>
      </div>
      <div id="doc-list" class="doc-list"></div>
    </div>
  </aside>
  <button id="doc-fab" class="doc-fab" type="button">üìé Documenten</button>

  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>

  <script type="module">
    /* ‚ñ∏ 0. Endpoints ‚óÇ */
    const endpointJobDetails = `/.netlify/functions/jobsvendor`;
    const endpointUpdate     = endpointJobDetails;

    /* ‚ñ∏ 1. Parameters ‚óÇ */
    const qs     = new URLSearchParams(window.location.search);
    const jobId  = qs.get('job') || qs.get('jobId') || '';
    let   lang   = qs.get('lang') || ((navigator.language||'').startsWith('fr') ? 'fr' : 'nl');
    const isFr   = (lang === 'fr');

    if (isFr) document.body.style.backgroundImage = "url('/afmeldentaak_fr.png')";

    /* ‚ñ∏ 2. Telemetrie (light) ‚óÇ */
    const Telemetry = (()=>{ 
      const base = { jobId: String(jobId), lang, env: qs.has('test') ? 'test' : 'prod' };
      async function send(type, extra={}){
        const json = JSON.stringify({ type, ts: Date.now(), href: location.href, ...base, ...extra });
        try{
          if (navigator.sendBeacon && navigator.sendBeacon('/.netlify/functions/formlog', new Blob([json],{type:'application/json'}))) return;
          await fetch('/.netlify/functions/formlog',{ method:'POST', headers:{'content-type':'application/json'}, body: json, keepalive:true });
        }catch{}
      }
      return { send };
    })();
    Telemetry.send('vendor_html_load');

    /* ‚ñ∏ 3. UI helpers ‚óÇ */
    const botui = new BotUI('botui-app');
    const elInfo = document.getElementById('job-info');
    document.getElementById('switch-nl').onclick = ()=>{const u=new URL(location.href);u.searchParams.set('lang','nl');location.href=u;};
    document.getElementById('switch-fr').onclick = ()=>{const u=new URL(location.href);u.searchParams.set('lang','fr');location.href=u;};

    let sessionEmail='';
    let jobPayload=null;

    /* ====== Documentenpaneel helpers ====== */
    const $panel   = document.getElementById('doc-panel');
    const $backdrop= document.getElementById('doc-backdrop');
    const $fab     = document.getElementById('doc-fab');
    const $close   = document.getElementById('doc-panel-close');
    const $list    = document.getElementById('doc-list');
    const $preview = document.getElementById('doc-preview');
    const $title   = document.getElementById('doc-panel-title');

    function openDocPanel(){
      $panel.classList.add('open');
      $panel.setAttribute('aria-hidden','false');
      $backdrop.hidden=false; requestAnimationFrame(()=>{$backdrop.style.opacity=1});
    }
    function closeDocPanel(){
      $panel.classList.remove('open');
      $panel.setAttribute('aria-hidden','true');
      $backdrop.style.opacity=0; setTimeout(()=>{$backdrop.hidden=true},180);
    }
    $fab.addEventListener('click',()=>{ openDocPanel(); if (!$list.dataset.bound) loadAndRenderDocuments(jobId).catch(console.error) });
    $close.addEventListener('click',closeDocPanel);
    $backdrop.addEventListener('click',closeDocPanel);

    /* ‚ñ∏ 4. Helpers ‚óÇ */
    const stripHtml=(s='')=>s.replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ').replace(/\s{2,}/g,' ').trim();
    function formatIsoToLocal(iso){try{const d=new Date(iso);if(isNaN(d.getTime())) return isFr?'Date non valide':'Invalid Date'; return d.toLocaleString()}catch{ return iso||(isFr?'Date non valide':'Invalid Date') }}

    async function fetchJobDocuments(jobId){
      const url = `${endpointJobDetails}?action=LIST_JOB_DOCS&jobId=${encodeURIComponent(jobId)}`;
      const r=await fetch(url,{headers:{accept:'application/json'}});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data=await r.json();
      return Array.isArray(data?.Documents)?data.Documents:[];
    }

    async function fetchDocumentBase64(docId){
      await botui.message.add({ content: isFr?`T√©l√©chargement du document ${docId}...`:`Document ${docId} aan het downloaden...` });
      const url = `${endpointJobDetails}?action=GET_JOB_DOC&docId=${encodeURIComponent(docId)}`;
      const r=await fetch(url,{headers:{accept:'application/json'}});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data=await r.json();
      const b64=data?.Document; if(!b64||typeof b64!=='string') throw new Error(isFr?'Donn√©es du document introuvables.':'Documentdata niet gevonden.');
      return b64;
    }

    function getMimeType(docType, description){
      const t=(docType||'').toUpperCase();
      if(t==='PDF') return 'application/pdf';
      if(t==='JPEG'||t==='JPG') return 'image/jpeg';
      if(t==='PNG') return 'image/png';
      const desc=(description||'').toLowerCase();
      if(desc.endsWith('.pdf')) return 'application/pdf';
      if(desc.endsWith('.jpg')||desc.endsWith('.jpeg')) return 'image/jpeg';
      if(desc.endsWith('.png')) return 'image/png';
      if(desc.endsWith('.doc')||desc.endsWith('.docx')) return 'application/msword';
      if(desc.endsWith('.xls')||desc.endsWith('.xlsx')) return 'application/vnd.ms-excel';
      return 'application/octet-stream';
    }

    async function displayBase64InPanel(docId, docType, docDescription, base64Data){
      const mimeType=getMimeType(docType, docDescription);
      const dataUrl=`data:${mimeType};base64,${base64Data}`;
      const fileName=(docDescription||`${docId}.${(docType||'bin').toLowerCase()}`);

      let html='';
      if(mimeType.startsWith('image/')){
        html = `<figure style="margin:0"><img src="${dataUrl}" alt="${docId}" style="max-width:100%;height:auto;border:1px solid #ddd;border-radius:6px"/><figcaption style="font-size:.85rem;color:#6b7280;margin-top:.25rem">${fileName}</figcaption></figure>`;
      } else if (mimeType==='application/pdf'){
        html = `<div class="pdf-tip">${isFr? 'Ce document est un PDF. Ouvrez/le t√©l√©chargez via le lien ci‚Äëdessous.' : 'Dit is een PDF. Open of download via de link hieronder.'}</div>
                <p><a href="${dataUrl}" target="_blank" download="${fileName}" style="display:inline-block;padding:8px 14px;background:#EE7E00;color:#fff;text-decoration:none;border-radius:6px;font-weight:700">${isFr?'Ouvrir/T√©l√©charger PDF':'PDF openen/downloaden'}</a></p>`;
      } else {
        html = `<p style="color:#b91c1c">${isFr?`Type non support√© (${mimeType}).`:`Niet-ondersteund type (${mimeType}).`}</p>
                <p><a href="${dataUrl}" target="_blank" download="${fileName}${mimeType==='application/octet-stream'?'.dat':''}" style="color:#EE7E00;font-weight:700">${isFr?`T√©l√©charger l'original`:'Origineel downloaden'}</a></p>`;
      }
      $preview.innerHTML = html;
    }

    /* ‚ñ∏ 5. Login ‚óÇ */
    const copy = { nl:{ intro1:"Welkom! We helpen je om deze taak snel en correct af te ronden. üëã", ask:"Gelieve uw login in te voeren:", invalid:"Foutieve login." }, fr:{ intro1:"Bienvenue ! Nous vous aidons √† cl√¥turer cette t√¢che rapidement et correctement. üëã", ask:"Veuillez entrer votre identifiant :", invalid:"Erreur d'identifiant." } };

async function isAllowedBusinessMail(e=''){
  // Controleert alleen nog of het de basis e-mail syntax is
  const okSyntax=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); 
  if(!okSyntax) return false;

  // Stelt de sessionEmail in op de ingevoerde waarde, om later te gebruiken
  // We slaan de servercontrole over
  return true; 
}

    async function emailIntroAndLogin(){
      const t=isFr?copy.fr:copy.nl; await botui.message.add({ content:t.intro1 });
      let attempts=0; while(attempts<3){
        await botui.message.add({ content:t.ask });
        const a=await botui.action.text({ action:{ placeholder:isFr?'prenom.nom@exemple.com':'voornaam.naam@voorbeeld.com' } });
        const email=(a.value||'').trim().toLowerCase();
        if(!(await isAllowedBusinessMail(email))){ attempts++; if(attempts>=3){ await botui.message.add({ content: isFr?'‚ùå Maximum d\'essais atteint. Le flux de travail est termin√©.':'‚ùå Maximum aantal pogingen bereikt. De workflow is be√´indigd.' }); Telemetry.send('login_max_attempts'); return false }
          const remaining=3-attempts; const msg=isFr?`${t.invalid} Il vous reste ${remaining} essai${remaining!==1?'s':''}.`:`${t.invalid} Je hebt nog ${remaining} poging(en) over.`; await botui.message.add({ content: msg }); continue; }
        sessionEmail=email; Telemetry.send('email_ok',{ emailMasked: email.replace(/(.).+(@.*)/,'$1***$2') }); return true;
      }
      return false;
    }

    /* ‚ñ∏ 6. Data ‚óÇ */
    async function fetchJobDetails(){
      const url=`${endpointJobDetails}?jobId=${encodeURIComponent(jobId)}&lang=${lang}&action=VIEW&email=${encodeURIComponent(sessionEmail)}`;
      const r=await fetch(url,{headers:{accept:'application/json'}}); if(!r.ok){ const errorText=await r.text(); console.error(`Fetch error ${r.status}: ${errorText}`); throw new Error(`HTTP ${r.status} - ${r.statusText||'Server Error'}`) } return r.json();
    }
    function isJobOpen(job){ const s=String(job?.Status??'').trim(); if(!s) return true; return s!=='1016' }
    function renderJobHeader(job){ const desc=stripHtml(job.Description || (isFr?'Description manquante':'Beschrijving ontbreekt')); elInfo.innerHTML=`<div class="jobid">${isFr?'ID t√¢che':'Job ID'}: ${job.Id}</div><div class="desc">${desc}</div>`; elInfo.style.display='flex' }

    /* ‚ñ∏ 7. Vertalen (zoals origineel, compacter gehouden) ‚óÇ */
    async function translateText(text, from, to){ if(!text||from===to) return {text, detected:null}; try{ const r=await fetch('/.netlify/functions/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,source:from||undefined,target:to})}); if(!r.ok) throw new Error(await r.text()); const data=await r.json(); return { text:data?.text??text, detected:data?.detected??null } }catch{ return { text, detected:null } } }

    async function showJobTextsThenAskTranslate(job){
      renderJobHeader(job);
      const rawDesc=job.Description||''; const rawReport=job.Report||job.JobReportText||''; const rawInstr=job.Instructions||job.JobText||'';
      if(rawDesc.trim()) await botui.message.add({ type:'html', content:`<div class='job-description-box'><b>${isFr?'Description (originale)':'Beschrijving (origineel)'}</b><br>${stripHtml(rawDesc)}</div>` });
      if(rawReport.trim()) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Remarque (originale)':'Toelichting (origineel)'}</b><br>${stripHtml(rawReport)}</div>` });
      if(rawInstr.trim()) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Instructions (original)':'Werkinstructies (origineel)'}</b><br>${stripHtml(rawInstr)}</div>` });

      await botui.message.add({ content: isFr?'Les d√©tails originaux sont affich√©s ci-dessus. Voulez-vous une version traduite ?':'De originele details worden hierboven weergegeven. Wil je een vertaalde versie zien?' });
      const choice=await botui.action.button({ action:[ {text:isFr?'üåê Traduire en fran√ßais':'üåê Vertalen naar Nederlands',value:'yes'},{text:isFr?'Garder l\'affichage actuel':'Houd chat zoals is',value:'no'} ] });
      if(choice.value!=='yes') return;
      const dst=isFr?'fr':'nl';
      const descRes=await translateText(rawDesc,'auto',dst);
      const repRes =await translateText(rawReport,'auto',dst);
      const insRes =await translateText(rawInstr,'auto',dst);
      const badge =(d)=> d?`<small style='color:#6b7280'>(${isFr?'traduit de':'vertaald uit'}: ${d.toUpperCase()})</small>`:'';
      const shouldDisplay=(res,target,raw)=>{ const t=target.toLowerCase(); if(!(res.text||'').trim()) return false; if(res.detected&&res.detected.toLowerCase()!==t) return true; const a=stripHtml(raw).trim(), b=stripHtml(res.text).trim(); return a!==b };
      if(shouldDisplay(descRes,dst,rawDesc)) await botui.message.add({ type:'html', content:`<div class='job-description-box'><b>${isFr?'Description (traduite)':'Beschrijving (vertaald)'}</b> ${badge(descRes.detected)}<br>${stripHtml(descRes.text)}</div>` });
      if(shouldDisplay(repRes ,dst,rawReport)) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Remarque (traduite)':'Toelichting (vertaald)'}</b> ${badge(repRes.detected)}<br>${stripHtml(repRes.text)}</div>` });
      if(shouldDisplay(insRes ,dst,rawInstr)) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Instructions (traduite)':'Werkinstructies (vertaald)'}</b> ${badge(insRes.detected)}<br>${stripHtml(insRes.text)}</div>` });
      await botui.message.add({ type:'html', content:`<small style='color:#6b7280'>${isFr?'Affichage traduit ajout√© sous l‚Äôoriginal.':'Vertaalde weergave toegevoegd onder het origineel.'}</small>` });
    }

    /* ‚ñ∏ 8. Update wrapper ‚óÇ */
    async function submitUpdate(payload, successMsg){ const r=await fetch(endpointUpdate,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); if(!r.ok) throw new Error(await r.text()); await botui.message.add({ content: successMsg }) }

    /* ‚ñ∏ 9. Documentenlijst in paneel ‚óÇ */
    async function loadAndRenderDocuments(jobId){
      $title.textContent = isFr? 'üìé Documents' : 'üìé Documenten';
      $list.innerHTML = `<div style="padding:.75rem;color:#6b7280">${isFr?'Chargement des documents‚Ä¶':'Documenten laden‚Ä¶'}</div>`;
      try{
        const docs=await fetchJobDocuments(jobId);
        if(!docs.length){ $list.innerHTML=`<div style='padding:.75rem'>${isFr?'Aucun document li√© √† cette t√¢che.':'Geen documenten gekoppeld aan deze taak.'}</div>`; return }

        const rows = docs.map(d=>{
          const id = d.Id || '';
          const desc = stripHtml(d.Description||'');
          const typ = d.DocumentType || '';
          const when = formatIsoToLocal(d.Created||'');
          return `<tr>
            <td>${desc}</td>
            <td style='white-space:nowrap;color:#6b7280'>${typ}</td>
            <td style='white-space:nowrap;color:#6b7280'>${when}</td>
            <td style='width:1%;white-space:nowrap'>
              <button class='view-doc-btn' data-id='${id}' data-type='${typ}' data-desc='${desc}'>${isFr?'Voir':'Bekijken'}</button>
            </td>
          </tr>`
        }).join('');

        $list.innerHTML = `<div style='overflow:auto'>
          <table class='doc-table'>
            <thead>
              <tr>
                <th>${isFr?'Description':'Omschrijving'}</th>
                <th>${isFr?'Type':'Type'}</th>
                <th>${isFr?'Cr√©√© le':'Aangemaakt'}</th>
                <th>${isFr?'Action':'Actie'}</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;

        // Bind once
        $list.dataset.bound = '1';
        $list.addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('button.view-doc-btn'); if(!btn) return;
          btn.disabled=true; const old=btn.textContent; btn.textContent=isFr?'Chargement‚Ä¶':'Laden‚Ä¶';
          try{
            const b64 = await fetchDocumentBase64(btn.dataset.id);
            await displayBase64InPanel(btn.dataset.id, btn.dataset.type, btn.dataset.desc, b64);
          }catch(e){ await botui.message.add({ content: isFr?`‚ùå Erreur de chargement du contenu: ${e.message}`:`‚ùå Fout bij laden inhoud: ${e.message}` }); }
          finally{ btn.disabled=false; btn.textContent=old }
        });
      }catch(e){
        console.error(e);
        $list.innerHTML = `<div style='padding:.75rem;color:#b91c1c'>${isFr?'√âchec du chargement des documents.':'Documenten laden mislukt.'} (${e.message})</div>`;
      }
    }

    /* ‚ñ∏ 10. Flow ‚óÇ */
    const createFormattedText=(s)=>`<span style="color:#007bff;font-weight:bold;">${(s||'').trim()}</span>`;

    async function menu(job){
      await botui.message.add({ content: isFr?`Que voulez-vous faire pour la t√¢che ${job.Id}?`:`Wat wil je doen voor taak ${job.Id}?` });
      const ans=await botui.action.button({ action:[
        { text:isFr?'‚ûï Ajouter un commentaire':'‚ûï Info toevoegen', value:'info' },
        { text:isFr?'‚úÖ Terminer la t√¢che':'‚úÖ Taak afronden', value:'done' },
        { text:isFr?'üìé Documents':'üìé Documenten', value:'docs' }
      ]});

      if(ans.value==='info'){
        await botui.message.add({ content:isFr?'Votre commentaire :':'Jouw commentaar:' });
        const t=await botui.action.text({ action:{ placeholder:isFr?'D√©tail‚Ä¶':'Detail‚Ä¶' } });
        const info=(t.value||'').trim(); if(!info){ await botui.message.add({ content:isFr?'‚ö†Ô∏è Entrez un texte.':'‚ö†Ô∏è Geef wat tekst in.' }); return menu(job) }
        const formatted=createFormattedText(info);
        await submitUpdate({ action:'ADD_INFO', jobId:job.Id, text:formatted, email:sessionEmail, lang }, isFr?'Commentaire ajout√©.':'Commentaar toegevoegd.');
        try{ jobPayload=await fetchJobDetails(); renderJobHeader(jobPayload.Job) }catch{}
        return menu(jobPayload.Job);
      }

      if(ans.value==='docs'){
        openDocPanel();
        await loadAndRenderDocuments(job.Id);
        return menu(job); // dialoog loopt verder, paneel blijft open
      }
	  
      if(ans.value==='done'){
        await botui.message.add({ content:isFr?'Veuillez ajouter un commentaire pour finaliser la t√¢che :':'Gelieve een opmerking toe te voegen om de taak af te ronden:' });
        const t=await botui.action.text({ action:{ placeholder:isFr?'D√©tail obligatoire‚Ä¶':'Verplichte opmerking‚Ä¶' } });
        const info=(t.value||'').trim(); if(!info){ await botui.message.add({ content:isFr?'‚ö†Ô∏è Le commentaire is obligatoire pour la cl√¥ture.':'‚ö†Ô∏è De opmerking is verplicht voor het afsluiten.' }); return menu(job) }
        const formatted=createFormattedText(info);
        const c=await botui.action.button({ action:[ {text:isFr?'Confirmer la cl√¥ture':'Sluiting bevestigen', value:'yes'},{text:isFr?'Annuler':'Annuleren', value:'no'} ] });
        if(c.value!=='yes') return menu(job);
        await submitUpdate({ action:'CLOSE', jobId:job.Id, email:sessionEmail, lang, text:formatted }, isFr?'Statut mis √† jour en commentaar is opgeslagen.':'Status bijgewerkt en opmerking vastgelegd.');
        try{ jobPayload=await fetchJobDetails(); renderJobHeader(jobPayload.Job); if(!isJobOpen(jobPayload.Job)){ await botui.message.add({ content:isFr?'‚úÖ T√¢che cl√¥tur√©e.':'‚úÖ Taak afgesloten.' }); closeDocPanel(); return } }catch{}
        return menu(jobPayload.Job);
      }
    }

    async function startFlow(){
      try{
        if(!jobId){ await botui.message.add({ type:'html', content:'<span style="color:red;font-weight:bold">Geen geldige Job ID.</span>' }); Telemetry.send('invalid_job_id'); return }
        const loginSuccess=await emailIntroAndLogin(); if(!loginSuccess) return;
        await botui.message.add({ content:isFr?'Je r√©cup√®re les d√©tails de la t√¢che‚Ä¶':'Ik haal de taakdetails op‚Ä¶' });
        jobPayload=await fetchJobDetails(); const job=jobPayload?.Job||{}; if(!job.Id) throw new Error('Job details ontvangen, maar taak-ID ontbreekt in de payload.');
        await showJobTextsThenAskTranslate(job);
        if(!isJobOpen(job)){ await botui.message.add({ content:isFr?'Cette t√¢che est d√©j√† cl√¥tur√©e. Aucune action possible.':'Deze taak is al afgesloten. Geen acties meer mogelijk.' }); Telemetry.send('job_closed',{status:job.Status}); return }
        await menu(job);
      }catch(e){
        const errorDetail=String(e.message||e); console.error('FATALE FOUT IN FLOW:', e);
        let userMessage=isFr?'‚ùå Erreur: Une erreur inattendue est survenue. Veuillez r√©essayer plus tard.':'‚ùå Fout: Er is een onverwachte fout opgetreden. Probeer later opnieuw.';
        if(errorDetail.includes('HTTP')) userMessage=isFr?`‚ùå Erreur de connexion: Le chargement a √©chou√© (D√©tail: ${errorDetail}).`:`‚ùå Verbindingsfout: Laden is onderbroken (D√©tail: ${errorDetail}).`;
        await botui.message.add({ content:userMessage, type:'html', cssClass:'error-message' }); Telemetry.send('fatal_error',{ err:errorDetail });
      }
    }

    /* ‚ñ∏ 11. Idle ping ‚óÇ */
    let lastActivity=Date.now(); ['click','keydown','touchstart'].forEach(ev=>document.addEventListener(ev,()=>lastActivity=Date.now(),{passive:true}));
    setInterval(()=>{ const ms=Date.now()-lastActivity; if(ms>45000){ Telemetry.send('idle',{inactiveMs:ms}); lastActivity=Date.now() } },5000);
    addEventListener('pagehide',()=>Telemetry.send('pagehide'));

    /* ‚ñ∏ 12. Start ‚óÇ */
    startFlow();
  </script>
</body>
</html>