<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Opvolging â€” met Documentenpaneel</title>

  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
  <style>
    /* ====== Basis layout (zoals origineel) ====== */
    html, body{height:auto;min-height:100vh;width:100%;margin:0;padding:0;box-sizing:border-box;
      font-family:'Segoe UI',sans-serif;background-color:#f4f6fa;overflow-y:auto}
    body{background-image:url('/afmeldentaak.png');background-size:cover;background-repeat:no-repeat;background-position:center}
    *{box-sizing:border-box}

    .header-flex{display:flex;flex-direction:column;align-items:center;max-width:600px;width:100%;margin:0 auto;padding:.5rem 0;gap:.5rem}
    img.logo{max-height:60px;height:auto;width:auto;display:block;margin:0 auto;background:rgba(255,255,255,.85);padding:.1rem;border-radius:12px}
    .header-flex .ruimte-label{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;background:rgba(255,255,255,.95);color:#1a202c;padding:.5rem 1rem;border-radius:12px;font-size:1rem;font-weight:500;white-space:normal;box-shadow:0 2px 6px rgba(0,0,0,.05);border:2px solid #EE7E00;box-shadow:0 2px 8px rgba(238,126,0,.06);width:100%;max-width:600px;margin:0 auto;border-bottom-width:4px}
    .lang-switch{text-align:right;padding-right:1rem;margin-top:1rem}
    .lang-switch a{margin:0 .5rem;text-decoration:none;font-size:1.2rem}
    #botui-app{width:100%;max-width:600px;margin:1rem auto 0 auto;padding:.5rem 1rem 1rem}
    .botui-container{max-width:600px;width:100%;margin:0 auto;background:linear-gradient(120deg,#fff 85%,#f4f6fa 100%);border:2px solid #EE7E00;box-shadow:0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);border-radius:12px;padding:1rem;box-sizing:border-box;opacity:0;animation:fadeIn 3s ease forwards}
    .botui-container,.botui-message-content{font-family:'Segoe UI',sans-serif}
    .botui-button{font-weight:600;border:none;box-shadow:0 2px 6px rgba(238,126,0,.04);transition:background .12s}
    .botui-button:active{background:#d86e00}

    .meldingen-lijst{background:#f5f8fc;border-radius:10px;padding:.7em 1em;margin:.7em 0;border-left:4px solid #EE7E00}
    .job-description-box{background:#e0f2fe;border-radius:10px;padding:.7em 1em;margin:.7em 0;border-left:4px solid #3b82f6}

    @keyframes fadeIn{to{opacity:1}}

	.ruimte-label .customer {
	  font-size: 1.25rem;         /* groot */
	  font-weight: 700;
	  color: #111827;
	  line-height: 1.25;
	  margin-bottom: .15rem;
	}
	.ruimte-label .complex {
	  font-size: 1rem;            /* kleiner */
	  font-weight: 600;
	  color: #374151;
	  margin-bottom: .25rem;
	}
	.ruimte-label .jobidline {
	  font-size: .9rem;           /* nog kleiner */
	  font-weight: 600;
	  color: #1f2937;
	}


    .botui-actions-text-input {width:100% !important; max-width:50% !important; flex-grow:1 !important}

    .view-doc-btn{background:none;border:1px solid #EE7E00;color:#EE7E00;padding:4px 8px;cursor:pointer;font-size:.8rem;border-radius:4px;transition:background-color .1s}
    .view-doc-btn:hover{background-color:#EE7E00;color:#fff}

    @media(max-width:768px){
      .header-flex{flex-wrap:wrap;justify-content:center}
      .header-flex .ruimte-label,img.logo{flex:0 0 90%;max-width:90%;text-align:center}
      .header-flex .ruimte-label{font-size:.95rem;padding:.5rem}
      .botui-container{padding:.75rem;max-width:95%}
      .botui-actions-text-input{max-width:100% !important}
    }

    /* ====== Documentenpaneel (nieuw) ====== */
    .doc-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:saturate(140%) blur(1px);z-index:990;opacity:0;transition:opacity .18s ease}
    .doc-backdrop[hidden]{display:none}

    .doc-panel{position:fixed;top:0;right:0;height:100vh;width:min(560px,96vw);background:#ffffff;box-shadow:-2px 0 18px rgba(0,0,0,.18);border-left:3px solid #EE7E00;z-index:999;transform:translateX(100%);transition:transform .22s ease}
    .doc-panel.open{transform:translateX(0)}

    .doc-panel-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid #eee}
    .doc-panel-header #doc-panel-title{font-weight:700}
    .doc-close-btn{background:none;border:0;font-size:1.2rem;cursor:pointer;color:#1f2937}

    .doc-panel-body{display:grid;grid-template-columns:1fr;grid-template-rows:auto 1fr;gap:.75rem;height:calc(100vh - 56px);padding:0 .75rem .75rem}

    .doc-preview{border:1px solid #e5e7eb;border-radius:8px;padding:.5rem;overflow:auto;min-height:160px;background:#fafafa}
    .doc-preview .pdf-tip{font-size:.85rem;color:#6b7280}

    .doc-list{border:1px solid #e5e7eb;border-radius:8px;overflow:auto}
    .doc-table{width:100%;border-collapse:collapse;font-size:.92rem}
    .doc-table th,.doc-table td{padding:.4rem .5rem;border-bottom:1px solid #f0f0f0}
    .doc-table th{text-align:left;background:#fafafa;position:sticky;top:0;z-index:1}

    /* Drijvende actieknop */
    .doc-fab{position:fixed;right:16px;bottom:16px;height:48px;min-width:48px;border-radius:24px;border:2px solid #EE7E00;background:#fff;color:#EE7E00;padding:0 14px;display:flex;align-items:center;gap:.5rem;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,.16);z-index:980;font-weight:700}
    .doc-fab:hover{background:#FFF8F1}
    
    /* Nieuwe stijl voor info over de knop */
    .document-tip{
        background:#ffedd5; /* Licht oranje/geel */
        border-left:4px solid #EE7E00; 
        padding:.7em 1em;
        margin-top:.7em;
        border-radius:4px;
        font-size:.95rem;
    }

    @media (max-width:640px){
      .doc-panel{width:100vw;border-left-width:0;border-top:3px solid #EE7E00}
      .doc-panel-body{grid-template-rows:1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="lang-switch">
      <a href="#" id="switch-nl">ğŸ‡³ğŸ‡± NL</a> |
      <a href="#" id="switch-fr">ğŸ‡«ğŸ‡· FR</a>
    </div>
    <div class="header-flex">
      <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
      <div id="job-info" class="ruimte-label" style="display:none"></div>
    </div>
  </header>

  <div id="botui-app"><bot-ui></bot-ui></div>

  <div id="doc-backdrop" class="doc-backdrop" hidden></div>
  <aside id="doc-panel" class="doc-panel" aria-hidden="true">
    <div class="doc-panel-header">
      <div id="doc-panel-title">ğŸ“ Documenten</div>
      <button id="doc-panel-close" class="doc-close-btn" aria-label="Sluiten">âœ•</button>
    </div>
    <div class="doc-panel-body">
      <div id="doc-preview" class="doc-preview">
        <div class="pdf-tip">Selecteer een document uit de lijst om de preview te zien. PDF's openen in een nieuw tabblad of via downloadlink.</div>
      </div>
      <div id="doc-list" class="doc-list"></div>
    </div>
  </aside>
  <button id="doc-fab" class="doc-fab" type="button">ğŸ“ Documenten</button>

  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>

 <script type="module">
Â  Â  /* â–¸ 0. Endpoints â—‚ */
Â  Â  const endpointJobDetails = `/.netlify/functions/jobsvendor`;
Â  Â  const endpointUpdateÂ  Â  Â = endpointJobDetails;

Â  Â  /* â–¸ 1. Parameters â—‚ */
Â  Â  const qsÂ  Â  Â = new URLSearchParams(window.location.search);
Â  Â  const jobIdÂ  = qs.get('job') || qs.get('jobId') || '';
Â  Â  letÂ  Â langÂ  Â = qs.get('lang') || ((navigator.language||'').startsWith('fr') ? 'fr' : 'nl');
Â  Â  const isFrÂ  Â = (lang === 'fr');

Â  Â  if (isFr) document.body.style.backgroundImage = "url('/afmeldentaak_fr.png')";

Â  Â  /* â–¸ 2. Telemetrie (light) â—‚ */
Â  Â  const Telemetry = (()=>{Â 
Â  Â  Â  const base = { jobId: String(jobId), lang, env: qs.has('test') ? 'test' : 'prod' };
Â  Â  Â  async function send(type, extra={}){
Â  Â  Â  Â  const json = JSON.stringify({ type, ts: Date.now(), href: location.href, ...base, ...extra });
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  if (navigator.sendBeacon && navigator.sendBeacon('/.netlify/functions/formlog', new Blob([json],{type:'application/json'}))) return;
Â  Â  Â  Â  Â  await fetch('/.netlify/functions/formlog',{ method:'POST', headers:{'content-type':'application/json'}, body: json, keepalive:true });
Â  Â  Â  Â  }catch{}
Â  Â  Â  }
Â  Â  Â  return { send };
Â  Â  })();
Â  Â  Telemetry.send('vendor_html_load');

Â  Â  /* â–¸ 3. UI helpers â—‚ */
Â  Â  const botui = new BotUI('botui-app');
Â  Â  const elInfo = document.getElementById('job-info');
Â  Â  document.getElementById('switch-nl').onclick = ()=>{const u=new URL(location.href);u.searchParams.set('lang','nl');location.href=u;};
Â  Â  document.getElementById('switch-fr').onclick = ()=>{const u=new URL(location.href);u.searchParams.set('lang','fr');location.href=u;};

Â  Â  let sessionEmail='';
Â  Â  let jobPayload=null;

Â  Â  /* ====== Documentenpaneel helpers ====== */
Â  Â  const $panelÂ  Â = document.getElementById('doc-panel');
Â  Â  const $backdrop= document.getElementById('doc-backdrop');
Â  Â  const $fabÂ  Â  Â = document.getElementById('doc-fab');
Â  Â  const $closeÂ  Â = document.getElementById('doc-panel-close');
Â  Â  const $listÂ  Â  = document.getElementById('doc-list');
Â  Â  const $preview = document.getElementById('doc-preview');
Â  Â  const $titleÂ  Â = document.getElementById('doc-panel-title');

Â  Â  // Vertaal de tekst op de drijvende knop (FAB)
Â  Â  $fab.textContent = isFr ? 'ğŸ“ Documents' : 'ğŸ“ Documenten';

Â  Â  function openDocPanel(){
Â  Â  Â  $panel.classList.add('open');
Â  Â  Â  $panel.setAttribute('aria-hidden','false');
Â  Â  Â  $backdrop.hidden=false; requestAnimationFrame(()=>{$backdrop.style.opacity=1});
Â  Â  }
Â  Â  function closeDocPanel(){
Â  Â  Â  $panel.classList.remove('open');
Â  Â  Â  $panel.setAttribute('aria-hidden','true');
Â  Â  Â  $backdrop.style.opacity=0; setTimeout(()=>{$backdrop.hidden=true},180);
Â  Â  }
Â  Â Â 
Â  Â  // Event listener voor FAB: opent en herlaadt altijd de documenten
Â  Â  $fab.addEventListener('click', async ()=>{Â 
Â  Â  Â  Â  openDocPanel();Â 
Â  Â  Â  Â  await loadAndRenderDocuments(jobId).catch(console.error);Â 
Â  Â  });
Â  Â Â 
Â  Â  $close.addEventListener('click',closeDocPanel);
Â  Â  $backdrop.addEventListener('click',closeDocPanel);

Â  Â  /* â–¸ 4. Helpers â—‚ */
Â  Â  const stripHtml=(s='')=>s.replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ').replace(/\s{2,}/g,' ').trim();
Â  Â  function formatIsoToLocal(iso){try{const d=new Date(iso);if(isNaN(d.getTime())) return isFr?'Date non valide':'Invalid Date'; return d.toLocaleString()}catch{ return iso||(isFr?'Date non valide':'Invalid Date') }}

Â  Â  async function fetchJobDocuments(jobId){
Â  Â  Â  const url = `${endpointJobDetails}?action=LIST_JOB_DOCS&jobId=${encodeURIComponent(jobId)}`;
Â  Â  Â  const r=await fetch(url,{headers:{accept:'application/json'}});
Â  Â  Â  if(!r.ok) throw new Error(`HTTP ${r.status}`);
Â  Â  Â  const data=await r.json();
Â  Â  Â  return Array.isArray(data?.Documents)?data.Documents:[];
Â  Â  }

Â  Â  async function fetchDocumentBase64(docId){
Â  Â  Â  // Voortgangsbericht verwijderd
Â  Â  Â  const url = `${endpointJobDetails}?action=GET_JOB_DOC&docId=${encodeURIComponent(docId)}`;
Â  Â  Â  const r=await fetch(url,{headers:{accept:'application/json'}});
Â  Â  Â  if(!r.ok) throw new Error(`HTTP ${r.status}`);
Â  Â  Â  const data=await r.json();
Â  Â  Â  const b64=data?.Document; if(!b64||typeof b64!=='string') throw new Error(isFr?'DonnÃ©es du document introuvables.':'Documentdata niet gevonden.');
Â  Â  Â  return b64;
Â  Â  }

Â  Â  // NIEUWE FIX: Voeg Base64 data toe aan de MIME type bepaling als fallback
Â  Â  function getMimeType(docType, description, base64Data){
Â  Â  Â  const t=(docType||'').toUpperCase();
Â  Â  Â  // 1. Check op basis van Ultimo data
Â  Â  Â  if(t==='PDF') return 'application/pdf';
Â  Â  Â  if(t==='JPEG'||t==='JPG') return 'image/jpeg';
Â  Â  Â  if(t==='PNG') return 'image/png';
Â  Â  Â  const desc=(description||'').toLowerCase();
Â  Â  Â  if(desc.endsWith('.pdf')) return 'application/pdf';
Â  Â  Â  if(desc.endsWith('.jpg')||desc.endsWith('.jpeg')) return 'image/jpeg';
Â  Â  Â  if(desc.endsWith('.png')) return 'image/png';
Â  Â  Â  if(desc.endsWith('.doc')||desc.endsWith('.docx')) return 'application/msword';
Â  Â  Â  if(desc.endsWith('.xls')||desc.endsWith('.xlsx')) return 'application/vnd.ms-excel';

Â  Â  Â  // 2. Fallback: Check Base64 "Magic Number" (eerste paar karakters)
Â  Â  Â  if (base64Data && base64Data.length > 10) {
Â  Â  Â  Â  const prefix = base64Data.substring(0, 20);
Â  Â  Â  Â  if (prefix.startsWith('/9j/')) return 'image/jpeg'; // JPEG (start met FF D8 FF E0/E1 in binary)
Â  Â  Â  Â  if (prefix.startsWith('iVBORw0KGgo')) return 'image/png'; // PNG
Â  Â  Â  Â  if (prefix.startsWith('JVBERi0x')) return 'application/pdf'; // PDF
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  return 'application/octet-stream'; // Standaard onbekend type
Â  Â  }

Â  Â  async function displayBase64InPanel(docId, docType, docDescription, base64Data){
Â  Â  Â  const mimeType=getMimeType(docType, docDescription, base64Data); // Argument toegevoegd
Â  Â  Â  const dataUrl=`data:${mimeType};base64,${base64Data}`;
Â  Â  Â  const fileName=(docDescription||`${docId}.${(docType||'bin').toLowerCase()}`);

Â  Â  Â  let html='';
Â  Â  Â  if(mimeType.startsWith('image/')){
Â  Â  Â  Â  html = `<figure style="margin:0"><img src="${dataUrl}" alt="${docId}" style="max-width:100%;height:auto;border:1px solid #ddd;border-radius:6px"/><figcaption style="font-size:.85rem;color:#6b7280;margin-top:.25rem">${fileName}</figcaption></figure>`;
Â  Â  Â  } else if (mimeType==='application/pdf'){
Â  Â  Â  Â  html = `<div class="pdf-tip">${isFr? 'Ce document est un PDF. Ouvrez/le tÃ©lÃ©chargez via le lien ciâ€‘dessous.' : 'Dit is een PDF. Open of download via de link hieronder.'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <p><a href="${dataUrl}" target="_blank" download="${fileName}" style="display:inline-block;padding:8px 14px;background:#EE7E00;color:#fff;text-decoration:none;border-radius:6px;font-weight:700">${isFr?'Ouvrir/TÃ©lÃ©charger PDF':'PDF openen/downloaden'}</a></p>`;
Â  Â  Â  } else {
Â  Â  Â  Â  html = `<p style="color:#b91c1c">${isFr?`Type non supportÃ© (${mimeType}).`:`Niet-ondersteund type (${mimeType}).`}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p><a href="${dataUrl}" target="_blank" download="${fileName}${mimeType==='application/octet-stream'?'.dat':''}" style="color:#EE7E00;font-weight:700">${isFr?'TÃ©lÃ©charger l\'original':'Origineel downloaden'}</a></p>`;
Â  Â  Â  }
Â  Â  Â  $preview.innerHTML = html;
Â  Â  }

Â  Â  /* â–¸ 5. Login â—‚ */
Â  Â  const copy = { nl:{ intro1:"Welkom! We helpen je om deze taak snel en correct af te ronden. ğŸ‘‹", ask:"Gelieve uw login in te voeren:", invalid:"Foutieve login." }, fr:{ intro1:"Bienvenue ! Nous vous aidons Ã  clÃ´turer cette tÃ¢che rapidement et correctement. ğŸ‘‹", ask:"Veuillez entrer votre identifiant :", invalid:"Erreur d'identifiant." } };

	async function isAllowedBusinessMail(e=''){
	Â  const okSyntax=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); if(!okSyntax) return false;
	Â  try{ const url=`${endpointJobDetails}?jobId=${encodeURIComponent(jobId)}&email=${encodeURIComponent(e)}&controle=${encodeURIComponent(e)}`;
		const r=await fetch(url,{headers:{accept:'application/json'}}); if(!r.ok) return false; const data=await r.json(); return !!data?.allowed; }catch{ return false }
	}

Â  Â  async function emailIntroAndLogin(){
Â  Â  Â  const t=isFr?copy.fr:copy.nl; await botui.message.add({ content:t.intro1 });
Â  Â  Â  let attempts=0; while(attempts<3){
Â  Â  Â  Â  await botui.message.add({ content:t.ask });
Â  Â  Â  Â  const a=await botui.action.text({ action:{ placeholder:isFr?'prenom.nom@exemple.com':'voornaam.naam@voorbeeld.com' } });
Â  Â  Â  Â  const email=(a.value||'').trim().toLowerCase();
Â  Â  Â  Â  if(!(await isAllowedBusinessMail(email))){ attempts++; if(attempts>=3){ await botui.message.add({ content: isFr?'âŒ Maximum d\'essais atteint. Le flux de travail est terminÃ©.':'âŒ Maximum aantal pogingen bereikt. De workflow is beÃ«indigd.' }); Telemetry.send('login_max_attempts'); return false }
Â  Â  Â  Â  Â  const remaining=3-attempts; const msg=isFr?`${t.invalid} Il vous reste ${remaining} essai${remaining!==1?'s':''}.`:`${t.invalid} Je hebt nog ${remaining} poging(en) over.`; await botui.message.add({ content: msg }); continue; }
Â  Â  Â  Â  sessionEmail=email; Telemetry.send('email_ok',{ emailMasked: email.replace(/(.).+(@.*)/,'$1***$2') }); return true;
Â  Â  Â  }
Â  Â  Â  return false;
Â  Â  }

Â  Â  /* â–¸ 6. Data â—‚ */
Â  Â  async function fetchJobDetails(){
Â  Â  Â  const url=`${endpointJobDetails}?jobId=${encodeURIComponent(jobId)}&lang=${lang}&action=VIEW&email=${encodeURIComponent(sessionEmail)}`;
Â  Â  Â  const r=await fetch(url,{headers:{accept:'application/json'}}); if(!r.ok){ const errorText=await r.text(); console.error(`Fetch error ${r.status}: ${errorText}`); throw new Error(`HTTP ${r.status} - ${r.statusText||'Server Error'}`) } return r.json();
Â  Â  }
Â  Â  function isJobOpen(job){ const s=String(job?.Status??'').trim(); if(!s) return true; return s!=='1016' }
	function renderJobHeader(job){
	Â  const klantÂ  Â = (job.CustomerName || '').trim();
	Â  const complex = (job.ComplexNameÂ  || '').trim();

	Â  const lineCustomer = klant || (isFr ? 'Client inconnu' : 'Onbekende klant');
	Â  const lineComplexÂ  = complex || (isFr ? 'Complexe inconnu' : 'Onbekend complex');

	Â  elInfo.innerHTML = `
		<div class="customer">${lineCustomer}</div>
		<div class="complex">${lineComplex}</div>
		<div class="jobidline">${isFr ? 'ID tÃ¢che' : 'Job ID'}: ${job.Id}</div>
	Â  `;
	Â  elInfo.style.display = 'flex';
	}


Â  Â  /* â–¸ 7. Vertalen (zoals origineel, compacter gehouden) â—‚ */
Â  Â  async function translateText(text, from, to){ if(!text||from===to) return {text, detected:null}; try{ const r=await fetch('/.netlify/functions/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,source:from||undefined,target:to})}); if(!r.ok) throw new Error(await r.text()); const data=await r.json(); return { text:data?.text??text, detected:data?.detected??null } }catch{ return { text, detected:null } } }

	let hasJobDocuments = false;

	async function showJobTextsThenAskTranslate(job){
		renderJobHeader(job);
		const rawDesc=job.Description||''; const rawReport=job.Report||job.JobReportText||''; const rawInstr=job.Instructions||job.JobText||'';
		if(rawDesc.trim()) await botui.message.add({ type:'html', content:`<div class='job-description-box'><b>${isFr?'Description (originale)':'Beschrijving (origineel)'}</b><br>${stripHtml(rawDesc)}</div>` });
		if(rawReport.trim()) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Remarque (originale)':'Toelichting (origineel)'}</b><br>${stripHtml(rawReport)}</div>` });
		if(rawInstr.trim()) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Instructions (original)':'Werkinstructies (origineel)'}</b><br>${stripHtml(rawInstr)}</div>` });

		await botui.message.add({ content: isFr?'Les dÃ©tails originaux sont affichÃ©s ci-dessus. Voulez-vous une version traduite ?':'De originele details worden hierboven weergegeven. Wil je een vertaalde versie zien?' });
		const choice=await botui.action.button({ action:[ {text:isFr?'ğŸŒ Traduire en franÃ§ais':'ğŸŒ Vertalen naar Nederlands',value:'yes'},{text:isFr?'Sans traduction':'Zonder vertaling',value:'no'} ] });
		if(choice.value==='yes'){
			const dst=isFr?'fr':'nl';
			const descRes=await translateText(rawDesc,'auto',dst);
			const repRes =await translateText(rawReport,'auto',dst);
			const insRes =await translateText(rawInstr,'auto',dst);
			const badge =(d)=> d?`<small style='color:#6b7280'>(${isFr?'traduit de':'vertaald uit'}: ${d.toUpperCase()})</small>`:'';
			const shouldDisplay=(res,target,raw)=>{ const t=target.toLowerCase(); if(!(res.text||'').trim()) return false; if(res.detected&&res.detected.toLowerCase()!==t) return true; const a=stripHtml(raw).trim(), b=stripHtml(res.text).trim(); return a!==b };
			if(shouldDisplay(descRes,dst,rawDesc)) await botui.message.add({ type:'html', content:`<div class='job-description-box'><b>${isFr?'Description (traduite)':'Beschrijving (vertaald)'}</b> ${badge(descRes.detected)}<br>${stripHtml(descRes.text)}</div>` });
			if(shouldDisplay(repRes ,dst,rawReport)) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Remarque (traduite)':'Toelichting (vertaald)'}</b> ${badge(repRes.detected)}<br>${stripHtml(repRes.text)}</div>` });
			if(shouldDisplay(insRes ,dst,rawInstr)) await botui.message.add({ type:'html', content:`<div class='meldingen-lijst'><b>${isFr?'Instructions (traduite)':'Werkinstructies (vertaald)'}</b> ${badge(insRes.detected)}<br>${stripHtml(insRes.text)}</div>` });
			await botui.message.add({ type:'html', content:`<small style='color:#6b7280'>${isFr?'Affichage traduit ajoutÃ© sous lâ€™original.':'Vertaalde weergave toegevoegd onder het origineel.'}</small>` });
		}

		// AANPASSING: Voeg het bericht over de FAB-knop ALLEEN toe als er documenten zijn
		if (hasJobDocuments) {Â 
			await botui.message.add({Â 
				type: 'html',Â 
				content: `<div class="document-tip">
							${isFrÂ 
								? '<b>Important :</b> Les documents liÃ©s Ã  cette tÃ¢che peuvent Ãªtre consultÃ©s Ã  tout moment via le bouton **ğŸ“ Documents** flottant en bas Ã  droite.'Â 
								: '<b>Belangrijk:</b> Documenten gekoppeld aan deze taak zijn op elk moment in te zien via de zwevende knop **ğŸ“ Documenten** rechtsonder.'}
						</div>`Â 
			});
		}
	}

Â  Â  /* â–¸ 8. Update wrapper â—‚ */
Â  Â  async function submitUpdate(payload, successMsg){ const r=await fetch(endpointUpdate,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); if(!r.ok) throw new Error(await r.text()); await botui.message.add({ content: successMsg }) }

Â  Â  /* â–¸ 9. Documentenlijst in paneel â—‚ */
	async function loadAndRenderDocuments(jobId){
	Â  Â  Â  $title.textContent = isFr? 'ğŸ“ Documents' : 'ğŸ“ Documenten';
	Â  Â  Â  $list.innerHTML = `<div style="padding:.75rem;color:#6b7280">${isFr?'Chargement des documentsâ€¦':'Documenten ladenâ€¦'}</div>`;
	Â  Â  Â  // Zorgt ervoor dat de preview terug naar de tip gaat bij een nieuwe lijst-laadactie
Â  Â  Â  Â  $preview.innerHTML = `<div class="pdf-tip">Selecteer een document uit de lijst om de preview te zien. PDF's openen in een nieuw tabblad of via downloadlink.</div>`;Â 

Â  Â  Â  Â  // Clone/replace om oude listeners op de lijst (indien aanwezig) te verwijderen
Â  Â  Â  Â  const listClone = $list.cloneNode(true);
Â  Â  Â  Â  $list.parentNode.replaceChild(listClone, $list);
Â  Â  Â  Â  const $newList = document.getElementById('doc-list');

	Â  Â  Â  try{
	Â  Â  Â  Â  const docs=await fetchJobDocuments(jobId);
	Â  Â  Â  Â  if(!docs.length){ $newList.innerHTML=`<div style='padding:.75rem'>${isFr?'Aucun document liÃ© Ã  cette tÃ¢che.':'Geen documenten gekoppeld aan deze taak.'}</div>`; return }

	Â  Â  Â  Â  const rows = docs.map(d=>{
	Â  Â  Â  Â  Â  const id = d.Id || '';
	Â  Â  Â  Â  Â  const desc = stripHtml(d.Description||'');
	Â  Â  Â  Â  Â  const typ = d.DocumentType || ''; // Nog nodig voor data-type
	Â  Â  Â  Â  Â  return `<tr>
	Â  Â  Â  Â  Â  Â  <td>${desc}</td>
	Â  Â  Â  Â  Â  Â  <td style='width:1%;white-space:nowrap'>
	Â  Â  Â  Â  Â  Â  Â  <button class='view-doc-btn' data-id='${id}' data-type='${typ}' data-desc='${desc}'>${isFr?'Voir':'Bekijken'}</button>
	Â  Â  Â  Â  Â  Â  </td>
	Â  Â  Â  Â  Â  </tr>`;
	Â  Â  Â  Â  }).join('');

	Â  Â  Â  Â  $newList.innerHTML = `<div style='overflow:auto'>
	Â  Â  Â  Â  Â  <table class='doc-table'>
	Â  Â  Â  Â  Â  Â  <thead>
	Â  Â  Â  Â  Â  Â  Â  <tr>
	Â  Â  Â  Â  Â  Â  Â  Â  <th>${isFr?'Description':'Omschrijving'}</th>
	Â  Â  Â  Â  Â  Â  Â  Â  <th>${isFr?'Actie':'Actie'}</th>
	Â  Â  Â  Â  Â  Â  Â  </tr>
	Â  Â  Â  Â  Â  Â  </thead>
	Â  Â  Â  Â  Â  Â  <tbody>${rows}</tbody>
	Â  Â  Â  Â  Â  </table>
	Â  Â  Â  Â  </div>`;
	Â  Â  Â  Â Â 
	Â  Â  Â  Â  // Bind de nieuwe event listener aan de (nieuwe) lijst
	Â  Â  Â  Â  $newList.addEventListener('click', async (ev)=>{
	Â  Â  Â  Â  Â  const btn = ev.target.closest('button.view-doc-btn'); if(!btn) return;
	Â  Â  Â  Â  Â  btn.disabled=true; const old=btn.textContent; btn.textContent=isFr?'Chargementâ€¦':'Ladenâ€¦';
	Â  Â  Â  Â  Â  try{
	Â  Â  Â  Â  Â  Â  const b64 = await fetchDocumentBase64(btn.dataset.id);
	Â  Â  Â  Â  Â  Â  await displayBase64InPanel(btn.dataset.id, btn.dataset.type, btn.dataset.desc, b64);
	Â  Â  Â  Â  Â  }catch(e){ await botui.message.add({ content: isFr?`âŒ Erreur de chargement du contenu: ${e.message}`:`âŒ Fout bij laden inhoud: ${e.message}` }); }
	Â  Â  Â  Â  Â  finally{ btn.disabled=false; btn.textContent=old }
	Â  Â  Â  Â  });
	Â  Â  Â  }catch(e){
	Â  Â  Â  Â  console.error(e);
	Â  Â  Â  Â  $newList.innerHTML = `<div style='padding:.75rem;color:#b91c1c'>${isFr?'Ã‰chec du chargement des documents.':'Documenten laden mislukt.'} (${e.message})</div>`;
	Â  Â  Â  }
	Â  Â  }

Â  Â  /* â–¸ 10. Flow â—‚ */
Â  Â  const createFormattedText=(s)=>`<span style="color:#007bff;font-weight:bold;">${(s||'').trim()}</span>`;

	async function menu(job, opts = {}) {
		Â  if (!opts.silent) {
			await botui.message.add({ content: isFr ? `Que voulez-vous faire pour la tÃ¢che ${job.Id}?` : `Wat wil je doen voor taak ${job.Id}?` });
		Â  }

		Â  // EENMALIGE DEFINITIE: Alle 3 de knoppen, inclusief de correcte "Sessie verlaten"
		Â  const ans = await botui.action.button({
			action: [
			Â  { text: isFr ? 'â• Ajouter un commentaire' : 'â• Info toevoegen', value: 'info' },
			Â  { text: isFr ? 'âœ… Terminer la tÃ¢che'Â  Â  Â  : 'âœ… Taak afronden',Â  value: 'done' },
			Â  { text: isFr ? 'ğŸ›‘ Quitter la session'Â  Â  Â  : 'ğŸ›‘ Sessie verlaten', value: 'exit', cssClass:'secondary-button' }
			]
		Â  });

		Â  if (ans.value !== 'docs') {
			await botui.message.add({ human: true, content: ans.text });
		Â  }

	Â  Â  Â  if(ans.value==='info'){
	Â  Â  Â  Â  await botui.message.add({ content:isFr?'Votre commentaire :':'Jouw commentaar:' });
	Â  Â  Â  Â  const t=await botui.action.text({ action:{ placeholder:isFr?'DÃ©tailâ€¦':'Detailâ€¦' } });
	Â  Â  Â  Â  const info=(t.value||'').trim(); if(!info){ await botui.message.add({ content:isFr?'âš ï¸ Entrez un texte.':'âš ï¸ Geef wat tekst in.' }); return menu(job) }
	Â  Â  Â  Â  const formatted=createFormattedText(info);
	Â  Â  Â  Â  await submitUpdate({ action:'ADD_INFO', jobId:job.Id, text:formatted, email:sessionEmail, lang }, isFr?'Commentaire ajoutÃ©.':'Commentaar toegevoegd.');
	Â  Â  Â  Â  try{ jobPayload=await fetchJobDetails(); renderJobHeader(jobPayload.Job); if(!isJobOpen(jobPayload.Job)){ await botui.message.add({ content:isFr?'âœ… TÃ¢che clÃ´turÃ©e.':'âœ… Taak afgesloten.' }); closeDocPanel(); return } }catch{}
	Â  Â  Â  Â  return menu(jobPayload.Job);
	Â  Â  Â  }
		Â Â 
		Â  // ACTIE: EINDE / EXIT (met de ğŸ”š emoji in de afsluitende tekst)
	Â  Â  Â  if(ans.value==='exit'){
	Â  Â  Â  Â  Â  await botui.message.add({Â 
	Â  Â  Â  Â  Â  Â  Â  content: isFrÂ 
	Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'ğŸ”š Merci. Vous pouvez fermer cette fenÃªtre. Si vous heeft nog actions pour cette tÃ¢che, veuillez rafraÃ®chir la page.'Â 
	Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'ğŸ”š Bedankt. Je kunt dit venster sluiten. Als je later nog acties voor deze taak hebt, ververs dan de pagina.'Â 
	Â  Â  Â  Â  Â  });
	Â  Â  Â  Â  Â  Telemetry.send('session_exit');
	Â  Â  Â  Â  Â  return;
	Â  Â  Â  }
		Â Â 
	Â  Â  Â  if(ans.value==='done'){
	Â  Â  Â  Â  await botui.message.add({ content:isFr?'Veuillez ajouter un commentaire pour finaliser la tÃ¢che :':'Gelieve een opmerking toe te voegen om de taak af te ronden:' });
	Â  Â  Â  Â  const t=await botui.action.text({ action:{ placeholder:isFr?'DÃ©tail obligatoireâ€¦':'Verplichte opmerkingâ€¦' } });
	Â  Â  Â  Â  const info=(t.value||'').trim(); if(!info){ await botui.message.add({ content:isFr?'âš ï¸ Le commentaire is obligatoire pour la clÃ´ture.':'âš ï¸ De opmerking is verplicht voor het afsluiten.' }); return menu(job) }
	Â  Â  Â  Â  const formatted=createFormattedText(info);
	Â  Â  Â  Â  const c=await botui.action.button({ action:[ {text:isFr?'Confirmer la clÃ´ture':'Sluiting bevestigen', value:'yes'},{text:isFr?'Annuler':'Annuleren', value:'no'} ] });
	Â  Â  Â  Â  if(c.value!=='yes') return menu(job);
	Â  Â  Â  Â  await submitUpdate({ action:'CLOSE', jobId:job.Id, email:sessionEmail, lang, text:formatted }, isFr?'Statut mis Ã  jour en commentaar is opgeslagen.':'Status bijgewerkt en opmerking vastgelegd.');
	Â  Â  Â  Â  try{ jobPayload=await fetchJobDetails(); renderJobHeader(jobPayload.Job); if(!isJobOpen(jobPayload.Job)){ await botui.message.add({ content:isFr?'âœ… TÃ¢che clÃ´turÃ©e.':'âœ… Taak afgesloten.' }); closeDocPanel(); return } }catch{}
	Â  Â  Â  Â  return menu(jobPayload.Job);
	Â  Â  Â  }
		}

	async function startFlow(){
		try{
			if(!jobId){ await botui.message.add({ type:'html', content:'<span style="color:red;font-weight:bold">Geen geldige Job ID.</span>' }); Telemetry.send('invalid_job_id'); return }
			const loginSuccess=await emailIntroAndLogin(); if(!loginSuccess) return;
			await botui.message.add({ content:isFr?'Je rÃ©cupÃ¨re les dÃ©tails de la tÃ¢cheâ€¦':'Ik haal de taakdetails opâ€¦' });
			jobPayload=await fetchJobDetails(); const job=jobPayload?.Job||{}; if(!job.Id) throw new Error('Job details ontvangen, maar taak-ID ontbreekt in de payload.');
			
			// â­ NIEUWE STAP: Documenten check vÃ³Ã³r het tonen van de chatberichten
			try {
				const docs = await fetchJobDocuments(job.Id);
				hasJobDocuments = docs.length > 0;
			} catch (e) {
				console.warn('Kon documenten niet vooraf controleren:', e.message);
				hasJobDocuments = false; // Blijft false bij fout
			}
			// â­ EINDE NIEUWE STAP

			await showJobTextsThenAskTranslate(job);
			if(!isJobOpen(job)){ await botui.message.add({ content:isFr?'Cette tÃ¢che est dÃ©jÃ  clÃ´turÃ©e. Aucune action possible.':'Deze taak is al afgesloten. Geen acties meer mogelijk.' }); Telemetry.send('job_closed',{status:job.Status}); return }
			await menu(job);
		}catch(e){
			const errorDetail=String(e.message||e); console.error('FATALE FOUT IN FLOW:', e);
			let userMessage=isFr?'âŒ Erreur: Une erreur inattendue est survenue. Veuillez rÃ©essayer plus tard.':'âŒ Fout: Er is een onverwachte fout opgetreden. Probeer later opnieuw.';
			if(errorDetail.includes('HTTP')) userMessage=isFr?`âŒ Erreur de connexion: Le chargement a Ã©chouÃ© (DÃ©tail: ${errorDetail}).`:`âŒ Verbindingsfout: Laden is onderbroken (DÃ©tail: ${errorDetail}).`;
			await botui.message.add({ content:userMessage, type:'html', cssClass:'error-message' }); Telemetry.send('fatal_error',{ err:errorDetail });
		}
	}

Â  Â  /* â–¸ 11. Idle ping â—‚ */
Â  Â  let lastActivity=Date.now(); ['click','keydown','touchstart'].forEach(ev=>document.addEventListener(ev,()=>lastActivity=Date.now(),{passive:true}));
Â  Â  setInterval(()=>{ const ms=Date.now()-lastActivity; if(ms>45000){ Telemetry.send('idle',{inactiveMs:ms}); lastActivity=Date.now() } },5000);
Â  Â  addEventListener('pagehide',()=>Telemetry.send('pagehide'));

Â  Â  /* â–¸ 12. Start â—‚ */
Â  Â  startFlow();
Â  </script>
</body>
</html>