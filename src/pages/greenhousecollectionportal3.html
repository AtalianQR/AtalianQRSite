<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Greenhouse Portal</title>

  <link rel="icon" href="/AtalianFavicon.png" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6fa;
      min-height: 100vh;
    }
    * { box-sizing: border-box; }

    body {
      background-image: url('/greenhousecollection.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }

    /* TEST banner ‚Äì zelfde logica als portal.html */
    .test-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #28a745;
      color: white;
      text-align: center;
      padding: 5px 0;
      font-weight: bold;
      z-index: 1000;
      font-size: 14px;
      text-transform: uppercase;
      opacity: 0.9;
    }
    body.is-test {
      padding-top: 30px;
    }

    header {
      padding: 0.5rem 1rem 0;
    }
    .lang-switch {
      text-align: right;
      margin-bottom: 0.5rem;
    }
    .lang-switch a {
      margin: 0 .25rem;
      text-decoration: none;
      font-size: 1.1rem;
    }

    .header-flex {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
      gap: .5rem;
    }
    img.logo {
      max-height: 60px;
      background: rgba(255,255,255,0.85);
      padding: .1rem;
      border-radius: 12px;
    }

    .page-card {
      max-width: 600px;
      margin: 1rem auto 2rem;
      background: linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border: 2px solid #EE7E00;
      border-radius: 12px;
      box-shadow: 0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      padding: 1.25rem 1.5rem 1.5rem;
    }

    .page-card h1 {
      margin: 0 0 .5rem;
      font-size: 1.4rem;
    }
    .page-card p {
      margin-top: 0;
      color: #4b5563;
      font-size: .95rem;
    }

    .choice-row {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      margin: 1rem 0;
    }
    .choice-btn {
      flex: 1 1 47%;
      border: 2px solid #EE7E00;
      background: #fff;
      border-radius: 10px;
      padding: .75rem .5rem;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,.04);
      transition: background .12s, transform .08s, box-shadow .08s;
    }
    .choice-btn span.emoji {
      display: block;
      font-size: 1.4rem;
      margin-bottom: .25rem;
    }
    .choice-btn.active {
      background: #EE7E00;
      color: #fff;
      box-shadow: 0 4px 10px rgba(238,126,0,.35);
      transform: translateY(-1px);
    }

    .form-block {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
    }
    .form-block label {
      display: block;
      font-weight: 600;
      margin-bottom: .25rem;
    }
    select {
      width: 100%;
      padding: .45rem .6rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: .95rem;
    }

    .status {
      margin-top: .5rem;
      font-size: .9rem;
      color: #6b7280;
    }
    .status.error {
      color: #b91c1c;
    }

    .actions {
      margin-top: 1.25rem;
      display: flex;
      justify-content: flex-end;
      gap: .75rem;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: .55rem 1.4rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: .95rem;
    }
    .btn-primary {
      background: #EE7E00;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }
    .btn-primary:active {
      background: #d86e00;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    /* Nieuwe V2 stijlen voor de lijstweergave voor installaties */
    .equipment-filter-container input[type="text"] {
      width: 100%;
      padding: .4rem .45rem;
      border-radius: 6px;
      border: 1px solid #cdd4e4;
      font-size: .9rem;
    }
    .equipment-filter-container input[type="text"]:focus {
      outline: none;
      border-color: #EE7E00;
      box-shadow: 0 0 0 2px rgba(238,126,0,.18);
    }
    .equipment-list {
      margin-top: .5rem;
      max-height: 260px;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    .equipment-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: .45rem .6rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: .9rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .equipment-item:last-child {
      border-bottom: none;
    }
    .equipment-item:hover {
      background: rgba(238,126,0,.06);
    }
    .equipment-item.selected {
      background: rgba(238,126,0,.12);
      border-left: 3px solid #EE7E00;
    }
    .equipment-main {
      font-weight: 600;
      color: #111827;
    }
    .equipment-meta {
      font-size: .78rem;
      color: #4b5563;
    }
    /* Einde V2 stijlen */


    @media (max-width: 480px) {
      .page-card {
        margin: .75rem auto 1.5rem;
        padding: 1rem 1rem 1.25rem;
        max-width: 95%;
      }
      .choice-btn { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <div id="test-indicator" style="display:none" class="test-banner">
    ‚ö†Ô∏è TEST OMGEVING ACTIEF
  </div>

  <header>
    <div class="lang-switch">
      <a href="#" id="switch-nl">üá≥üá± NL</a> |
      <a href="#" id="switch-fr">üá´üá∑ FR</a>
    </div>
    <div class="header-flex">
      <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
    </div>
  </header>

  <main>
    <section class="page-card">
      <h1 id="title-text">Waarvoor wil je een ticket aanmaken?</h1>
      <p id="intro-text">
        Kies eerst of je een probleem wil melden voor een installatie of voor een ruimte (complex 006691. üåø)
      </p>

      <div class="choice-row">
        <button id="btn-installation" class="choice-btn" type="button" data-type="equipment">
          <span class="emoji">üîß</span>
          <span id="lbl-installation">Installatie</span>
        </button>
        <button id="btn-room" class="choice-btn" type="button" data-type="space">
          <span class="emoji">üè¢</span>
          <span id="lbl-room">Ruimte</span>
        </button>
      </div>

      <div class="form-block" id="block-select" style="display:none">
	  <label id="label-building" for="select-building" style="display:none;">
		  Kies gebouw
		</label>
		<select id="select-building" style="display:none;">
		  <option value="">-- kies een gebouw --</option>
		</select>

		<label id="label-part" for="select-part" style="display:none;">
		  Kies gebouwdeel
		</label>
		<select id="select-part" style="display:none;">
		  <option value="">-- kies een gebouwdeel --</option>
		</select>
        <label id="label-floor" for="select-floor">Kies verdieping</label>
        <select id="select-floor">
          <option value="">-- eerst een verdieping kiezen --</option>
        </select>

        <label id="label-select" for="select-target" style="margin-top:.75rem;display:block;">
          Kies installatie of ruimte
        </label>
		
        <div id="equipment-filter-container" class="equipment-filter-container" style="margin-top:.5rem;display:none;">
          <label id="label-equipment-filter" for="equipment-filter">
            Filter installaties (code, lokaal, tenant‚Ä¶)
          </label>
          <input
            type="text"
            id="equipment-filter"
            placeholder="Typ om te filteren‚Ä¶"
            autocomplete="off"
          />
        </div>
		
        <select id="select-target" style="display:block;">
          <option value="">-- eerst een keuze maken hierboven --</option>
        </select>

        <div id="equipment-list" class="equipment-list" style="display:none;"></div>
        <div id="status" class="status"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-secondary" id="btn-cancel">
          ‚¨ÖÔ∏è Terug
        </button>
        <button type="button" class="btn btn-primary" id="btn-go">
          ‚û°Ô∏è Ga naar meldingsportaal
        </button>
      </div>
    </section>
  </main>

 <script>
  /* ============================================================
     CONFIG
  ============================================================ */
  const COMPLEX_ID    = '006691';
  const ChooseBuilding = 'No';
  const ChooseBuildingPart = 'Yes';
  const LIST_ENDPOINT = '/.netlify/functions/complexinfo';
  const selectBuilding = document.getElementById('select-building');
  const selectPart     = document.getElementById('select-part');

  /* ============================================================
     TAAL EN OMGEVING
  ============================================================ */
  const qs        = new URLSearchParams(window.location.search);
  let   lang      = qs.get('lang') || ((navigator.language || '').startsWith('fr') ? 'fr' : 'nl');
  const host      = location.host || '';
  const isTestEnv = qs.has('test') || qs.get('env') === 'test' || /test|staging/i.test(host);
  const envPrefix = isTestEnv ? 'test' : 'prod';

  function applyLanguage() {
    const isFr = (lang === 'fr');

    document.documentElement.lang = isFr ? 'fr' : 'nl';

    document.getElementById('title-text').textContent =
      isFr ? 'Pour quoi voulez-vous cr√©er un ticket ?'
           : 'Waarvoor wil je een ticket aanmaken?';

    document.getElementById('intro-text').textContent =
      isFr
        ? "Choisissez d‚Äôabord si vous signalez un probl√®me pour une installation ou pour un espace dans la Greenhouse Collection. üåø"
        : "Kies eerst of je een probleem wil melden voor een installatie of voor een ruimte in de Greenhouse Collection. üåø";

    document.getElementById('lbl-installation').textContent =
      isFr ? 'Installation' : 'Installatie';

    document.getElementById('lbl-room').textContent =
      isFr ? 'Espace / Local' : 'Ruimte';

    document.getElementById('label-floor').textContent =
      isFr ? 'Choisissez un √©tage' : 'Kies verdieping';

    document.getElementById('label-select').textContent =
      isFr ? 'S√©lectionnez une installation ou un espace'
           : 'Kies installatie of ruimte';

    document.getElementById('btn-cancel').textContent =
      isFr ? '‚¨ÖÔ∏è Retour'
           : '‚¨ÖÔ∏è Terug';

    document.getElementById('btn-go').textContent =
      isFr ? '‚û°Ô∏è Aller au portail de ticket'
           : '‚û°Ô∏è Ga naar meldingsportaal';

    document.getElementById('label-building').textContent =
      isFr ? 'Choisissez un b√¢timent' : 'Kies gebouw';

    document.getElementById('label-part').textContent =
      isFr ? 'Choisissez une partie du b√¢timent' : 'Kies gebouwdeel';
	  
    // Nieuwe V2 filter-labels
    const eqFilterLabel = document.getElementById('label-equipment-filter');
    const eqFilterInput = document.getElementById('equipment-filter');

    if (eqFilterLabel) {
      eqFilterLabel.textContent = isFr
        ? 'Filtrer les installations (code, local, locataire‚Ä¶)'
        : 'Filter installaties (code, lokaal, tenant‚Ä¶)';
    }
    if (eqFilterInput) {
      eqFilterInput.placeholder = isFr
        ? 'Tapez pour filtrer‚Ä¶'
        : 'Typ om te filteren‚Ä¶';
    }
	  
  }

  function initEnvBanner() {
    if (isTestEnv) {
      document.getElementById('test-indicator').style.display = 'block';
      document.body.classList.add('is-test');
    }
  }

  /* ============================================================
     LOGICA
  ============================================================ */
  const btnInstallation  = document.getElementById('btn-installation');
  const btnRoom          = document.getElementById('btn-room');
  const selectFloor      = document.getElementById('select-floor');
  const selectTarget     = document.getElementById('select-target');
  const statusEl         = document.getElementById('status');
  const blockSelect      = document.getElementById('block-select');
  const btnGo            = document.getElementById('btn-go');
  const btnCancel        = document.getElementById('btn-cancel');

  // Nieuwe V2 DOM refs
  const equipmentFilterContainer = document.getElementById('equipment-filter-container');
  const equipmentFilterInput = document.getElementById('equipment-filter');
  const equipmentList = document.getElementById('equipment-list');


  let currentType        = null;  // 'equipment' of 'space'
  let allFloors          = [];    // LIST_FLOORS-respons
  let allEquipmentItems  = [];    // volledige LIST_COMPLEX (E) respons
  let selectedEquipmentId = null; // bij de listweergave


  function setStatus(msg, isError = false) {
    statusEl.textContent = msg || '';
    statusEl.classList.toggle('error', !!isError);
  }

  /* ============================================================
     V2 Installatie List Renderer (Vervangt selectTarget vulling)
  ============================================================ */
  function renderEquipmentList() {
    const isFr = (lang === 'fr');
    const filterText = (equipmentFilterInput?.value || '').trim().toLowerCase();
    
    // Reset selectie en status
    selectedEquipmentId = null;
    
    let filtered = allEquipmentItems;

    if (filterText.length > 0) {
      filtered = allEquipmentItems.filter(it => {
        const fullText = (
          String(it.Id || '') + 
          String(it.Description || '') + 
          String(it.BuildingFloorLevel || '') +
          String(it.RoomNumber || '') +
          String(it.Tenant || '') +
          String(it.Common || '')
        ).toLowerCase();
        return fullText.includes(filterText);
      });
    }

    if (!equipmentList) return;
    equipmentList.innerHTML = '';
    
    if (!filtered.length) {
      setStatus(
        isFr ? 'Aucune installation ne correspond √† ce filtre.' : 'Geen installaties gevonden voor deze filter.',
        true
      );
      return;
    }

    filtered.forEach(it => {
      const id = String(it.Id ?? it.id ?? '');
      const desc = String(it.Description ?? it.description ?? id);
      const floorLevel = String(it.BuildingFloorLevel ?? it.buildingFloorLevel ?? '');
      const roomNr = String(it.RoomNumber ?? it.roomNumber ?? '');
      const tenant = String(it.Tenant ?? it.tenant ?? '');
      const common = String(it.Common ?? it.common ?? '');

      let metaParts = [];
      if (floorLevel) metaParts.push(`L${floorLevel}`);
      if (roomNr) metaParts.push(roomNr);
      if (common) metaParts.push(common);
      
      const metaStr = metaParts.length ? metaParts.join(' ¬∑ ') : '';
      const mainLabel = `${id} ‚Äì ${desc}`;
      let metaLabel = metaStr;
      if (tenant) metaLabel = metaLabel ? `${metaLabel} ¬∑ ${tenant}` : tenant;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'equipment-item';
      btn.setAttribute('data-id', id);

      const mainSpan = document.createElement('div');
      mainSpan.className = 'equipment-main';
      mainSpan.textContent = mainLabel;
      btn.appendChild(mainSpan);

      if (metaLabel) {
        const metaSpan = document.createElement('div');
        metaSpan.className = 'equipment-meta';
        metaSpan.textContent = metaLabel;
        btn.appendChild(metaSpan);
      }

      equipmentList.appendChild(btn);
    });

    setStatus(
      isFr ? `‚úÖ ${filtered.length} installation(s) trouv√©e(s).` : `‚úÖ ${filtered.length} installatie(s) gevonden.`,
      false
    );
  }

  /* ============================================================
     INSTALLATIES ‚Äì LIST_COMPLEX (E-prefix) (V2-logica)
  ============================================================ */
  async function fetchItems(type) {
    const isFr = (lang === 'fr');

    setStatus(isFr ? 'Chargement des donn√©es‚Ä¶' : 'Gegevens worden geladen‚Ä¶', false);

    const prefix          = 'E';
    const complexSelector = `${prefix}${COMPLEX_ID}`;
    const url             = `${LIST_ENDPOINT}?complex=${encodeURIComponent(complexSelector)}&env=${encodeURIComponent(envPrefix)}`;

    const resp = await fetch(url, { cache: 'no-store' });
    const txt  = await resp.text();

    let data;
    try {
      data = JSON.parse(txt);
    } catch (e) {
      console.error('JSON parse error', e, txt);
      throw new Error('Geen geldige JSON van de backend.');
    }

    const items = Array.isArray(data.Items) ? data.Items : (Array.isArray(data.items) ? data.items : []);

    if (!items.length) {
      setStatus(
        isFr ? "Aucun r√©sultat trouv√© pour ce complexe." : "Geen resultaten gevonden voor dit complex.",
        true
      );
      allEquipmentItems = [];
      renderEquipmentList(); // Toon lege lijst met foutmelding
      return;
    }

    allEquipmentItems = items;
    renderEquipmentList(); // Render de lijst met alle items
  }

  /* ============================================================
     LIST_FLOORS ‚Äì alle verdiepingen voor dit complex
  ============================================================ */
  async function fetchFloorsForComplex() {
    const isFr = (lang === 'fr');
    setStatus(isFr ? 'Chargement des donn√©es‚Ä¶' : 'Gegevens worden geladen‚Ä¶', false);

    const prefix = 'S';
    const complexSelector = `${prefix}${COMPLEX_ID}`;
    const url = `${LIST_ENDPOINT}?action=LIST_FLOORS&complex=${encodeURIComponent(complexSelector)}&env=${encodeURIComponent(envPrefix)}`;

    const resp = await fetch(url, { cache: 'no-store' });
    const txt  = await resp.text();
    
    let data;
    try {
      data = JSON.parse(txt);
    } catch (e) {
      console.error('JSON parse error', e, txt);
      throw new Error('Geen geldige JSON van de backend.');
    }

    allFloors = Array.isArray(data.Items) ? data.Items : [];
    
    // gebouw + buildingpart opbouwen
    buildBuildingAndPartDropdowns();
    rebuildPartDropdown();
    buildFloorDropdown();

    selectTarget.innerHTML =
      `<option value="">${isFr ? "-- choisissez d'abord un √©tage --"
                               : "-- kies eerst een verdieping --"}</option>`;
    setStatus('', false);
  }

  /* ============================================================
     SPACES ‚Äì op basis van verdieping en building/buildingpart
  ============================================================ */
  async function fetchSpacesForFloor(buildingFloorId) {
    const isFr = (lang === 'fr');
    if (!buildingFloorId) {
      selectTarget.innerHTML = `<option value="">${isFr ? '-- choisissez d\'abord un √©tage --' : '-- kies eerst een verdieping --'}</option>`;
      return;
    }
    setStatus(isFr ? 'Chargement des locaux‚Ä¶' : 'Ruimtes worden geladen‚Ä¶', false);

    const prefix = 'S';
    const complexSelector = `${prefix}${COMPLEX_ID}`;
    
    const bldId = (ChooseBuilding === 'Yes') ? (selectBuilding.value || '').trim() : '';
    const partId = (ChooseBuildingPart === 'Yes') ? (selectPart.value || '').trim() : '';
    
    let url = `${LIST_ENDPOINT}?action=LIST_FLOOR_SPACES` +
              `&complex=${encodeURIComponent(complexSelector)}` +
              `&buildingFloorId=${encodeURIComponent(buildingFloorId)}` + 
              `&env=${encodeURIComponent(envPrefix)}`;
    
    if (partId) { url += `&buildingPartId=${encodeURIComponent(partId)}`; }
    if (bldId) { url += `&buildingId=${encodeURIComponent(bldId)}`; } 

    const resp = await fetch(url, { cache: 'no-store' });
    const txt  = await resp.text();
    let data;
    try {
      data = JSON.parse(txt);
    } catch (e) {
      console.error('JSON parse error', e, txt);
      throw new Error('Geen geldige JSON van de backend.');
    }

    const items = Array.isArray(data.Items) ? data.Items : [];
    
    selectTarget.innerHTML = '';
    selectTarget.insertAdjacentHTML(
      'beforeend',
      `<option value="">${isFr ? '-- choisissez un local --' : '-- kies een ruimte --'}</option>`
    );
    
    if (!items.length) {
      setStatus(
        isFr ? "Aucun local trouv√© pour cet √©tage." : "Geen ruimtes gevonden op deze verdieping.",
        true
      );
      return;
    }
    
    items.sort((a, b) => {
      const rnA = String(a.RoomNumber || '').trim();
      const rnB = String(b.RoomNumber || '').trim();
      const idA = String(a.Id || '').trim();
      const idB = String(b.Id || '').trim();
      const keyA = rnA || idA;
      const keyB = rnB || idB;
      return keyA.localeCompare(keyB, 'nl', { numeric: true, sensitivity: 'base' });
    });

    items.forEach(sp => {
      const id = String(sp.Id || '');
      const roomNumber = String(sp.RoomNumber || '').trim();
      const desc = String(sp.Description || id);
      const tenant = String(sp.Tenant || '').trim();
      const common = String(sp.Common || '').trim();

      const primaryCode = roomNumber || id;

      let label = `${primaryCode} - ${desc}`;
      if (tenant) label += ` ‚Äì (${tenant})`;
      if (common) label += ` ‚Äì (Common: ${common})`;
      
      const optHtml = `<option value="${id.replace(/"/g,'&quot;')}">` + 
                      `${label.replace(/</g,'&lt;')}` +
                      `</option>`;
      selectTarget.insertAdjacentHTML('beforeend', optHtml);
    });

    setStatus('', false);
  }

  /* ============================================================
     DROPDOWN LOGICA (Gebouw, Gebouwdeel, Verdieping)
  ============================================================ */
  
  function getShortPartId(raw) {
    const txt = String(raw || '');
    const m = txt.match(/BuildingPart\.Id\.Id='([^']+)'/);
    return m ? m[1] : txt;
  }

	function buildBuildingAndPartDropdowns() {
	  const isFr = (lang === 'fr');
	  const showBuilding = (ChooseBuilding === 'Yes'); 

	  if (showBuilding) {
		const bldMap = new Map();

		allFloors.forEach(f => {
		  const id   = String(f.BuildingId || '').trim();
		  if (!id) return;
		  const desc = String(f.BuildingDescription || id).trim();
		  if (!bldMap.has(id)) bldMap.set(id, desc);
		});

		selectBuilding.innerHTML =
		  `<option value="">${isFr ? '-- choisissez un b√¢timent --'
								   : '-- kies een gebouw --'}</option>`;

		for (const [id, desc] of bldMap.entries()) {
		  const label = `${id} ‚Äì ${desc}`;
		  selectBuilding.insertAdjacentHTML(
			'beforeend',
			`<option value="${id.replace(/"/g,'&quot;')}">${label.replace(/</g,'&lt;')}</option>`
		  );
		}
	  }
	}


	function rebuildPartDropdown() {
	  if (ChooseBuildingPart !== 'Yes') return;

	  const isFr = (lang === 'fr');
      // BldId alleen ophalen als het 'Kies Gebouw' veld wordt gebruikt
	  const bldId = (ChooseBuilding === 'Yes') ? (selectBuilding.value || '').trim() : '';
      
      if (ChooseBuilding === 'Yes' && !bldId) {
          selectPart.innerHTML =
		    `<option value="">${isFr ? '-- choisissez un b√¢timent d\'abord --'
								     : '-- kies eerst een gebouw --'}</option>`;
          return;
      }

	  selectPart.innerHTML =
		`<option value="">${isFr ? '-- choisissez un b√¢timentdeel --'
								 : '-- kies een gebouwdeel --'}</option>`;

	  const partMap = new Map(); // shortId -> description

	  allFloors.forEach(f => {
        if (ChooseBuilding === 'Yes') {
            const fbld = String(f.BuildingId || '').trim();
            if (fbld !== bldId) return;
        }

		const pidRaw  = String(f.BuildingPartId || '').trim();
		const pid     = getShortPartId(pidRaw);             
		if (!pid) return;

		const pdesc = String(f.BuildingPartDescription || pid).trim();
		if (!partMap.has(pid)) partMap.set(pid, pdesc);
	  });

	  for (const [pid, desc] of partMap.entries()) {
		const label = `${desc}`;
		selectPart.insertAdjacentHTML(
		  'beforeend',
		  `<option value="${pid.replace(/"/g,'&quot;')}">${label.replace(/</g,'&lt;')}</option>`
		);
	  }
	}


	function buildFloorDropdown() {
	  const isFr = (lang === 'fr');

	  const bldId  = (ChooseBuilding === 'Yes') ? (selectBuilding.value || '').trim() : '';
	  const partId = (ChooseBuildingPart === 'Yes') ? (selectPart.value || '').trim()     : '';

	  if (!Array.isArray(allFloors) || !allFloors.length) {
		selectFloor.innerHTML =
		  `<option value="">${isFr ? '-- aucun √©tage --' : '-- geen verdiepingen --'}</option>`;
		return;
	  }

	  const levelToId = new Map(); // level -> BuildingFloorId

	  allFloors.forEach(f => {
		if (bldId && String(f.BuildingId || '').trim() !== bldId) return;

		const pidShort = getShortPartId(f.BuildingPartId);
		if (partId && pidShort !== partId) return;

		const levelRaw = f.Level ?? f._Level ?? f.BuildingFloorLevel ?? '';

		const level = String(levelRaw).trim();
		const bfId  = String(f.Id || '').trim(); 

		if (!level || !bfId) return;
		if (!levelToId.has(level)) levelToId.set(level, bfId);
	  });

	  if (!levelToId.size) {
		selectFloor.innerHTML =
		  `<option value="">${isFr ? '-- aucun √©tage filtr√© --'
								   : '-- geen verdiepingen gevonden --'}</option>`;
		return;
	  }

	  const sortedLevels = Array.from(levelToId.keys()).sort((a, b) => {
		const na = parseFloat(String(a).replace(',', '.'));
		const nb = parseFloat(String(b).replace(',', '.'));
		if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
		return String(a).localeCompare(String(b), undefined, { sensitivity: 'base' });
	  });

	  selectFloor.innerHTML =
		`<option value="">${isFr ? '-- choisissez un √©tage --'
								 : '-- kies een verdieping --'}</option>`;

	  sortedLevels.forEach(level => {
		const bfId = levelToId.get(level);
		const opt  =
		  `<option value="${String(bfId).replace(/"/g,'&quot;')}">` +
			`${String(level).replace(/</g,'&lt;')}` +
		  `</option>`;
		selectFloor.insertAdjacentHTML('beforeend', opt);
	  });
	}

  /* ============================================================
     TYPE SELECTIE LOGICA
  ============================================================ */
  function setActiveType(type) {
    currentType = type;
    selectedEquipmentId = null;
    if (equipmentFilterInput) equipmentFilterInput.value = '';

    btnInstallation.classList.toggle('active', type === 'equipment');
    btnRoom.classList.toggle('active', type === 'space');
    blockSelect.style.display = 'block';

    if (type === 'space') {
      // üè¢ RUIMTE
      const showBuildingDropdown = (ChooseBuilding === 'Yes');
      const showPartDropdown = (ChooseBuildingPart === 'Yes');

      document.getElementById('label-building').style.display = showBuildingDropdown ? 'block' : 'none';
      selectBuilding.style.display = showBuildingDropdown ? 'block' : 'none';
      document.getElementById('label-part').style.display = showPartDropdown ? 'block' : 'none';
      selectPart.style.display = showPartDropdown ? 'block' : 'none';

      selectFloor.style.display = 'block';
      document.getElementById('label-floor').style.display = 'block';

      document.getElementById('label-select').textContent = (lang === 'fr') ? 'S√©lectionnez un espace' : 'Kies ruimte';

      // Toon de standaard select dropdown voor ruimtes
      selectTarget.style.display = 'block';
      if (equipmentFilterContainer) equipmentFilterContainer.style.display = 'none';
      if (equipmentList) equipmentList.style.display = 'none';
      
      // Reset dropdowns
      selectBuilding.innerHTML = '<option value="">-- kies een gebouw --</option>';
      selectPart.innerHTML     = '<option value="">-- kies een gebouwdeel --</option>';
      selectFloor.innerHTML  = '<option value="">-- laden... --</option>';
      selectTarget.innerHTML = '<option value="">-- eerst een verdieping kiezen --</option>';

      setStatus('', false);

      fetchFloorsForComplex().catch(err => {
        console.error(err);
        const isFr = (lang === 'fr');
        setStatus(
          isFr ? 'Erreur lors du chargement des √©tages.' : 'Fout bij het laden van de verdiepingen.',
          true
        );
        selectFloor.innerHTML = '<option value="">-- geen gegevens --</option>';
        selectTarget.innerHTML = '<option value="">-- geen gegevens --</option>';
      });

    } else {
      // üîß INSTALLATIES
      selectFloor.style.display = 'none';
      document.getElementById('label-floor').style.display = 'none';
      document.getElementById('label-select').textContent = (lang === 'fr') ? 'S√©lectionnez une installation' : 'Kies installatie';

      // Verberg de gebouw/gebouwdeel labels voor installaties
      document.getElementById('label-building').style.display = 'none';
      selectBuilding.style.display = 'none';
      document.getElementById('label-part').style.display = 'none';
      selectPart.style.display = 'none';
      
      // Verberg de standaard select dropdown, toon de filter/list (V2 logica)
      selectTarget.style.display = 'none';
      if (equipmentFilterContainer) equipmentFilterContainer.style.display = 'block';
      if (equipmentList) equipmentList.style.display = 'block';
      if (equipmentList) equipmentList.innerHTML = '<div style="padding:0.45rem 0.6rem; color:#6b7280;">Laden...</div>';

      fetchItems(type).catch(err => {
        console.error(err);
        const isFr = (lang === 'fr');
        setStatus(
          isFr ? 'Erreur lors du chargement.' : 'Fout bij het laden.',
          true
        );
        if (equipmentList) equipmentList.innerHTML = '<div style="padding:0.45rem 0.6rem; color:#b91c1c;">Geen gegevens beschikbaar</div>';
      });
    }
  }

  /* ============================================================
     CODE VOOR PORTAL (13-cijferige interleaving logica)
  ============================================================ */
  function buildCodeForPortal(type, id) {
    const nummer = Number(id);

    if (!Number.isFinite(nummer)) {
      // Dit geval komt alleen voor als een alfanumeriek ID (bijv. AHU-01) door de selectie is gekomen.
      // Omdat de filterlijst voor installaties ook alfanumerieke ID's kan bevatten,
      // wordt hier een fallback voorzien, hoewel de specificatie van de 13-cijferige code
      // alleen voor numerieke ID's is ontworpen. We returnen het ID om door te gaan.
      return String(id);
    }

    const orgId = String(Math.trunc(nummer)).padStart(6, "0");
    const mult3 = Math.trunc(nummer * 3);
    const last6 = String(mult3).padStart(6, "0");

    let resultaat = "";
    for (let i = 0; i < 6; i++) {
      resultaat += orgId[i] + last6[i];
    }

    const isSpace = (type === "space");
    let endDigit;

    if (isSpace) {
      endDigit = Math.floor(Math.random() * 9); // 0-8
    } else {
      endDigit = 9;
    }

    resultaat += String(endDigit);
    return resultaat;
  }

  function goToPortal() {
    const isFr = (lang === 'fr');
    let id = null;

    if (!currentType) {
      alert(
        isFr
          ? 'Choisissez d‚Äôabord installation ou espace.'
          : 'Kies eerst installatie of ruimte.'
      );
      return;
    }

    if (currentType === 'equipment') {
      id = selectedEquipmentId;
    } else if (currentType === 'space') {
      // Check of er een verdieping geselecteerd is (niet de placeholder)
      if (!selectFloor.value) {
          alert(
            isFr
              ? 'S√©lectionnez un √©tage dans la liste.'
              : 'Selecteer een verdieping in de lijst.'
          );
          return;
      }
      id = selectTarget.value;
    }

    if (!id) {
      alert(
        isFr
          ? `S√©lectionnez un ${currentType === 'space' ? 'local' : '√©l√©ment'} dans la lijst.`
          : `Selecteer een ${currentType === 'space' ? 'ruimte' : 'item'} in de lijst.`
      );
      return;
    }
    
    // Alfanumerieke ID's (bijv. AHU-01) worden niet door de 13-cijferige logica gehaald.
    // De code-functie handelt dit af door het ID zelf terug te geven.
    const code = buildCodeForPortal(currentType, id);
    const url  = new URL('/portal.html', window.location.origin);
    url.searchParams.set('code', code);
    url.searchParams.set('lang', lang);
    url.searchParams.set('env', envPrefix);
    window.location.href = url.toString();
  }

  /* ============================================================
     EVENT LISTENERS
  ============================================================ */
  document.getElementById('switch-nl').onclick = (e) => {
    e.preventDefault();
    const u = new URL(window.location.href);
    u.searchParams.set('lang','nl');
    window.location.href = u.toString();
  };
  document.getElementById('switch-fr').onclick = (e) => {
    e.preventDefault();
    const u = new URL(window.location.href);
    u.searchParams.set('lang','fr');
    window.location.href = u.toString();
  };
  
  btnInstallation.addEventListener('click', () => setActiveType('equipment'));
  btnRoom.addEventListener('click', () => setActiveType('space'));
  btnGo.addEventListener('click', goToPortal);
  
  btnCancel.addEventListener('click', () => {
    currentType = null;
    btnInstallation.classList.remove('active');
    btnRoom.classList.remove('active');
    blockSelect.style.display = 'none';
    selectFloor.innerHTML = '<option value="">-- eerst een verdieping kiezen --</option>';
    selectTarget.innerHTML = '<option value="">-- eerst een keuze maken hierboven --</option>';
    // Reset V2 elementen
    selectTarget.style.display = 'block'; 
    if (equipmentFilterContainer) equipmentFilterContainer.style.display = 'none';
    if (equipmentList) { equipmentList.style.display = 'none'; equipmentList.innerHTML = ''; }
    if (equipmentFilterInput) equipmentFilterInput.value = '';
    setStatus('', false);
  });

  // Listener voor Ruimte (selectie)
  selectFloor.addEventListener('change', () => {
    const isFr = (lang === 'fr');
    const selectedFloorId = selectFloor.value;

    if (!selectedFloorId) {
      selectTarget.innerHTML =
        `<option value="">${isFr ? '-- choisissez d\'abord un √©tage --'
                                 : '-- kies eerst een verdieping --'}</option>`;
      setStatus('', false);
      return;
    }

    selectTarget.innerHTML =
      `<option value="">${isFr ? '-- chargement des locaux --'
                               : '-- ruimtes worden geladen --'}</option>`;

    fetchSpacesForFloor(selectedFloorId).catch(err => {
      console.error(err);
      setStatus(
        isFr ? 'Erreur lors du chargement des locaux.'
             : 'Fout bij het laden van de ruimtes.',
        true
      );
      selectTarget.innerHTML =
        `<option value="">${isFr ? '-- aucune donn√©e --'
                                 : '-- geen gegevens --'}</option>`;
    });
  });

  // V2 Listeners voor Installaties (filter en selectie)
  if (equipmentFilterInput) {
    equipmentFilterInput.addEventListener('input', () => {
      if (currentType === 'equipment') renderEquipmentList();
    });
  }

  if (equipmentList) {
    equipmentList.addEventListener('click', (e) => {
      const row = e.target.closest('.equipment-item');
      if (!row) return;
      const id = row.getAttribute('data-id');
      if (!id) return;

      // Deselecteer alles
      equipmentList.querySelectorAll('.equipment-item.selected')
        .forEach(el => el.classList.remove('selected'));
      
      // Selecteer de nieuwe rij
      row.classList.add('selected');
      
      // Sla de ID op die goToPortal zal gebruiken
      selectedEquipmentId = id; 

      setStatus(
        lang === 'fr' ? `Installation s√©lectionn√©e : ${id}` : `Installatie geselecteerd: ${id}`,
        false
      );
    });
  }

  if (selectBuilding) {
    selectBuilding.addEventListener('change', () => {
      rebuildPartDropdown();
      buildFloorDropdown();
    });
  }

  if (selectPart) {
    selectPart.addEventListener('change', () => {
      buildFloorDropdown();
    });
  }

  /* ============================================================
     INIT
  ============================================================ */
  (function init() {
    initEnvBanner();
    applyLanguage();

    const initialType = qs.get('type');
    if (initialType) {
      setActiveType(initialType);
    }
  })();
</script>
</body>
</html>