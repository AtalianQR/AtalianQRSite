<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Greenhouse Portal</title>

  <link rel="icon" href="/AtalianFavicon.png" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6fa;
      color: #111827;
    }

    body {
      background-image: url('/greenhousecollection.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }

    .test-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #28a745;
      color: white;
      text-align: center;
      padding: 5px 0;
      font-weight: bold;
      z-index: 1000;
      font-size: 14px;
      text-transform: uppercase;
      opacity: 0.9;
    }
    body.is-test {
      padding-top: 30px;
    }

    header {
      padding: 0.5rem 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .lang-switch {
      font-size: 0.9rem;
      color: #111827;
      background: rgba(255,255,255,0.8);
      padding: .2rem .6rem;
      border-radius: 999px;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .lang-switch a {
      color: #111827;
      text-decoration: none;
      font-weight: 500;
    }
    .lang-switch a:hover {
      text-decoration: underline;
    }

    .header-flex {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: .5rem;
    }
    .logo {
      height: 40px;
      object-fit: contain;
    }

    main {
      min-height: calc(100vh - 60px);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 0.75rem 1rem 2rem;
    }

    .page-card {
      max-width: 600px;
      margin: 1rem auto 2rem;
      background: linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border: 2px solid #EE7E00;
      border-radius: 12px;
      box-shadow: 0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      padding: 1.25rem 1.5rem 1.5rem;
    }

    .page-card h1 {
      margin: 0 0 .5rem;
      font-size: 1.4rem;
    }

    .page-card p {
      margin-top: 0;
      color: #4b5563;
      font-size: .95rem;
    }

    .choice-row {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      margin: 1rem 0;
    }
    .choice-btn {
      flex: 1 1 47%;
      border: 2px solid #EE7E00;
      background: #fff;
      color: #111827;
      border-radius: 999px;
      padding: .55rem 1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .35rem;
      font-size: .95rem;
      transition: background .15s, color .15s, box-shadow .15s, transform .05s;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
    }
    .choice-btn span.icon {
      font-size: 1.1rem;
    }
    .choice-btn span.label {
      white-space: nowrap;
    }
    .choice-btn:hover {
      background: #fff7ed;
      box-shadow: 0 4px 10px rgba(0,0,0,.12);
      transform: translateY(-1px);
    }
    .choice-btn.active {
      background: #EE7E00;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
    }

    .form-block {
      margin-top: 1rem;
      padding: .75rem .75rem 1rem;
      border-radius: 10px;
      background: rgba(255,255,255,0.92);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.05);
    }

    .form-block label {
      display: block;
      margin-bottom: .15rem;
      font-weight: 600;
      font-size: .9rem;
      color: #111827;
    }

    .form-block small {
      display: block;
      margin-top: .15rem;
      font-size: .8rem;
      color: #6b7280;
    }

    select {
      width: 100%;
      padding: .45rem .5rem;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: .9rem;
      background-color: #fff;
      box-sizing: border-box;
    }
    select:focus {
      outline: none;
      border-color: #EE7E00;
      box-shadow: 0 0 0 2px rgba(238,126,0,.16);
    }

    .status {
      margin-top: .5rem;
      font-size: .85rem;
      color: #374151;
    }
    .status.error {
      color: #b91c1c;
      font-weight: 600;
    }

    .actions {
      margin-top: 1.25rem;
      display: flex;
      justify-content: flex-end;
      gap: .75rem;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: .55rem 1.4rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: .95rem;
    }
    .btn-primary {
      background: #EE7E00;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }
    .btn-primary:active {
      background: #d86e00;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    /* Lijstweergave voor installaties */
    .equipment-filter-container {
      margin-top: .5rem;
    }
    .equipment-filter-container input[type="text"] {
      width: 100%;
      padding: .4rem .45rem;
      border-radius: 6px;
      border: 1px solid #cdd4e4;
      font-size: .9rem;
    }
    .equipment-filter-container input[type="text"]:focus {
      outline: none;
      border-color: #EE7E00;
      box-shadow: 0 0 0 2px rgba(238,126,0,.18);
    }
    .equipment-list {
      margin-top: .5rem;
      max-height: 260px;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    .equipment-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: .45rem .6rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: .9rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .equipment-item:last-child {
      border-bottom: none;
    }
    .equipment-item:hover {
      background: rgba(238,126,0,.06);
    }
    .equipment-item.selected {
      background: rgba(238,126,0,.12);
      border-left: 3px solid #EE7E00;
    }
    .equipment-main {
      font-weight: 600;
      color: #111827;
    }
    .equipment-meta {
      font-size: .78rem;
      color: #4b5563;
    }

    @media (max-width: 480px) {
      .page-card {
        margin: .75rem auto 1.5rem;
        padding: 1rem 1rem 1.25rem;
        max-width: 95%;
      }
      .choice-btn { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <div id="test-indicator" style="display:none" class="test-banner">
    ‚ö†Ô∏è TEST OMGEVING ACTIEF
  </div>

  <header>
    <div class="lang-switch">
      <a href="#" id="switch-nl">üá≥üá± NL</a> |
      <a href="#" id="switch-fr">üá´üá∑ FR</a>
    </div>
    <div class="header-flex">
      <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
    </div>
  </header>

  <main>
    <section class="page-card">
      <h1 id="title-text">Waarvoor wil je een ticket aanmaken?</h1>
      <p id="intro-text">
        Kies eerst of je een probleem wil melden voor een installatie of voor een ruimte in de Greenhouse Collection. üåø
      </p>

      <div class="choice-row">
        <button type="button" id="btn-installation" class="choice-btn">
          <span class="icon">‚öôÔ∏è</span>
          <span class="label" id="lbl-installation">Installatie</span>
        </button>
        <button type="button" id="btn-room" class="choice-btn">
          <span class="icon">üè†</span>
          <span class="label" id="lbl-room">Ruimte</span>
        </button>
      </div>

      <div id="block-select" class="form-block" style="display:none;">
        <label id="label-building" for="select-building" style="display:none;">
          Kies gebouw
        </label>
        <select id="select-building" style="display:none;">
          <option value="">-- kies een gebouw --</option>
        </select>

        <label id="label-part" for="select-part" style="display:none;">
          Kies gebouwdeel
        </label>
        <select id="select-part" style="display:none;">
          <option value="">-- kies een gebouwdeel --</option>
        </select>

        <label id="label-floor" for="select-floor">Kies verdieping</label>
        <select id="select-floor">
          <option value="">-- eerst een verdieping kiezen --</option>
        </select>

        <label id="label-select" for="select-target" style="margin-top:.75rem;display:block;">
          Kies installatie of ruimte
        </label>

        <div id="equipment-filter-container" class="equipment-filter-container" style="display:none;">
          <label id="label-equipment-filter" for="equipment-filter">
            Filter installaties (code, lokaal, tenant‚Ä¶)
          </label>
          <input
            type="text"
            id="equipment-filter"
            placeholder="Typ om te filteren‚Ä¶"
            autocomplete="off"
          />
        </div>

        <select id="select-target">
          <option value="">-- eerst een keuze maken hierboven --</option>
        </select>

        <div id="equipment-list" class="equipment-list" style="display:none;"></div>

        <div id="status" class="status"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-secondary" id="btn-cancel">
          ‚¨ÖÔ∏è Terug
        </button>
        <button type="button" class="btn btn-primary" id="btn-go">
          ‚û°Ô∏è Ga naar meldingsportaal
        </button>
      </div>
    </section>
  </main>

<script>
  // ============================================================
  // CONFIG
  // ============================================================
  const COMPLEX_ID    = '006691';
  const LIST_ENDPOINT = '/.netlify/functions/complexinfo';
  const PORTAL_URL    = '/portal.html';

  const isTestEnv   = window.location.hostname.includes('test') ||
                      window.location.search.includes('env=test');
  const envPrefix   = isTestEnv ? 'test' : 'prod';

  const urlParams   = new URLSearchParams(window.location.search);
  let   lang        = urlParams.get('lang') === 'fr' ? 'fr' : 'nl';

  // üëâ hier de fix: gebouw NIET verplicht, gebouwdeel w√©l (zoals je vroeger had)
  const ChooseBuilding     = 'No';   // was 'Yes'
  const ChooseBuildingPart = 'Yes';

  function applyLanguage() {
    const isFr = (lang === 'fr');

    document.documentElement.lang = isFr ? 'fr' : 'nl';

    document.getElementById('title-text').textContent =
      isFr ? 'Pour quoi voulez-vous cr√©er un ticket ?'
           : 'Waarvoor wil je een ticket aanmaken?';

    document.getElementById('intro-text').textContent =
      isFr
        ? "Choisissez d‚Äôabord si vous signalez un probl√®me pour une installation ou pour un espace dans la Greenhouse Collection. üåø"
        : "Kies eerst of je een probleem wil melden voor een installatie of voor een ruimte in de Greenhouse Collection. üåø";

    document.getElementById('lbl-installation').textContent =
      isFr ? 'Installation' : 'Installatie';

    document.getElementById('lbl-room').textContent =
      isFr ? 'Espace / Local' : 'Ruimte';

    document.getElementById('label-floor').textContent =
      isFr ? 'Choisissez un √©tage' : 'Kies verdieping';

    document.getElementById('label-select').textContent =
      isFr ? 'S√©lectionnez une installation ou un espace'
           : 'Kies installatie of ruimte';

    document.getElementById('btn-cancel').textContent =
      isFr ? '‚¨ÖÔ∏è Retour'
           : '‚¨ÖÔ∏è Terug';

    document.getElementById('btn-go').textContent =
      isFr ? '‚û°Ô∏è Aller au portail de ticket'
           : '‚û°Ô∏è Ga naar meldingsportaal';

    document.getElementById('label-building').textContent =
      isFr ? 'Choisissez un b√¢timent' : 'Kies gebouw';

    document.getElementById('label-part').textContent =
      isFr ? 'Choisissez une partie du b√¢timent' : 'Kies gebouwdeel';

    const eqFilterLabel = document.getElementById('label-equipment-filter');
    const eqFilterInput = document.getElementById('equipment-filter');
    if (eqFilterLabel) {
      eqFilterLabel.textContent = isFr
        ? 'Filtrer les installations (code, local, locataire‚Ä¶)'
        : 'Filter installaties (code, lokaal, tenant‚Ä¶)';
    }
    if (eqFilterInput) {
      eqFilterInput.placeholder = isFr
        ? 'Tapez pour filtrer‚Ä¶'
        : 'Typ om te filteren‚Ä¶';
    }
  }

  function initEnvBanner() {
    if (isTestEnv) {
      document.getElementById('test-indicator').style.display = 'block';
      document.body.classList.add('is-test');
    }
  }

  // ============================================================
  // DOM refs & state
  // ============================================================
  const btnInstallation = document.getElementById('btn-installation');
  const btnRoom         = document.getElementById('btn-room');
  const selectFloor     = document.getElementById('select-floor');
  const selectTarget    = document.getElementById('select-target');
  const statusEl        = document.getElementById('status');
  const blockSelect     = document.getElementById('block-select');
  const btnGo           = document.getElementById('btn-go');
  const btnCancel       = document.getElementById('btn-cancel');

  const equipmentFilterContainer = document.getElementById('equipment-filter-container');
  const equipmentFilterInput     = document.getElementById('equipment-filter');
  const equipmentList            = document.getElementById('equipment-list');
  const selectBuilding           = document.getElementById('select-building');
  const selectPart               = document.getElementById('select-part');

  let currentType        = null;  // 'equipment' of 'space'
  let allFloors          = [];
  let allEquipmentItems  = [];

  function setStatus(msg, isError = false) {
    statusEl.textContent = msg || '';
    statusEl.classList.toggle('error', !!isError);
  }

  // ============================================================
  // INSTALLATIES ‚Äì LIST_COMPLEX (E006691)
  // ============================================================
  async function fetchItems() {
    const isFr = (lang === 'fr');
    setStatus(isFr ? 'Chargement des donn√©es‚Ä¶' : 'Gegevens worden geladen‚Ä¶', false);

    const complexSelector = `E${COMPLEX_ID}`;
    const url             = `${LIST_ENDPOINT}?complex=${encodeURIComponent(complexSelector)}&env=${encodeURIComponent(envPrefix)}`;

    const resp = await fetch(url, { cache: 'no-store' });
    const txt  = await resp.text();

    let data;
    try {
      data = JSON.parse(txt);
    } catch (e) {
      console.error('JSON parse error', e, txt);
      throw new Error('Geen geldige JSON van de backend.');
    }

    const items = Array.isArray(data.Items)
      ? data.Items
      : (Array.isArray(data.items) ? data.items : []);

    if (!items.length) {
      setStatus(
        isFr ? "Aucun r√©sultat trouv√© pour ce complexe."
             : "Geen resultaten gevonden voor dit complex.",
        true
      );
      if (equipmentList) equipmentList.innerHTML = '';
      return;
    }

    allEquipmentItems = items;
    if (equipmentFilterInput) equipmentFilterInput.value = '';

    renderEquipmentList();
  }

  function renderEquipmentList() {
    const isFr = (lang === 'fr');
    const q = equipmentFilterInput
      ? equipmentFilterInput.value.trim().toLowerCase()
      : '';

    const items = Array.isArray(allEquipmentItems) ? allEquipmentItems : [];
    let filtered = items;

    if (q) {
      filtered = items.filter(it => {
        const id         = String(it.Id ?? it.id ?? '');
        const desc       = String(it.Description ?? it.description ?? '');
        const floorId    = String(it.BuildingFloorId ?? it.buildingFloorId ?? '');
        const floorLevel = String(it.BuildingFloorLevel ?? it.buildingFloorLevel ?? '');
        const roomNr     = String(it.RoomNumber ?? it.roomNumber ?? '');
        const tenant     = String(it.Tenant ?? it.tenant ?? '');
        const common     = String(it.Common ?? it.common ?? '');

        const haystack = [
          id, desc, floorId, floorLevel,
          roomNr, tenant, common
        ].join(' ').toLowerCase();

        return haystack.includes(q);
      });
    }

    if (!equipmentList) return;

    equipmentList.innerHTML = '';

    if (!filtered.length) {
      setStatus(
        isFr ? 'Aucune installation ne correspond √† ce filtre.'
             : 'Geen installaties gevonden voor deze filter.',
        true
      );
      return;
    }

    filtered.forEach(it => {
      const id         = String(it.Id ?? it.id ?? '');
      const desc       = String(it.Description ?? it.description ?? id);
      const floorLevel = String(it.BuildingFloorLevel ?? it.buildingFloorLevel ?? '');
      const roomNr     = String(it.RoomNumber ?? it.roomNumber ?? '');
      const tenant     = String(it.Tenant ?? it.tenant ?? '');
      const common     = String(it.Common ?? it.common ?? '');

      let metaParts = [];
      if (floorLevel) metaParts.push(`L${floorLevel}`);
      if (roomNr)     metaParts.push(roomNr);
      if (common)     metaParts.push(common);
      const metaStr = metaParts.length ? metaParts.join(' ¬∑ ') : '';

      const mainLabel = `${id} ‚Äì ${desc}`;
      let metaLabel   = metaStr;
      if (tenant) metaLabel = metaLabel ? `${metaLabel} ¬∑ ${tenant}` : tenant;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'equipment-item';
      btn.setAttribute('data-id', id);

      const mainSpan = document.createElement('div');
      mainSpan.className = 'equipment-main';
      mainSpan.textContent = mainLabel;

      btn.appendChild(mainSpan);

      if (metaLabel) {
        const metaSpan = document.createElement('div');
        metaSpan.className = 'equipment-meta';
        metaSpan.textContent = metaLabel;
        btn.appendChild(metaSpan);
      }

      equipmentList.appendChild(btn);
    });

    setStatus(
      isFr ? `‚úÖ ${filtered.length} installation(s) trouv√©e(s).`
           : `‚úÖ ${filtered.length} installatie(s) gevonden.`,
      false
    );
  }

  // ============================================================
  // LIST_FLOORS ‚Äì alle verdiepingen
  // ============================================================
  async function fetchFloorsForComplex() {
    const isFr = (lang === 'fr');
    setStatus(isFr ? 'Chargement des donn√©es‚Ä¶' : 'Gegevens worden geladen‚Ä¶', false);

    const complexSelector = `S${COMPLEX_ID}`;
    const url             = `${LIST_ENDPOINT}?action=LIST_FLOORS&complex=${encodeURIComponent(complexSelector)}&env=${encodeURIComponent(envPrefix)}`;

    const resp = await fetch(url, { cache: 'no-store' });
    const txt  = await resp.text();

    let data;
    try {
      data = JSON.parse(txt);
    } catch (e) {
      console.error('JSON parse error', e, txt);
      throw new Error('Geen geldige JSON van de backend.');
    }

    const items = Array.isArray(data.Items) ? data.Items : [];
    if (!items.length) {
      setStatus(
        isFr ? "Aucun √©tage trouv√© pour ce complexe."
             : "Geen verdiepingen gevonden voor dit complex.",
        true
      );
      selectFloor.innerHTML  = '<option value="">-- niets beschikbaar --</option>';
      selectTarget.innerHTML = '<option value="">-- niets beschikbaar --</option>';
      return;
    }

    allFloors = items;

    // gebouw-keuze is optioneel (ChooseBuilding = 'No'), maar we laten de helper staan
    if (ChooseBuilding === 'Yes') {
      buildBuildingDropdown();
    }
    if (ChooseBuildingPart === 'Yes') {
      buildPartDropdown();
    }
    buildFloorDropdown();

    setStatus(
      isFr ? `‚úÖ ${items.length} √©tage(s) trouv√©(s).`
           : `‚úÖ ${items.length} verdieping(en) gevonden.`,
      false
    );
  }

  function buildBuildingDropdown() {
    const isFr = (lang === 'fr');
    selectBuilding.innerHTML =
      `<option value="">${isFr ? '-- tous les b√¢timents --' : '-- alle gebouwen --'}</option>`;

    const buildingIds = new Set();
    allFloors.forEach(f => {
      const bid = String(f.BuildingId || '').trim();
      if (bid) buildingIds.add(bid);
    });

    Array.from(buildingIds).sort((a,b) =>
      a.localeCompare(b, 'nl', { numeric: true, sensitivity: 'base' })
    ).forEach(bid => {
      selectBuilding.insertAdjacentHTML(
        'beforeend',
        `<option value="${bid.replace(/"/g,'&quot;')}">${bid.replace(/</g,'&lt;')}</option>`
      );
    });
  }

  function buildPartDropdown() {
    const isFr = (lang === 'fr');
    selectPart.innerHTML =
      `<option value="">${isFr ? '-- toutes les parties --' : '-- alle gedeeltes --'}</option>`;

    const partMap = new Map();
    allFloors.forEach(f => {
      const pid   = String(f.BuildingPartId || '').trim();
      const pdesc = String(f.BuildingPartDescription || pid).trim();
      if (!partMap.has(pid)) partMap.set(pid, pdesc);
    });

    for (const [pid, desc] of partMap.entries()) {
      selectPart.insertAdjacentHTML(
        'beforeend',
        `<option value="${pid.replace(/"/g,'&quot;')}">${desc.replace(/</g,'&lt;')}</option>`
      );
    }
  }

  function buildFloorDropdown() {
    const isFr = (lang === 'fr');

    const bldId  = (ChooseBuilding === 'Yes') ? (selectBuilding.value || '').trim() : '';
    const partId = (ChooseBuildingPart === 'Yes') ? (selectPart.value || '').trim() : '';

    if (!Array.isArray(allFloors) || !allFloors.length) {
      selectFloor.innerHTML =
        `<option value="">${isFr ? '-- aucun √©tage --' : '-- geen verdiepingen --'}</option>`;
      return;
    }

    const levelToId = new Map();

    allFloors.forEach(f => {
      if (bldId) {
        const fid = String(f.BuildingId || '').trim();
        if (fid !== bldId) return;
      }
      if (partId) {
        const pid = String(f.BuildingPartId || '').trim();
        if (pid !== partId) return;
      }

      const level = String(f.Level || f.BuildingFloorLevel || '').trim();
      const id    = String(f.Id || f.BuildingFloorId || '').trim();
      if (!level || !id) return;

      if (!levelToId.has(level)) levelToId.set(level, id);
    });

    const levels = Array.from(levelToId.keys()).sort((a, b) =>
      a.localeCompare(b, 'nl', { numeric: true, sensitivity: 'base' })
    );

    if (!levels.length) {
      selectFloor.innerHTML =
        `<option value="">${isFr ? '-- aucun √©tage --' : '-- geen verdiepingen --'}</option>`;
      return;
    }

    selectFloor.innerHTML =
      `<option value="">${isFr ? '-- choisissez un √©tage --' : '-- kies een verdieping --'}</option>`;

    levels.forEach(level => {
      const bfId  = levelToId.get(level);
      const label = `${isFr ? '√âtage' : 'Verdieping'} ${level}`;
      selectFloor.insertAdjacentHTML(
        'beforeend',
        `<option value="${bfId.replace(/"/g,'&quot;')}">${label.replace(/</g,'&lt;')}</option>`
      );
    });
  }

  // ============================================================
  // LIST_FLOOR_SPACES ‚Äì fix: gebruik weer floorid / buildingpartid / buildingid
  // ============================================================
  async function fetchSpacesForFloor(buildingFloorId) {
    const isFr = (lang === 'fr');
    setStatus(isFr ? 'Chargement des locaux‚Ä¶' : 'Ruimtes worden geladen‚Ä¶', false);

    const complexSelector = `S${COMPLEX_ID}`;

    const bldId  = (ChooseBuilding === 'Yes')
      ? (selectBuilding.value || '').trim()
      : '';
    const partId = (ChooseBuildingPart === 'Yes')
      ? (selectPart.value || '').trim()
      : '';

    // üîß BELANGRIJK: parameter-namen terug zoals in je bestaande complexinfo.js:
    // action=LIST_FLOOR_SPACES&floorid=...&buildingpartid=...&buildingid=...
    let url = `${LIST_ENDPOINT}?action=LIST_FLOOR_SPACES` +
              `&complex=${encodeURIComponent(complexSelector)}` +
              `&floorid=${encodeURIComponent(buildingFloorId)}` +
              `&env=${encodeURIComponent(envPrefix)}`;

    if (partId) {
      url += `&buildingpartid=${encodeURIComponent(partId)}`;
    }
    if (bldId) {
      url += `&buildingid=${encodeURIComponent(bldId)}`;
    }

    const resp = await fetch(url, { cache: 'no-store' });
    const txt  = await resp.text();
    console.log('LIST_FLOOR_SPACES raw response:', txt);

    let data;
    try {
      data = JSON.parse(txt);
    } catch (e) {
      console.error('JSON parse error', e, txt);
      throw new Error('Geen geldige JSON van de backend.');
    }

    const items = Array.isArray(data.Items) ? data.Items : [];

    selectTarget.innerHTML =
      `<option value="">${isFr ? '-- choisissez un local --'
                               : '-- kies een ruimte --'}</option>`;

    if (!items.length) {
      setStatus(
        isFr ? "Aucun local trouv√© pour cet √©tage."
             : "Geen ruimtes gevonden op deze verdieping.",
        true
      );
      return;
    }

    items.sort((a, b) => {
      const rnA = String(a.RoomNumber || '').trim();
      const rnB = String(b.RoomNumber || '').trim();
      const idA = String(a.Id || '').trim();
      const idB = String(b.Id || '').trim();
      const keyA = rnA || idA;
      const keyB = rnB || idB;
      return keyA.localeCompare(keyB, 'nl', { numeric: true, sensitivity: 'base' });
    });

    items.forEach(sp => {
      const id         = String(sp.Id || '');
      const roomNumber = String(sp.RoomNumber || '').trim();
      const desc       = String(sp.Description || id);
      const tenant     = String(sp.Tenant || '').trim();
      const common     = String(sp.Common || '').trim();

      let label = '';
      if (roomNumber) label += `[${roomNumber}] `;
      label += desc;

      const metaParts = [];
      if (tenant) metaParts.push(tenant);
      if (common) metaParts.push(common);
      if (metaParts.length) label += ' ‚Äì ' + metaParts.join(' ¬∑ ');

      selectTarget.insertAdjacentHTML(
        'beforeend',
        `<option value="${id.replace(/"/g,'&quot;')}">${label.replace(/</g,'&lt;')}</option>`
      );
    });

    setStatus(
      isFr ? `‚úÖ ${items.length} local(aux) trouv√©(s).`
           : `‚úÖ ${items.length} ruimte(s) gevonden.`,
      false
    );
  }

  // ============================================================
  // PORTAL CODE
  // ============================================================
  function buildCodeForPortal(type, id) {
    const nummer = Number(id);
    if (!Number.isFinite(nummer)) return String(id);

    const orgId = String(Math.trunc(nummer)).padStart(6, "0");
    const mult3 = Math.trunc(nummer * 3);
    const last6 = String(mult3).padStart(6, "0");

    let resultaat = "";
    for (let i = 0; i < 6; i++) {
      resultaat += orgId[i] + last6[i];
    }
    return resultaat;
  }

  function goToPortal() {
    if (!currentType) {
      setStatus(
        lang === 'fr'
          ? 'Choisissez d\'abord Installation ou Espace.'
          : 'Kies eerst Installatie of Ruimte.',
        true
      );
      return;
    }

    const id = selectTarget.value;
    if (!id) {
      setStatus(
        lang === 'fr'
          ? 'S√©lectionnez d\'abord un √©l√©ment.'
          : 'Selecteer eerst een item.',
        true
      );
      return;
    }

    const code = buildCodeForPortal(currentType, id);
    const url  = new URL(PORTAL_URL, window.location.origin);
    url.searchParams.set('type', currentType);
    url.searchParams.set('id',   id);
    url.searchParams.set('code', code);
    url.searchParams.set('lang', lang);
    url.searchParams.set('env',  envPrefix);

    window.location.href = url.toString();
  }

  function setActiveType(type) {
    currentType = type;

    btnInstallation.classList.toggle('active', type === 'equipment');
    btnRoom.classList.toggle('active',         type === 'space');

    blockSelect.style.display = 'block';

    if (type === 'space') {
      const showBuildingDropdown = (ChooseBuilding === 'Yes');
      const showPartDropdown     = (ChooseBuildingPart === 'Yes');

      document.getElementById('label-building').style.display = showBuildingDropdown ? 'block' : 'none';
      selectBuilding.style.display                             = showBuildingDropdown ? 'block' : 'none';

      document.getElementById('label-part').style.display      = showPartDropdown ? 'block' : 'none';
      selectPart.style.display                                 = showPartDropdown ? 'block' : 'none';

      // ook al tonen we gebouw misschien niet, we resetten ze gewoon
      selectBuilding.innerHTML = '<option value="">-- kies een gebouw --</option>';
      selectPart.innerHTML     = '<option value="">-- kies een gebouwdeel --</option>';

      selectFloor.style.display = 'block';
      document.getElementById('label-floor').style.display = 'block';
      document.getElementById('label-select').textContent =
        (lang === 'fr') ? 'S√©lectionnez un espace' : 'Kies ruimte';

      selectFloor.innerHTML  = '<option value="">-- laden... --</option>';
      selectTarget.innerHTML = '<option value="">-- eerst een verdieping kiezen --</option>';

      selectTarget.style.display = 'block';
      if (equipmentFilterContainer) equipmentFilterContainer.style.display = 'none';
      if (equipmentList) {
        equipmentList.style.display = 'none';
        equipmentList.innerHTML = '';
      }

      fetchFloorsForComplex().catch(err => {
        console.error(err);
        const isFr = (lang === 'fr');
        setStatus(
          isFr ? 'Erreur lors du chargement des √©tages.'
               : 'Fout bij het laden van de verdiepingen.',
          true
        );
        selectFloor.innerHTML  = '<option value="">-- geen gegevens --</option>';
        selectTarget.innerHTML = '<option value="">-- geen gegevens --</option>';
      });

    } else {
      // INSTALLATIES
      selectFloor.style.display = 'none';
      document.getElementById('label-floor').style.display = 'none';
      document.getElementById('label-select').textContent =
        (lang === 'fr') ? 'S√©lectionnez une installation' : 'Kies installatie';

      document.getElementById('label-building').style.display = 'none';
      selectBuilding.style.display                             = 'none';
      document.getElementById('label-part').style.display      = 'none';
      selectPart.style.display                                 = 'none';

      selectTarget.value       = '';
      selectTarget.style.display = 'none';
      if (equipmentFilterContainer) equipmentFilterContainer.style.display = 'block';
      if (equipmentList) {
        equipmentList.style.display = 'block';
        equipmentList.innerHTML = '';
      }
      if (equipmentFilterInput) equipmentFilterInput.value = '';

      fetchItems().catch(err => {
        console.error(err);
        const isFr = (lang === 'fr');
        setStatus(
          isFr ? 'Erreur lors du chargement.' : 'Fout bij het laden.',
          true
        );
        selectTarget.innerHTML = '<option value="">-- geen gegevens beschikbaar --</option>';
      });
    }
  }

  btnCancel.addEventListener('click', () => {
    currentType = null;
    btnInstallation.classList.remove('active');
    btnRoom.classList.remove('active');
    blockSelect.style.display = 'none';
    selectFloor.innerHTML  = '<option value="">-- eerst een verdieping kiezen --</option>';
    selectTarget.innerHTML = '<option value="">-- eerst een keuze maken hierboven --</option>';
    selectTarget.style.display = 'block';
    if (equipmentFilterContainer) equipmentFilterContainer.style.display = 'none';
    if (equipmentList) {
      equipmentList.style.display = 'none';
      equipmentList.innerHTML = '';
    }
    if (equipmentFilterInput) equipmentFilterInput.value = '';
    setStatus('', false);
  });

  selectFloor.addEventListener('change', () => {
    const isFr = (lang === 'fr');
    const selectedFloorId = selectFloor.value;

    if (!selectedFloorId) {
      selectTarget.innerHTML =
        `<option value="">${isFr ? '-- choisissez d\'abord un √©tage --'
                                 : '-- kies eerst een verdieping --'}</option>`;
      return;
    }

    selectTarget.innerHTML =
      `<option value="">${isFr ? '-- chargement... --' : '-- laden... --'}</option>`;

    fetchSpacesForFloor(selectedFloorId).catch(err => {
      console.error(err);
      setStatus(
        isFr ? 'Erreur lors du chargement des locaux.'
             : 'Fout bij het laden van de ruimtes.',
        true
      );
    });
  });

  selectBuilding.addEventListener('change', () => {
    if (ChooseBuildingPart === 'Yes') {
      buildPartDropdown();
    }
    buildFloorDropdown();
    const isFr = (lang === 'fr');
    selectTarget.innerHTML =
      `<option value="">${isFr ? '-- choisissez d\'abord un √©tage --'
                               : '-- kies eerst een verdieping --'}</option>`;
  });

  selectPart.addEventListener('change', () => {
    buildFloorDropdown();
    const isFr = (lang === 'fr');
    selectTarget.innerHTML =
      `<option value="">${isFr ? '-- choisissez d\'abord un √©tage --'
                               : '-- kies eerst een verdieping --'}</option>`;
  });

  document.getElementById('switch-nl').onclick = (e) => {
    e.preventDefault();
    const u = new URL(window.location.href);
    u.searchParams.set('lang','nl');
    window.location.href = u.toString();
  };
  document.getElementById('switch-fr').onclick = (e) => {
    e.preventDefault();
    const u = new URL(window.location.href);
    u.searchParams.set('lang','fr');
    window.location.href = u.toString();
  };

  btnInstallation.addEventListener('click', () => setActiveType('equipment'));
  btnRoom.addEventListener('click',         () => setActiveType('space'));
  btnGo.addEventListener('click',           goToPortal);

  if (equipmentFilterInput) {
    equipmentFilterInput.addEventListener('input', () => {
      if (currentType === 'equipment') renderEquipmentList();
    });
  }

  if (equipmentList) {
    equipmentList.addEventListener('click', (e) => {
      const row = e.target.closest('.equipment-item');
      if (!row) return;
      const id = row.getAttribute('data-id');
      if (!id) return;

      equipmentList.querySelectorAll('.equipment-item.selected')
        .forEach(el => el.classList.remove('selected'));
      row.classList.add('selected');

      selectTarget.value = id;
      setStatus('', false);
    });
  }

  (function init() {
    initEnvBanner();
    applyLanguage();
  })();
</script>
</body>
</html>
