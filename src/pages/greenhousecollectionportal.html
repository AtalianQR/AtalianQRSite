<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Greenhouse Portal</title>

  <link rel="icon" href="/AtalianFavicon.png" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6fa;
      min-height: 100vh;
    }
    * { box-sizing: border-box; }

    body {
      background-image: url('/greenhousecollection.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }

    /* TEST banner ‚Äì zelfde logica als portal.html */
    .test-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #28a745;
      color: white;
      text-align: center;
      padding: 5px 0;
      font-weight: bold;
      z-index: 1000;
      font-size: 14px;
      text-transform: uppercase;
      opacity: 0.9;
    }
    body.is-test { padding-top: 30px; }

    header { padding: 0.5rem 1rem 0; }
    .lang-switch {
      text-align: right;
      margin-bottom: 0.5rem;
    }
    .lang-switch a {
      margin: 0 .25rem;
      text-decoration: none;
      font-size: 1.1rem;
    }

    .header-flex {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
      gap: .5rem;
    }
    img.logo {
      max-height: 60px;
      background: rgba(255,255,255,0.85);
      padding: .1rem;
      border-radius: 12px;
    }

    .page-card {
      max-width: 600px;
      margin: 1rem auto 2rem;
      background: linear-gradient(120deg,#fff 85%,#f4f6fa 100%);
      border: 2px solid #EE7E00;
      border-radius: 12px;
      box-shadow: 0 6px 32px rgba(0,0,0,.12),0 1.5px 8px rgba(238,126,0,.10);
      padding: 1.25rem 1.5rem 1.5rem;
    }

    .page-card h1 { margin: 0 0 .5rem; font-size: 1.4rem; }
    .page-card p  { margin-top: 0; color: #4b5563; font-size: .95rem; }

    .choice-row {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      margin: 1rem 0;
    }
    .choice-btn {
      flex: 1 1 47%;
      border: 2px solid #EE7E00;
      background: #fff;
      border-radius: 10px;
      padding: .75rem .5rem;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,.04);
      transition: background .12s, transform .08s, box-shadow .08s;
    }
    .choice-btn span.emoji {
      display: block;
      font-size: 1.4rem;
      margin-bottom: .25rem;
    }
    .choice-btn.active {
      background: #EE7E00;
      color: #fff;
      box-shadow: 0 4px 10px rgba(238,126,0,.35);
      transform: translateY(-1px);
    }

    .form-block {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
    }
    .form-block label {
      display: block;
      font-weight: 600;
      margin-bottom: .25rem;
    }
    select, input[type="text"] {
      width: 100%;
      padding: .45rem .6rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: .95rem;
    }

    .status { margin-top: .5rem; font-size: .9rem; color: #6b7280; }
    .status.error { color: #b91c1c; }

    .actions {
      margin-top: 1.25rem;
      display: flex;
      justify-content: flex-end;
      gap: .75rem;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: .55rem 1.4rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: .95rem;
    }
    .btn-primary {
      background: #EE7E00;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }
    .btn-primary:active { background: #d86e00; }
    .btn-secondary { background: #e5e7eb; color: #111827; }

    @media (max-width: 480px) {
      .page-card {
        margin: .75rem auto 1.5rem;
        padding: 1rem 1rem 1.25rem;
        max-width: 95%;
      }
      .choice-btn { flex: 1 1 100%; }
    }
	input:disabled {
	  opacity: 0.55;
	  cursor: not-allowed;
	}

  </style>
</head>

<body>
  <div id="test-indicator" style="display:none" class="test-banner">
    ‚ö†Ô∏è TEST OMGEVING ACTIEF
  </div>

  <header>
    <div class="lang-switch">
      <a href="#" id="switch-nl">üá≥üá± NL</a> |
      <a href="#" id="switch-fr">üá´üá∑ FR</a>
    </div>
    <div class="header-flex">
      <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
    </div>
  </header>

  <main>
    <section class="page-card">
      <h1 id="title-text">Waarvoor wil je een ticket aanmaken?</h1>
      <p id="intro-text">
        Kies eerst of je een probleem wil melden voor een installatie of voor een ruimte (Greenhouse Collection. üåø)
      </p>

      <div class="choice-row">
        <button id="btn-installation" class="choice-btn" type="button" data-type="equipment">
          <span class="emoji">üîß</span>
          <span id="lbl-installation">Installatie</span>
        </button>
        <button id="btn-room" class="choice-btn" type="button" data-type="space">
          <span class="emoji">üè¢</span>
          <span id="lbl-room">Ruimte</span>
        </button>
      </div>

      <div class="form-block" id="block-select" style="display:none">
        <!-- SPACE: gebouw/gebouwdeel/verdieping -->
        <label id="label-building" for="select-building" style="display:none;">Kies gebouw</label>
        <select id="select-building" style="display:none;">
          <option value="">-- kies een gebouw --</option>
        </select>

        <label id="label-part" for="select-part" style="display:none;">Kies gebouwdeel</label>
        <select id="select-part" style="display:none;">
          <option value="">-- kies een gebouwdeel --</option>
        </select>

        <label id="label-floor" for="select-floor" style="display:none;">Kies verdieping</label>
        <select id="select-floor" style="display:none;">
          <option value="">-- eerst een verdieping kiezen --</option>
        </select>

        <!-- EQUIPMENT: eerst type, dan installatie -->
        <label id="label-equipmenttype" for="select-equipmenttype" style="display:none; margin-top:.75rem;">
          Kies installatiesoort
        </label>
        <select id="select-equipmenttype" style="display:none;">
          <option value="">-- eerst een installatiesoort kiezen --</option>
        </select>

        <div id="filter-block" style="margin-top:.5rem; display:none;">
          <label id="label-filter-installation" for="filter-installation">
            Filter installaties (benaming, lokaal, tenant‚Ä¶)
          </label>
          <input
            type="text"
            id="filter-installation"
            placeholder="Typ om te filteren‚Ä¶"
            autocomplete="off"
          />
        </div>
		
<!-- SPACE filter -->
<div id="filter-space-block" style="margin-top:.5rem; display:none;">
  <label id="label-filter-space" for="filter-space">
    Filter ruimtes (code, naam‚Ä¶)
  </label>
  <input
    type="text"
    id="filter-space"
    placeholder="Typ om te filteren‚Ä¶"
    autocomplete="off"
  />
</div>
		

        <label id="label-select" for="select-target" style="margin-top:.75rem; display:block;">
          Kies installatie of ruimte
        </label>
        <select id="select-target">
          <option value="">-- eerst een keuze maken hierboven --</option>
        </select>

        <div id="status" class="status"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-secondary" id="btn-cancel">‚¨ÖÔ∏è Terug</button>
        <button type="button" class="btn btn-primary" id="btn-go">‚û°Ô∏è Ga naar meldingsportaal</button>
      </div>
    </section>
  </main>

  <script>
   console.log("JS loaded ‚úÖ");

    /* ============================================================
       CONFIG
    ============================================================ */
    const COMPLEX_ID           = '006691';
    const ChooseBuilding       = 'No';
    const ChooseBuildingPart   = 'Yes';
    const LIST_ENDPOINT        = '/.netlify/functions/complexinfo';

    /* ============================================================
       TAAL EN OMGEVING
    ============================================================ */
    const qs        = new URLSearchParams(window.location.search);
    let   lang      = qs.get('lang') || ((navigator.language || '').startsWith('fr') ? 'fr' : 'nl');
    const host      = location.host || '';
    const isTestEnv = qs.has('test') || qs.get('env') === 'test' || /test|staging/i.test(host);
    const envPrefix = isTestEnv ? 'test' : 'prod';

    function applyLanguage() {
      const isFr = (lang === 'fr');
	  const lblSpace = document.getElementById('label-filter-space');
		const inpSpace = document.getElementById('filter-space');
		if (lblSpace) lblSpace.textContent = isFr ? 'Filtrer les espaces (code, nom‚Ä¶)'
												 : 'Filter ruimtes (code, naam‚Ä¶)';
		if (inpSpace) inpSpace.placeholder = isFr ? 'Tapez pour filtrer‚Ä¶'
												 : 'Typ om te filteren‚Ä¶';

      document.documentElement.lang = isFr ? 'fr' : 'nl';

      document.getElementById('title-text').textContent =
        isFr ? 'Pour quoi voulez-vous cr√©er un ticket ?' : 'Waarvoor wil je een ticket aanmaken?';

      document.getElementById('intro-text').textContent =
        isFr
          ? "Choisissez d‚Äôabord si vous signalez un probl√®me pour une installation ou pour un espace dans la Greenhouse Collection. üåø"
          : "Kies eerst of je een probleem wil melden voor een installatie of voor een ruimte in de Greenhouse Collection. üåø";

      document.getElementById('lbl-installation').textContent = isFr ? 'Installation' : 'Installatie';
      document.getElementById('lbl-room').textContent         = isFr ? 'Espace / Local' : 'Ruimte';

      document.getElementById('btn-cancel').textContent = isFr ? '‚¨ÖÔ∏è Retour' : '‚¨ÖÔ∏è Terug';
      document.getElementById('btn-go').textContent     = isFr ? '‚û°Ô∏è Aller au portail de ticket' : '‚û°Ô∏è Ga naar meldingsportaal';

      document.getElementById('label-building').textContent = isFr ? 'Choisissez un b√¢timent' : 'Kies gebouw';
      document.getElementById('label-part').textContent     = isFr ? 'Choisissez une partie du b√¢timent' : 'Kies gebouwdeel';
      document.getElementById('label-floor').textContent    = isFr ? 'Choisissez un √©tage' : 'Kies verdieping';

      document.getElementById('label-equipmenttype').textContent =
        isFr ? "Choisissez le type d'installation" : "Kies installatiesoort";

      document.getElementById('label-select').textContent =
        isFr ? 'S√©lectionnez une installation ou un espace' : 'Kies installatie of ruimte';

      const lblFilter = document.getElementById('label-filter-installation');
      const inpFilter = document.getElementById('filter-installation');
      if (lblFilter) {
        lblFilter.textContent = isFr
          ? 'Filtrer les installations (nom, local, locataire‚Ä¶)'
          : 'Filter installaties (benaming, lokaal, tenant‚Ä¶)';
      }
      if (inpFilter) {
        inpFilter.placeholder = isFr ? 'Tapez pour filtrer‚Ä¶' : 'Typ om te filteren‚Ä¶';
      }
    }

    function initEnvBanner() {
      if (isTestEnv) {
        document.getElementById('test-indicator').style.display = 'block';
        document.body.classList.add('is-test');
      }
    }

    /* ============================================================
       ELEMENTS
    ============================================================ */
    const btnInstallation     = document.getElementById('btn-installation');
    const btnRoom             = document.getElementById('btn-room');

    const blockSelect         = document.getElementById('block-select');
    const statusEl            = document.getElementById('status');

    const selectBuilding      = document.getElementById('select-building');
    const selectPart          = document.getElementById('select-part');
    const selectFloor         = document.getElementById('select-floor');

    const selectEquipmentType = document.getElementById('select-equipmenttype');
    const selectTarget        = document.getElementById('select-target');

    const filterBlock         = document.getElementById('filter-block');
    const filterInstall       = document.getElementById('filter-installation');

    const btnGo               = document.getElementById('btn-go');
    const btnCancel           = document.getElementById('btn-cancel');

    /* ============================================================
       STATE
    ============================================================ */
    let currentType        = null;   // 'equipment' of 'space'
    let allFloors          = [];
    let allInstallations   = [];     // Items[]
    let allEquipmentTypes  = [];     // EquipmentTypes[]
    let selectedEqType     = null;   // typeId of '__unknown__'
	let allSpaces = []; // ruimtes van geselecteerde verdieping
	
	const filterSpace = document.getElementById('filter-space');
	

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || '';
      statusEl.classList.toggle('error', !!isError);
    }

    /* ============================================================
       HELPERS: Equipment types & filtering
    ============================================================ */
	

    function normalizeId(v) {
      return String(v ?? '').trim();
    }

    function buildEquipmentTypeDropdown(types, items) {
      const isFr = (lang === 'fr');

      // detecteer onbekende types (lege EquipmentTypeId)
      const hasUnknown = items.some(it => !normalizeId(it.EquipmentTypeId ?? it.equipmentTypeId));

      // options
      selectEquipmentType.innerHTML =
        `<option value="">${isFr ? "-- choisissez d'abord un type --" : "-- kies eerst een installatiesoort --"}</option>`;

      (types || []).forEach(t => {
        const id   = normalizeId(t.Id ?? t.id);
        const desc = String(t.Description ?? t.description ?? id).trim();
        if (!id) return;
        selectEquipmentType.insertAdjacentHTML(
          'beforeend',
          `<option value="${id.replace(/"/g,'&quot;')}">${desc.replace(/</g,'&lt;')}</option>`
        );
      });

      if (hasUnknown) {
        selectEquipmentType.insertAdjacentHTML(
          'beforeend',
          `<option value="__unknown__">${isFr ? "Autre / Inconnu" : "Andere / Onbekend"}</option>`
        );
      }

      // auto-select als er exact 1 type is en geen unknown-only situatie
      const optionCount = selectEquipmentType.querySelectorAll('option').length;
      if (optionCount === 2 && !hasUnknown) {
        // placeholder + 1 type
        selectEquipmentType.selectedIndex = 1;
        selectedEqType = selectEquipmentType.value;
        renderEquipmentOptions();
      } else {
        selectedEqType = null;
        selectTarget.innerHTML =
          `<option value="">${isFr ? "-- choisissez d'abord un type --" : "-- kies eerst een installatiesoort --"}</option>`;
      }
    }
	function updateSpaceFilterAvailability() {
	  // Alleen relevant in SPACE-mode
	  if (currentType !== 'space') {
		document.getElementById('filter-space-block').style.display = 'none';
		return;
	  }

	  const block = document.getElementById('filter-space-block');
	  const inp   = document.getElementById('filter-space');

	  // toon blok wel in space
	  block.style.display = 'block';

	  // voorwaarden: gebouw (als het bestaat) + gebouwdeel (als het bestaat)
	  const buildingOk = (ChooseBuilding !== 'Yes') || !!(selectBuilding && selectBuilding.value);
	  const partOk     = (ChooseBuildingPart !== 'Yes') || !!(selectPart && selectPart.value);

	  const enabled = buildingOk && partOk;

	  inp.disabled = !enabled;

	  if (!enabled) {
		inp.value = '';
		// zolang hij disabled is: toon geen gefilterde rommel
		// (laat de dropdown gewoon wachten op verdieping/ruimtes)
	  }
	}


    function matchesType(item, typeId) {
      const itemType = normalizeId(item.EquipmentTypeId ?? item.equipmentTypeId);
      if (typeId === "__unknown__") return !itemType;
      return itemType === normalizeId(typeId);
    }

	function renderSpaceOptions() {
	  const isFr = (lang === 'fr');

	  function ellipsize(s, max = 42) {
		s = String(s || '').trim();
		return (s.length > max) ? (s.slice(0, max - 1) + '‚Ä¶') : s;
	  }

	  const q = String(filterSpace?.value || '').toLowerCase().trim();

	  const filtered = allSpaces.filter(sp => {
		if (!q) return true;

		const id     = String(sp.Id || '').toLowerCase();
		const code   = String(sp.RoomNumber || '').toLowerCase();
		const desc   = String(sp.Description || '').toLowerCase();
		const tenant = String(sp.Tenant || '').toLowerCase();   // ‚úÖ added

		// ‚úÖ tenant telt mee in de zoekmatch
		return id.includes(q) || code.includes(q) || desc.includes(q) || tenant.includes(q);
	  });

	  selectTarget.innerHTML = '';
	  selectTarget.insertAdjacentHTML(
		'beforeend',
		`<option value="">${isFr ? '-- choisissez un local --' : '-- kies een ruimte --'}</option>`
	  );

	  if (!filtered.length) {
		setStatus(isFr ? "Aucun local trouv√©." : "Geen ruimtes gevonden.", true);
		return;
	  }

	  filtered.sort((a, b) => {
		const keyA = String(a.RoomNumber || a.Id || '').trim();
		const keyB = String(b.RoomNumber || b.Id || '').trim();
		return keyA.localeCompare(keyB, 'nl', { numeric: true, sensitivity: 'base' });
	  });

	  // ‚úÖ Tenant blijft NIET zichtbaar in de dropdown
	  filtered.forEach(sp => {
		const id         = String(sp.Id || '');
		const roomNumber = String(sp.RoomNumber || '').trim();
		const desc       = ellipsize(sp.Description || id, 42);

		const primaryCode = roomNumber || id;
		const label = `${primaryCode} - ${desc}`;

		selectTarget.insertAdjacentHTML(
		  'beforeend',
		  `<option value="${id.replace(/"/g,'&quot;')}">${label.replace(/</g,'&lt;')}</option>`
		);
	  });

	  setStatus(isFr ? `‚úÖ ${filtered.length} trouv√©(s).` : `‚úÖ ${filtered.length} gevonden.`, false);
	}


    function matchesText(item, q) {
      if (!q) return true;
      const needle = q.toLowerCase().trim();
      if (!needle) return true;

      const id   = String(item.Id ?? item.id ?? '').toLowerCase();
      const desc = String(item.Description ?? item.description ?? '').toLowerCase();

      // als je later extra velden meestuurt (SpaceDescription, Tenant, ‚Ä¶) pakt dit ze automatisch mee
      const extra = JSON.stringify(item).toLowerCase();

      return id.includes(needle) || desc.includes(needle) || extra.includes(needle);
    }







    /* ============================================================
       INSTALLATIES (E): haalt Items + EquipmentTypes op
    ============================================================ */
	
	function floorToNumber(v) {
	  const s = String(v ?? '').trim().replace(',', '.');
	  const n = parseFloat(s);
	  return Number.isFinite(n) ? n : 999999;
	}

	function renderEquipmentOptions() {
	  const isFr = (lang === 'fr');

	  const typeId = String(selectEquipmentType.value || '').trim(); // kan leeg zijn
	  selectedEqType = typeId || null;

	  const q = String(filterInstall?.value || '');

	  // ‚úÖ geen type gekozen = toon ALLES
	  const filtered = allInstallations
		.filter(it => !selectedEqType || matchesType(it, selectedEqType))
		.filter(it => matchesText(it, q));

	  selectTarget.innerHTML = '';
	  selectTarget.insertAdjacentHTML(
		'beforeend',
		`<option value="">${isFr ? '-- choisissez une installation --' : '-- kies een installatie --'}</option>`
	  );

	  if (!filtered.length) {
		setStatus(isFr ? "Aucune installation trouv√©e." : "Geen installaties gevonden.", true);
		return;
	  }

	  // sorteren
	  filtered.sort((a, b) => {
		const fa = floorToNumber(a.BuildingFloor);
		const fb = floorToNumber(b.BuildingFloor);
		if (fa !== fb) return fa - fb;

		const na = String(a.Description ?? '').trim();
		const nb = String(b.Description ?? '').trim();
		const cmp = na.localeCompare(nb, 'nl', { numeric: true, sensitivity: 'base' });
		if (cmp !== 0) return cmp;

		const ida = String(a.Id ?? '').trim();
		const idb = String(b.Id ?? '').trim();
		return ida.localeCompare(idb, 'nl', { numeric: true, sensitivity: 'base' });
	  });

	  filtered.forEach(it => {
		const id     = String(it.Id ?? it.id ?? '');
		const floor  = String(it.BuildingFloor ?? '').trim();
		const name   = String(it.Description ?? '').trim() || id;
		const space  = String(it.SpaceDescription ?? '').trim();
		const tenant = String(it.Tenant ?? '').trim();

		let label = `[${floor || '-'}] - ${name}`;
		if (space)  label += ` - ${space}`;
		if (tenant) label += ` - ${tenant}`;

		selectTarget.insertAdjacentHTML(
		  'beforeend',
		  `<option value="${id.replace(/"/g,'&quot;')}">${label.replace(/</g,'&lt;')}</option>`
		);
	  });

	  setStatus(isFr ? `‚úÖ ${filtered.length} trouv√©e(s).` : `‚úÖ ${filtered.length} gevonden.`, false);
	}

	
	
	function buildTypesFromItems(items) {
	  const map = new Map();

	  (items || []).forEach(it => {
		const id = String(it.EquipmentTypeId ?? '').trim();
		const desc = String(it.EquipmentType ?? id).trim(); // trim is belangrijk (je hebt "Koffiemachine ")

		if (!id) return;
		if (!map.has(id)) map.set(id, desc);
	  });

	  return Array.from(map.entries())
		.map(([Id, Description]) => ({ Id, Description }))
		.sort((a, b) => String(a.Description).localeCompare(String(b.Description), 'nl', { sensitivity: 'base' }));
	}


	
	async function fetchEquipmentsForComplex() {
	  const isFr = (lang === 'fr');
	  setStatus(isFr ? 'Chargement des installations‚Ä¶' : 'Installaties worden geladen‚Ä¶', false);

	  const complexSelector = `E${COMPLEX_ID}`;
	  const url = `${LIST_ENDPOINT}?complex=${encodeURIComponent(complexSelector)}&env=${encodeURIComponent(envPrefix)}`;

	  let resp, txt, data;

	  try {
		resp = await fetch(url, { cache: 'no-store' });
		txt  = await resp.text();
	  } catch (e) {
		console.error("Fetch error:", e);
		setStatus(isFr ? "Erreur r√©seau." : "Netwerkfout.", true);
		return;
	  }

	  try {
		data = JSON.parse(txt);
	  } catch (e) {
		console.error('JSON parse error', e, txt);
		setStatus(isFr ? "R√©ponse invalide (JSON)." : "Ongeldige response (JSON).", true);
		return;
	  }

	  const items = Array.isArray(data.Items) ? data.Items : (Array.isArray(data.items) ? data.items : []);
	  const types = buildTypesFromItems(items);

	  console.log("Items geladen:", items.length);
	  console.log("Types gevonden:", types);

	  allInstallations  = items;
	  allEquipmentTypes = types;

	  if (!items.length) {
		setStatus(isFr ? "Aucune installation trouv√©e." : "Geen installaties gevonden.", true);
		selectEquipmentType.innerHTML = `<option value="">-- niets beschikbaar --</option>`;
		selectTarget.innerHTML        = `<option value="">-- niets beschikbaar --</option>`;
		return;
	  }

	  if (!types.length) {
		setStatus(isFr ? "Aucun type trouv√© dans les donn√©es." : "Geen installatiesoorten gevonden in de data.", true);
		selectEquipmentType.innerHTML = `<option value="">-- geen types --</option>`;
		selectTarget.innerHTML        = `<option value="">-- kies eerst een installatiesoort --</option>`;
		return;
	  }

	  // dropdown opbouwen
	  buildEquipmentTypeDropdown(allEquipmentTypes, allInstallations);
	  selectEquipmentType.value = '';
	  filterInstall.value = '';
	  renderEquipmentOptions();

	  // UX: zet target dropdown terug op ‚Äúkies eerst type‚Äù

	  setStatus(isFr ? `‚úÖ ${items.length} installation(s) charg√©e(s).` : `‚úÖ ${items.length} installaties geladen.`, false);
	}


    /* ============================================================
       SPACES: LIST_FLOORS + LIST_FLOOR_SPACES (ongewijzigd)
    ============================================================ */
    async function fetchFloorsForComplex() {
      const isFr = (lang === 'fr');
      setStatus(isFr ? 'Chargement des √©tages‚Ä¶' : 'Verdiepingen worden geladen‚Ä¶', false);

      const complexSelector = `S${COMPLEX_ID}`;
      const url = `${LIST_ENDPOINT}?action=LIST_FLOORS&complex=${encodeURIComponent(complexSelector)}&env=${encodeURIComponent(envPrefix)}`;

      const resp = await fetch(url, { cache: 'no-store' });
      const txt  = await resp.text();

      let data;
      try { data = JSON.parse(txt); }
      catch (e) {
        console.error('JSON parse error', e, txt);
        throw new Error('Geen geldige JSON van de backend.');
      }

      const items = Array.isArray(data.Items) ? data.Items : [];
      if (!items.length) {
        setStatus(isFr ? "Aucun √©tage trouv√©." : "Geen verdiepingen gevonden.", true);
        selectFloor.innerHTML  = '<option value="">-- niets beschikbaar --</option>';
        selectTarget.innerHTML = '<option value="">-- niets beschikbaar --</option>';
        return;
      }

      allFloors = items;

      buildBuildingAndPartDropdowns();
      rebuildPartDropdown();
      buildFloorDropdown();

      selectTarget.innerHTML =
        `<option value="">${isFr ? "-- choisissez d'abord un √©tage --" : "-- kies eerst een verdieping --"}</option>`;
      setStatus('', false);
    }

	 async function fetchSpacesForFloor(buildingFloorId) {
	  const isFr = (lang === 'fr');

	  if (!buildingFloorId) {
		selectTarget.innerHTML =
		  `<option value="">${isFr ? "-- choisissez d'abord un √©tage --" : "-- kies eerst een verdieping --"}</option>`;
		return;
	  }

	  setStatus(isFr ? 'Chargement des locaux‚Ä¶' : 'Ruimtes worden geladen‚Ä¶', false);

	  const complexSelector = `S${COMPLEX_ID}`;
	  const bldId  = (ChooseBuilding === 'Yes') ? (selectBuilding.value || '').trim() : '';
	  const partId = (ChooseBuildingPart === 'Yes') ? (selectPart.value || '').trim() : '';

	  let url = `${LIST_ENDPOINT}?action=LIST_FLOOR_SPACES` +
				`&complex=${encodeURIComponent(complexSelector)}` +
				`&buildingFloorId=${encodeURIComponent(buildingFloorId)}` +
				`&env=${encodeURIComponent(envPrefix)}`;

	  if (partId) url += `&buildingPartId=${encodeURIComponent(partId)}`;
	  if (bldId)  url += `&buildingId=${encodeURIComponent(bldId)}`;

	  let resp, txt, data;
	  try {
		resp = await fetch(url, { cache: 'no-store' });
		txt  = await resp.text();
		data = JSON.parse(txt);
	  } catch (e) {
		console.error('Fetch/JSON error', e, txt);
		setStatus(isFr ? "Erreur lors du chargement des locaux." : "Fout bij het laden van de ruimtes.", true);
		selectTarget.innerHTML = `<option value="">${isFr ? '-- aucune donn√©e --' : '-- geen gegevens --'}</option>`;
		return;
	  }

	  const items = Array.isArray(data.Items) ? data.Items : [];

	  if (!items.length) {
		allSpaces = [];
		selectTarget.innerHTML =
		  `<option value="">${isFr ? '-- choisissez un local --' : '-- kies een ruimte --'}</option>`;
		setStatus(isFr ? "Aucun local trouv√©." : "Geen ruimtes gevonden.", true);
		return;
	  }

	  // ‚úÖ 1) bewaar ruimtes voor filter/render
	  allSpaces = items;

	  // ‚úÖ 2) filterveld resetten (optioneel maar handig)
	  if (filterSpace) filterSpace.value = '';

	  // ‚úÖ 3) render dropdown via jouw renderer (tenant wordt daar NIET getoond)
	  renderSpaceOptions();
	  updateSpaceFilterAvailability();

	}


    /* ============================================================
       Dropdowns: gebouw, buildingpart, verdieping
    ============================================================ */
    function getShortPartId(raw) {
      const txt = String(raw || '');
      const m = txt.match(/BuildingPart\.Id\.Id='([^']+)'/);
      return m ? m[1] : txt;
    }

    function buildBuildingAndPartDropdowns() {
      const isFr = (lang === 'fr');
      const showBuilding = (ChooseBuilding === 'Yes');

      if (showBuilding) {
        const bldMap = new Map();
        allFloors.forEach(f => {
          const id   = String(f.BuildingId || '').trim();
          if (!id) return;
          const desc = String(f.BuildingDescription || id).trim();
          if (!bldMap.has(id)) bldMap.set(id, desc);
        });

        selectBuilding.innerHTML =
          `<option value="">${isFr ? '-- choisissez un b√¢timent --' : '-- kies een gebouw --'}</option>`;

        for (const [id, desc] of bldMap.entries()) {
          const label = `${id} ‚Äì ${desc}`;
          selectBuilding.insertAdjacentHTML(
            'beforeend',
            `<option value="${id.replace(/"/g,'&quot;')}">${label.replace(/</g,'&lt;')}</option>`
          );
        }
      }
    }

    function rebuildPartDropdown() {
      if (ChooseBuildingPart !== 'Yes') return;

      const isFr = (lang === 'fr');
      const bldId = (ChooseBuilding === 'Yes') ? (selectBuilding.value || '').trim() : '';

      if (ChooseBuilding === 'Yes' && !bldId) {
        selectPart.innerHTML =
          `<option value="">${isFr ? "-- choisissez un b√¢timent d'abord --" : "-- kies eerst een gebouw --"}</option>`;
        return;
      }

      selectPart.innerHTML =
        `<option value="">${isFr ? '-- choisissez une partie --' : '-- kies een gebouwdeel --'}</option>`;

      const partMap = new Map();

      allFloors.forEach(f => {
        if (ChooseBuilding === 'Yes') {
          const fbld = String(f.BuildingId || '').trim();
          if (fbld !== bldId) return;
        }

        const pidRaw = String(f.BuildingPartId || '').trim();
        const pid    = getShortPartId(pidRaw);
        if (!pid) return;

        const pdesc  = String(f.BuildingPartDescription || pid).trim();
        if (!partMap.has(pid)) partMap.set(pid, pdesc);
      });

      for (const [pid, desc] of partMap.entries()) {
        selectPart.insertAdjacentHTML(
          'beforeend',
          `<option value="${pid.replace(/"/g,'&quot;')}">${desc.replace(/</g,'&lt;')}</option>`
        );
      }
    }

    function buildFloorDropdown() {
      const isFr = (lang === 'fr');

      const bldId  = (ChooseBuilding === 'Yes') ? (selectBuilding.value || '').trim() : '';
      const partId = (ChooseBuildingPart === 'Yes') ? (selectPart.value || '').trim() : '';

      if (!Array.isArray(allFloors) || !allFloors.length) {
        selectFloor.innerHTML =
          `<option value="">${isFr ? '-- aucun √©tage --' : '-- geen verdiepingen --'}</option>`;
        return;
      }

      const levelToId = new Map();

      allFloors.forEach(f => {
        if (bldId && String(f.BuildingId || '').trim() !== bldId) return;

        const pidShort = getShortPartId(f.BuildingPartId);
        if (partId && pidShort !== partId) return;

        const levelRaw = f.Level ?? f._Level ?? f.BuildingFloorLevel ?? '';
        const level    = String(levelRaw).trim();
        const bfId     = String(f.Id || '').trim();

        if (!level || !bfId) return;
        if (!levelToId.has(level)) levelToId.set(level, bfId);
      });

      if (!levelToId.size) {
        selectFloor.innerHTML =
          `<option value="">${isFr ? '-- aucun √©tage filtr√© --' : '-- geen verdiepingen gevonden --'}</option>`;
        return;
      }

      const sortedLevels = Array.from(levelToId.keys()).sort((a, b) => {
        const na = parseFloat(String(a).replace(',', '.'));
        const nb = parseFloat(String(b).replace(',', '.'));
        if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
        return String(a).localeCompare(String(b), undefined, { sensitivity: 'base' });
      });

      selectFloor.innerHTML =
        `<option value="">${isFr ? '-- choisissez un √©tage --' : '-- kies een verdieping --'}</option>`;

      sortedLevels.forEach(level => {
        const bfId = levelToId.get(level);
        selectFloor.insertAdjacentHTML(
          'beforeend',
          `<option value="${String(bfId).replace(/"/g,'&quot;')}">${String(level).replace(/</g,'&lt;')}</option>`
        );
      });

      selectTarget.innerHTML =
        `<option value="">${isFr ? "-- choisissez d'abord un √©tage --" : "-- kies eerst een verdieping --"}</option>`;
    }

    /* ============================================================
       TYPE KIEZEN
    ============================================================ */
	function setActiveType(type) {
	  currentType = type;

	  btnInstallation.classList.toggle('active', type === 'equipment');
	  btnRoom.classList.toggle('active',         type === 'space');

	  blockSelect.style.display = 'block';
	  setStatus('', false);

	  const isFr = (lang === 'fr');

	  if (type === 'space') {

		const showBuildingDropdown = (ChooseBuilding === 'Yes');
		const showPartDropdown     = (ChooseBuildingPart === 'Yes');

		document.getElementById('label-building').style.display = showBuildingDropdown ? 'block' : 'none';
		selectBuilding.style.display                             = showBuildingDropdown ? 'block' : 'none';
		document.getElementById('label-part').style.display      = showPartDropdown ? 'block' : 'none';
		selectPart.style.display                                 = showPartDropdown ? 'block' : 'none';

		document.getElementById('label-floor').style.display     = 'block';
		selectFloor.style.display                                = 'block';

		// equipment-velden verbergen
		document.getElementById('label-equipmenttype').style.display = 'none';
		selectEquipmentType.style.display                             = 'none';
		filterBlock.style.display                                      = 'none';

		// ‚úÖ space-filter tonen (maar evt disabled)
		document.getElementById('filter-space-block').style.display = 'block';
		updateSpaceFilterAvailability();

		document.getElementById('label-select').textContent = isFr ? 'S√©lectionnez un espace' : 'Kies ruimte';

		// resets
		selectEquipmentType.innerHTML = `<option value="">${isFr ? "-- choisissez d'abord un type --" : "-- kies eerst een installatiesoort --"}</option>`;
		filterInstall.value = '';

		// dropdowns resetten
		selectTarget.innerHTML = `<option value="">${isFr ? "-- choisissez d'abord un √©tage --" : "-- kies eerst een verdieping --"}</option>`;
		selectFloor.innerHTML  = `<option value="">-- laden... --</option>`;

		// ‚úÖ ruimtes-state leeg
		allSpaces = [];
		if (filterSpace) filterSpace.value = '';

		fetchFloorsForComplex().catch(err => {
		  console.error(err);
		  setStatus(isFr ? "Erreur lors du chargement des √©tages." : "Fout bij het laden van de verdiepingen.", true);
		  selectFloor.innerHTML  = '<option value="">-- geen gegevens --</option>';
		  selectTarget.innerHTML = '<option value="">-- geen gegevens --</option>';
		});

	  } else {

		// equipment-velden tonen
		document.getElementById('label-equipmenttype').style.display = 'block';
		selectEquipmentType.style.display                             = 'block';
		filterBlock.style.display                                      = 'block';

		// space-velden verbergen
		document.getElementById('label-building').style.display = 'none';
		selectBuilding.style.display                             = 'none';
		document.getElementById('label-part').style.display      = 'none';
		selectPart.style.display                                 = 'none';
		document.getElementById('label-floor').style.display     = 'none';
		selectFloor.style.display                                = 'none';

		// ‚úÖ space-filter verbergen
		document.getElementById('filter-space-block').style.display = 'none';

		document.getElementById('label-select').textContent = isFr ? 'S√©lectionnez une installation' : 'Kies installatie';

		filterInstall.value = '';
		selectTarget.innerHTML = `<option value="">${isFr ? "-- choisissez d'abord un type --" : "-- kies eerst een installatiesoort --"}</option>`;
		selectEquipmentType.innerHTML = `<option value="">${isFr ? "-- chargement... --" : "-- laden... --"}</option>`;

		fetchEquipmentsForComplex().catch(err => {
		  console.error(err);
		  setStatus(isFr ? 'Erreur lors du chargement.' : 'Fout bij het laden.', true);
		  selectEquipmentType.innerHTML = '<option value="">-- geen gegevens --</option>';
		  selectTarget.innerHTML        = '<option value="">-- geen gegevens --</option>';
		});
	  }
	}



    /* ============================================================
       CODE VOOR PORTAL
    ============================================================ */
    function buildCodeForPortal(type, id) {
      const nummer = Number(id);
      if (!Number.isFinite(nummer)) return String(id);

      const orgId = String(Math.trunc(nummer)).padStart(6, "0");
      const mult3 = Math.trunc(nummer * 3);
      const last6 = String(mult3).padStart(6, "0");

      let resultaat = "";
      for (let i = 0; i < 6; i++) resultaat += orgId[i] + last6[i];

      const isSpace = (type === "space");
      const endDigit = isSpace ? Math.floor(Math.random() * 9) : 9; // space: 0-8, equipment: 9
      resultaat += String(endDigit);
      return resultaat;
    }

    function goToPortal() {
	  const isFr = (lang === 'fr');

	  if (!currentType) {
		alert(isFr ? 'Choisissez d‚Äôabord installation ou espace.' : 'Kies eerst installatie of ruimte.');
		return;
	  }

	  // ‚úÖ SPACE blijft zoals bij jou (verdieping verplicht)
	  if (currentType === 'space' && !selectFloor.value) {
		alert(isFr ? 'S√©lectionnez un √©tage dans la liste.' : 'Selecteer een verdieping in de lijst.');
		return;
	  }

	  // ‚úÖ INSTALLATIE blijft verplicht (ongeacht type)
	  const id = selectTarget.value;
	  if (!id) {
		alert(
		  isFr
			? `S√©lectionnez un ${currentType === 'space' ? 'local' : '√©l√©ment'} dans la liste.`
			: `Selecteer een ${currentType === 'space' ? 'ruimte' : 'installatie'} in de lijst.`
		);
		return;
	  }

	  const code = buildCodeForPortal(currentType, id);
	  const url  = new URL('/portal.html', window.location.origin);
	  url.searchParams.set('code', code);
	  url.searchParams.set('lang', lang);
	  url.searchParams.set('env', envPrefix);
	  url.searchParams.set('src', window.location.pathname + window.location.search);
	  window.location.href = url.toString();
	}


    /* ============================================================
       EVENTS
    ============================================================ */
    document.getElementById('switch-nl').onclick = (e) => {
      e.preventDefault();
      const u = new URL(window.location.href);
      u.searchParams.set('lang','nl');
      window.location.href = u.toString();
    };
    document.getElementById('switch-fr').onclick = (e) => {
      e.preventDefault();
      const u = new URL(window.location.href);
      u.searchParams.set('lang','fr');
      window.location.href = u.toString();
    };

    btnInstallation.addEventListener('click', () => setActiveType('equipment'));
    btnRoom.addEventListener('click',         () => setActiveType('space'));
    btnGo.addEventListener('click',           goToPortal);

    btnCancel.addEventListener('click', () => {
      currentType = null;
      btnInstallation.classList.remove('active');
      btnRoom.classList.remove('active');
      blockSelect.style.display = 'none';

      // reset visible inputs
      selectFloor.innerHTML         = '<option value="">-- eerst een verdieping kiezen --</option>';
      selectEquipmentType.innerHTML = '<option value="">-- eerst een installatiesoort kiezen --</option>';
      selectTarget.innerHTML        = '<option value="">-- eerst een keuze maken hierboven --</option>';
      filterInstall.value           = '';

      setStatus('', false);
    });

    // space: floor change => spaces ophalen
    selectFloor.addEventListener('change', () => {
      const isFr = (lang === 'fr');
      const selectedFloorId = selectFloor.value;

      if (!selectedFloorId) {
        selectTarget.innerHTML =
          `<option value="">${isFr ? "-- choisissez d'abord un √©tage --" : "-- kies eerst een verdieping --"}</option>`;
        setStatus('', false);
        return;
      }

      selectTarget.innerHTML =
        `<option value="">${isFr ? '-- chargement des locaux --' : '-- ruimtes worden geladen --'}</option>`;

      fetchSpacesForFloor(selectedFloorId).catch(err => {
        console.error(err);
        setStatus(isFr ? 'Erreur lors du chargement des locaux.' : 'Fout bij het laden van de ruimtes.', true);
        selectTarget.innerHTML = `<option value="">${isFr ? '-- aucune donn√©e --' : '-- geen gegevens --'}</option>`;
      });
    });

    if (selectBuilding) {
      selectBuilding.addEventListener('change', () => {
        rebuildPartDropdown();
        buildFloorDropdown();
		updateSpaceFilterAvailability(); // ‚úÖ
      });
    }
    if (selectPart) {
      selectPart.addEventListener('change', () => {
        buildFloorDropdown();
		updateSpaceFilterAvailability(); // ‚úÖ
      });
    }

    // equipment: type change => installaties vullen
    selectEquipmentType.addEventListener('change', () => {
      filterInstall.value = '';
      renderEquipmentOptions();
    });

    // equipment: filter text => opnieuw renderen (zelfde type)
	filterInstall.addEventListener('input', () => {
	  if (currentType !== 'equipment') return;
	  renderEquipmentOptions();
	});

	filterSpace.addEventListener('input', () => {
	  if (currentType !== 'space') return;
	  if (filterSpace.disabled) return; // ‚úÖ pas filteren als actief
	  renderSpaceOptions();
	});


    /* ============================================================
       INIT
    ============================================================ */
    (function init() {
      initEnvBanner();
      applyLanguage();
    })();
  </script>
</body>
</html>
