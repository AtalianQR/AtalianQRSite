<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ATALIAN • Game Stats (compact)</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--text:#0f172a;--muted:#475569;--accent:#ee7e00}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:880px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:20px} .muted{color:var(--muted)}
    .grid{display:grid;gap:10px}
    .cards{grid-template-columns:repeat(3,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:14px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .val{font-size:28px;font-weight:800}
    .kpi .vals{display:flex;gap:10px;align-items:baseline}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
    button{background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:#111827;color:#fff;border-color:#111827}
    .right{margin-left:auto}
    .bars{display:grid;grid-template-columns:1fr;gap:8px}
    .bar{display:flex;align-items:center;gap:10px}
    .bar .label{width:76px;font-variant-numeric:tabular-nums}
    .bar .track{flex:1;height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar .fill{height:100%;background:var(--accent)}
    .foot{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;color:var(--muted)}
    @media(max-width:720px){ .cards{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ATALIAN • Game Stats</h1>
  <div class="muted">Compacte live-statistiek op basis van <code>/api/log</code>. Reset wordt server-side onthouden.</div>

  <div class="toolbar">
    <button id="btn-refresh" class="primary">Vernieuw</button>
    <button id="btn-reset">Reset teller (server)</button>
    <label class="right"><input type="checkbox" id="auto"/> Auto-refresh (30s)</label>
  </div>

  <div class="grid cards">
    <div class="card kpi">
      <div class="lbl muted">Inschrijvingen</div>
      <div class="val" id="k-checkins">–</div>
    </div>
    <div class="card kpi">
      <div class="lbl muted">Gem. voortgang</div>
      <div class="vals">
        <span class="val" id="k-avg">–</span>
        <span class="val" id="k-avg-pct">(–%)</span>
      </div>
      <div class="muted" id="k-avg-sub">van ingeschrevenen</div>
    </div>
    <div class="card kpi">
      <div class="lbl muted">Voltooid (4/4)</div>
      <div class="val" id="k-done">–</div>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <h3 style="margin:0 0 8px">Pogingen per step (aandeel van alle pogingen)</h3>
    <div class="bars">
      <div class="bar"><div class="label">Step 1</div><div class="track"><div class="fill" id="b1" style="width:0%"></div></div><div class="pct" id="p1">–</div></div>
      <div class="bar"><div class="label">Step 2</div><div class="track"><div class="fill" id="b2" style="width:0%"></div></div><div class="pct" id="p2">–</div></div>
      <div class="bar"><div class="label">Step 3</div><div class="track"><div class="fill" id="b3" style="width:0%"></div></div><div class="pct" id="p3">–</div></div>
      <div class="bar"><div class="label">Step 4</div><div class="track"><div class="fill" id="b4" style="width:0%"></div></div><div class="pct" id="p4">–</div></div>
    </div>
  </div>

  <div class="foot" style="margin-top:10px">
    <span class="badge" id="since">telt vanaf: (geen reset)</span>
    <span class="badge" id="meta"></span>
  </div>
</div>

<script>
/* ===== API-endpoint ===== */
const API =
  location.hostname.includes('localhost') || location.hostname.includes('127.0.0.1')
    ? '/api/log'
    : 'https://atalian-logs.atalianqr.workers.dev/api/log';

/* ===== DOM helpers ===== */
const $ = (s)=>document.querySelector(s);
const fmtPct = (x)=> isFinite(x) ? (x*100).toFixed(0)+'%' : '–';

/* ===== Caches + optimistic buffer ===== */
let itemsCache = [];   // laatste serveritems
let lastResetTs = 0;   // server-resetanker
window.__OPT = [];     // optionele, lokale “optimistic” events (indien ooit gebruikt)

/* ===== Normalisatie (compatibel met game-logger) ===== */
function inferEvent(rec){
  if(!rec.event && (rec.contextLabel || rec.email_present!==undefined || rec.urgent)) return 'ticket_submitted';
  return rec.event || 'event';
}
function normalize(rec){
  return {
    event: inferEvent(rec),
    ts: Number(rec.server_ts || rec.ts || Date.now()),
    user: rec.user_id || rec.visitor_id || 'unknown',
    session: rec.session_id || 'default',
    step: (rec.step != null ? Number(rec.step) : null),
    lang: rec.lang || 'nl'
  };
}

/* ===== Server reset-anker ===== */
async function postReset(){
  await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({event:'statsgame_reset', ts: Date.now()})
  });
}

/* ===== Ophalen uit API ===== */
async function fetchAll(limit=8000){
  const url = new URL(API, location.origin);
  url.searchParams.set('limit', String(limit));
  const res = await fetch(url.toString(), { cache:'no-store' });
  if(!res.ok) throw new Error('HTTP '+res.status);
  const json = await res.json();
  const raw = Array.isArray(json) ? json : (Array.isArray(json.items) ? json.items : []);
  return raw.map(normalize);
}

function latestResetTs(items){
  const r = items.filter(it => it.event==='statsgame_reset').sort((a,b)=>b.ts-a.ts)[0];
  return r ? r.ts : null;
}
function filterSince(items, sinceTs){
  return sinceTs ? items.filter(it => it.ts >= sinceTs) : items;
}

/* ===== Aggregaties ===== */
function buildParticipants(items){
  const map = new Map(); // key: user|session
  for(const it of items){
    const key = (it.user||'unknown') + '|' + (it.session||'default');
    let p = map.get(key);
    if(!p){ p = {checked:false, steps:new Set(), lang:it.lang||'nl'}; map.set(key,p); }
    if(it.event==='checkin') p.checked = true;
    if(it.event==='scenario_done' && Number.isFinite(it.step)){
      const s = Math.max(1, Math.min(4, it.step));
      p.steps.add(s);
    }
  }
  return Array.from(map.values());
}
function computeMetrics(items){
  const parts = buildParticipants(items);
  const checked = parts.filter(p=>p.checked);
  const checkins = checked.length;

  const attemptsByStep = {1:0,2:0,3:0,4:0};
  for(const it of items){
    if(it.event==='scenario_done' && Number.isFinite(it.step)){
      const s = Math.max(1, Math.min(4, it.step));
      attemptsByStep[s] += 1;
    }
  }

  let totalCompleted=0, done=0;
  if(checkins>0){
    for(const p of checked){
      const c = Math.min(4, p.steps.size);
      totalCompleted += c;
      if(c>=4) done++;
    }
  }
  const avg = checkins ? totalCompleted/checkins : 0;

  const totalAttempts = attemptsByStep[1]+attemptsByStep[2]+attemptsByStep[3]+attemptsByStep[4];
  const shareByStep = totalAttempts ? {
    1: attemptsByStep[1]/totalAttempts,
    2: attemptsByStep[2]/totalAttempts,
    3: attemptsByStep[3]/totalAttempts,
    4: attemptsByStep[4]/totalAttempts
  } : {1:0,2:0,3:0,4:0};

  const avgAttemptsPerStep = checked.length ? {
    1: attemptsByStep[1]/checked.length,
    2: attemptsByStep[2]/checked.length,
    3: attemptsByStep[3]/checked.length,
    4: attemptsByStep[4]/checked.length
  } : {1:0,2:0,3:0,4:0};

  return {checkins, avg, done, attemptsByStep, shareByStep, avgAttemptsPerStep, totalAttempts};
}

/* ===== Render ===== */
function render(metrics, sinceTs, allCount){
  const {checkins, avg, done, attemptsByStep, shareByStep, avgAttemptsPerStep} = metrics;

  $('#k-checkins').textContent = checkins;

  const avgInt = Math.round(avg);
  $('#k-avg').textContent = `${avgInt} / 4`;
  const pct = (avg/4)*100;
  $('#k-avg-pct').textContent = `(${Math.round(pct)}%)`;

  $('#k-done').textContent = done;

  const upd = (i)=> {
    const share = shareByStep[i] || 0;
    const attempts = attemptsByStep[i] || 0;
    const perUser = avgAttemptsPerStep[i] || 0;
    $('#b'+i).style.width = (share*100).toFixed(0)+'%';
    $('#p'+i).textContent = `${attempts}× • ${(share*100).toFixed(0)}%`;
    $('#p'+i).title = `gem. pogingen per deelnemer: ${perUser.toFixed(2)}`;
  };
  upd(1); upd(2); upd(3); upd(4);

  $('#since').textContent = sinceTs ? ('telt vanaf: '+ new Date(sinceTs).toLocaleString()) : 'telt vanaf: (geen reset)';
  $('#meta').textContent = `events in venster: ${allCount}`;
}

/* ===== Optimistic helpers ===== */
async function refreshStats(){
  const all = await fetchAll(8000);
  itemsCache   = all;
  lastResetTs  = latestResetTs(all) || 0;
  const windowed = filterSince([...itemsCache, ...(window.__OPT||[])], lastResetTs);
  const metrics = computeMetrics(windowed);
  render(metrics, lastResetTs, windowed.length);
}
function applyOptimistic(ev){
  window.__OPT ||= [];
  window.__OPT.push(ev);
  const merged = filterSince([...itemsCache, ...window.__OPT], lastResetTs);
  render(computeMetrics(merged), lastResetTs, merged.length);
}
async function postAndRefresh(ev){
  applyOptimistic(ev);                  // meteen feedback
  setTimeout(refreshStats, 1500);
  setTimeout(refreshStats, 5000);
  setTimeout(refreshStats, 12000);
}

/* ===== UI ===== */
document.getElementById('btn-refresh').addEventListener('click', () => {
  refreshStats();
});
document.getElementById('btn-reset').addEventListener('click', async ()=>{
  if (!confirm('Teller resetten en server-anker plaatsen?')) return;
  await postReset();
  // na reset geen optimistic events nodig; gewoon herhaald verversen
  setTimeout(refreshStats, 300);
  setTimeout(refreshStats, 2000);
  setTimeout(refreshStats, 6000);
  setTimeout(refreshStats, 15000);
});

let timer=null;
document.getElementById('auto').addEventListener('change', e=>{
  if(e.target.checked){ timer=setInterval(refreshStats, 30000); } else { clearInterval(timer); timer=null; }
});

/* Init */
refreshStats();
</script>
</body>
</html>
