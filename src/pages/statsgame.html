<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ATALIAN â€¢ Game Stats (compact)</title>
  <style>
    :root{
      --bg:#f7fafc;--card:#fff;--text:#0f172a;--muted:#475569;--accent:#ee7e00
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(180deg,#ffffff 0%, #f6f8fb 100%);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0 0 4px;font-size:20px;font-weight:700}
    .muted{color:var(--muted);font-size:14px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef2ff;font-size:13px}
    .badge b{font-weight:700}
    .health{font-size:18px}

    .grid{display:grid;gap:12px;margin-top:12px}
    .cards{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{
      background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);
      padding:14px;min-height:76px;display:flex;flex-direction:column;justify-content:center
    }
    .k{font-size:13px;color:var(--muted);margin-bottom:2px}
    .v{font-size:26px;font-weight:800;line-height:1}

    .panel{display:grid;grid-template-columns:1fr;gap:10px}
    .list{
      background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);
      padding:12px;min-height:180px
    }
    .list h2{font-size:16px;margin:0 0 8px}
    ul.ev{list-style:none;margin:0;padding:0;max-height:420px;overflow:auto}
    ul.ev li{padding:8px 6px;border-bottom:1px solid #eef2f7;font-size:14px;display:flex;justify-content:space-between;gap:10px}
    ul.ev li:last-child{border-bottom:none}
    .evt{font-weight:600}
    .ctx{color:var(--muted)}
    .ts{white-space:nowrap;color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center;margin-top:8px}
    button{background:var(--accent);border:none;color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
    button.ghost{background:#e2e8f0;color:#0f172a}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}

    @media (max-width:800px){
      .cards{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <h1>ATALIAN â€¢ Game Stats</h1>
      <span class="badge">Status: <b id="status">opstartenâ€¦</b></span>
      <span class="badge">API health: <span id="health" class="health">?</span></span>
    </div>
    <div class="muted">Live tellingen uit de QR-game. Verversing elke 5 s. </div>

    <div class="grid cards">
      <div class="card"><div class="k">Totaal events</div><div class="v" id="kpi-total">0</div></div>
      <div class="card"><div class="k">Tickets</div><div class="v" id="kpi-tickets">0</div></div>
      <div class="card"><div class="k">Bezoeken</div><div class="v" id="kpi-visits">0</div></div>
      <div class="card"><div class="k">Scenario klaar</div><div class="v" id="kpi-done">0</div></div>
    </div>

    <div class="grid panel" style="margin-top:12px">
      <div class="list">
        <h2>Laatst 50 events</h2>
        <ul class="ev" id="events"></ul>
        <div class="toolbar">
          <button id="btn-refresh" class="ghost">Herlaad</button>
          <button id="btn-reset"  title="Stuurt een reset-event via dezelfde proxy">Reset teller</button>
          <span class="muted">Endpoint: <code id="ep"></code></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== API-endpoint (hardcoded to external logger for robust demo) ===== */
    const API = 'https://atalian-logs.atalianqr.workers.dev/api/log';

    /* ===== Utils ===== */
    const $ = (s)=>document.querySelector(s);
    const byTsDesc = (a,b)=> (Number(b.ts||0) - Number(a.ts||0));

    function inferEvent(rec){
      if(!rec.event && (rec.contextLabel || rec.email_present !== undefined || rec.urgent)) return 'ticket_submitted';
      return rec.event || 'event';
    }
    function normalize(rec){
      return {
        event: inferEvent(rec),
        ts: Number(rec.server_ts || rec.ts || Date.now()),
        contextLabel: rec.contextLabel ?? null,
        lang: rec.lang ?? null,
        urgent: rec.urgent ?? null
      };
    }

    /* ===== Data ===== */
    async function fetchAll(limit=8000){
      const res = await fetch(`${API}?limit=${encodeURIComponent(limit)}`, { cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const items = Array.isArray(json?.items) ? json.items : [];
      return items.map(normalize).sort(byTsDesc);
    }

    function saveSnapshot(items){ try{ localStorage.setItem('stats_snapshot', JSON.stringify(items.slice(0,500))); }catch{} }
    function loadSnapshot(){ try{ return JSON.parse(localStorage.getItem('stats_snapshot')||'[]'); }catch{ return []; } }

    /* ===== Render ===== */
    function render(items){
      const total   = items.length;
      const tickets = items.filter(x=>x.event==='ticket_submitted').length;
      const visits  = items.filter(x=>x.event==='visit').length;
      const done    = items.filter(x=>x.event==='scenario_done').length;

      $('#kpi-total').textContent   = total.toLocaleString('nl-BE');
      $('#kpi-tickets').textContent = tickets.toLocaleString('nl-BE');
      $('#kpi-visits').textContent  = visits.toLocaleString('nl-BE');
      $('#kpi-done').textContent    = done.toLocaleString('nl-BE');

      const ul = $('#events'); ul.innerHTML='';
      items.slice(0,50).forEach(x=>{
        const li=document.createElement('li');
        const left = document.createElement('div');
        left.innerHTML = `<span class="evt">${x.event}</span> Â· <span class="ctx">${x.contextLabel ?? '-'}</span>`;
        const right = document.createElement('div');
        right.className='ts';
        right.textContent = new Date(x.ts).toLocaleString('nl-BE');
        li.append(left,right);
        ul.appendChild(li);
      });
    }

    /* ===== Healthcheck (Edge Function /api/health indien aanwezig) ===== */
    async function pingHealth(){
      try{
        // De health-check is een lokaal /api/health endpoint. Als dit niet werkt op de host van de gebruiker, geven we een neutraal antwoord.
        // Omdat ik het lokaal pad niet kan wijzigen naar een extern adres zonder een extern health-check endpoint te kennen,
        // gebruik ik hier een try-catch om het dashboard niet te breken.
        const r = await fetch('/api/health',{cache:'no-store'});
        $('#health').textContent = r.ok ? 'ðŸŸ¢' : 'ðŸŸ ';
      }catch{ $('#health').textContent = 'ðŸ”´'; }
    }

    /* ===== Orchestratie ===== */
    async function refreshStats(){
      $('#status').textContent = 'â³ laden...';
      try{
        const items = await fetchAll(4000); // demo: iets lager voor snelheid
        saveSnapshot(items);
        render(items);
        $('#status').textContent = 'âœ… live';
      }catch(e){
        console.error(e);
        const snap = loadSnapshot();
        if(snap.length){
          render(snap);
          $('#status').textContent = 'ðŸŸ  offline â€“ snapshot';
        }else{
          $('#status').textContent = 'ðŸ”´ geen data';
        }
      }
    }

    async function resetCounter(){
      $('#status').textContent = 'â³ reset...';
      try{
        // Deze POST stuurt een reset event naar de log-API.
        const r = await fetch(API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ event:'statsgame_reset', ts: Date.now() })
        });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        await refreshStats();
      }catch(e){
        console.error(e);
        $('#status').textContent = 'âš ï¸ reset mislukt';
      }
    }

    /* ===== Init ===== */
    document.addEventListener('DOMContentLoaded', () => {
      $('#ep').textContent = API;
      console.debug('Statsgame API endpoint:', API);
      $('#btn-refresh').addEventListener('click', refreshStats);
      $('#btn-reset').addEventListener('click', resetCounter);
      pingHealth();
      refreshStats();
      setInterval(refreshStats, 5000);
      setInterval(pingHealth, 10000);
    });
  </script>
</body>
</html>