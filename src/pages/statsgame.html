<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Statsgame – robuuste versie (zonder sorteren)</title>
  <!-- lege favicon om 404 te vermijden -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    :root{
      --bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--accent:#ee7e00;
      --ok:#0ea5e9;--err:#ef4444;--ok2:#16a34a
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;z-index:10}
    h1{margin:0;font-size:18px}
    .wrap{max-width:940px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 4px}
    input[type="date"]{padding:8px 10px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    button{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    button:disabled{opacity:.6;cursor:not-allowed}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e2e8f0;color:#0f172a;font-size:12px}
    .status{margin:10px 0 0;color:var(--muted);font-size:13px}
    .status.ok{color:var(--ok2)} .status.err{color:var(--err)}
    .cards{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));margin-top:14px}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.06),0 8px 24px -16px rgba(0,0,0,.25)}
    .title{font-weight:700;margin-bottom:6px}
    .muted{color:var(--muted)}
    .kv{display:flex;justify-content:space-between;margin:4px 0}
    .kv b{font-variant-numeric:tabular-nums}
    .loglist{margin-top:8px;border-top:1px dashed #e5e7eb;padding-top:8px;max-height:360px;overflow:auto}
    .logitem{display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #f1f5f9}
    .pill{font-size:11px;border-radius:999px;padding:2px 8px;background:#f1f5f9}
    .okdot{width:8px;height:8px;border-radius:999px;background:var(--ok2)}
    .seprow{height:1px;background:#e5e7eb;margin:10px 0}
    .foot{margin-top:18px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>🎯 Statsgame</h1>
  </header>

  <main class="wrap">
    <section class="row">
      <div>
        <label for="from">Van</label>
        <input id="from" type="date" />
      </div>
      <div>
        <label for="to">Tot</label>
        <input id="to" type="date" />
      </div>
      <div class="row" style="gap:8px">
        <button id="btnLoad">Vernieuwen</button>
        <button id="btnReset" class="secondary">Reset teller</button>
        <label class="badge"><input type="checkbox" id="chkAuto" /> auto-refresh (30s)</label>
      </div>
    </section>

    <div id="status" class="status">Klaar.</div>

    <section class="cards" id="cards"></section>

    <div class="foot">
      Geen sortering: we tonen in de volgorde waarin de server levert.  
      Health check? Vraag je function met <code>?view=keys&debug=1</code>.
    </div>
  </main>

  <script type="module">
    // ======== CONFIG =========
    const API = '/.netlify/functions/logs';   // proxy –> geen CORS
    const TIMEOUT = 8000;                     // ms
    const AUTO_MS = 30000;                    // auto-refresh interval
    const MAX_RENDER = 600;                   // safety cap voor lijst

    // ======== ELEMENTS =======
    const $ = (s)=>document.querySelector(s);
    const elFrom = $('#from'), elTo = $('#to');
    const elBtnLoad = $('#btnLoad'), elBtnReset = $('#btnReset');
    const elStatus = $('#status'), elCards = $('#cards');
    const elAuto = $('#chkAuto');

    // ======== INIT ===========
    setDefaultRange(7);
    elBtnLoad.addEventListener('click', refreshStats);
    elBtnReset.addEventListener('click', postReset);
    elAuto.addEventListener('change', toggleAuto);
    let autoTimer = null;
    refreshStats();

    // ======== HELPERS =========
    function setDefaultRange(daysBack=7){
      const today = new Date();
      const from  = new Date(today.getTime() - daysBack*86400000);
      elFrom.value = toISO(today, -daysBack);
      elTo.value   = toISO(today, 0);
    }
    function toISO(baseDate, offsetDays=0){
      const d = new Date(baseDate.getTime() + offsetDays*86400000);
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function status(msg, cls=''){ elStatus.textContent = msg; elStatus.className = 'status '+cls; }
    function uniq(arr){ return [...new Set(arr)]; }
    function safeNum(n){ return Number.isFinite(+n) ? +n : 0; }

    function toLocalDateISO(ts, tz='Europe/Brussels'){
      try {
        return new Intl.DateTimeFormat('en-CA',{
          timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'
        }).format(new Date(Number(ts)));
      } catch { return null; }
    }

    // Normaliseer inkomend record naar uniform object
    function normalize(x){
      const t = Number(x?.server_ts ?? x?.ts ?? NaN);
      return {
        t, day: Number.isFinite(t) ? toLocalDateISO(t) : null,
        event: String(x?.event ?? 'event'),
        urgent: !!x?.urgent,
        photo: !!x?.photo,
        desc_len: safeNum(x?.desc_len),
        visitor_id: x?.visitor_id ?? null,
        session_id: x?.session_id ?? null,
        user_id: x?.user_id ?? null,
        contextLabel: x?.contextLabel ?? null
      };
    }

    async function fetchLogs(limit=8000){
      const url = new URL(API, location.origin);
      url.searchParams.set('limit', String(limit));
      url.searchParams.set('from', elFrom.value.slice(0,10));
      url.searchParams.set('to',   elTo.value.slice(0,10));

      const ctrl = new AbortController();
      const tm = setTimeout(()=>ctrl.abort(), TIMEOUT);

      try{
        const res = await fetch(url.toString(), {
          method: 'GET',
          headers: { 'Accept':'application/json' },
          cache: 'no-store',
          signal: ctrl.signal
        });
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status} ${res.statusText} — ${txt.slice(0,160)}`);
        }
        const json = await res.json().catch(()=> ({}));
        const raw  = Array.isArray(json) ? json
                   : Array.isArray(json.items) ? json.items
                   : [];
        return raw.map(normalize);
      } finally {
        clearTimeout(tm);
      }
    }

    async function postReset(){
      elBtnReset.disabled = true;
      status('Reset aan het posten…', '');
      try{
        const body = {
          event: 'reset',
          ts: Date.now(),
          contextLabel: 'statsgame'
        };
        const ctrl = new AbortController();
        const tm = setTimeout(()=>ctrl.abort(), TIMEOUT);

        const url = new URL(API, location.origin);
        const res = await fetch(url.toString(), {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(body),
          signal: ctrl.signal
        });
        clearTimeout(tm);
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status} ${res.statusText} — ${txt.slice(0,160)}`);
        }
        status('Reset geregistreerd ✅  (even verversen)', 'ok');
        await refreshStats();
      } catch(e){
        console.error(e);
        status('Reset mislukt: '+(e?.message||e), 'err');
      } finally {
        elBtnReset.disabled = false;
      }
    }

    function latestResetTs(items){
      let max=0;
      for(const e of items){
        if ((e.event === 'reset' || e.event === 'stats_reset') && Number.isFinite(e.t)) {
          if (e.t > max) max = e.t;
        }
      }
      return max; // 0 = geen anchor
    }

    function filterSince(items, sinceTs){
      if(!sinceTs) return items;
      const out=[];
      for(const e of items){
        if (!Number.isFinite(e.t)) continue;
        if (e.t >= sinceTs) out.push(e);
      }
      return out;
    }

    function computeMetrics(items){
      const m = {
        total: 0,
        urgent: 0,
        photo: 0,
        byEvent: Object.create(null),
        uniqueVisitors: 0,
        uniqueSessions: 0,
        days: new Map() // day -> { total, urgent, photo, byEvent:{} }
      };
      const vs = new Set(), ss = new Set();

      for(const e of items){
        m.total++;
        if (e.urgent) m.urgent++;
        if (e.photo)  m.photo++;
        if (e.visitor_id) vs.add(e.visitor_id);
        if (e.session_id) ss.add(e.session_id);

        m.byEvent[e.event] = (m.byEvent[e.event] || 0) + 1;

        // per dag (géén sorting; we gebruiken insertion order van Map)
        if (e.day){
          if (!m.days.has(e.day)) m.days.set(e.day, { day:e.day, total:0, urgent:0, photo:0, byEvent:{} });
          const d = m.days.get(e.day);
          d.total++; if (e.urgent) d.urgent++; if (e.photo) d.photo++;
          d.byEvent[e.event] = (d.byEvent[e.event] || 0) + 1;
        }
      }
      m.uniqueVisitors = vs.size;
      m.uniqueSessions = ss.size;
      return m;
    }

    function render(metrics, sinceTs, sampleItems){
      elCards.innerHTML = '';

      // Kaart 1: Overzicht
      const k1 = card('Totaal sinds reset');
      k1.append(kv('Totaal events', metrics.total));
      k1.append(kv('Urgent', metrics.urgent));
      k1.append(kv('Met foto', metrics.photo));
      k1.append(kv('Unieke bezoekers', metrics.uniqueVisitors));
      k1.append(kv('Sessions', metrics.uniqueSessions));
      k1.append(sep());
      k1.append(kv('Reset anchor', sinceTs ? new Date(sinceTs).toLocaleString('nl-BE') : 'geen'));
      elCards.append(k1);

      // Kaart 2: Per dag (in aangeleverde volgorde)
      const k2 = card('Per dag (zonder sorteren)');
      const listDays = document.createElement('div');
      listDays.className = 'loglist';
      let i=0;
      for (const d of metrics.days.values()){
        if (i++ > 60) { listDays.append(row('…', 'cap bereikt')); break; }
        listDays.append(row(`📅 ${d.day}`, `${d.total}`));
      }
      k2.append(listDays);
      elCards.append(k2);

      // Kaart 3: Per eventtype (geen sort)
      const k3 = card('Per eventtype');
      const byEvt = document.createElement('div'); byEvt.className = 'loglist';
      let c=0;
      for (const k in metrics.byEvent){
        if (!Object.hasOwn(metrics.byEvent, k)) continue;
        byEvt.append(row(k, String(metrics.byEvent[k])));
        if (++c > 60) { byEvt.append(row('…','cap bereikt')); break; }
      }
      k3.append(byEvt);
      elCards.append(k3);

      // Kaart 4: Laatste items (zoals ontvangen, geen sort)
      const k4 = card('Laatste items (servervolgorde)');
      const lst = document.createElement('div'); lst.className = 'loglist';
      const N = Math.min(sampleItems.length, MAX_RENDER);
      for (let i=0;i<N;i++){
        const e = sampleItems[i];
        lst.append(logRow(e));
      }
      k4.append(lst);
      elCards.append(k4);
    }

    function logRow(e){
      const d = document.createElement('div'); d.className = 'logitem';
      const dot = document.createElement('div'); dot.className = 'okdot';
      const when = new Date(e.t||Date.now()).toLocaleString('nl-BE');
      const pill = document.createElement('span'); pill.className='pill'; pill.textContent = e.event;
      const rest = document.createElement('div'); rest.className='muted';
      rest.textContent = `${when} — ${e.day ?? '-'}`;
      d.append(dot, pill, rest);
      return d;
    }
    function card(title){
      const c = document.createElement('div'); c.className = 'card';
      const t = document.createElement('div'); t.className = 'title'; t.textContent = title;
      c.append(t);
      return c;
    }
    function kv(a,b){
      const r = document.createElement('div'); r.className = 'kv';
      const l = document.createElement('span'); l.textContent = a;
      const v = document.createElement('b'); v.textContent = String(b);
      r.append(l,v); return r;
    }
    function sep(){ const s=document.createElement('div'); s.className='seprow'; return s; }

    async function refreshStats(){
      const from = elFrom.value?.slice(0,10);
      const to   = elTo.value?.slice(0,10);
      if (!from || !to) { status('Kies een geldige datumrange.', 'err'); return; }

      elBtnLoad.disabled = true;
      status('Data laden… ⏳', '');
      try{
        const items = await fetchLogs(8000); // in servervolgorde
        if (!items || !items.length) {
          elCards.innerHTML = '';
          status('Geen data in dit bereik.', 'ok'); return;
        }
        const anchor = latestResetTs(items);
        const windowed = filterSince(items, anchor);
        const metrics = computeMetrics(windowed);
        render(metrics, anchor, windowed);
        status(`OK — ${windowed.length} events sinds reset`, 'ok');
      } catch(e){
        console.error(e);
        elCards.innerHTML = '';
        status(`Fout bij laden: ${e?.message||e}`, 'err');
      } finally {
        elBtnLoad.disabled = false;
      }
    }

    function toggleAuto(){
      if (elAuto.checked){
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(refreshStats, AUTO_MS);
      } else {
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = null;
      }
    }
  </script>
</body>
</html>
