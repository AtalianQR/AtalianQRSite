<!DOCTYPE html>
<html lang="nl">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <title>StatsPortal â€” Vandaag (top 50) + duidelijke ID</title>
Â  <style>
Â  Â  :root{ --bg:#0f1115; --card:#151923; --muted:#8b93a7; --text:#e7ecf2; --br:#23293a; --chip:#2a3142; --accent:#6ea8fe; }
Â  Â  *{box-sizing:border-box}
Â  Â  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
Â  Â  header{padding:16px 18px 0 18px}
Â  Â  h1{margin:0 0 8px;font-size:18px;display:flex;gap:8px;align-items:center}
Â  Â  h1 small{font-size:12px;color:var(--muted);font-weight:400}
Â  Â  .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:var(--card);border:1px solid var(--br);padding:10px 12px;border-radius:12px}
Â  Â  .bar input[type="text"], .bar input[type="number"]{background:#0f1422;color:var(--text);border:1px solid var(--br);border-radius:8px;padding:6px 8px}
Â  Â  .btn{border:1px solid var(--br);background:#0f1422;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
Â  Â  .btn:hover{border-color:#3a4260}
Â  Â  .wrap{padding:0 18px 18px;display:grid;grid-template-columns:1fr 360px;gap:12px}
Â  Â  @media (max-width: 1000px){ .wrap{grid-template-columns:1fr} }
Â  Â  .panel{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:12px}
Â  Â  .status{margin-top:8px;padding:10px 12px;border-radius:10px;background:#0f1422;border:1px solid var(--br);color:var(--muted)}
Â  Â  .status.ok{color:#c7f5d9;border-color:#1e3b2b;background:#0d1a14}
Â  Â  .status.warn{color:#ffe8c7;border-color:#5a3b14;background:#1a130a}
Â  Â  .status.err{color:#ffd3d0;border-color:#5a1714;background:#1a0d0c}
Â  Â  .day{margin:10px 0 18px;border:1px solid var(--br);border-radius:12px;overflow:hidden}
Â  Â  .day>header{background:#101625;border-bottom:1px solid var(--br);padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
Â  Â  .day>header h3{margin:0;font-size:14px;font-weight:600}
Â  Â  .day ul{list-style:none;margin:0;padding:0}
Â  Â  .day li{display:grid;grid-template-columns:80px 1fr auto;gap:10px;align-items:center;padding:10px 12px;border-top:1px solid var(--br)}
Â  Â  .day li:first-child{border-top:0}
Â  Â  code.time{font-family:ui-monospace,Consolas,monospace;font-size:12px;color:#c1c9da;background:#0b0f19;border:1px solid var(--br);padding:2px 6px;border-radius:6px;min-width:60px;text-align:center}
Â  Â  .chip{padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid var(--br);background:var(--chip);color:#dbe4ff}
Â  Â  .chip.env-prod{background:#0f2016;border-color:#18492a;color:#bff2d1}
Â  Â  .chip.env-test{background:#241d10;border-color:#6b4d15;color:#ffe5b5}
Â  Â  .chip.env-unknown{background:#201626;border-color:#5c325d;color:#f3c9ff}
Â  Â  .chip.kind-space{background:#0e1a2b;border-color:#1d3557;color:#a7c4ff}
Â  Â  .chip.kind-eq{background:#1a0f16;border-color:#5d234a;color:#f7bfe3}
Â  Â  .idbadge{font-family:ui-monospace,Consolas,monospace;background:#0b0f19;border:1px solid var(--br);padding:2px 8px;border-radius:8px;color:#dfe6f3}
Â  Â  .idwrap{display:flex;gap:8px;align-items:center;justify-content:flex-end}
Â  Â  .list-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
Â  Â  .muted{color:#9aa3b8}
Â  Â  .kv{font-size:12px;color:#b7bfd2;display:flex;justify-content:space-between;border-bottom:1px dashed #2a334a;padding:6px 0}
Â  </style>
</head>
<body>
<header>
Â  <h1>ðŸ“Š StatsPortal <small>Vandaag (top 50) + duidelijke ID</small></h1>
Â  <div class="bar">
Â  Â  <label>Logs API:
Â  Â  Â  <input type="text" id="api" size="48" value="https://atalian-logs.atalianqr.workers.dev/api/log">
Â  Â  </label>
Â  Â  <label>Max events (vandaag): <input type="number" id="limit" value="50" min="10" step="10"></label>
Â  Â  <button class="btn" id="btnLoad">Laden</button>
Â  Â  <button class="btn" id="btnCsv">CSV</button>
Â  Â  <span style="flex:1"></span>
Â  Â  <label style="display:flex;gap:8px;align-items:center">Env:
Â  Â  Â  <label><input type="checkbox" id="envProd" checked> prod</label>
Â  Â  Â  <label><input type="checkbox" id="envTest" checked> test</label>
Â  Â  Â  <label><input type="checkbox" id="envUnknown" checked> onbekend</label>
Â  Â  </label>
Â  Â  <label>Zoek: <input type="text" id="q" placeholder="type, id6, id13, urlâ€¦"></label>
Â  </div>
Â  <div id="status" class="status">Klaar.</div>
</header>

<div class="wrap">
Â  <main class="panel" id="list"></main>
Â  <aside class="panel">
Â  Â  <h3>ðŸ“Œ Samenvatting</h3>
Â  Â  <div class="kv"><span>Totaal getoond</span><b id="mTotal">0</b></div>
Â  Â  <div class="kv"><span>prod</span><b id="mProd">0</b></div>
Â  Â  <div class="kv"><span>test</span><b id="mTest">0</b></div>
Â  Â  <div class="kv"><span>onbekend</span><b id="mUnknown">0</b></div>
Â  Â  <hr style="border:none;border-top:1px solid var(--br);margin:10px 0">
Â  Â  <div class="kv"><span>Equipment</span><b id="mEq">0</b></div>
Â  Â  <div class="kv"><span>Space</span><b id="mSp">0</b></div>
Â  Â  <div class="kv"><span>Unknown target</span><b id="mTk">0</b></div>
Â  Â  <hr style="border:none;border-top:1px solid var(--br);margin:10px 0">
Â  Â  <div class="kv"><span>Dagfilter</span><b id="mDay">vandaag</b></div>
Â  Â  <div class="kv"><span>Laatst geladen</span><b id="mLoaded">â€”</b></div>
Â  </aside>
</div>

<script>
const TZ = 'Europe/Brussels';
const PROD_HOSTS = new Set(['atalianqrportal.netlify.app','atalianqr.workers.dev','atalian-logs.atalianqr.workers.dev','atalian.ultimo.net']);
const TEST_HOSTS = new Set(['atalianqrportal--test.netlify.app','atalianqrportal-test.netlify.app','atalianqr-test.workers.dev','test.ultimo.net','preprod.ultimo.net']);
const $ = s => document.querySelector(s);
function setStatus(m,k=''){ const el=$('#status'); el.textContent=m; el.className='status '+(k||''); }
function toLocalDayKey(ts){ const d=new Date(Number(ts)); const y=d.toLocaleDateString('nl-BE',{timeZone:TZ,year:'numeric'}); const m=d.toLocaleDateString('nl-BE',{timeZone:TZ,month:'2-digit'}); const da=d.toLocaleDateString('nl-BE',{timeZone:TZ,day:'2-digit'}); return `${y}-${m}-${da}`; }
function todayKey(){ return toLocalDayKey(Date.now()); }
function fmtTime(ts){ return new Intl.DateTimeFormat('nl-BE',{timeZone:TZ,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date(Number(ts))); }

// 13â†’6 decode: neem posities 0,2,4,6,8,10
function decode13to6(code13){
Â  const s=String(code13);
Â  if(!/^\d{13}$/.test(s)) return '';
Â  return s[0]+s[2]+s[4]+s[6]+s[8]+s[10];
}

// env: eerst expliciet veld, dan host-heuristiek
function readEnv(ev){
Â  const direct=(ev.env||ev.environment||'').toString().toLowerCase();
Â  if (direct==='prod'||direct==='production') return 'prod';
Â  if (direct==='test'||direct==='accept'||direct==='acc') return 'test';
Â  const urlish=ev.href||ev.url||ev.location||ev.referrer||ev.origin||'';
Â  let host=''; try{ host=new URL(urlish).host.toLowerCase(); }catch(_){ host=(ev.host||ev.domain||'').toLowerCase(); }
Â  if (PROD_HOSTS.has(host)) return 'prod';
Â  if (TEST_HOSTS.has(host)) return 'test';
Â  return 'unknown';
}

// Haal id/soort uit meerdere velden + querystring + 13-cijferregel
function extractIdentity(ev){
Â  const fields = [ev.id, ev.code, ev.eq_id, ev.spc_id, ev.equipmentId, ev.spaceId, ev._id].filter(Boolean).map(String);
Â  let urlId=''; let urlType='';
Â  try{
Â  Â  const u=new URL(ev.url||ev.location||'https://x.invalid');
Â  Â  urlId = u.searchParams.get('id') || '';
Â  Â  urlType = (u.searchParams.get('type')||u.searchParams.get('t')||'').toLowerCase();
Â  }catch(_){}

Â  // voorkeur: 13-cijferige code
Â  const hit13 = fields.find(v=>/^\d{13}$/.test(v)) || (urlId && /^\d{13}$/.test(urlId) ? urlId : '');
Â  if (hit13){
Â  Â  const id6 = decode13to6(hit13);
Â  Â  const last = hit13.slice(-1);
Â  Â  const kind = last==='9' ? 'equipment' : (last==='0' ? 'space' : 'unknown');
Â  Â  return { kind, id6, id13: hit13 };
Â  }

Â  // anders: 6-cijferig id ergens
Â  const hit6 = fields.find(v=>/^\d{6}$/.test(v)) || (urlId && /^\d{6}$/.test(urlId) ? urlId : '');
Â  if (hit6){
Â  Â  // soort proberen af te leiden via type/url/veldnamen
Â  Â  let kind = 'unknown';
Â  Â  const t = String(ev.type||'').toLowerCase();
Â  Â  if (/(equip|eq)/.test(t) || /equipment/i.test(JSON.stringify(ev))) kind='equipment';
Â  Â  if (/(space|sp)/.test(t)Â  Â || /space/i.test(JSON.stringify(ev)))Â  Â  Â kind='space';
Â  Â  if (urlType==='eq'||urlType==='equipment') kind='equipment';
Â  Â  if (urlType==='sp'||urlType==='space') kind='space';
Â  Â  return { kind, id6: hit6, id13: '' };
Â  }

Â  // fallback: we tonen wat we hebben
Â  const raw = fields[0] || urlId || '';
Â  let kind = 'unknown';
Â  const t = String(ev.type||'').toLowerCase();
Â  if (/(equip|eq)/.test(t)) kind='equipment';
Â  if (/(space|sp)/.test(t)) kind='space';
Â  if (!kind || kind==='unknown'){
Â  Â  // heuristiek op veldnaam
Â  Â  if ('equipmentId' in ev || 'eq_id' in ev) kind='equipment';
Â  Â  if ('spaceId' in ev || 'spc_id' in ev) kind='space';
Â  }
Â  return { kind, id6: '', id13: raw };
}

function applySearch(items, q){
Â  const s=q.trim().toLowerCase(); if(!s) return items;
Â  return items.filter(e=>{
Â  Â  const hay=[e.type||e.event||'', e.__env||'', e.__kind||'', e.__id6||'', e.__id13||'', e.url||e.location||''].join(' ').toLowerCase();
Â  Â  return hay.includes(s);
Â  });
}

function renderList(dayKey, arr){
Â  const root=$('#list'); root.innerHTML='';
Â  const box=document.createElement('section'); box.className='day';
Â  const hd=document.createElement('header');
Â  const h3=document.createElement('h3'); h3.textContent=`${dayKey} â€” meest recent 50`;
Â  const sub=document.createElement('div'); sub.className='muted'; sub.textContent=`${arr.length} events getoond`;
Â  hd.appendChild(h3); hd.appendChild(sub); box.appendChild(hd);
Â  const ul=document.createElement('ul');

Â  let cTotal=0,cProd=0,cTest=0,cUnk=0,cEq=0,cSp=0,cTk=0;

Â  for (const e of arr){
Â  Â  const li=document.createElement('li');
Â  Â  const time=document.createElement('code'); time.className='time'; time.textContent=fmtTime(e.__ts);
Â  Â  const meta=document.createElement('div'); meta.className='list-meta';
Â  Â  const env=document.createElement('span'); env.className='chip env-'+e.__env; env.textContent=e.__env;
Â  Â  const kind=document.createElement('span'); kind.className='chip '+(e.__kind==='equipment'?'kind-eq':(e.__kind==='space'?'kind-space':'env-unknown')); kind.textContent=e.__kind;
Â  Â  const type=document.createElement('span'); type.textContent=e.type||e.event||'event';
Â  Â  meta.appendChild(type); meta.appendChild(env); meta.appendChild(kind);

Â  Â  const idwrap=document.createElement('div'); idwrap.className='idwrap';
Â  Â  if (e.__id6){ const b=document.createElement('span'); b.className='idbadge'; b.title='ID (6)'; b.textContent=e.__id6; idwrap.appendChild(b); }
Â  Â  if (e.__id13){ const s=document.createElement('span'); s.className='muted'; s.title='Code (13)'; s.textContent=e.__id13; idwrap.appendChild(s); }

Â  Â  li.appendChild(time);
Â  Â  li.appendChild(meta);
Â  Â  li.appendChild(idwrap);
Â  Â  ul.appendChild(li);

Â  Â  cTotal++; if (e.__env==='prod') cProd++; else if (e.__env==='test') cTest++; else cUnk++;
Â  Â  if (e.__kind==='equipment') cEq++; else if (e.__kind==='space') cSp++; else cTk++;
Â  }
Â  box.appendChild(ul); root.appendChild(box);

Â  $('#mTotal').textContent=cTotal; $('#mProd').textContent=cProd; $('#mTest').textContent=cTest; $('#mUnknown').textContent=cUnk;
Â  $('#mEq').textContent=cEq; $('#mSp').textContent=cSp; $('#mTk').textContent=cTk;
Â  $('#mLoaded').textContent=new Date().toLocaleString('nl-BE',{timeZone:TZ});
Â  $('#mDay').textContent='vandaag';
}

async function fetchEvents(url, limitHint){
Â  const u=new URL(url);
Â  if (!u.searchParams.has('limit')) u.searchParams.set('limit', String(Math.max(200, limitHint*3)));
Â  const r=await fetch(u.toString(),{headers:{accept:'application/json'},cache:'no-store'});
Â  if (!r.ok) throw new Error(`HTTP ${r.status}`);
Â  const data=await r.json();
Â  return Array.isArray(data)?data:(data.items||data.logs||data.results||Object.values(data));
}

async function loadAll(){
Â  const api=$('#api').value.trim();
Â  const lim=Number($('#limit').value)||50;
Â  const fProd=$('#envProd').checked, fTest=$('#envTest').checked, fUnk=$('#envUnknown').checked;
Â  const q=$('#q').value||'';
Â  setStatus('Ladenâ€¦');

Â  let raw=[];
Â  try{ raw=await fetchEvents(api, lim); }
Â  catch(e){ setStatus('Fout bij laden: '+e.message, 'err'); return; }

Â  const tKey=todayKey();
Â  const rows=[];
Â  for (const ev of raw){
Â  Â  const ts=Number(ev.server_ts ?? ev.ts ?? ev.time ?? ev.timestamp ?? ev.createdAt ?? ev.date);
Â  Â  if (!Number.isFinite(ts)) continue;
Â  Â  if (toLocalDayKey(ts)!==tKey) continue; // enkel vandaag
Â  Â  const env=readEnv(ev);
Â  Â  const {kind,id6,id13}=extractIdentity(ev);
Â  Â  rows.push({...ev, __ts:ts, __env:env, __kind:kind, __id6:id6||'', __id13:id13||''});
Â  }

Â  // env filter
Â  let filtered = rows.filter(e => (e.__env==='prod'&&fProd)||(e.__env==='test'&&fTest)||(e.__env==='unknown'&&fUnk));

Â  // zoekfilter
Â  filtered = applySearch(filtered, q);

Â  // Sorteer meest recent eerst en beperk tot 50
Â  filtered.sort((a,b)=> b.__ts - a.__ts);
Â  const top = filtered.slice(0, lim);

Â  if (!top.length){ setStatus('Geen events voor vandaag die aan de filters voldoen.', 'warn'); $('#list').innerHTML=''; return; }

Â  renderList(tKey, top);
Â  setStatus(`OK â€” ${top.length} meest recente events voor vandaag.`, 'ok');
}

function exportCsv(){
Â  const rows=[['day','time','env','kind','id6','id13','type']];
Â  const dayKey=document.querySelector('.day>header h3')?.textContent?.split(' â€” ')[0]||'';
Â  document.querySelectorAll('.day li').forEach(li=>{
Â  Â  const time=li.querySelector('code.time')?.textContent||'';
Â  Â  const chips=li.querySelectorAll('.chip');
Â  Â  const env=chips[0]?.textContent||'';
Â  Â  const kind=chips[1]?.textContent||'';
Â  Â  const id6=li.querySelector('.idbadge')?.textContent||'';
Â  Â  const id13=Array.from(li.querySelectorAll('.idwrap .muted')).find(s=>/^\d{13}$/.test(s.textContent||''))?.textContent||'';
Â  Â  const type=li.querySelector('.list-meta span')?.textContent||'';
Â  Â  rows.push([dayKey,time,env,kind,id6,id13,type]);
Â  });
Â  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\r\n');
Â  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
Â  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='events_today_top50.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

document.getElementById('btnLoad').addEventListener('click', loadAll);
document.getElementById('btnCsv').addEventListener('click', exportCsv);
document.getElementById('envProd').addEventListener('change', loadAll);
document.getElementById('envTest').addEventListener('change', loadAll);
document.getElementById('envUnknown').addEventListener('change', loadAll);
document.getElementById('q').addEventListener('input', ()=>{ clearTimeout(window.__q_t); window.__q_t=setTimeout(loadAll,250); });
window.addEventListener('DOMContentLoaded', loadAll);
</script>
</body>
</html>