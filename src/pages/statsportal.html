<!DOCTYPE html>
<html lang="nl">
<head>
Â  <meta charset="utf-8" />
Â  <title>Statsportal â€“ Portal Telemetry</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <style>
Â  Â  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px;color:#222}
Â  Â  h1{margin:0 0 12px}
Â  Â  .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
Â  Â  input[type="date"]{padding:6px 8px}
Â  Â  button{padding:8px 12px;border:0;border-radius:8px;background:#0b5fff;color:#fff;cursor:pointer}
Â  Â  button:disabled{opacity:.6;cursor:not-allowed}
Â  Â  #status{margin:6px 0 16px;font-size:14px;color:#444;word-break:break-all}
Â  Â  #status.error{color:#b00020}
Â  Â  #status.warn{color:#995c00}
Â  Â  .day-card{background:#fff;border:1px solid #e6e8f0;border-radius:12px;margin:10px 0;padding:12px}
Â  Â  .day-card h3{margin:0 0 8px}
Â  Â  ul.evlist{list-style:none;padding-left:0;margin:0}
Â  Â  ul.evlist li{padding:6px 0;border-top:1px solid #f0f1f6}
Â  Â  ul.evlist li:first-child{border-top:0}
Â  Â  code{background:#f0f2f8;border-radius:6px;padding:2px 6px}
Â  Â  small.muted{color:#666}
Â  </style>
</head>
<body>

Â  <h1>Statsportal <small class="muted" id="build"></small></h1>

Â  <div class="bar">
Â  Â  <label>Van: <input id="from" type="date"></label>
Â  Â  <label>Tot: <input id="to" type="date"></label>
Â  Â  <button id="btnLoad">Laden</button>
Â  </div>

Â  <div id="status"></div>
Â  <div id="results"></div>

Â  <script>
Â  /* ====== CONFIG ====== */
Â  // âœï¸ Pas aan indien je worker-URL anders is:
Â  const API_BASE = 'https://atalian-logs.atalianqr.workers.dev/api/log';
Â  const TZ = 'Europe/Brussels';
Â  const VIEW = 'raw'; // of 'summary' als je worker dat ondersteunt

Â  document.getElementById('build').textContent =
Â  Â  `(build @ ${new Date().toLocaleString('nl-BE', { timeZone: TZ })})`;

Â  /* ====== utils ====== */
Â  const fmtDay = new Intl.DateTimeFormat('nl-BE', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' });
Â  const fmtTime = new Intl.DateTimeFormat('nl-BE', { timeZone: TZ, hour:'2-digit', minute:'2-digit', second:'2-digit' });

Â  function toLocalDayKey(tsMs){ return fmtDay.format(new Date(tsMs)); }

Â  function setStatus(msg, type='info'){
Â  Â  const el = document.getElementById('status');
Â  Â  el.textContent = msg;
Â  Â  el.className = type;
Â  }

Â  function renderDays(dayEntries){
Â  Â  const host = document.getElementById('results');
Â  Â  host.innerHTML = '';
Â  Â  if (!dayEntries.length) return;

Â  Â  for (const [day, events] of dayEntries){
Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  card.className = 'day-card';

Â  Â  Â  const h = document.createElement('h3');
Â  Â  Â  h.textContent = `${day}Â  (${events.length})`;
Â  Â  Â  card.appendChild(h);

Â  Â  Â  const ul = document.createElement('ul');
Â  Â  Â  ul.className = 'evlist';

Â  Â  Â  for (const e of events){
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  const ts = Number(e.server_ts ?? e.ts ?? e.time ?? e.timestamp);
Â  Â  Â  Â  const time = isFinite(ts) ? fmtTime.format(new Date(ts)) : 'â€”';
Â  Â  Â  Â  const typ = e.type || e.event || 'event';
Â  Â  Â  Â  const idÂ  = e.id ?? e.code ?? '';
Â  Â  Â  Â  li.innerHTML = `<code>${time}</code> â€” <b>${typ}</b> ${id ? 'â€” '+id : ''}`;
Â  Â  Â  Â  ul.appendChild(li);
Â  Â  Â  }

Â  Â  Â  card.appendChild(ul);
Â  Â  Â  host.appendChild(card);
Â  Â  }
Â  }

Â  /* ====== kern ====== */
Â  async function loadAll(){
Â  Â  const elFrom = document.getElementById('from');
Â  Â  const elToÂ  Â = document.getElementById('to');
Â  Â  const elBtnÂ  = document.getElementById('btnLoad');

Â  Â  const from = elFrom.value?.slice(0,10);
Â  Â  const toÂ  Â = elTo.value?.slice(0,10);
Â  Â  if (!from || !to){ setStatus('Kies een geldige datumrange.','error'); return; }

Â  Â  // garandeer f â‰¤ t
Â  Â  let f = from, t = to;
Â  Â  if (f > t) [f, t] = [t, f];

Â  Â  // Lokale daggrenzen â†’ epoch millis (voorkomt UTC-dagverschuivingen)
Â  Â  const start = new Date(`${f}T00:00:00`);
Â  Â  const endÂ  Â = new Date(`${t}T23:59:59.999`);
Â  Â  const fromTs = start.getTime();
Â  Â  const toTsÂ  Â = end.getTime();

Â  Â  // âœ… Event-filter: matcht portal-telemetry
Â  Â  const portalEvents = [
Â  Â  Â  'url_load',
Â  Â  Â  'step',
Â  Â  Â  'invalid_qr',
Â  Â  Â  'open_jobs_shown',
Â  Â  Â  'existing_list_confirm',
Â  Â  Â  'urgent_answer',
Â  Â  Â  'desc_entered',
Â  Â  Â  'email_entered',
Â  Â  Â  'submit_attempt',
Â  Â  Â  'submit_success',
Â  Â  Â  'submit_error',
Â  Â  Â  'poets_info_viewed',
Â  Â  Â  'language_switch',
Â  Â  Â  'restart',
Â  Â  Â  'external_info',
Â  Â  Â  'idle',
Â  Â  Â  'pagehide'
Â  Â  ].join(',');

Â  Â  const url = new URL(API_BASE);
Â  Â  url.searchParams.set('events', portalEvents);
Â  Â  url.searchParams.set('from', f);Â  Â  Â  Â  Â  Â  Â  Â  // menselijk leesbaar in logs
Â  Â  url.searchParams.set('to', t);
Â  Â  url.searchParams.set('from_ts', String(fromTs)); // eenduidige serverfilter
Â  Â  url.searchParams.set('to_ts', String(toTs));
Â  Â  url.searchParams.set('tz', TZ);
Â  Â  url.searchParams.set('view', VIEW);
Â  Â  url.searchParams.set('limit', '8000');
Â  Â  url.searchParams.set('cb', String(Date.now())); // cache-buster

Â  Â  elBtn.disabled = true;
Â  Â  setStatus(`Ladenâ€¦ â³ ${url.toString()}`);

Â  Â  try{
Â  Â  Â  const r = await fetch(url.toString(), { cache: 'no-store' });
Â  Â  Â  if (!r.ok) throw new Error(`HTTP ${r.status}`);
Â  Â  Â  const payload = await r.json();

Â  Â  Â  const items = Array.isArray(payload) ? payload : (payload.items ?? []);
Â  Â  Â  if (!items.length){
Â  Â  Â  Â  setStatus('Geen events in deze periode.','warn');
Â  Â  Â  Â  renderDays([]);
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // groepeer per dag (lokale TZ)
Â  Â  Â  const byDay = new Map();
Â  Â  Â  for (const ev of items){
Â  Â  Â  Â  const ts = Number(ev.server_ts ?? ev.ts ?? ev.time ?? ev.timestamp);
Â  Â  Â  Â  if (!isFinite(ts)) continue;
Â  Â  Â  Â  const key = toLocalDayKey(ts);
Â  Â  Â  Â  if (!byDay.has(key)) byDay.set(key, []);
Â  Â  Â  Â  byDay.get(key).push(ev);
Â  Â  Â  }

Â  Â  Â  // sort: nieuwste dag eerst
Â  Â  Â  const days = [...byDay.entries()].sort((a,b)=>{
Â  Â  Â  Â  const [da] = a, [db] = b;
Â  Â  Â  Â  const pa = da.split('/').reverse().join(''); // yyyymmdd
Â  Â  Â  Â  const pb = db.split('/').reverse().join('');
Â  Â  Â  Â  return pb.localeCompare(pa);
Â  Â  Â  });

Â  Â  Â  setStatus(`OK â€” ${items.length} events in range ğŸ‘`);
Â  Â  Â  renderDays(days);

Â  Â  } catch (e){
Â  Â  Â  console.error(e);
Â  Â  Â  setStatus(`Fout bij laden: ${String(e.message || e)}`, 'error');
Â  Â  Â  renderDays([]);
Â  Â  } finally {
Â  Â  Â  elBtn.disabled = false;
Â  Â  }
Â  }

Â  // init (today â†’ today)
Â  (function initDates(){
Â  Â  const d = new Date();
Â  Â  const iso = (x)=> x.toISOString().slice(0,10);
Â  Â  document.getElementById('from').value = iso(d);
Â  Â  document.getElementById('to').value = iso(d);
Â  })();

Â  document.getElementById('btnLoad').addEventListener('click', loadAll);

Â  // auto-load bij openen (optioneel)
Â  loadAll();
Â  </script>
</body>
</html>