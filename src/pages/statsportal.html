<script>
/* ====== CONFIG ====== */
const API_BASE = 'https://atalian-logs.atalianqr.workers.dev/api/log'; // jouw worker endpoint
const TZ = 'Europe/Brussels';
const VIEW = 'raw'; // of 'summary' als je worker dit ondersteunt

/* ====== HULP ====== */
const fmtDay = new Intl.DateTimeFormat('nl-BE', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' });
function toLocalDayKey(tsMs) {
  return fmtDay.format(new Date(tsMs)); // bv. 19/10/2025
}
function setStatus(msg, type='info') {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = type;
}

/* ====== LAAD FUNCTIE ====== */
async function loadAll() {
  const elFrom = document.getElementById('from');
  const elTo   = document.getElementById('to');
  const elBtn  = document.getElementById('btnLoad');

  const from = elFrom.value?.slice(0,10);
  const to   = elTo.value?.slice(0,10);
  if (!from || !to) { setStatus('Kies een geldige datumrange.','error'); return; }

  // Zorg dat from ‚â§ to (swap indien nodig)
  let f = from, t = to;
  if (f > t) [f, t] = [t, f];

  // Expliciete daggrenzen in lokale tijd (voorkomt UTC-dagverschuivingen)
  const start = new Date(`${f}T00:00:00`);
  const end   = new Date(`${t}T23:59:59.999`);
  const fromTs = start.getTime();         // epoch millis
  const toTs   = end.getTime();

  // ‚òÖ Event-filter: matcht jouw portal (url_load/step/submit_*/idle/pagehide/‚Ä¶)
  const portalEvents = [
    'url_load',
    'step',
    'invalid_qr',
    'open_jobs_shown',
    'existing_list_confirm',
    'urgent_answer',
    'desc_entered',
    'email_entered',
    'submit_attempt',
    'submit_success',
    'submit_error',
    'poets_info_viewed',
    'language_switch',
    'restart',
    'external_info',
    'idle',
    'pagehide'
  ].join(',');

  const url = new URL(API_BASE);
  url.searchParams.set('events', portalEvents);
  url.searchParams.set('from', f);              // voor leesbaarheid/debug in logs
  url.searchParams.set('to', t);
  url.searchParams.set('from_ts', String(fromTs)); // eenduidige filtering server-side
  url.searchParams.set('to_ts', String(toTs));
  url.searchParams.set('tz', TZ);
  url.searchParams.set('view', VIEW);
  url.searchParams.set('limit', '8000');
  url.searchParams.set('cb', String(Date.now())); // cache-buster voor zekerheid

  elBtn.disabled = true;
  setStatus(`Laden‚Ä¶ ‚è≥ ${url.toString()}`);

  try {
    const r = await fetch(url.toString(), { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const payload = await r.json();

    // payload kan array zijn of {items:[...]} afhankelijk van je worker
    const items = Array.isArray(payload) ? payload : (payload.items ?? []);
    if (!items.length) {
      setStatus('Geen events in deze periode.','warn');
      renderDays([]);
      return;
    }

    // Client-side groepering per dag (lokale tijd)
    const byDay = new Map();
    for (const ev of items) {
      const ts = ev.server_ts ?? ev.ts ?? ev.time ?? ev.timestamp;
      if (!ts) continue;
      const key = toLocalDayKey(Number(ts));
      if (!byDay.has(key)) byDay.set(key, []);
      byDay.get(key).push(ev);
    }

    // Sorteer dagen aflopend
    const days = [...byDay.entries()].sort((a,b)=>{
      const [da] = a, [db] = b;
      const pa = da.split('/').reverse().join(''); // 2025 10 19
      const pb = db.split('/').reverse().join('');
      return pb.localeCompare(pa);
    });

    setStatus(`OK ‚Äî ${items.length} events in range üëç`);
    renderDays(days);

  } catch (e) {
    console.error(e);
    setStatus(`Fout bij laden: ${String(e.message || e)}`, 'error');
    renderDays([]);
  } finally {
    elBtn.disabled = false;
  }
}

/* ====== RENDER ====== */
function renderDays(dayEntries) {
  const host = document.getElementById('results');
  host.innerHTML = '';
  if (!dayEntries.length) return;

  for (const [day, events] of dayEntries) {
    const card = document.createElement('div');
    card.className = 'day-card';
    const h = document.createElement('h3');
    h.textContent = day + `  (${events.length})`;
    card.appendChild(h);

    // eenvoudige lijst
    const ul = document.createElement('ul');
    ul.className = 'evlist';
    for (const e of events) {
      const li = document.createElement('li');
      const t = Number(e.server_ts ?? e.ts);
      const time = new Intl.DateTimeFormat('nl-BE', { timeZone: TZ, hour:'2-digit', minute:'2-digit', second:'2-digit' }).format(new Date(t));
      li.innerHTML = `<code>${time}</code> ‚Äî <b>${e.type || e.event || 'event'}</b> ‚Äî ${e.id ?? e.code ?? ''}`;
      ul.appendChild(li);
    }
    card.appendChild(ul);
    host.appendChild(card);
  }
}

/* ====== INIT ====== */
document.getElementById('btnLoad').addEventListener('click', loadAll);
</script>
