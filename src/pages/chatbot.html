<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wat wil je melden?</title>
  <link rel="icon" href="/AtalianFavicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css">
  <style>
    html {
      width: 100%;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6fa;
      padding: 0;
      max-width: 800px;
      margin: auto;
      display: flex;
      flex-direction: column;
      height: 100dvh;
      max-height: 100svh;
      overflow: hidden;
    }

  body {
    margin: 0;
    padding: 0;
    background-image: url('/building-cleaning.png');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
  }

  @media (max-width: 480px) {
    .header-flex {
      flex-direction: row;
      align-items: center;
      padding: 0.5rem;
      gap: 0.5rem;
    }

  .header-flex .logo,
  .header-flex .ruimte-label {
    flex: none;
    max-width: 90%;
    width: auto;
    margin-bottom: 0.5rem;
  }
}

    img.logo {
      display: block;
      max-width: 50%;
      margin: 0 ;
      background: rgba(255, 255, 255, 0.85);
      padding: 0.1rem;
      border-radius: 12px;
    }
    .ruimte-label {
	  margin-top: 0rem;  /* geen extra ruimte bovenaan */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.95);
      color: #1a202c;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      margin-bottom: 0rem;
      margin-right: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #ddd;

    }

    .ruimte-label .type {
      font-size: 0.85rem;
      font-weight: normal;
      margin-top: 0.4rem;
      color: #666;
    }	

    #botui-app {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 0.5rem 1rem 1rem 1rem;
    }

.botui-container {
  max-width: 600px;
  width: 80%;
  margin: 0 auto;
  background-color: #fffaf0;
  border-radius: 12px;
  padding: 1rem;
  box-sizing: border-box;
}

    .lang-switch a {
      margin: 0 0.5rem;
      text-decoration: none;
      font-size: 1.2rem;
    }
    
.header-flex {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 600px;
  width: 100%;
  margin: 0 auto;
  padding: 0.5rem 0;
}

.header-flex .logo {
  flex: 0 0 100px;
  max-width: 100px;
  height: auto;
  margin: 0;
}

    .header-flex .ruimte-label {
      flex: 0 0 calc(100% - 100px);
      max-width: calc(100% - 100px);
      text-align: center;
      white-space: normal;   

    }
    


}
  </style>
  
</head>
<body>
  <header>
    <div class="lang-switch" style="text-align: right; padding-right: 1rem;">
      <a href="#" id="switch-nl">üá≥üá± NL</a> |
      <a href="#" id="switch-fr">üá´üá∑ FR</a>
    </div>
    <div class="header-flex">
      <img src="/AtalianLogo.png" alt="Atalian Logo" class="logo" />
      <div id="ruimte-info" class="ruimte-label" style="display:none;"></div>
    </div>
    </header>
  <div id="botui-app">
    <bot-ui></bot-ui>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script>
    document.getElementById('switch-nl').addEventListener('click', () => {
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.set('lang', 'nl');
      window.location.href = newUrl.toString();
    });
    document.getElementById('switch-fr').addEventListener('click', () => {
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.set('lang', 'fr');
      window.location.href = newUrl.toString();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const lang = urlParams.get("lang") ?? "nl";
    const type = urlParams.get("type") ?? '';
    const id = urlParams.get("id") ?? '';
    const isFr = lang === 'fr';
    const botui = new BotUI('botui-app');
    const phoneLink = '<a href="tel:+3278152300">üìû +32 78 152 300</a>';
    let omschrijving = '';



    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function fetchLocationDescription() {
      if (!id || !type) return;
      const endpoint = type === 'eq' ? '/.netlify/functions/equipment' : '/.netlify/functions/space';
      fetch(`${endpoint}?id=${encodeURIComponent(id)}`)
        .then(res => res.json())
        .then(data => {
          const ruimte = document.getElementById('ruimte-info');
          if (data.description) {
            ruimte.innerHTML = `${data.description}<div class="type">${type === 'eq' ? (isFr ? 'üîß Installation' : 'üîß Installatie') : (isFr ? 'üè¢ Espace' : 'üè¢ Ruimte')}</div>`;
            ruimte.style.display = 'flex';
          }
        });
    }

    async function fetchOpenJobs(type, id) {
      try {
        const res = await fetch(`/.netlify/functions/jobs?type=${type}&id=${id}`);
        if (!res.ok) throw new Error(`Server error ${res.status}`);
        const jobs = await res.json();
        return Array.isArray(jobs) ? jobs : [];
      } catch (e) {
        console.error('Fout bij ophalen jobs:', e);
        return null;
      }
    }

    async function startChat() {
      fetchLocationDescription();
      await botui.message.add({type: 'html', content: isFr ? 'Bonjour, je suis votre assistant <span style="color: orange; font-weight: bold;">ATALIAN</span>, <br>je recherche pour vous les signalements en cours...' : 'Hallo, ik ben je <span style="color: orange; font-weight: bold;">ATALIAN</span>-assistent,<br>ik haal even de openstaande meldingen voor je op...' });
      const jobs = await fetchOpenJobs(type, id);
      if (jobs === null) {
        return botui.message.add({ content: isFr ? '‚ùå Erreur lors du chargement des signalements.' : '‚ùå Fout bij het ophalen van de meldingen.' });
      }
      if (jobs.length > 0) {
        const jobList = jobs.map(j => `‚úÖ ${j.Description}`).join('<br>');
        return botui.message.add({ type: 'html', content: jobList })
          .then(() => botui.message.add({ content: isFr ? 'Votre probl√®me est-il d√©j√† list√©?' : 'Staat jouw probleem hierbij?' }))
          .then(() => botui.action.button({ action: [
            { text: isFr ? 'Oui' : 'Ja', value: 'ja' },
            { text: isFr ? 'Non' : 'Nee', value: 'nee' }
                    ] }))
          .then(res => {
            if (res.value === 'ja') {
              return botui.message.add({ content: isFr ? 'Merci ! Aucun nouveau signalement n‚Äôest n√©cessaire.' : 'Bedankt! Je hoeft geen nieuwe melding te maken.' })
                .then(() => setTimeout(() => { try { window.close(); } catch {} }, 3000));
            }
            if (res.value === 'info') {
              return botui.message.add({ content: isFr ? 'Vous allez √™tre redirig√© vers Atalian.' : 'Je wordt nu doorgestuurd naar Atalian.' })
                .then(() => setTimeout(() => { window.location.href = 'https://www.atalian.be'; }, 1500));
            }
            return askProblemType();
          });
      }
      return askProblemType();
    }

    async function askProblemType() {
      // Voor type eq geen keuze voor Technisch/Schoonmaak/Anders, ga direct naar urgentie
      if (type === 'eq') {
        return askUrgency('');
      }
      return botui.message.add({ content: isFr ? 'Je n\'ai rien retrouv√©, quel type de probl√®me souhaitez-vous signaler?' : 'Ik heb niets gevonden, wat wil je melden?' })
        .then(() => botui.action.button({ action: [
          { text: isFr ? 'üîß Technique' : 'üîß Technisch', value: 'technisch' },
          { text: isFr ? 'üßº Nettoyage' : 'üßº Schoonmaak', value: 'schoonmaak' },
          { text: isFr ? '‚ùì Autre' : '‚ùì Anders', value: 'anders' }
        ] }))
        .then(res => {
          // Als type sp dan achtergrond aanpassen
          if (type === 'sp') {
            if (res.value === 'technisch') {
              document.body.style.backgroundImage = "linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0)), url('/meldentechnisch.png')";
            } else if (res.value === 'schoonmaak') {
              document.body.style.backgroundImage = "linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0)), url('/meldenschoonmaak.png')";
            }
            // Anders: behoud standaard achtergrond
          }
          return askUrgency(res.value);
        });
    }

    function askUrgency(selectedType) {
      return botui.message.add({ content: isFr ? 'Je n\'ai rien retrouv√©, le probl√®me est urgent?' : 'Ik heb niets gevonden, is het dringend?' })
        .then(() => botui.action.button({ action: [
          { text: isFr ? 'üö® Oui' : 'üö® Ja', value: 'ja' },
          { text: isFr ? '‚è± Non' : '‚è± Nee', value: 'nee' }
        ] }))
        .then(res => {
          if (res.value === 'ja') {
            return botui.message.add({ type: 'html', content: isFr ? `Merci ! Veuillez appeler onmiddellijk ${phoneLink}` : `Bedankt! Gelieve onmiddellijk te bellen naar ${phoneLink}` });
          }
          return askDescription();
        });
    }

    function askDescription() {
      return botui.message.add({ content: isFr ? 'Quel est le probl√®me exactement?' : 'Wat is het probleem precies?' })
        .then(() => botui.action.text({ action: { placeholder: isFr ? 'Beschrijf het probleem' : 'Beschrijf het probleem' } }))
        .then(res => { omschrijving = res.value; return askEmail(); });
    }

    function askEmail() {
      return botui.message.add({ content: isFr ? 'Quelle est votre adresse e-mail?' : 'Wat is je e-mailadres?' })
        .then(() => botui.action.text({ action: { placeholder: 'jouw@email.com' } }))
        .then(res => {
          const email = res.value;
          if (!isValidEmail(email)) {
            return botui.message.add({ content: isFr ? 'Adresse e-mail invalide.' : 'Ongeldig e-mailadres.' })
              .then(() => askEmail());
          }
          const payload = { id, type, JobDescr: omschrijving, ReportText: email, lang };
          return fetch('/.netlify/functions/melding', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(async apiRes => {
            const text = await apiRes.text();
            if (!apiRes.ok) throw new Error(text);
            return botui.message.add({ content: isFr ? 'Merci ! Votre signalement a √©t√© envoy√©.' : 'Bedankt! Jouw melding is verzonden.' });
          }).catch(err => {
            console.error('Fout bij verzenden melding:', err);
            return botui.message.add({ content: isFr ? 'Erreur lors de l‚ÄôEnvoi de la demande.' : 'Fout bij het verzenden van de melding.' });
          });
        });
    }

    startChat();
  </script>
</body>
</html>
